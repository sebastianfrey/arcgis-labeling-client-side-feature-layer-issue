import{ga as O,da as g,gb as m}from"./index-C_bK48d2.js";import{N as M}from"./CIMSymbolHelper-BdzJMZqf.js";import{CIMSymbolRasterizer as R}from"./CIMSymbolRasterizer-CxZOCRQl.js";import{OverrideHelper as E}from"./OverrideHelper-C80mPzpW.js";import{l as q}from"./symbolUtils-C-02jwAZ.js";import"./BidiEngine-DbjCV6G7.js";import"./labelPoint-Btea-Ya0.js";import"./OptimizedGeometry-KE6YknPZ.js";import"./memoryEstimations-w0EAmzVg.js";import"./GeometryUtils-CROhaqZP.js";import"./fontUtils-WtN6_M4S.js";import"./rasterizingUtils-JV4ZHDNN.js";import"./Rect-CUzevAry.js";import"./BoundingBox-hPKJQmqA.js";import"./CIMResourceManager-DEewzKlt.js";import"./colorUtils-CLNuAJnC.js";import"./callExpressionWithFeature-Yw0RK2Jm.js";import"./quantizationUtils-DpuTGthe.js";import"./utils-B2fTWpox.js";import"./cimSymbolUtils-kUrI6vhQ.js";const d=new R(null),u=m(22),I=m(120),S=m(50),D=1;async function N(a,e,o){const r=e==null?void 0:e.size;let t=r!=null&&typeof r=="object"&&"width"in r?r.width:r,l=r!=null&&typeof r=="object"&&"height"in r?r.height:r;if(!t||!l)if(o==="esriGeometryPolygon")t=l=e.maxSize?Math.min(e.maxSize,u):u;else{const s=await T(a,e,o);s&&(t=s.width,l=s.height),o==="esriGeometryPolyline"&&(t=e.maxSize?Math.min(e.maxSize,S):S),t=t!=null&&isFinite(t)?Math.min(t,I):u,l=l!=null&&isFinite(l)?Math.max(Math.min(l,I),D):u}return e.style==="legend"&&o==="esriGeometryPolyline"&&(t=S),{width:t,height:l}}async function T(a,e={},o){var c;const r=e.cimOptions||e;o??(o=r.geometryType||O((c=a==null?void 0:a.data)==null?void 0:c.symbol));const{feature:t,fieldMap:l,viewParams:s}=r,n=await E.resolveSymbolOverrides(a.data,t,null,l,o,null,s);if(!n)return null;(a=a.clone()).data={type:"CIMSymbolReference",symbol:n},a.data.primitiveOverrides=void 0;const i=[];return M.fetchResources(n,d.resourceManager,i),M.fetchFonts(n,d.resourceManager,i),i.length>0&&await Promise.all(i),M.getEnvelope(n,null,d.resourceManager)}async function ne(a,e={}){var x,z;const{node:o,opacity:r,symbolConfig:t}=e,l=t!=null&&typeof t=="object"&&"isSquareFill"in t&&t.isSquareFill,s=e.cimOptions||e,n=s.geometryType||O((x=a==null?void 0:a.data)==null?void 0:x.symbol),i=await N(a,e,n),{feature:c,fieldMap:F}=s,G=e!=null&&e.geometry||l||n!=="esriGeometryPolygon"?"preview":"legend";let v=i;const P=i;if(e!=null&&e.geometry&&(n==="esriGeometryPolygon"||n==="esriGeometryPolyline")&&(g(i.width)<200||g(i.height)<200)){const L=i.width>i.height?m(200)*i.height/i.width:m(200);v={width:i.width>i.height?m(200):m(200)*i.width/i.height,height:L}}const f=await d.rasterizeCIMSymbolAsync(a,c,v,G,F,n,null,s.viewParams,s.allowScalingUp,(z=e==null?void 0:e.geometry)==null?void 0:z.toJSON());if(!f)return null;const{width:$,height:j}=f,p=document.createElement("canvas");p.width=$,p.height=j,p.getContext("2d").putImageData(f,0,0);const w=g(P.width),b=g(P.height),h=new Image(w,b);h.src=p.toDataURL(),h.ariaLabel=e.ariaLabel??null,h.alt=e.ariaLabel??"",r!=null&&(h.style.opacity=`${r}`);let y=h;if(e.cssEffectFilter){const C={shape:{type:"image",x:0,y:0,width:w,height:b,src:h.src},fill:null,stroke:null,offset:[0,0]};y=q([[C]],[w,b],e)}return o&&y&&o.appendChild(y),y}export{T as getCIMSymbolPreviewSize,ne as previewCIMSymbol};
