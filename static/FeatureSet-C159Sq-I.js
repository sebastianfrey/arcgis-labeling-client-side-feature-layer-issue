import{t as R}from"./arcadeEnvironment-DXZ5oSsm.js";import{ck as G,p5 as j,aW as M,g1 as O,g2 as x,ef as D,ed as J,ec as z,ee as B,ae as K,c_ as W,p6 as V,aX as Q}from"./index-C_bK48d2.js";import{I as X}from"./Feature-IMCzHRW9.js";import{c as S,m as F,d as A,a as E,f as L,S as ee,l as te,D as $}from"./shared-CCxkzcop.js";import{a as p,L as v,i as H}from"./WhereClause-BTKovlsq.js";import{a as b}from"./operatorsWorkerConnection-DC2XMJIx.js";const ae={Cancelled:"Cancelled",InvalidStatResponse:"Invalid statistics response from service",InvalidRequest:"Invalid request",RequestFailed:"Request failed - {reason}",MissingFeatures:"Missing features",AggregationFieldNotFound:"Aggregation field not found",DataElementsNotFound:"Data elements not found on service",NeverReach:"Encountered unreachable logic",NotImplemented:"Not implemented"};class g extends Error{constructor(e,a){super(G(ae[e],a)),this.declaredRootClass="esri.arcade.featureset.support.featureseterror",Error.captureStackTrace&&Error.captureStackTrace(this,g)}}function re(t){if(t!=null&&(t!=null&&t.aborted))throw new g("Cancelled")}const C=class C{constructor(){this._databaseTypeMetaData={},this._layerInfo={}}clearDatabaseType(e){this._databaseTypeMetaData[e]===void 0&&delete this._databaseTypeMetaData[e]}getDatabaseType(e){return e==="MUSTBESET"||this._databaseTypeMetaData[e]===void 0?null:this._databaseTypeMetaData[e]}setDatabaseType(e,a){this._databaseTypeMetaData[e]=a}getLayerInfo(e){return this._layerInfo[e]===void 0?null:this._layerInfo[e]}setLayerInfo(e,a){this._layerInfo[e]=a}clearLayerInfo(e){this._layerInfo[e]!==void 0&&delete this._layerInfo[e]}};C.applicationCache=null;let y=C;class se{constructor(e,a){this._parent=e,this._abortSignal=a,this._done=!1,this._features=null,this._batchMutex=new j,this._currentPage=null,this._pageCursor=-1}get _numAvailable(){return this._currentPage==null||this._pageCursor<0?0:Math.max(this._currentPage.length-this._pageCursor,0)}_takeNFeatures(e){if(this._currentPage==null)return[];const a=this._currentPage.slice(this._pageCursor,this._pageCursor+e);return this._pageCursor+=a.length,a.map(r=>M.fromJSON(r))}_takeOneFeature(){const e=this._currentPage[this._pageCursor];return this._pageCursor+=1,M.fromJSON(e)}async _nextBatch(){if(this._done)return!1;const e=await(this._features??(this._features=this._parent.queryAll(this._abortSignal)));let a;do if(a=await e.next(),a.done)return this._done=!0,this._currentPage=null,this._pageCursor=-1,!1;while(a.value.length<=0);return this._currentPage=a.value,this._pageCursor=0,!0}async nextBatchAsArcadeFeatures(e,a){const r=await this.nextBatch(e);return r==null?r:r.map(s=>X.createFromGraphicLikeObject(s.geometry,s.attributes,this._parent,a))}async nextBatch(e){const a={stack:[],error:void 0,hasError:!1};try{if(this._done)return null;if(e<=0)return[];if(O(a,await this._batchMutex.acquire(),!1),this._numAvailable>=e)return this._takeNFeatures(e);const r=[];let s=e;do{const l=this._takeNFeatures(s);s-=l.length,r.push(l)}while(s>0&&await this._nextBatch());const n=r.flat();return n.length>0?n:null}catch(r){a.error=r,a.hasError=!0}finally{x(a)}}async next(){const e={stack:[],error:void 0,hasError:!1};try{return this._done?null:(O(e,await this._batchMutex.acquire(),!1),this._numAvailable>=1||await this._nextBatch()?this._takeOneFeature():null)}catch(a){e.error=a,e.hasError=!0}finally{x(e)}}}function k(t,e){return c(t==null?void 0:t.parseTree,e,t==null?void 0:t.parameters)}function Le(t,e,a){return c(t,e,a)}function Ne(t,e,a,r){const s=c(t.parseTree,0,t.parameters,e,a);return v.create(s,{fieldsIndex:r,timeZone:t.timeZone,currentUser:t.currentUser})}function De(t,e,a="AND"){return v.create("(("+k(t,0)+")"+a+"("+k(e,0)+"))",{fieldsIndex:t.fieldsIndex,timeZone:t.timeZone,currentUser:t.currentUser})}function ne(t){return t.delimited===!0?`"${t.column.split('"').join('""')}"`:t.column}function c(t,e,a,r=null,s=null){let n,l,h,d;switch(t.type){case"interval":return ue(c(t.value,e,a,r,s),t.qualifier,t.op);case"case-expression":{let i=" CASE ";t.format==="simple"&&(i+=c(t.operand,e,a,r,s));for(let u=0;u<t.clauses.length;u++)i+=" WHEN "+c(t.clauses[u].operand,e,a,r,s)+" THEN "+c(t.clauses[u].value,e,a,r,s);return t.else!==null&&(i+=" ELSE "+c(t.else,e,a,r,s)),i+=" END ",i}case"parameter":{const i=a[t.value.toLowerCase()];if(typeof i=="string")return"'"+a[t.value.toLowerCase()].toString().replaceAll("'","''")+"'";if(S(i)||F(i))return _(i,e);if(A(i))return U(i,e);if(E(i))return N(i,e);if(L(i))return P(i,e);if(Array.isArray(i)){const u=[];for(let o=0;o<i.length;o++)typeof i[o]=="string"?u.push("'"+i[o].toString().replaceAll("'","''")+"'"):S(i[o])||F(i[o])?u.push(_(i[o],e)):A(i[o])?u.push(U(i[o],e)):E(i[o])?u.push(N(i[o],e)):L(i[o])?u.push(P(i[o],e)):u.push(i[o].toString());return u}return i.toString()}case"expression-list":l=[];for(const i of t.value)l.push(c(i,e,a,r,s));return l;case"unary-expression":return" ( NOT "+c(t.expr,e,a,r,s)+" ) ";case"binary-expression":switch(t.operator){case"AND":return" ("+c(t.left,e,a,r,s)+" AND "+c(t.right,e,a,r,s)+") ";case"OR":return" ("+c(t.left,e,a,r,s)+" OR "+c(t.right,e,a,r,s)+") ";case"IS":if(t.right.type!=="null")throw new p("UnsupportedIsRhs");return" ("+c(t.left,e,a,r,s)+" IS NULL )";case"ISNOT":if(t.right.type!=="null")throw new p("UnsupportedIsRhs");return" ("+c(t.left,e,a,r,s)+" IS NOT NULL )";case"IN":return n=[],t.right.type==="expression-list"?(n=c(t.right,e,a,r,s)," ("+c(t.left,e,a,r,s)+" IN ("+n.join(",")+")) "):(d=c(t.right,e,a,r,s),Array.isArray(d)?" ("+c(t.left,e,a,r,s)+" IN ("+d.join(",")+")) ":" ("+c(t.left,e,a,r,s)+" IN ("+d+")) ");case"NOT IN":return n=[],t.right.type==="expression-list"?(n=c(t.right,e,a,r,s)," ("+c(t.left,e,a,r,s)+" NOT IN ("+n.join(",")+")) "):(d=c(t.right,e,a,r,s),Array.isArray(d)?" ("+c(t.left,e,a,r,s)+" NOT IN ("+d.join(",")+")) ":" ("+c(t.left,e,a,r,s)+" NOT IN ("+d+")) ");case"BETWEEN":return h=c(t.right,e,a,r,s)," ("+c(t.left,e,a,r,s)+" BETWEEN "+h[0]+" AND "+h[1]+" ) ";case"NOTBETWEEN":return h=c(t.right,e,a,r,s)," ("+c(t.left,e,a,r,s)+" NOT BETWEEN "+h[0]+" AND "+h[1]+" ) ";case"LIKE":return t.escape!==""?" ("+c(t.left,e,a,r,s)+" LIKE "+c(t.right,e,a,r,s)+" ESCAPE '"+t.escape+"') ":" ("+c(t.left,e,a,r,s)+" LIKE "+c(t.right,e,a,r,s)+") ";case"NOT LIKE":return t.escape!==""?" ("+c(t.left,e,a,r,s)+" NOT LIKE "+c(t.right,e,a,r,s)+" ESCAPE '"+t.escape+"') ":" ("+c(t.left,e,a,r,s)+" NOT LIKE "+c(t.right,e,a,r,s)+") ";case"<>":case"<":case">":case">=":case"<=":case"=":case"*":case"-":case"+":case"/":return" ("+c(t.left,e,a,r,s)+" "+t.operator+" "+c(t.right,e,a,r,s)+") ";case"||":return" ("+c(t.left,e,a,r,s)+" "+(e===2?"+":t.operator)+" "+c(t.right,e,a,r,s)+") "}throw new p("UnsupportedOperator",{operator:t.operator});case"null":return"null";case"boolean":return t.value===!0?"1":"0";case"string":return"'"+t.value.toString().replaceAll("'","''")+"'";case"timestamp":return`timestamp '${t.value}'`;case"date":return`date '${t.value}'`;case"time":return`time '${t.value}'`;case"number":return t.value.toString();case"current-time":return le(t.mode,e);case"current-user":return"CURRENT_USER";case"column-reference":return r&&r.toLowerCase()===t.column.toLowerCase()?"("+s+")":ne(t);case"data-type":return t.value;case"function":{const i=c(t.args,e,a,r,s);return ie(t.name,i,e)}}throw new p("UnsupportedSyntax",{node:t.type})}function ie(t,e,a){switch(t.toLowerCase().trim()){case"cos":case"sin":case"tan":case"cosh":case"tanh":case"sinh":case"acos":case"asin":case"atan":case"floor":case"log10":case"log":case"abs":if(e.length!==1)throw new p("InvalidFunctionParameters",{function:t.toLowerCase().trim()});return`${t.toUpperCase().trim()}(${e[0]})`;case"ceiling":case"ceil":if(e.length!==1)throw new p("InvalidFunctionParameters",{function:"ceiling"});return"CEILING("+e[0]+")";case"mod":case"power":case"nullif":if(e.length!==2)throw new p("InvalidFunctionParameters",{function:t.toLowerCase().trim()});return`${t.toUpperCase().trim()}(${e[0]},${e[1]})`;case"round":if(e.length===2)return"ROUND("+e[0]+","+e[1]+")";if(e.length===1)return"ROUND("+e[0]+")";throw new p("InvalidFunctionParameters",{function:"round"});case"truncate":if(e.length<1||e.length>2)throw new p("InvalidFunctionParameters",{function:"truncate"});return a===2?"ROUND("+e[0]+(e.length===1?"0":","+e[1])+",1)":"TRUNCATE("+e[0]+(e.length===1?")":","+e[1]+")");case"char_length":case"len":if(e.length!==1)throw new p("InvalidFunctionParameters",{function:"char_length"});switch(a){case 2:return"LEN("+e[0]+")";case 3:return"LENGTH("+e[0]+")";default:return"CHAR_LENGTH("+e[0]+")"}case"coalesce":case"concat":{if(e.length<1)throw new p("InvalidFunctionParameters",{function:t.toLowerCase()});let r=t.toUpperCase().trim()+"(";for(let s=0;s<e.length;s++)s!==0&&(r+=","),r+=e[s];return r+=")",r}case"lower":case"lcase":if(e.length!==1)throw new p("InvalidFunctionParameters",{function:"lower"});return"LOWER("+e[0]+")";case"upper":case"ucase":if(e.length!==1)throw new p("InvalidFunctionParameters",{function:"upper"});return"UPPER("+e[0]+")";case"substring":{let r="";switch(a){case 3:return r="SUBSTR("+e[0]+","+e[1],e.length===3&&(r+=","+e[2]),r+=")",r;case 2:return r=e.length===3?"SUBSTRING("+e[0]+","+e[1]+","+e[2]+")":"SUBSTRING("+e[0]+",  "+e[1]+", LEN("+e[0]+") - "+e[1]+")",r;default:return r="SUBSTRING("+e[0]+" FROM "+e[1],e.length===3&&(r+=" FOR "+e[2]),r+=")",r}}case"extract":return"EXTRACT("+e[0].replaceAll("'","")+" FROM "+e[1]+")";case"cast":{let r="";switch(a){case 3:switch(e[1].type){case"date":r="DATE";break;case"float":r="DOUBLE";break;case"integer":r="INTEGER";break;case"real":r="REAL";break;case"smallint":r="SMALLINT";break;case"timestamp":r="TIMESTAMP";break;case"varchar":r="VARCHAR("+e[1].size.toString()+")"}return`CAST(${e[0]} AS ${r})`;case 4:switch(e[1].type){case"date":r="DATE";break;case"float":r="DOUBLE PRECISION";break;case"integer":r="INT";break;case"real":r="REAL";break;case"smallint":r="SMALLINT";break;case"timestamp":r="TIMESTAMP";break;case"varchar":r="VARCHAR("+e[1].size.toString()+")"}return`CAST(${e[0]} AS ${r})`;case 2:switch(e[1].type){case"date":r="DATE";break;case"float":r="FLOAT";break;case"integer":r="INT";break;case"real":r="REAL";break;case"smallint":r="SMALLINT";break;case"timestamp":r="DATETIME";break;case"varchar":r="VARCHAR("+e[1].size.toString()+")"}return`CAST(${e[0]} AS ${r})`;default:switch(e[1].type){case"date":r="DATE";break;case"float":r="FLOAT";break;case"integer":r="INTEGER";break;case"real":r="REAL";break;case"smallint":r="SMALLINT";break;case"timestamp":r="TIMESTAMP";break;case"varchar":r="VARCHAR("+e[1].size.toString()+")"}return`CAST(${e[0]} AS ${r})`}}}throw new p("InvalidFunctionParameters",{function:t})}function N(t,e){const a=t.toDateTime(),r=a.hour===0&&a.minute===0&&a.second===0&&a.millisecond===0;switch(e){case 6:case 0:case 1:return r?`date '${a.toFormat("yyyy-LL-dd")}'`:`timestamp '${a.toFormat("yyyy-LL-dd HH:mm:ss")}'`;case 3:return r?`TO_DATE('${a.toFormat("yyyy-LL-dd")}','YYYY-MM-DD')`:`TO_DATE('${a.toFormat("yyyy-LL-dd HH:mm:ss")}','YYYY-MM-DD HH24:MI:SS')`;case 2:return`'${a.toFormat(r?"yyyy-LL-dd":"yyyy-LL-dd HH:mm:ss")}'`;case 5:return`#${a.toFormat(r?"LL-dd-yyyy":"LL-dd-yyyy HH:mm:ss")}#`;case 4:return`TIMESTAMP '${a.toFormat(r?"yyyy-LL-dd":"yyyy-LL-dd HH:mm:ss")}'`;default:return`timestamp '${a.toFormat("yyyy-LL-dd HH:mm:ss")}'`}}function P(t,e){switch(e){case 6:case 0:case 1:default:return t.toSQLWithKeyword();case 3:return`TO_DATE('${t.toFormat("Y-MM-DD")}'`;case 2:return`'${t.toFormat("Y-MM-DD")}'`;case 5:return`#${t.toFormat("Y-MM-DD")}#`;case 4:return`TIMESTAMP '${t.toFormat("Y-MM-DD")}'`}}function U(t,e){switch(t instanceof D&&(t=t.toStorageString()),e){case 3:return`TO_DATE('${t}', 'HH24:MI:SS')`;case 2:return`'${t}'`;default:return`time '${t}'`}}function _(t,e){return N(J.dateTimeToArcadeDate(F(t)?t:z.fromJSDate(t)),e)}function le(t,e){switch(e){case 6:case 0:case 1:case 3:case 5:default:return t==="date"?"CURRENT_DATE":t==="time"?"CURRENT_TIME":"CURRENT_TIMESTAMP";case 2:return t==="date"?"CAST(GETDATE() AS DATE)":t==="time"?"CAST(GETDATE() AS TIME)":"GETDATE()";case 4:return t==="date"?"CURRENT_DATE":t==="time"?"LOCALTIME":"CURRENT_TIMESTAMP"}}function oe(t,e,a={}){const r={},s={},n={esriFieldTypeSmallInteger:"integer",esriFieldTypeInteger:"integer",esriFieldTypeBigInteger:"integer",esriFieldTypeSingle:"double",esriFieldTypeDouble:"double",esriFieldTypeString:"string",esriFieldTypeTimeOnly:"time-only",esriFieldTypeDateOnly:"date-only",esriFieldTypeTimestampOffset:"timestamp-offset",esriFieldTypeDate:"date",esriFieldTypeOID:"integer",esriFieldTypeGUID:"guid",esriFieldTypeGlobalID:"guid",oid:"integer",long:"integer","small-integer":"integer",integer:"integer","big-integer":"integer",single:"double","time-only":"time-only","date-only":"date-only","timestamp-offset":"timestemp-offset",double:"double",date:"date",guid:"guid","global-id":"guid",string:"string"};for(const l of e){const h=l.type?n[l.type]:void 0;r[l.name.toLowerCase()]=h===void 0?"":h}for(const l in a){const h=n[a[l]];s[l.toLowerCase()]=h===void 0?"":h}switch(f(r,t.parseTree,t.parameters,s)){case"double":return"double";case"integer":return"integer";case"date":return"date";case"date-only":return"date-only";case"time-only":return"time-only";case"timestamp-offset":return"timestamp-offset";case"string":return"string";case"global-id":case"guid":return"guid"}return""}function f(t,e,a,r){var n,l,h,d,i;let s;switch(e.type){case"interval":return"integer";case"case-expression":{const u=[];if(e.format==="simple"){for(let o=0;o<e.clauses.length;o++)u.push(f(t,e.clauses[o].value,a,r));e.else!==null&&u.push(f(t,e.else,a,r))}else{for(let o=0;o<e.clauses.length;o++)u.push(f(t,e.clauses[o].value,a,r));e.else!==null&&u.push(f(t,e.else,a,r))}return w(u)}case"parameter":{const u=r[e.value.toLowerCase()];if(u===void 0&&a){const o=a[e.value.toLowerCase()];if(o===void 0||o===null)return"";if(typeof o=="string"||o instanceof String)return"string";if(typeof o=="boolean")return"boolean";if(S(o)||E(o))return"date";if(L(o))return"date-only";if(A(o))return"time-only";if(typeof o=="number")return o%1==0?"integer":"double"}return u===void 0?"":u}case"expression-list":{const u=[];for(const o of e.value)u.push(f(t,o,a,r));return u}case"unary-expression":return"boolean";case"binary-expression":switch(e.operator){case"AND":case"OR":case"IN":case"NOT IN":case"BETWEEN":case"NOTBETWEEN":case"LIKE":case"NOT LIKE":case"<>":case"<":case">":case">=":case"<=":case"=":return"boolean";case"IS":case"ISNOT":if(e.right.type!=="null")throw new p("UnsupportedIsRhs");return"boolean";case"*":case"-":case"+":case"/":return w([f(t,e.left,a,r),f(t,e.right,a,r)]);case"||":return"string";default:throw new p("UnsupportedOperator",{operator:e.operator})}case"null":return"";case"boolean":return"boolean";case"string":return"string";case"number":return e.value===null?"":e.value%1==0?"integer":"double";case"date":return"date";case"timestamp":return e.withtimezone?"timestamp-offset":"date";case"time":return"time-only";case"current-time":return e.mode==="time"?"time-only":"date";case"current-user":return"string";case"column-reference":{const u=t[e.column.toLowerCase()];return u===void 0?"":u}case"function":switch(e.name.toLowerCase()){case"cast":switch(((l=(n=e.args)==null?void 0:n.value[1])==null?void 0:l.value.type)??""){case"integer":case"smallint":return"integer";case"real":case"float":return"double";case"date":case"timestamp":return((i=(d=(h=e.args)==null?void 0:h.value[1])==null?void 0:d.value)==null?void 0:i.withtimezone)===!0?"timestamp-offset":"date";case"time":return"time-only";case"varchar":return"string";default:return""}case"position":case"extract":case"char_length":case"mod":return"integer";case"round":if(s=f(t,e.args,a,r),Array.isArray(s)){if(s.length<=0)return"double";s=s[0]}return s;case"sign":return"integer";case"ceiling":case"floor":case"abs":return s=f(t,e.args,a,r),Array.isArray(s)&&(s=w(s)),s==="integer"||s==="double"?s:"double";case"area":case"length":case"log":case"log10":case"sin":case"cos":case"tan":case"asin":case"acos":case"atan":case"cosh":case"sinh":case"tanh":case"power":return"double";case"substring":case"trim":case"concat":case"lower":case"upper":return"string";case"truncate":return"double";case"nullif":case"coalesce":return s=f(t,e.args,a,r),Array.isArray(s)?s.length>0?s[0]:"":s}return""}throw new p("UnsupportedSyntax",{node:e.type})}const q={boolean:1,string:2,integer:3,double:4,date:5};function w(t){if(t){let e="";for(const a of t)a!==""&&(e=e===""||q[e]<q[a]?a:e);return e}return""}function ve(t,e){return m(t.parseTree,e)}function ce(t){return(t==null?void 0:t.parseTree.type)==="column-reference"}function m(t,e){if(t==null)return!1;switch(t.type){case"when-clause":return m(t.operand,e)||m(t.value,e);case"case-expression":for(const a of t.clauses)if(m(a,e))return!0;return!(t.format!=="simple"||!m(t.operand,e))||!(t.else===null||!m(t.else,e));case"parameter":case"null":case"boolean":case"date":case"timestamp":case"time":case"string":case"number":return!1;case"expression-list":for(const a of t.value)if(m(a,e))return!0;return!1;case"unary-expression":return m(t.expr,e);case"binary-expression":return m(t.left,e)||m(t.right,e);case"column-reference":return e.toLowerCase()===t.column.toLowerCase();case"function":return m(t.args,e)}return!1}function I(t){let e="";return e+=t.period.toUpperCase(),e}function ue(t,e,a){let r="";return r=e.type==="interval-period"?I(e):I(e.start)+" TO "+I(e.end),"INTERVAL "+a+" "+t+" "+r}function he(t){return t=+t,isFinite(t)?t-t%1||(t<0?-0:t===0?t:0):t}function Y(t){let e=0;for(let a=0;a<t.length;a++)e+=t[a];return e/t.length}function Z(t){const e=Y(t);let a=0;for(let r=0;r<t.length;r++)a+=(e-t[r])**2;return a/(t.length-1)}function de(t){let e=0;for(let a=0;a<t.length;a++)e+=t[a];return e}function Ce(t){switch(t.toLowerCase()){case"distinct":return"distinct";case"avg":case"mean":return"avg";case"min":return"min";case"sum":return"sum";case"max":return"max";case"stdev":case"stddev":return"stddev";case"var":case"variance":return"var";case"count":return"count"}return null}async function pe(t,e,a){const r=await T(t,e,a);return r.length===0?null:Math.min.apply(Math,r)}async function fe(t,e,a){const r=await T(t,e,a);return r.length===0?null:Math.max.apply(Math,r)}async function me(t,e,a){let r="";e&&!ce(e)&&(r=oe(e,t.fields));const s=await T(t,e,a);if(s.length===0)return null;const n=Y(s);return n===null?n:r==="integer"?he(n):n}async function ye(t,e,a){const r=await T(t,e,a);return r.length===0?null:Z(r)}async function ge(t,e,a){const r=await T(t,e,a);return r.length===0?null:Math.sqrt(Z(r))}async function Te(t,e,a){const r=await T(t,e,a);return r.length===0?null:de(r)}async function T(t,e,a){const r=await t.queryAll(a),s=[],n={ticker:0};for await(const l of r){if(n.ticker+=l.length,n.ticker>=100&&(n.ticker=0,await new Promise(h=>{setTimeout(h,0)})),a==null?void 0:a.aborted)throw new g("Cancelled");for(const h of l){const d=e==null?void 0:e.calculateValue(h);d===null||(s[s.length]=d instanceof B||d instanceof D?d.toNumber():d instanceof H?d.toMilliseconds():d)}}return s}async function be(t,e,a=1e3,r=null){if(e==null)return[];const s=await t.queryAll(r),n=[],l=new Set,h={ticker:0};for await(const d of s){if(h.ticker+=d.length,h.ticker>=100&&(h.ticker=0,await new Promise(i=>{setTimeout(i,0)})),r==null?void 0:r.aborted)throw new g("Cancelled");for(const i of d){const u=e.calculateValue(i);let o=u;if(u instanceof B?o="!!DATEONLY!!-"+u.toString():u instanceof H?o="!!TSOFFSETONLY!!-"+u.toString():u instanceof D?o="!!TIMEONLY!!-"+u.toString():u instanceof Date&&(o="!!DATE!!-"+u.toString()),u!=null&&(l.has(o)||(n.push(u),l.add(o))),n.length>=a&&a!==-1)return n}}return n}function Re(t,e){var a;for(const r of t)r.geometry!=null&&((a=r.geometry).spatialReference??(a.spatialReference=e))}const Me=Object.freeze({ordered:!0,filterApplied:!0,spatialFilterApplied:!0,features:Object.freeze({next:()=>Promise.resolve({done:!0,value:void 0}),[Symbol.asyncIterator](){return this}})});class _e{constructor(){this.declaredRootClass="esri.arcade.featureset.support.FeatureSet",this._parent=null,this._maxProcessing=200,this._maxQuery=500,this._totalCount=-1,this._databaseType=7,this._databaseTypeProbed=null,this._loadPromise=null,this._allFeatures=null,this._fieldsIndex=null,this.typeIdField=null,this.types=null,this.subtypeField=null,this.subtypes=null,this.fields=null,this.geometryType="",this.objectIdField="",this.globalIdField="",this.spatialReference=null,this.hasM=!1,this.hasZ=!1}_ensureLoaded(){return this.load()}load(){return this._loadPromise===null&&(this._loadPromise=this.loadImpl()),this._loadPromise}async loadImpl(){var e;return await((e=this._parent)==null?void 0:e.load()),this._initialiseFeatureSet(),this}_initialiseFeatureSet(){this._parent!==null?(this.fields=this._parent.fields.slice(),this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types,this.subtypeField=this._parent.subtypeField,this.subtypes=this._parent.subtypes):(this.fields=[],this.typeIdField="",this.subtypeField="",this.objectIdField="",this.globalIdField="",this.spatialReference=new K({wkid:4326}),this.geometryType=ee.point)}getField(e,a){return e=e.toLowerCase(),(a||this.fields).find(r=>r.name.toLowerCase()===e)}getFieldsIndex(){return this._fieldsIndex===null&&(this._fieldsIndex=W.fromLayer({timeInfo:this.timeInfo,editFieldsInfo:this.editFieldsInfo,dateFieldsTimeZone:this.dateFieldsTimeZone,datesInUnknownTimezone:this.datesInUnknownTimezone,fields:this.fields})),this._fieldsIndex}_maxProcessingRate(){return this._parent!==null?Math.min(this._maxProcessing,this._parent._maxProcessingRate()):Math.min(this._maxProcessing,this._maxQueryRate())}_maxQueryRate(){return this._parent!==null?Math.max(this._maxQuery,this._parent._maxQueryRate()):this._maxQuery}nativeCapabilities(){return this._parent.nativeCapabilities()}get _hasCachedFeatures(){return this._allFeatures!=null}async queryAll(e){this._allFeatures==null&&(this._allFeatures=this._queryAll().then(r=>V(r)));const a=(await this._allFeatures)();return e==null||e===R?a:async function*(){for await(const r of a)re(e),yield r}()}async databaseType(){if(this._databaseType===7){if(y.applicationCache!==null){const e=y.applicationCache.getDatabaseType(this._cacheableFeatureSetSourceKey());if(e!==null)return e}if(this._databaseTypeProbed!==null)return this._databaseTypeProbed;try{this._databaseTypeProbed=this._getDatabaseTypeImpl(),y.applicationCache!==null&&y.applicationCache.setDatabaseType(this._cacheableFeatureSetSourceKey(),this._databaseTypeProbed)}catch(e){throw y.applicationCache!==null&&y.applicationCache.clearDatabaseType(this._cacheableFeatureSetSourceKey()),e}return this._databaseTypeProbed}return this._databaseType}async _getDatabaseTypeImpl(){const e=[{dbType:2,probeSql:"(CAST( '2015-01-01' as DATETIME) = CAST( '2015-01-01' as DATETIME)) AND OBJECTID<0"},{dbType:3,probeSql:"(TO_DATE('2003-11-18','YYYY-MM-DD') = TO_DATE('2003-11-18','YYYY-MM-DD')) AND OBJECTID<0"},{dbType:1,probeSql:"(date '2015-01-01 10:10:10' = date '2015-01-01 10:10:10') AND OBJECTID<0"}];for(const a of e)if(await this._runDatabaseProbe(a.probeSql)===!0)return a.dbType;return 1}_cacheableFeatureSetSourceKey(){return"MUSTBESET"}async _runDatabaseProbe(e){if(this._parent!==null)return this._parent._runDatabaseProbe(e);throw new g("NotImplemented")}isTable(){var e;return((e=this._parent)==null?void 0:e.isTable())??!1}first(e){return this.iterator(e).next()}async isEmpty(e){return this._totalCount>=0?this._totalCount===0:await this.first(e)==null}async calculateStatistic(e,a,r,s){await this._ensureLoaded();let n=await this.queryStat({stat:e,field:a,limit:r,abortSignal:s});return n.calculated===!1&&(n=await this._manualStat(e,a,r,s)),n.result}async _manualStat(e,a,r,s){let n=null;switch(e.toLowerCase()){case"count":{if(this._totalCount>=0)return{calculated:!0,result:this._totalCount};const l=await this.queryAll(s);let h=0;for await(const d of l)h+=d.length;return this._totalCount=h,{calculated:!0,result:h}}case"distinct":return n=await be(this,a,r,s),{calculated:!0,result:n};case"avg":case"mean":return n=await me(this,a,s),{calculated:!0,result:n};case"stdev":return n=await ge(this,a,s),{calculated:!0,result:n};case"variance":return n=await ye(this,a,s),{calculated:!0,result:n};case"sum":return n=await Te(this,a,s),{calculated:!0,result:n};case"min":return n=await pe(this,a,s),{calculated:!0,result:n};case"max":return n=await fe(this,a,s),{calculated:!0,result:n};default:return{calculated:!0,result:0}}}iterator(e){return new se(this,e)}async sumArea(e,a,r){let s=0;for await(const n of await this.queryAll(r))for(const l of n)l.geometry!=null&&(s+=a!=null?await b("geodeticArea",[l.geometry,e,a]):await b("area",[l.geometry,e]));return s}async sumLength(e,a,r){let s=0;for await(const n of await this.queryAll(r))for(const l of n)l.geometry!=null&&(s+=a!=null?await b("geodeticLength",[l.geometry,e,a]):await b("length",[l.geometry,e]));return s}async count(e){return await this.load(),this.calculateStatistic("count",v.create("1",{fieldsIndex:this.getFieldsIndex(),timeZone:this.dateFieldsTimeZoneDefaultUTC}),-1,e??R)}castToText(e=!1){return"object, FeatureSet"}queryAttachments(e,a,r,s,n){return this._parent.queryAttachments(e,a,r,s,n)}serviceUrl(){return this._parent.serviceUrl()}subtypeMetadata(){return this.subtypeField&&this.subtypes?{subtypeField:this.subtypeField,subtypes:this.subtypes?this.subtypes.map(e=>({name:e.name,code:e.code})):[]}:this.typeIdField?{subtypeField:this.typeIdField,subtypes:this.types?this.types.map(e=>({name:e.name,code:e.id})):[]}:null}relationshipMetadata(){return this._parent.relationshipMetadata()}get gdbVersion(){return this._parent?this._parent.gdbVersion:""}schema(){const e=[];for(const a of this.fields)e.push(te(a));return{objectIdField:this.objectIdField,globalIdField:this.globalIdField,geometryType:$[this.geometryType]===void 0?"esriGeometryNull":$[this.geometryType],fields:e}}async convertToText(e,a){if(e==="schema")return await this._ensureLoaded(),JSON.stringify(this.schema());if(e==="featureset"){await this._ensureLoaded();const r=[];for await(const s of await this.queryAll(a))for(const n of s){const l={geometry:n.geometry??null,attributes:n.attributes};if(l.geometry!==null&&l.geometry.spatialReference){const{spatialReference:h,...d}=l.geometry;l.geometry=d}r.push(l)}return JSON.stringify({...this.schema(),features:r,spatialReference:this.spatialReference.toJSON()})}return this.castToText()}getFeatureByObjectId(e,a){return this._parent.getFeatureByObjectId(e,a)}getOwningSystemUrl(){return this._parent.getOwningSystemUrl()}getIdentityUser(){return this._parent.getIdentityUser()}getRootFeatureSet(){return this._parent.getRootFeatureSet()}getDataSourceFeatureSet(){return this._parent!==null?this._parent.getDataSourceFeatureSet():this}castAsJson(e=null){return(e==null?void 0:e.featureset)==="keeptype"?this:(e==null?void 0:e.featureset)==="none"?null:{type:"FeatureSet"}}async castAsJsonAsync(e=null,a=null){var s;if((a==null?void 0:a.featureset)==="keeptype")return this;if((a==null?void 0:a.featureset)==="schema")return await this._ensureLoaded(),JSON.parse(JSON.stringify(this.schema()));if((a==null?void 0:a.featureset)==="none")return null;await this._ensureLoaded();const r=[];for await(const n of await this.queryAll(e))for(const l of n){const h={geometry:l.geometry?(a==null?void 0:a.keepGeometryType)===!0?Q(l.geometry):l.geometry:null,attributes:l.attributes};if(h.geometry!==null&&h.geometry.spatialReference&&(a==null?void 0:a.keepGeometryType)!==!0){delete h.geometry.spatialReference;const{spatialReference:d,...i}=h.geometry;h.geometry=i}r.push(h)}return{...this.schema(),features:r,spatialReference:(a==null?void 0:a.keepGeometryType)===!0?this.spatialReference:(s=this.spatialReference)==null?void 0:s.toJSON()}}fieldTimeZone(e){return this.getFieldsIndex().getTimeZone(e)}get preferredTimeZone(){var e;return((e=this._parent)==null?void 0:e.preferredTimeZone)??null}get dateFieldsTimeZone(){var e;return((e=this._parent)==null?void 0:e.dateFieldsTimeZone)??null}get dateFieldsTimeZoneDefaultUTC(){return this.datesInUnknownTimezone?"unknown":this.dateFieldsTimeZone||"UTC"}get datesInUnknownTimezone(){return this._parent.datesInUnknownTimezone}get editFieldsInfo(){var e;return((e=this._parent)==null?void 0:e.editFieldsInfo)??null}get timeInfo(){var e;return((e=this._parent)==null?void 0:e.timeInfo)??null}getFeatureSetInfo(){return this._parent?this._parent.getFeatureSetInfo():Promise.resolve(null)}}class Oe extends _e{constructor(){super(...arguments),this._parent=null}getRootFeatureSet(){return this}}export{_ as A,ue as C,U as E,Re as F,Me as I,oe as L,Oe as S,P as T,Ce as a,y as b,le as c,ne as d,ve as e,Le as f,ie as h,k as l,Ne as m,De as p,g as r,re as s,ce as v,_e as w,N as y};
