import{aJ as i,aL as u,db as $,cC as O,ej as q,aK as h,bb as P,aX as T,hN as A,ax as j,dl as V,bj as S,oQ as w,ft as x,a as I,ap as l,fz as p,oR as N,f3 as k,oS as L,oT as U,oU as z,aF as B,oV as D}from"./index-C_bK48d2.js";import{n as M}from"./Container-DDZeWUS3.js";import{r as F}from"./layerViewUtils-B_qaHejE.js";let _=class extends ${constructor(){super(...arguments),this._idToCounters=new O}get size(){return this._idToCounters.size}get objectIds(){return this._idToCounters.keys()}get highlightNamesByObjectId(){return G(this._idToCounters)}add(c,s){let e=!1;for(const r of c){const o=q(this._idToCounters,r,()=>(e=!0,new Map)),a=o.get(s)??0;a||(e=!0),o.set(s,a+1)}return e}delete(c,s){let e=!1;for(const r of c){const o=this._idToCounters.get(r);if(!o)continue;let a=o.get(s);a!=null&&(a--,a>0?o.set(s,a):(o.delete(s),e=!0),o.size===0&&(this._idToCounters.delete(r),e=!0))}return e}};function*G(n){for(const[c,s]of n)yield[c,s.keys()]}_=i([u("esri.views.2d.layers.support.HighlightCounter")],_);let g=class extends P{get version(){return this.commitVersionProperties(),(this._get("version")||0)+1}};i([h({readOnly:!0})],g.prototype,"version",null),g=i([u("esri.views.layers.support.ClipArea")],g);var b;let d=b=class extends g{constructor(n){super(n),this.type="rect",this.left=null,this.right=null,this.top=null,this.bottom=null}clone(){return new b({left:this.left,right:this.right,top:this.top,bottom:this.bottom})}commitVersionProperties(){this.commitProperty("left"),this.commitProperty("right"),this.commitProperty("top"),this.commitProperty("bottom")}};i([h({type:[Number,String],json:{write:!0}})],d.prototype,"left",void 0),i([h({type:[Number,String],json:{write:!0}})],d.prototype,"right",void 0),i([h({type:[Number,String],json:{write:!0}})],d.prototype,"top",void 0),i([h({type:[Number,String],json:{write:!0}})],d.prototype,"bottom",void 0),d=b=i([u("esri.views.layers.support.ClipRect")],d);var R;const W={base:A,key:"type",typeMap:{extent:j,polygon:V}};let m=R=class extends g{constructor(n){super(n),this.type="geometry",this.geometry=null}clone(){var n;return new R({geometry:((n=this.geometry)==null?void 0:n.clone())??null})}commitVersionProperties(){this.commitProperty("geometry")}};i([h({types:W,json:{read:T,write:!0}})],m.prototype,"geometry",void 0),m=R=i([u("esri.views.layers.support.GeometryClipArea")],m);let f=class extends g{constructor(n){super(n),this.type="path",this.path=[]}commitVersionProperties(){this.commitProperty("path")}};i([h({type:[[[Number]]],json:{write:!0}})],f.prototype,"path",void 0),f=i([u("esri.views.layers.support.Path")],f);const v=S.ofType({key:"type",base:null,typeMap:{rect:d,path:f,geometry:m}}),E=new(S.ofType(w)),Y=n=>{const c=n;let s=class extends c{constructor(){super(...arguments),this._highlightCounter=new _,this.attached=!1,this.clips=new v,this.highlights=null,this.lastUpdateId=-1,this.moving=!1,this.updateRequested=!1,this._visibleAtCurrentScale=!0}initialize(){var o,a,y;const e=((o=this.view)==null?void 0:o.spatialReferenceLocked)??!0;((a=this.view)==null?void 0:a.spatialReference)&&e&&!this.spatialReferenceSupported?this.addResolvingPromise(Promise.reject(new I("layerview:spatial-reference-incompatible","The spatial reference of this layer does not meet the requirements of the view",{layer:this.layer}))):(this.container||(this.container=new M),this.container.fadeTransitionEnabled=!0,this.container.visible=!1,this.container.endTransitions(),this.addHandles([l(()=>this.suspended,t=>{this.container&&(this.container.visible=!t)},p),l(()=>this.updateSuspended,t=>{this.view&&!t&&this.updateRequested&&this.view.requestUpdate()},p),l(()=>{var t;return((t=this.layer)==null?void 0:t.opacity)??1},t=>{this.container&&(this.container.opacity=t)},p),l(()=>this.layer&&"blendMode"in this.layer?this.layer.blendMode:"normal",t=>{this.container&&(this.container.blendMode=t)},p),l(()=>this.layer&&"effect"in this.layer?this.layer.effect:null,t=>{this.container&&(this.container.effect=t)},p),l(()=>this._mergedHighlights.items.map(t=>({name:t.name,options:{fillColor:t.color,haloColor:t.haloColor,fillOpacity:t.fillOpacity,haloOpacity:t.haloOpacity,haloWidth:t.haloWidth,haloBlur:t.haloBlur}})),()=>{this.container.highlightGradient=N(this.container.highlightGradient,this._mergedHighlights.items)},p),l(()=>this._mergedHighlights.items.map(t=>t.name),()=>{this._processHighlight()}),k(()=>this.clips,"change",()=>{this.container&&(this.container.clips=this.clips)},p),l(()=>{var t;return{scale:(t=this.view)==null?void 0:t.scale,scaleRange:this.layer&&"effectiveScaleRange"in this.layer?this.layer.effectiveScaleRange:null}},({scale:t,scaleRange:H})=>{const C=F(H,t);C!==this._visibleAtCurrentScale&&(this._visibleAtCurrentScale=C)},p)],"constructor"),(y=this.view)!=null&&y.whenLayerView?this.view.whenLayerView(this.layer).then(t=>{t===this&&this.processAttach()},()=>{}):this.when().then(()=>{this.processAttach()},()=>{}))}destroy(){this.processDetach(),this.updateRequested=!1}get highlightOptions(){return this._logHighlightOptionsDeprecation(),L(this)}set highlightOptions(e){this._logHighlightOptionsDeprecation(),U(this,e)}_logHighlightOptionsDeprecation(){z(B.getLogger(this),"`LayerView.highlightOptions` is deprecated in favor of View.highlights",{replacement:"View.highlights",version:"4.34",see:"https://arcg.is/inbTa1#highlights",warnOnce:!0})}get hasHighlight(){return this._highlightCounter.size>0}get _mergedHighlights(){if(!this.view)return E;if(!this.highlights)return this.view.highlights;const e=this.view.highlights.clone();for(const r of this.highlights){const o=e.find(a=>a.name===r.name);o&&o.assignFrom(r)}return e}get highlightIds(){return Array.from(this._highlightCounter.objectIds)}get scheduler(){return this.view.scheduler}get spatialReferenceSupported(){var r;const e=(r=this.view)==null?void 0:r.spatialReference;return e==null||this.supportsSpatialReference(e)}get updating(){var e;return this.spatialReferenceSupported&&(!this.attached||!this.suspended&&(this.updateRequested||this.isUpdating())||!!((e=this._updatingHandles)!=null&&e.updating)||this.container.transitioning)}get visibleAtCurrentScale(){return this._visibleAtCurrentScale}processAttach(){this.isResolved()&&!this.attached&&!this.destroyed&&this.spatialReferenceSupported&&(this.attach(),this.attached=!0,this.requestUpdate())}processDetach(){this.attached&&(this.attached=!1,this.removeHandles("attach"),this.detach(),this.updateRequested=!1)}requestUpdate(){this.destroyed||this.updateRequested||(this.updateRequested=!0,this.updateSuspended||this.view.requestUpdate())}processUpdate(e){!this.isFulfilled()||this.isResolved()?(this._set("updateParameters",e),this.updateRequested&&!this.updateSuspended&&(this.updateRequested=!1,this.update(e))):this.updateRequested=!1}hitTest(e,r){return Promise.resolve(null)}supportsSpatialReference(e){return!0}canResume(){var e;if(!this.spatialReferenceSupported)return!1;switch((e=this.layer)==null?void 0:e.type){case"link-chart":case"knowledge-graph-sublayer":case"graphics":break;default:if(D(this.view)&&!this.view.inGeographicLayout)return!1}return!!super.canResume()&&this.visibleAtCurrentScale}getSuspendInfo(){const e=super.getSuspendInfo(),r=!this.spatialReferenceSupported;return r&&(e.spatialReferenceNotSupported=r),e}addAttachHandles(e){this.addHandles(e,"attach")}_addHighlights(e,r){this._highlightCounter.add(e,r)&&this._processHighlight()}_removeHighlights(e,r){this._highlightCounter.delete(e,r)&&this._processHighlight()}_processHighlight(){}_getHighlights(){const e=[];for(const[r,o]of this._highlightCounter.highlightNamesByObjectId){const a=this._getHighlightBits(o);e.push({objectId:r,highlightFlags:a})}return e}_getHighlightBits(e){const r=new Set(e);let o=1,a=0;if(!this.view)return 0;const y=this._mergedHighlights;for(const{name:t}of y)r.delete(t)&&(a=o),o<<=1;return a}};return i([h()],s.prototype,"attached",void 0),i([h({type:v,set(e){const r=x(e,this._get("clips"),v);this._set("clips",r)}})],s.prototype,"clips",void 0),i([h()],s.prototype,"container",void 0),i([h({type:w})],s.prototype,"highlightOptions",null),i([h({type:S.ofType(w)})],s.prototype,"highlights",void 0),i([h()],s.prototype,"_mergedHighlights",null),i([h()],s.prototype,"moving",void 0),i([h({readOnly:!0})],s.prototype,"spatialReferenceSupported",null),i([h({readOnly:!0})],s.prototype,"updateParameters",void 0),i([h()],s.prototype,"updateRequested",void 0),i([h()],s.prototype,"updating",null),i([h()],s.prototype,"view",void 0),i([h()],s.prototype,"_visibleAtCurrentScale",void 0),i([h({readOnly:!0})],s.prototype,"visibleAtCurrentScale",null),s=i([u("esri.views.2d.layers.LayerView2D")],s),s};export{Y as b,m as n};
