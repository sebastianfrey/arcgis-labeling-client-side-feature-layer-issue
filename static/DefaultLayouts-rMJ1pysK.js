const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./ImageMaterial.glsl-DfkX5TuI.js","./index-C_bK48d2.js","./index-DxLSJ8yk.css","./colorUtils-CLNuAJnC.js","./elevationInfoUtils-C7MilKvD.js","./vectorStacks-CpRnv_41.js","./quatf64-aQ5IuZRd.js","./SketchViewModel-BpdG2zzZ.js","./GraphicsLayer-CFgfYbpT.js","./hitTestSelectUtils-xrNddzEE.js","./projectVectorToVector-IRvjF_FZ.js","./projectPointToVector-oWOZnQKe.js","./geodesicUtils-CTZo9mb6.js","./plane-CYaN818s.js","./sphere-Dx28BAGo.js","./ray-DFDOQn-4.js","./quantity-wpyqwS5w.js","./spatialReferenceEllipsoidUtils-DtI6yob-.js","./geodeticLengthOperator-BhsSOjnG.js","./geodeticCurveType-CirnHLSB.js","./earcut-Lltz9D9k.js","./triangle-Bs-n1Sd1.js","./geodeticAreaOperator-D2z_GCTf.js","./SegmentLabels-Bq17BHQb.js","./quantityFormatUtils-BygWVGS0.js","./unitFormatUtils-Ckw47jIR.js","./getDefaultUnitForView-DghHjrRa.js","./frustum-BtvbAxAw.js","./RibbonLine.glsl-mNksHmZY.js","./orientedBoundingBox-QSEKbinM.js","./quat-BPAPKRxq.js","./computeTranslationToOriginAndRotation-BdfVN0tn.js","./OutputColorHighlightOLID.glsl-sxs6Kjna.js","./Indices-BnCWM-r-.js","./BufferView-CruTDoyp.js","./VertexAttributeLocations-BSIMTgtd.js","./VertexElementDescriptor-2_ON7b9t.js","./renderState-CtcAbezy.js","./glsl-B5bJgrnA.js","./Octree-Dmg0kHEk.js","./InterleavedLayout-DFvKIHDS.js","./types-BKo2foNY.js","./HUDMaterial.glsl-p70B5G9C.js","./meshVertexSpaceUtils-CDdm4woH.js","./MeshLocalVertexSpace-D2aWm81U.js","./hydratedFeatures-dJZG-d3P.js","./vec3f32-WCVSSNPR.js","./ShaderBuilder-DMt-f1fI.js","./VertexBuffer-CJAj1yU0.js","./BufferObject--KeRTd-9.js","./sdfPrimitives-DLG4KC99.js","./ManagedTexture-B9Ayb5dV.js","./videoUtils-DSNBJ20F.js","./image-CVbVCSUp.js","./SnappingContext-DX_opi8j.js","./PointSnappingHint-b5UNALvh.js","./rotate-CT4vtfG5.js","./MeshTransform-auT0YL_N.js","./axisAngleDegrees-DpGZEdI4.js","./angularMeasurementUtils-CjfVhRr8.js","./GraphicManipulator-Bi7jhnCD.js","./drapedUtils-lizrtG85.js","./SelectedVertexTooltipInfo-CEuzVg6_.js","./editPlaneUtils-3MbDrFCi.js","./createUtils-BtrZ1zkK.js","./distanceOperator-Dulc5dHh.js","./Point2D-CHGoJJR2.js","./Distance2DCalculator-CXhBP-8I-BUsGD9ex.js","./ProjectionTransformation-yTMc8p-1.js","./Envelope2D-K-BIX8ba.js","./Transformation2D-CsY48lRi.js","./SimpleGeometryCursor-B92kdZ15.js","./OperatorDefinitions-DP7_WWTp.js","./apiConverter-CdLHvLkb.js","./jsonConverter-E47-BQ_b.js","./simplifyOperator-DCwRzIwh.js","./operatorSimplify-CaWHRVp7.js","./ReactiveSet-Dh87lN3P.js","./boundedPlane-C07RSIqX.js","./TranslateTooltipInfo-DKuO2aLZ.js","./utils-B2fTWpox.js","./cimSymbolUtils-kUrI6vhQ.js","./ExtentScaleTooltipInfo-Bg4VkwYW.js"])))=>i.map(i=>d[i]);
import{p_ as bs,jL as Qt,kN as ws,uB as $s,kF as q,uC as Cs,i0 as f,du as qe,bq as Ts,uD as wt,oz as Ss,j$ as ve,b5 as Xt,db as Os,aJ as c,aL as S,_ as U,uE as Ps,aK as v,ap as ae,fx as at,cT as _t,fj as ft,ke as Fs,cN as Rs,fk as Yt,aF as Ds,c2 as xe,bb as ye,cD as Xe,b3 as be,eF as Zt,gw as Ms,j9 as Ye,pQ as $t,ja as he,bE as Vs,gn as Is,bH as E,fO as qs,fN as zs,jn as Ls,b9 as I,dR as js,i$ as mt,aq as Es,k9 as Te,br as Ct,aN as As,pP as Tt,jl as Hs,jc as Ws,gu as Jt,jd as nt,b8 as Gs,gp as Kt,uF as Bs,pW as Ns,gs as Us,mY as H,mX as ne,mZ as de,jZ as St,hZ as oe,pa as $,uG as ks,mW as Ot,m0 as Qs,bF as Xs,fB as Ys,gc as Zs,fz as Pt,f3 as Js,eQ as Ks,uH as er,nz as ge,oP as tr,uI as Se,uJ as sr,uK as Ft,uL as rr,ji as ir,jo as ar,jb as nr,q0 as or,fP as hr,jJ as Rt}from"./index-C_bK48d2.js";import{m as lr,n as cr,a as es,c as we,o as vt,b as ze,d as ur,i as ts,f as Ge,g as ss,r as rs,l as is,j as k,k as Be,p as Q,q as dr,s as gr,A as Ze,u as Ne,_ as Je,v as pr,w as F,x as _r,y as fr,t as Ke,z as mr,B as vr,C as xr,D as yr,E as br,F as wr,G as $r,H as Cr,P as Tr,I as Sr,J as Or,K as Pr,L as Fr,M as as,N as Rr,O as Dr,Q as Mr,R as Vr,S as Ir,U as qr,V as zr,W as Lr,X as jr,Y as Er,Z as et,$ as Dt,a0 as Ar,a1 as Hr,a2 as Wr,a3 as Gr,a4 as Br}from"./OutputColorHighlightOLID.glsl-sxs6Kjna.js";import{c as Nr}from"./Indices-BnCWM-r-.js";import{t as V}from"./orientedBoundingBox-QSEKbinM.js";import{E as Ur,T as kr}from"./sphere-Dx28BAGo.js";import{m as Qr}from"./plane-CYaN818s.js";import{Q as X,t as Xr}from"./InterleavedLayout-DFvKIHDS.js";import{t as z}from"./glsl-B5bJgrnA.js";import{s as Y}from"./ShaderBuilder-DMt-f1fI.js";import{T as B,r as ns,d as N,_ as Yr}from"./renderState-CtcAbezy.js";import{f as os}from"./triangulationUtils-XRKprkBw.js";import{t as Zr,f as Jr,l as Kr}from"./RibbonLine.glsl-mNksHmZY.js";import{r as xt}from"./VertexAttributeLocations-BSIMTgtd.js";import{h as ei}from"./VertexArrayObject-DXnl-4Rl.js";import{o as ti}from"./BufferObject--KeRTd-9.js";import{r as si}from"./VertexBuffer-CJAj1yU0.js";import{t as ri}from"./NestedMap-DI2--xdt.js";import{c as le,u as ii,h as J,l as Oe}from"./BufferView-CruTDoyp.js";import{j as ai,q as Mt,w as Vt}from"./axisAngleDegrees-DpGZEdI4.js";import{n as ni}from"./ManagedTexture-B9Ayb5dV.js";import{i as hs}from"./TextureBackedBufferLayout-Bu_3CpJU.js";function Na(t,e,s=null){const r=[],i=e.mapPositions,a=oi(e,r),n=a.data,o=a.indices.length,l=Nr(o);return hi(e,r,l),ui(e,r,l),li(e,r,l),ci(e,r,a.indices,l),di(e,r,a.indices,l),gi(e,r),pi(e,r,a.indices,l),_i(e,r,n),new lr(t,r,i,2,s)}function oi(t,e){const{attributeData:{position:s},removeDuplicateStartEnd:r}=t,i=fi(s)&&r,a=s.length/3-(i?1:0),n=new Array(2*(a-1)),o=i?s.slice(0,-3):s;let l=0;for(let u=0;u<a-1;u++)n[l++]=u,n[l++]=u+1;const g=new V(o,n,3,i);return e.push(["position",g]),g}function hi(t,e,s){if(t.attributeData.colorFeature!=null)return;const r=t.attributeData.color;e.push(["color",new V(r??bs,s,4)])}function li(t,e,s){t.attributeData.normal&&e.push(["normal",new V(t.attributeData.normal,s,3)])}function ci(t,e,s,r){const i=t.attributeData.colorFeature;i!=null&&(typeof i=="number"?e.push(["colorFeatureAttribute",new V([i],r,1,!0)]):e.push(["colorFeatureAttribute",new V(i,s,1,!0)]))}function ui(t,e,s){t.attributeData.sizeFeature==null&&e.push(["size",new V([t.attributeData.size??1],s,1,!0)])}function di(t,e,s,r){const i=t.attributeData.sizeFeature;i!=null&&(typeof i=="number"?e.push(["sizeFeatureAttribute",new V([i],r,1,!0)]):e.push(["sizeFeatureAttribute",new V(i,s,1,!0)]))}function gi(t,e){const{attributeData:{position:s,timeStamps:r}}=t;if(!r)return;const i=s.length/3,a=new Array(2*(i-1));let n=0;for(let o=0;o<i-1;o++)a[n++]=o,a[n++]=o+1;e.push(["timeStamps",new V(r,a,xi,!0)])}function pi(t,e,s,r){const i=t.attributeData.opacityFeature;i!=null&&(typeof i=="number"?e.push(["opacityFeatureAttribute",new V([i],r,1,!0)]):e.push(["opacityFeatureAttribute",new V(i,s,1,!0)]))}function _i(t,e,s){if(t.overlayInfo==null||t.overlayInfo.renderCoordsHelper.viewingMode!==1||!t.overlayInfo.spatialReference.isGeographic)return;const r=Qt(s.length),i=ws(t.overlayInfo.spatialReference);for(let p=0;p<r.length;p+=3)$s(s,p,r,p,i);const a=s.length/3,n=cr(a+1);let o=mi,l=vi,g=0,u=0;q(o,r[u++],r[u++]),u++,n[0]=0;for(let p=1;p<a+1;++p)p===a&&(u=0),q(l,r[u++],r[u++]),u++,g+=Cs(o,l),n[p]=g,[o,l]=[l,o];e.push(["distanceToStart",new V(n,e[0][1].indices,1,!0)])}function fi(t){const e=t.length;return t[0]===t[e-3]&&t[1]===t[e-2]&&t[2]===t[e-1]}const mi=f(),vi=f(),xi=4;let yi=class extends ei{},It=class{constructor(){this._extent=qe(),this.resolution=0,this.renderLocalOrigin=Zr(0,0,0,"O"),this.pixelRatio=1,this.mapUnitsPerPixel=1,this.canvasGeometries=new bi}get extent(){return this._extent}setExtent(e){Ts(this._extent,e)}setupGeometryViews(e){if(this._setupGeometryView(),!e)return;const s=.001*e.range;if(this._extent[0]-s<=e.min){const r=this.canvasGeometries.extents[this.canvasGeometries.numViews++];wt(this._extent,e.range,0,r)}if(this._extent[2]+s>=e.max){const r=this.canvasGeometries.extents[this.canvasGeometries.numViews++];wt(this._extent,-e.range,0,r)}}_setupGeometryView(){this.canvasGeometries.numViews=1,Ss(this.canvasGeometries.extents[0],this._extent)}hasSomeSizedView(){for(let e=0;e<this.canvasGeometries.numViews;e++){const s=this.canvasGeometries.extents[e];if(s[0]!==s[2]&&s[1]!==s[3])return!0}return!1}},bi=class{constructor(){this.extents=[qe(),qe(),qe()],this.numViews=0}},wi=class{constructor(e,s,r){this._fbos=e,this._format=s,this._name=r}get valid(){var e;return((e=this._handle)==null?void 0:e.getTexture())!=null}dispose(){this._handle=ve(this._handle)}get texture(){var e;return(e=this._handle)==null?void 0:e.getTexture()}ensureFramebuffer(e,s){var r,i,a;this._handle&&((r=this._handle.fbo)==null?void 0:r.width)===e&&((i=this._handle.fbo)==null?void 0:i.height)===s||((a=this._handle)==null||a.release(),this._handle=this._fbos.acquire(e,s,this._name,this._format))}bind(e){var s;e.bindFramebuffer((s=this._handle)==null?void 0:s.fbo)}generateMipMap(){var e,s,r,i,a;(r=(s=(e=this._handle)==null?void 0:e.getTexture())==null?void 0:s.descriptor)!=null&&r.hasMipmap&&((a=(i=this._handle)==null?void 0:i.getTexture())==null||a.generateMipmap())}},K=class{constructor(e,s,r,i,a=1,n=6){this.output=r,this.content=i,this.redrawOnRequest=a,this.fbo=new wi(e,n,s)}handleRenderRequest(e){return e===1||e===this.redrawOnRequest}get valid(){return this.fbo.valid}},$i=class{constructor(e){this.targets=[new K(e,"overlay color",0,0),new K(e,"overlay IM color",0,1),new K(e,"overlay highlight",8,2,1,3),new K(e,"overlay water",2,3,0),new K(e,"overlay occluded",0,4)],es()&&this.targets.push(new K(e,"overlay olid",9,5,1,5))}getTexture(e){var s;return(s=this.targets[e])==null?void 0:s.fbo.texture}dispose(e){if(e!==0)for(const s of this.targets)s.fbo.dispose();else this.targets[3].fbo.dispose()}computeValidity(){return this.targets.reduce((e,s,r)=>s.valid?e|=1<<r:e,0)}},ls=class extends we{constructor(){super(...arguments),this.color=Xt(1,1,1)}};function Ci(){const t=new Y;return t.include(vt),t.fragment.uniforms.add(new ze("tex",e=>e.texture),new ur("uColor",e=>e.color)),t.fragment.main.add(z`vec4 texColor = texture(tex, uv);
fragColor = texColor * vec4(uColor, 1.0);`),t}const Ti=Object.freeze(Object.defineProperty({__proto__:null,TextureOnlyPassParameters:ls,build:Ci},Symbol.toStringTag,{value:"Module"})),Si={required:[]};let cs=class extends Os{precompile(e){return!!this.acquireTechniques(e)}consumes(){return Si}get usedMemory(){return 0}get renderOccludedFlags(){return 1}get isDecoration(){return!1}get readyToRun(){return!1}get numGeometries(){return 0}get hasOccludees(){return!1}get hasEmitters(){return!1}forEachGeometry(e){}},Oi=class extends cs{},tn=class extends cs{},qt=class extends ts{constructor(e,s){super(e,"ivec2",1,(r,i,a)=>r.setUniform2iv(e,s(i,a)))}},Ue=class extends ts{constructor(e,s){super(e,"usampler2D",1,(r,i,a)=>r.bindTexture(e,s(i,a)))}},us=class extends we{};function Pi(){const t=new Y,{outputs:e,fragment:s}=t;return t.include(vt),s.uniforms.add(new Ue("highlightTexture",r=>r.highlightTexture)),s.constants.add("outlineWidth","int",Math.ceil(Le)),s.constants.add("cellSize","int",G),e.add("fragGrid","uvec2"),s.main.add(z`ivec2 inputTextureSize = textureSize(highlightTexture, 0);
ivec2 cellBottomLeftCornerInput = ivec2(ivec2(floor(gl_FragCoord.xy) * vec2(cellSize)));
ivec2 coordMid =  cellBottomLeftCornerInput + ivec2(cellSize >> 1);
uvec2 centreTexel = texelFetch(highlightTexture, coordMid, 0).rg & uvec2(0x55u);
float marginSquare = float(outlineWidth*outlineWidth);
uvec2 outputValue = centreTexel & uvec2(0x55u);
for(int y = -outlineWidth; y <= cellSize + outlineWidth; y+=2) {
int dy = y < 0 ? -y : y > cellSize ? y-cellSize : 0;
int xMargin = dy > 0 ? int(ceil(sqrt(marginSquare - float(dy*dy)))) : outlineWidth;
for(int x = -xMargin; x <= cellSize + xMargin; x+=2) {
ivec2 coord = cellBottomLeftCornerInput + ivec2(x, y);
uvec2[4] texels = uvec2[4] (
texelFetch(highlightTexture,coord+ivec2(0,0),0).rg & uvec2(0x55u),
texelFetch(highlightTexture,coord+ivec2(1,0),0).rg & uvec2(0x55u),
texelFetch(highlightTexture,coord+ivec2(0,1),0).rg & uvec2(0x55u),
texelFetch(highlightTexture,coord+ivec2(1,1),0).rg & uvec2(0x55u)
);
if (texels[0] == texels[1] && texels[1] == texels[2] && texels[2] == texels[3] && texels[3] ==  centreTexel) {
continue;
}
for (int i=0; i<4; ++i){
outputValue |= ((texels[i] ^ centreTexel) << 1);
outputValue |= texels[i];
}
}
}
fragGrid = outputValue;`),t}const G=32,Le=9,ds=.4,Fi=Object.freeze(Object.defineProperty({__proto__:null,HighlightDownsampleDrawParameters:us,blurSize:ds,build:Pi,gridCellPixelSize:G,outlineSize:Le},Symbol.toStringTag,{value:"Module"}));function yt(t){const{vertex:e}=t;e.uniforms.add(new Ue("coverageTexture",s=>s.coverageTexture),new qt("highlightRenderCellCount",s=>q(zt,s.horizontalCellCount,s.verticalCellCount)),new qt("highlightTextureResolution",({highlightTexture:s})=>q(zt,s.descriptor.width,s.descriptor.height)),new Ge("highlightLevel",s=>s.highlightLevel)).constants.add("cellSize","int",G),t.varyings.add("sUV","vec2"),t.varyings.add("vOutlinePossible","float"),e.code.add(z`const ivec2 cellVertices[4] = ivec2[4](ivec2(0,0), ivec2(1,0), ivec2(0,1), ivec2(1,1));`),e.main.add(z`int cellIndex = gl_InstanceID;
int cellX = cellIndex % highlightRenderCellCount[0];
int cellY = (cellIndex - cellX) / highlightRenderCellCount[0];
ivec2 cellPos = ivec2(cellX, cellY);
uvec2 covTexel = texelFetch(coverageTexture, cellPos, 0).rg;
int channelIndex = (highlightLevel >> 2) & 3;
uint channelValue = covTexel[channelIndex];
int highlightIndex = (highlightLevel & 3) << 1;
bool covered = ((channelValue >> highlightIndex) & 1u) == 1u;
if (!covered) {
gl_Position = vec4(0.0);
return;
}
vOutlinePossible = (((channelValue >> highlightIndex) & 2u) == 2u) ? 1.0 : 0.0;
ivec2 iPosInCell = cellVertices[gl_VertexID];
vec2 sPos = vec2(cellPos * cellSize + iPosInCell * (cellSize));
vec2 vPos = sPos / vec2(highlightTextureResolution);
sUV = vPos;
gl_Position = vec4(2.0 * vPos - vec2(1.0), 0.0, 1.0);`)}const zt=f();function Ri(){const t=new Y;t.include(yt);const{fragment:e}=t;return e.uniforms.add(new ze("blurInput",s=>s.highlightBlurTexture),new ss("blurSize",s=>s.blurSize),new Ue("highlightTexture",s=>s.highlightTexture),new ze("highlightOptionsTexture",s=>s.highlightOptionsTexture),new Ge("highlightLevel",s=>s.highlightLevel),new rs("occludedIntensityFactor",s=>s.occludedFactor)),e.constants.add("inner","float",1-(Le-ds)/Le),t.include(is),e.main.add(z`vec2 highlightTextureSize = vec2(textureSize(highlightTexture,0));
vec2 uv = sUV;
vec2 center = texture(blurInput, uv).rg;
vec2 blurredHighlightValue = (vOutlinePossible == 0.0)
? center
: center * 0.204164
+ texture(blurInput, uv + blurSize * 1.407333).rg * 0.304005
+ texture(blurInput, uv - blurSize * 1.407333).rg * 0.304005
+ texture(blurInput, uv + blurSize * 3.294215).rg * 0.093913
+ texture(blurInput, uv - blurSize * 3.294215).rg * 0.093913;
float highlightIntensity = blurredHighlightValue.r;
float occlusionWeight = blurredHighlightValue.g;
if (highlightIntensity <= 0.01) {
discard;
}
vec4 fillColor    = texelFetch(highlightOptionsTexture, ivec2(highlightLevel, 0), 0);
vec4 outlineColor = texelFetch(highlightOptionsTexture, ivec2(highlightLevel, 1), 0);
uvec2 centerTexel = texelFetch(highlightTexture, ivec2(uv * highlightTextureSize), 0).rg;
uint centerBits = readLevelBits(centerTexel, highlightLevel);
bool centerFilled = (centerBits & 1u) == 1u;
bool centerOccluded = (centerBits & 3u) == 3u;
bool occluded = centerOccluded || (0.5 * highlightIntensity < occlusionWeight);
float occlusionFactor = occluded ? occludedIntensityFactor : 1.0;
float outlineFactor = centerFilled ? 1.0 : smoothstep(0.0, inner, highlightIntensity);
float fillFactor = centerFilled ? 1.0 : 0.0;
vec4 baseColor = mix(outlineColor, fillColor, fillFactor);
float intensity = baseColor.a * occlusionFactor * outlineFactor;
fragColor = vec4(baseColor.rgb, intensity);`),t}const Di=Object.freeze(Object.defineProperty({__proto__:null,build:Ri},Symbol.toStringTag,{value:"Module"}));let je=class extends k{constructor(e,s){super(e,s,xt(Be)),this.shader=new Q(Di,()=>U(()=>import("./ImageMaterial.glsl-DfkX5TuI.js").then(r=>r.H),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82]),import.meta.url))}initializePipeline(){return B({blending:ns,colorWrite:N})}};je=c([S("esri.views.3d.webgl-engine.effects.highlight.HighlightApplyTechnique")],je);let gs=class extends we{constructor(){super(...arguments),this.blurSize=f()}};function Mi(){const t=new Y;return t.include(yt),t.outputs.add("fragHighlight","vec2",0),t.fragment.uniforms.add(new ss("blurSize",e=>e.blurSize),new dr("blurInput",e=>e.blurInput)).main.add(z`vec2 highlightTextureSize = vec2(textureSize(blurInput,0));
vec2 center = texture(blurInput, sUV).rg;
if (vOutlinePossible == 0.0) {
fragHighlight = center;
} else {
vec2 sum = center * 0.204164;
sum += texture(blurInput, sUV + blurSize * 1.407333).rg * 0.304005;
sum += texture(blurInput, sUV - blurSize * 1.407333).rg * 0.304005;
sum += texture(blurInput, sUV + blurSize * 3.294215).rg * 0.093913;
sum += texture(blurInput, sUV - blurSize * 3.294215).rg * 0.093913;
fragHighlight = sum;
}`),t}const Vi=Object.freeze(Object.defineProperty({__proto__:null,HighlightBlurDrawParameters:gs,build:Mi},Symbol.toStringTag,{value:"Module"}));let Ee=class extends k{constructor(e,s){super(e,s,xt(Be)),this.shader=new Q(Vi,()=>U(()=>import("./ImageMaterial.glsl-DfkX5TuI.js").then(r=>r.a),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82]),import.meta.url))}initializePipeline(){return B({colorWrite:N})}};Ee=c([S("esri.views.3d.webgl-engine.effects.highlight.HighlightBlurTechnique")],Ee);let me=class extends k{constructor(){super(...arguments),this.shader=new Q(Fi,()=>U(()=>import("./ImageMaterial.glsl-DfkX5TuI.js").then(e=>e.b),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82]),import.meta.url))}initializePipeline(){return B({colorWrite:N})}};me=c([S("esri.views.3d.webgl-engine.effects.highlight.HighlightDownsampleTechnique")],me);class Ii extends we{constructor(){super(...arguments),this.occludedFactor=Ps,this.verticalCellCount=0,this.horizontalCellCount=0,this.highlightLevel=0,this.pixelRatio=1}}function qi(){const t=new Y;t.include(yt),t.include(is);const{fragment:e}=t;return t.outputs.add("fragSingleHighlight","vec2",0),e.uniforms.add(new Ue("highlightTexture",s=>s.highlightTexture),new Ge("highlightLevel",s=>s.highlightLevel)),e.main.add(z`ivec2 iuv = ivec2(gl_FragCoord.xy);
uvec2 inputTexel = texelFetch(highlightTexture, iuv, 0).rg;
uint bits = readLevelBits(inputTexel, highlightLevel);
bool hasHighlight = (bits & 1u) == 1u;
bool hasOccluded  = (bits & 2u) == 2u;
fragSingleHighlight = vec2(hasHighlight ? 1.0 : 0.0, hasOccluded ? 1.0 : 0.0);`),t}const zi=Object.freeze(Object.defineProperty({__proto__:null,build:qi},Symbol.toStringTag,{value:"Module"}));let Ae=class extends k{constructor(e,s){super(e,s,xt(Be)),this.shader=new Q(zi,()=>U(()=>import("./ImageMaterial.glsl-DfkX5TuI.js").then(r=>r.c),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82]),import.meta.url))}initializePipeline(){return B({colorWrite:N})}};Ae=c([S("esri.views.3d.webgl-engine.effects.highlight.HighlightToSingleTechnique")],Ae);let Pe=class extends gr{constructor(){super(...arguments),this.produces=Ze.HIGHLIGHTS,this.consumes={required:[Ze.HIGHLIGHTS,"highlights"]},this._downsampleDrawParameters=new us,this._passParameters=new Ii,this._highlightBlurDrawParameters=new gs,this._grid=new Li}initialize(){this.addHandles([ae(()=>this._updateOptionsTexture(),()=>{},at)])}destroy(){this._grid.coverage=ve(this._grid.coverage),this._grid.vao=_t(this._grid.vao),this._passParameters.highlightOptionsTexture=ve(this._passParameters.highlightOptionsTexture)}_updateOptionsTexture(){if(this._passParameters.highlightOptionsTexture==null){const t=new Yt(16,2);t.internalFormat=6408,t.samplingMode=9728,this._passParameters.highlightOptionsTexture=new ft(this.renderingContext,t,null)}this._passParameters.highlightOptionsTexture.setData(ji(this.view.state.highlights)),this.requestRender(1)}precompile(){this.techniques.precompile(me),this.techniques.precompile(Ae),this.techniques.precompile(Ee),this.techniques.precompile(je)}render(t){const e=t.find(({name:a})=>a===Ze.HIGHLIGHTS),{techniques:s,bindParameters:r}=this;if(!r.decorations)return e;if(!s.get(me).compiled)return this.requestRender(1),e;const i=t.find(({name:a})=>a==="highlights").getTexture();return this._renderHighlightPostprocess(i,e),e}_prepareAndDownSample(t){var n;this._gridUpdateResources(t);const e=this.techniques.get(me),s=this._gridComputeCoverage(e,t),{horizontalCellCount:r,verticalCellCount:i}=s,a=this._passParameters;return a.horizontalCellCount=r,a.verticalCellCount=i,a.coverageTexture=(n=s.coverage)==null?void 0:n.getTexture(),s}_renderGrid(t){const e=t.verticalCellCount*t.horizontalCellCount;this.renderingContext.bindVAO(t.vao),this.renderingContext.drawElementsInstanced(Fs.TRIANGLES,6,Rs.UNSIGNED_BYTE,0,e)}_renderHighlightPostprocess(t,e){var bt;const{fboCache:s,techniques:r,bindParameters:i,_passParameters:a,renderingContext:n}=this,o=r.get(Ae),l=r.get(Ee),g=r.get(je);if(!g.compiled||!l.compiled||!o.compiled)return void this.requestRender(1);a.highlightTexture=t;const u=this._prepareAndDownSample(t),{width:p,height:y}=t.descriptor;a.highlightTexture=t;const{camera:_}=i,{fullWidth:b,fullHeight:D,pixelRatio:Z,fullViewport:ke}=_,ce=Math.ceil(b/Z),ue=Math.ceil(D/Z),{_highlightBlurDrawParameters:A}=this,m=this.view.stage.renderView.renderer,{highlights:C}=i;for(let $e=0;$e<C.length;++$e){const{name:ys}=C[$e];if(!m.hasHighlight(ys))continue;a.highlightLevel=$e,n.setClearColor(0,0,0,0);const Qe=s.acquire(p,y,"single highlight",2);n.bindFramebuffer(Qe.fbo),n.setViewport(0,0,p,y),n.clear(16384),n.bindTechnique(o,i,a),this._renderGrid(u),A.blurInput=Qe.getTexture(),q(A.blurSize,1/ce,0);const Ce=s.acquire(ce,ue,"single highlight blur",2);n.unbindTexture((bt=Ce.fbo)==null?void 0:bt.colorTexture),n.bindFramebuffer(Ce.fbo),n.setViewport(0,0,ce,ue),n.clear(16384),n.bindTechnique(l,i,a,A),this._renderGrid(u),Qe.release(),q(A.blurSize,0,1/ue),a.highlightBlurTexture=Ce.getTexture(),n.bindFramebuffer(e.fbo),n.setViewport4fv(ke),n.bindTechnique(g,i,a,A),this._renderGrid(u),Ce.release()}a.coverageTexture=a.highlightTexture=null}_gridUpdateResources(t){const e=this._grid,{width:s,height:r}=t.descriptor;if(e.horizontalCellCount=Math.ceil(s/G),e.verticalCellCount=Math.ceil(r/G),e.vao)return;const i=this.renderingContext,a=ti.createIndex(i,35044,Hi);e.vao=new yi(i,new si(i,Be),a)}_gridComputeCoverage(t,e){var g;const s=this.renderingContext,r=this._grid,i=e.descriptor,a=Math.ceil(i.width/G),n=Math.ceil(i.height/G);this._downsampleDrawParameters.input=e;const{highlights:o}=this.bindParameters;(g=r.coverage)==null||g.release();const l=this.fboCache.acquire(a,n,"highlight coverage",o.length>ps?3:1);return r.coverage=l,s.bindFramebuffer(l.fbo),s.bindTechnique(t,this.bindParameters,this._passParameters,this._downsampleDrawParameters),s.setViewport(0,0,a,n),s.screen.draw(),r}get test(){}};c([v()],Pe.prototype,"produces",void 0),c([v()],Pe.prototype,"consumes",void 0),Pe=c([S("esri.views.3d.webgl-engine.effects.highlight.Highlight")],Pe);let Li=class{constructor(){this.coverage=null,this.vao=null,this.verticalCellCount=0,this.horizontalCellCount=0,this.viewportWidth=0,this.viewportHeight=0}};function ji(t){const e=new Uint8Array(128);let s=0;for(const r of t){const i=4*s,a=4*s+64;++s;const{color:n}=r,o=r.haloColor??n;e[i+0]=n.r,e[i+1]=n.g,e[i+2]=n.b,e[i+3]=r.fillOpacity*n.a*255,e[a+0]=o.r,e[a+1]=o.g,e[a+2]=o.b,e[a+3]=r.haloOpacity*o.a*255}return e}let Ei=0;function Ai(t){let e=0;for(const r of t){const{name:i}=r;e+=i.length;const{color:a,fillOpacity:n,haloColor:o,haloOpacity:l}=r;e+=a.r+a.g+a.b+a.a+n,e+=o?o.r+o.g+o.b+o.a+l:0}const s=t.at(0);if(s){const{shadowOpacity:r,shadowDifference:i,shadowColor:a}=s;e+=r+i+a.r+a.g+a.b+a.a}return Ei+++(e>=0?0:1)}const Hi=new Uint8Array([0,1,2,2,1,3]);function Wi(t,e,s,r,i,a=0){const{highlights:n}=r,o=n.length>1?e.acquire(s.width,s.height,"highlight mix",n.length>ps?3:1):null,{gl:l}=t;if(o){const u=t.getBoundFramebufferObject();t.bindFramebuffer(o.fbo),l.clearBufferuiv(l.COLOR,0,[0,0,0,0]),t.bindFramebuffer(u)}const g=o==null?void 0:o.getTexture();r.highlightMixTexture=g,q(r.highlightMixOrigin,a,0),n.forEach((u,p)=>{if(p>0){const y=ft.TEXTURE_UNIT_FOR_UPDATES;t.bindTexture(g,y),t.setActiveTexture(y),l.copyTexSubImage2D(3553,0,0,0,a,0,s.width,s.height),t.bindTexture(null,y)}t.clear(256),r.highlightLevel=p,i()}),r.highlightLevel=null,r.highlightMixTexture=null,o==null||o.release()}const ps=4;let Gi=class{constructor(e,s,r,i){this.material=e,this.output=s,this.techniques=r,this.textures=i}};class Bi{constructor(e,s,r,i){this._textures=e,this._techniques=s,this.materialChanged=r,this.requestRender=i,this._id2glMaterialRef=new ri}dispose(){this._textures.destroy()}acquire(e,s,r){this._ownMaterial(e);const i=e.produces.get(s);if(!(i!=null&&i(r)))return null;let a=this._id2glMaterialRef.get(r,e.id);if(a==null){const n=e.createGLMaterial(new Gi(e,r,this._techniques,this._textures));a=new Ni(n),this._id2glMaterialRef.set(r,e.id,a)}return a.ref(),a.glMaterial}release(e,s){const r=this._id2glMaterialRef.get(s,e.id);r!=null&&(r.unref(),r.referenced||(_t(r.glMaterial),this._id2glMaterialRef.delete(s,e.id)))}_ownMaterial(e){e.repository&&e.repository!==this&&Ds.getLogger("esri.views.3d.webgl-engine.lib.GLMaterialRepository").error("Material is already owned by a different material repository"),e.repository=this}}let Ni=class{constructor(e){this.glMaterial=e,this._refCnt=0}ref(){++this._refCnt}unref(){--this._refCnt,le(this._refCnt>=0)}get referenced(){return this._refCnt>0}};function Ui(t){return t!=null&&!t.readyToRun}var ot;let Fe=ot=class extends ye{constructor(t){super(t),this.type="cloudy",this.cloudCover=.5}clone(){return new ot({cloudCover:this.cloudCover})}};c([xe({cloudy:"cloudy"}),v({json:{write:{isRequired:!0}}})],Fe.prototype,"type",void 0),c([v({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],Fe.prototype,"cloudCover",void 0),Fe=ot=c([S("esri.views.3d.environment.CloudyWeather")],Fe);var ht;let Re=ht=class extends ye{constructor(t){super(t),this.type="foggy",this.fogStrength=.5}clone(){return new ht({fogStrength:this.fogStrength})}};c([xe({foggy:"foggy"}),v({json:{write:{isRequired:!0}}})],Re.prototype,"type",void 0),c([v({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],Re.prototype,"fogStrength",void 0),Re=ht=c([S("esri.views.3d.environment.FoggyWeather")],Re);var lt;let pe=lt=class extends ye{constructor(t){super(t),this.type="rainy",this.cloudCover=.5,this.precipitation=.5}clone(){return new lt({cloudCover:this.cloudCover,precipitation:this.precipitation})}};c([xe({rainy:"rainy"}),v({json:{write:{isRequired:!0}}})],pe.prototype,"type",void 0),c([v({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],pe.prototype,"cloudCover",void 0),c([v({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],pe.prototype,"precipitation",void 0),pe=lt=c([S("esri.views.3d.environment.RainyWeather")],pe);var ct;let ee=ct=class extends ye{constructor(t){super(t),this.type="snowy",this.cloudCover=.5,this.precipitation=.5,this.snowCover="disabled"}clone(){return new ct({cloudCover:this.cloudCover,precipitation:this.precipitation,snowCover:this.snowCover})}};c([xe({snowy:"snowy"}),v({json:{write:{isRequired:!0}}})],ee.prototype,"type",void 0),c([v({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],ee.prototype,"cloudCover",void 0),c([v({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],ee.prototype,"precipitation",void 0),c([v({type:["enabled","disabled"],nonNullable:!0,json:{write:!0}})],ee.prototype,"snowCover",void 0),ee=ct=c([S("esri.views.3d.environment.SnowyWeather")],ee);var ut;let De=ut=class extends ye{constructor(t){super(t),this.type="sunny",this.cloudCover=.5}clone(){return new ut({cloudCover:this.cloudCover})}};c([xe({sunny:"sunny"}),v({json:{write:{isRequired:!0}}})],De.prototype,"type",void 0),c([v({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],De.prototype,"cloudCover",void 0),De=ut=c([S("esri.views.3d.environment.SunnyWeather")],De);const Me=1e4,_n=1e5;let ki=class{constructor(){this.startTime=0,this._data=Xe(null),this.coverage=0,this.absorption=0,this._readChannels=0,this.parallax=new Lt,this.parallaxNew=new Lt,this._anchorPoint=be(),this._fadeState=Xe(0),this._fadeFactor=Xe(1)}get data(){return this._data.value}set data(e){this._data.value=e}get readChannels(){return this._readChannels}get fadeState(){return this._fadeState.value}get fadeFactor(){return this._fadeFactor.value}get opacity(){switch(this.fadeState){case 0:return 0;case 4:return 1-this.fadeFactor;case 1:return this.fadeFactor;case 2:case 3:return 1}}fade(e,s,r){this.isFading&&this.fadeFactor<1&&(this._fadeFactor.value=r?Zt((s-this.startTime)/(Xi*r),0,1):1,this.fadeFactor===1&&this._endFade()),this._evaluateState(e,s),this._updateParallax(e)}_evaluateState(e,s){const r=e.relativeElevation,i=this._updateAnchorPoint(e);(r>1.7*Me||r<-Me||i>Et)&&this.opacity>0?this._startFade(0,s):this.isFading||(r>Me||r<-.35*Me||i>Yi*Et?this.opacity>0&&this._startFade(4,s):Ui(this.data)&&(this.opacity===0?this._startFade(1,s):this.data.state===2&&(this.fadeState===2?this._startFade(3,s):this._startFade(2,s))))}_updateParallax(e){const s=Ms(e.eye);this.parallax.radiusCurvatureCorrection=.84*Math.sqrt(Math.max(s-Ye.radius*Ye.radius,0))/Math.sqrt(s),Mt(jt,this.parallax.anchorPoint,te),$t(this.parallax.transform,he,te[3],Vt(te)),Mt(jt,this.parallaxNew.anchorPoint,te),$t(this.parallaxNew.transform,he,te[3],Vt(te))}_updateAnchorPoint(e){var s;return Vs(this._anchorPoint,e.eye),Is(this._anchorPoint,this._anchorPoint,Ye.radius),this.fadeState===0&&((s=this.data)==null?void 0:s.state)===2?(E(this.parallax.anchorPoint,this._anchorPoint),0):qs(zs(Qi,this.parallax.anchorPoint,this._anchorPoint))}requestFade(){this._fadeFactor.value=0}_startFade(e,s){switch(this._fadeState.value=e,this.startTime=s,e){case 3:this.requestFade(),this._switchReadChannels(),E(this.parallaxNew.anchorPoint,this._anchorPoint);break;case 1:this.requestFade(),this._switchReadChannels(),E(this.parallax.anchorPoint,this._anchorPoint),E(this.parallaxNew.anchorPoint,this._anchorPoint);break;case 4:this.requestFade();break;case 2:this._switchReadChannels(),E(this.parallax.anchorPoint,this._anchorPoint),E(this.parallaxNew.anchorPoint,this._anchorPoint),this._endFade();break;case 0:this._endFade()}}_endFade(){switch(this._fadeFactor.value=1,this.data&&this.data.state!==2&&(this.data.state=0),this.fadeState){case 3:E(this.parallax.anchorPoint,this.parallaxNew.anchorPoint),this._fadeState.value=2;break;case 1:this._fadeState.value=2;break;case 4:this._fadeState.value=0;break;case 2:case 0:break;default:Ls(this.fadeState)}}_switchReadChannels(){var e;((e=this.data)==null?void 0:e.state)===2&&(this._readChannels=1-this._readChannels,this.data.state=3)}get isFading(){return this.fadeState===4||this.fadeState===1||this.fadeState===3}},Lt=class{constructor(){this.anchorPoint=be(),this.radiusCurvatureCorrection=0,this.transform=I()}};const jt=Xt(0,0,1),te=ai(),Qi=be(),Xi=1.25,Yi=.5,Et=2e5;let Zi=class{constructor(e){this.shadowMap=e,this.slot=2,this.slicePlane=null,this.hasOccludees=!1,this.hasEmission=!1,this.enableFillLights=!0,this.oitPass=0,this.alignPixelEnabled=!1,this.decorations=!0,this.overlayStretch=1,this.viewshedEnabled=!1,this.cutFillEnabled=!1,this._camera=new Ne,this._inverseViewport=f(),this._oldLighting=new Je,this._newLighting=new Je,this._fadedLighting=new Je,this._lighting=this._newLighting,this.ssr=new Ji,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.highlights=new Array,this.highlightOrderMap=new Map,this.highlightMixOrigin=f(),this.highlightMixTexture=null,this.hudRenderStyle=0,this.hudOccludedFragmentOpacity=1,this.snowCover=0,this.clouds=new ki,this.shadowHighlightsVisible=!1}destroy(){this._camera=null,this.contentCamera=null,this.depth=null,this.geometryDepth=null,this.mainDepth=null,this.overlay=null,this.ssao=null,this.terrainDepth=null}get camera(){return this._camera}set camera(e){this._camera=e,this._inverseViewport[0]=1/e.fullViewport[2],this._inverseViewport[1]=1/e.fullViewport[3]}get enableOffset(){return this.oitPass===1&&this.camera.relativeElevation<pr}get inverseViewport(){return this._inverseViewport}get lighting(){return this._lighting}fadeLighting(){switch(this.clouds.fadeFactor){case 0:this._lighting=this._oldLighting;break;default:this._fadedLighting.lerpLighting(this._oldLighting,this._newLighting,this.clouds.fadeFactor),this._lighting=this._fadedLighting;break;case 1:this._lighting=this._newLighting,this._oldLighting.copyFrom(this._newLighting)}}updateLighting(e,s,r,i){this._oldLighting.copyFrom(this.lighting),this._newLighting.noonFactor=s,this._newLighting.globalFactor=r,this._newLighting.set(e),this._oldLighting.updateLegacy(),i===1&&this.clouds.requestFade(),this.fadeLighting()}get highlight(){return this.highlightLevel==null?null:this.highlights[this.highlightLevel]}get occluder(){return this.slot===11||this.slot===12?this.slot:null}},Ji=class{constructor(){this.fadeFactor=1,this.reprojectionMatrix=I()}};class Ki{constructor(e,s,r){this.rctx=e,this.techniques=r,this.lastFrameCamera=new Ne,this.output=0,this.renderOccludedMask=dt,this.time=js(0),this.bind=new Zi(s),this.bind.alignPixelEnabled=!0}}const dt=13;let fe=class extends Ne{constructor(){super(...arguments),this._projectionMatrix=I()}get projectionMatrix(){return this._projectionMatrix}};c([v()],fe.prototype,"_projectionMatrix",void 0),c([v({readOnly:!0})],fe.prototype,"projectionMatrix",null),fe=c([S("esri.views.3d.webgl-engine.lib.CascadeCamera")],fe);class Ve{constructor(){this.camera=new fe,this.lightMat=I()}}class ea{constructor(){this.maxNumCascadesHighQuality=4,this.maxNumCascadesLowQuality=4,this.textureSizeModHighQuality=1.3,this.textureSizeModLowQuality=.9,this.splitSchemeLambda=0}}let ta=class{constructor(e,s){this._fbos=e,this._viewingMode=s,this._snapshots=new Array,this._textureHeight=0,this._numCascades=1,this.settings=new ea,this._projectionView=I(),this._projectionViewInverse=I(),this._modelViewLight=I(),this._cascadeDistances=[0,0,0,0,0],this._usedCascadeDistances=mt(),this._cascades=[new Ve,new Ve,new Ve,new Ve],this._lastOrigin=null,this._enabled=!1,this._maxTextureWidth=Math.min(Es("esri-mobile")?4096:16384,e.rctx.parameters.maxTextureSize)}dispose(){this.enabled=!1,this.disposeOffscreenBuffers()}get depthTexture(){var e;return(e=this._handle)==null?void 0:e.getTexture(Te)}get _textureWidth(){return this._textureHeight*this._numCascades}get numCascades(){return this._numCascades}get cascadeDistances(){return Ct(this._usedCascadeDistances,this._cascadeDistances[0],this._numCascades>1?this._cascadeDistances[1]:1/0,this._numCascades>2?this._cascadeDistances[2]:1/0,this._numCascades>3?this._cascadeDistances[3]:1/0)}disposeMainBuffer(){this._handle=ve(this._handle)}disposeOffscreenBuffers(){this.disposeMainBuffer(),this._discardSnapshots()}set maxCascades(e){this.settings.maxNumCascadesHighQuality=Zt(Math.floor(e),1,4)}get maxCascades(){return this.settings.maxNumCascadesHighQuality}set enabled(e){this._enabled=e,e||this.disposeOffscreenBuffers()}get enabled(){return this._enabled}get ready(){return this._enabled&&this.depthTexture!=null}get cascades(){for(let e=0;e<this._numCascades;++e)st[e]=this._cascades[e];return st.length=this._numCascades,st}start(e,s,r,i,a){le(this.enabled);const{near:n,far:o}=oa(r);this._computeCascadeDistances(n,o,i),this._textureHeight=this._computeTextureHeight(e,a,i),this._setupMatrices(e,s);const{viewMatrix:l,projectionMatrix:g}=e;for(let u=0;u<this._numCascades;++u)this._constructCascade(u,g,l,s);this._lastOrigin=null,this.clear()}finish(){le(this.enabled)}getShadowMapMatrices(e){if(!this._lastOrigin||!As(e,this._lastOrigin)){this._lastOrigin=this._lastOrigin||be(),E(this._lastOrigin,e);for(let s=0;s<this._numCascades;++s){Tt(Nt,this._cascades[s].lightMat,e);for(let r=0;r<16;++r)Ut[16*s+r]=Nt[r]}}return Ut}moveSnapshot(e){var s,r;le(this.enabled),(s=this._snapshots[e])==null||s.release(),this._snapshots[e]=this._handle,(r=this._handle)==null||r.setName(e===0?"shadow map highlight":"shadow map excluding highlight"),this._handle=null}copySnapshot(e){var o,l,g,u;if(!this.enabled||!((l=(o=this._handle)==null?void 0:o.getTexture(Te))==null?void 0:l.descriptor))return;(g=this._snapshots[e])==null||g.release();const r=e===0?"shadow map highlight":"shadow map excluding highlight",i=this._acquireFBO(r);this._snapshots[e]=i;const a=(u=this._handle)==null?void 0:u.fbo;if(!a||!(i!=null&&i.fbo))return void console.error("No FBO");const{rctx:n}=this._fbos;n.blitFramebuffer(a,i.fbo,256)}getSnapshot(e){var s;return this.enabled?(s=this._snapshots[e])==null?void 0:s.getTexture(Te):null}clear(){this._ensureFbo(),this.bindFbo(),this._fbos.rctx.clear(256)}_computeTextureHeight({pixelRatio:e,fullWidth:s,fullHeight:r},i,a){const n=Math.min(window.devicePixelRatio,i)/e,o=a?this.settings.textureSizeModHighQuality:this.settings.textureSizeModLowQuality;return ni(Math.max(s,r)*n*o,this._maxTextureWidth/this._numCascades)}_ensureFbo(){var e,s,r,i;((s=(e=this._handle)==null?void 0:e.fbo)==null?void 0:s.width)===this._textureWidth&&((r=this._handle)==null?void 0:r.fbo.height)===this._textureHeight||((i=this._handle)==null||i.release(),this._handle=this._acquireFBO("shadow map"))}_acquireFBO(e){var r;const s=this._fbos.acquire(this._textureWidth,this._textureHeight,e,12);return(r=s.getTexture(Te))==null||r.setShadowFiltering(!0),s}_discardSnapshot(e){this._snapshots[e]=ve(this._snapshots[e])}_discardSnapshots(){for(let e=0;e<this._snapshots.length;++e)this._discardSnapshot(e);this._snapshots.length=0}bindFbo(){var e;this._fbos.rctx.bindFramebuffer((e=this._handle)==null?void 0:e.fbo)}_constructCascade(e,s,r,i){const a=this._cascades[e],n=-this._cascadeDistances[e],o=-this._cascadeDistances[e+1],l=(s[10]*n+s[14])/Math.abs(s[11]*n+s[15]),g=(s[10]*o+s[14])/Math.abs(s[11]*o+s[15]);le(l<g);for(let _=0;_<8;++_){Ct(At,_%4==0||_%4==3?-1:1,_%4==0||_%4==1?-1:1,_<4?l:g,1);const b=M[_];Hs(b,At,this._projectionViewInverse),b[0]/=b[3],b[1]/=b[3],b[2]/=b[3]}Ws(tt,M[0]),a.camera.viewMatrix=Tt(sa,this._modelViewLight,tt);for(let _=0;_<8;++_)Jt(M[_],M[_],a.camera.viewMatrix);let u=M[0][2],p=M[0][2];for(let _=1;_<8;++_)u=Math.min(u,M[_][2]),p=Math.max(p,M[_][2]);u-=200,p+=200,a.camera.near=-p,a.camera.far=-u,na(r,i,u,p,a.camera),nt(a.lightMat,a.camera.projectionMatrix,a.camera.viewMatrix);const y=this._textureHeight;a.camera.viewport=[e*y,0,y,y]}_setupMatrices(e,s){nt(this._projectionView,e.projectionMatrix,e.viewMatrix),Gs(this._projectionViewInverse,this._projectionView);const r=this._viewingMode===1?e.eye:Kt(tt,0,0,1);Bs(this._modelViewLight,[0,0,0],[-s[0],-s[1],-s[2]],r)}_computeCascadeDistances(e,s,r){const i=r?this.settings.maxNumCascadesHighQuality:this.settings.maxNumCascadesLowQuality;this._numCascades=Math.min(1+Math.floor(ii(s/e,4)),i);const a=(s-e)/this._numCascades,n=(s/e)**(1/this._numCascades);let o=e,l=e;for(let g=0;g<this._numCascades+1;++g)this._cascadeDistances[g]=Ns(o,l,this.settings.splitSchemeLambda),o*=n,l+=a}get test(){}};const sa=I(),At=mt(),M=[];for(let t=0;t<8;++t)M.push(mt());const Ht=f(),Wt=f(),ra=f(),Gt=f(),Bt=f(),tt=be(),st=[],Nt=I(),Ut=he.concat(he,he,he),P=f(),se=f(),W=[f(),f(),f(),f()],x=f(),rt=f(),j=f(),_e=f(),re=f(),ie=f(),Ie=f();function ia(t,e,s,r,i,a,n,o){q(P,0,0);for(let m=0;m<4;++m)H(P,P,t[m]);ne(P,P,.25),q(se,0,0);for(let m=4;m<8;++m)H(se,se,t[m]);ne(se,se,.25),de(W[0],t[4],t[5],.5),de(W[1],t[5],t[6],.5),de(W[2],t[6],t[7],.5),de(W[3],t[7],t[4],.5);let l=0,g=St(W[0],P);for(let m=1;m<4;++m){const C=St(W[m],P);C<g&&(g=C,l=m)}oe(x,W[l],t[l+4]);const u=x[0];let p,y;x[0]=-x[1],x[1]=u,oe(rt,se,P),$(rt,x)<0&&ks(x,x),de(x,x,rt,s),Ot(x,x),p=y=$(oe(j,t[0],P),x);for(let m=1;m<8;++m){const C=$(oe(j,t[m],P),x);C<p?p=C:C>y&&(y=C)}Qs(r,P),ne(j,x,p-e),H(r,r,j);let _=-1,b=1,D=0,Z=0;for(let m=0;m<8;++m){oe(_e,t[m],r),Ot(_e,_e);const C=x[0]*_e[1]-x[1]*_e[0];C>0?C>_&&(_=C,D=m):C<b&&(b=C,Z=m)}J(_>0,"leftArea"),J(b<0,"rightArea"),ne(re,x,p),H(re,re,P),ne(ie,x,y),H(ie,ie,P),Ie[0]=-x[1],Ie[1]=x[0];const ke=Oe(r,t[Z],ie,H(j,ie,Ie),1,i),ce=Oe(r,t[D],ie,j,1,a),ue=Oe(r,t[D],re,H(j,re,Ie),1,n),A=Oe(r,t[Z],re,j,1,o);J(ke,"rayRay"),J(ce,"rayRay"),J(ue,"rayRay"),J(A,"rayRay")}function d(t,e){return 3*e+t}const kt=f();function O(t,e){return q(kt,t[e],t[e+3]),kt}const T=f(),h=Xs();function aa(t,e,s,r,i){oe(T,s,r),ne(T,T,.5),h[0]=T[0],h[1]=T[1],h[2]=0,h[3]=T[1],h[4]=-T[0],h[5]=0,h[6]=T[0]*T[0]+T[1]*T[1],h[7]=T[0]*T[1]-T[1]*T[0],h[8]=1,h[d(0,2)]=-$(O(h,0),t),h[d(1,2)]=-$(O(h,1),t);let a=$(O(h,0),s)+h[d(0,2)],n=$(O(h,1),s)+h[d(1,2)],o=$(O(h,0),r)+h[d(0,2)],l=$(O(h,1),r)+h[d(1,2)];a=-(a+o)/(n+l),h[d(0,0)]+=h[d(1,0)]*a,h[d(0,1)]+=h[d(1,1)]*a,h[d(0,2)]+=h[d(1,2)]*a,a=1/($(O(h,0),s)+h[d(0,2)]),n=1/($(O(h,1),s)+h[d(1,2)]),h[d(0,0)]*=a,h[d(0,1)]*=a,h[d(0,2)]*=a,h[d(1,0)]*=n,h[d(1,1)]*=n,h[d(1,2)]*=n,h[d(2,0)]=h[d(1,0)],h[d(2,1)]=h[d(1,1)],h[d(2,2)]=h[d(1,2)],h[d(1,2)]+=1,a=$(O(h,1),e)+h[d(1,2)],n=$(O(h,2),e)+h[d(2,2)],o=$(O(h,1),s)+h[d(1,2)],l=$(O(h,2),s)+h[d(2,2)],a=-.5*(a/n+o/l),h[d(1,0)]+=h[d(2,0)]*a,h[d(1,1)]+=h[d(2,1)]*a,h[d(1,2)]+=h[d(2,2)]*a,a=$(O(h,1),e)+h[d(1,2)],n=$(O(h,2),e)+h[d(2,2)],o=-n/a,h[d(1,0)]*=o,h[d(1,1)]*=o,h[d(1,2)]*=o,i[0]=h[0],i[1]=h[1],i[2]=0,i[3]=h[2],i[4]=h[3],i[5]=h[4],i[6]=0,i[7]=h[5],i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=h[6],i[13]=h[7],i[14]=0,i[15]=h[8]}function na(t,e,s,r,i){const a=1/M[0][3],n=1/M[4][3];le(a<n);let o=a+Math.sqrt(a*n);const l=Math.sin(Us(t[2]*e[0]+t[6]*e[1]+t[10]*e[2]));o/=l,ia(M,o,l,Ht,Wt,ra,Gt,Bt),aa(Ht,Wt,Gt,Bt,i.projectionMatrix),i.projectionMatrix[10]=2/(s-r),i.projectionMatrix[14]=-(s+r)/(s-r)}function oa(t){let{near:e,far:s}=t;return e<2&&(e=2),s<2&&(s=2),e>=s&&(e=2,s=4),{near:e,far:s}}let He=class extends k{constructor(){super(...arguments),this.shader=new Q(Ti,()=>U(()=>import("./ImageMaterial.glsl-DfkX5TuI.js").then(e=>e.T),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82]),import.meta.url))}initializePipeline(e){return e.hasAlpha?B({blending:ns,colorWrite:N}):B({colorWrite:N})}};He=c([S("esri.views.3d.webgl-engine.lib.TextureTechnique")],He);let _s=class extends _r{constructor(){super(...arguments),this.hasAlpha=!1}};c([F()],_s.prototype,"hasAlpha",void 0);let fs=class extends we{constructor(){super(...arguments),this.overlayIndex=0,this.opacity=1}};function ha(){const t=new Y;return t.include(vt),t.fragment.uniforms.add(new ze("tex",e=>e.texture)),t.fragment.uniforms.add(new Ge("overlayIdx",e=>e.overlayIndex)),t.fragment.uniforms.add(new rs("opacity",e=>e.opacity)),t.fragment.main.add(z`vec2 overlayUV = overlayIdx == 0 ? vec2(uv.x * 0.5, uv.y) : vec2(uv.x * 0.5 + 0.5, uv.y);
fragColor = texture(tex, overlayUV) * opacity;`),t}const la=Object.freeze(Object.defineProperty({__proto__:null,OverlayCompositingPassParameters:fs,build:ha},Symbol.toStringTag,{value:"Module"}));let We=class extends k{constructor(){super(...arguments),this.shader=new Q(la,()=>U(()=>import("./ImageMaterial.glsl-DfkX5TuI.js").then(e=>e.O),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82]),import.meta.url))}};We=c([S("esri.views.3d.webgl-engine.shaders.OverlayCompositingTechnique")],We);let L=class extends Oi{constructor(t){super(t),this._overlays=null,this._renderTargets=null,this._overlayParameters=new fs,this.hasHighlights=!1,this.renderOccludedFlags=1,this._hasWater=!1,this._renderers=new Map,this._sortedDrapeSourceRenderersDirty=!1,this._sortedRenderers=new Ys,this._passParameters=new ls,this._screenToWorldRatio=1,this._localOriginFactory=null,this.unloadedMemory=0,this.ignoresMemoryFactor=!1,this._camera=new Ne,this.events=new Zs,this.longitudeCyclical=null,this.produces=new Map([[19,e=>e!==8||this.hasHighlights],[20,()=>this._hasWater]]),this._hasTargetWithoutRasterImage=!1,this._hasDrapedFeatureSource=!1,this._hasDrapedRasterSource=!1,this._hasDrapedFlowSource=!1}initialize(){const t=this._view,e=t.stage,s=e.renderer.fboCache,{waterTextures:r,techniques:i}=e.renderView;this._renderContext=new Ki(this._rctx,new ta(s,t.state.viewingMode),i),this.addHandles([ae(()=>r.updating,()=>this.events.emit("content-changed"),Pt),ae(()=>this._spatialReference,n=>this._localOriginFactory=new Jr(n),Pt),Js(()=>t.allLayerViews,"after-changes",()=>this._sortedDrapeSourceRenderersDirty=!0),ae(()=>Ai(t.state.highlights),()=>this._sortedDrapeSourceRenderersDirty=!0,at),ae(()=>t.state.highlights,n=>{this._bindParameters.highlights=n,this._bindParameters.highlightOrderMap=t.state.highlightOrderMap},at),t.resourceController.scheduler.registerTask(Ks.OVERLAY_RENDERER,this)]);const a=this._camera;a.near=1,a.far=1e4,a.relativeElevation=null,this._bindParameters.slot=19,this._bindParameters.camera=a,this._bindParameters.updateLighting([new fr(er())],0,0,0)}destroy(){this._renderers.forEach(t=>t.destroy()),this._renderers.clear(),this._passParameters.texture=_t(this._passParameters.texture),this.disposeOverlays(),this._renderContext=null,this._sortedRenderers.prune()}get _bindParameters(){return this._renderContext.bind}get _rctx(){return this._stage.renderView.renderingContext}get _view(){return this.parent.view}get _stage(){return this.parent.view.stage}get _spatialReference(){return this.parent.spatialReference}get _techniques(){return this._stage.renderView.techniques}get rctx(){return this._rctx}get materials(){return this._pluginContext.materials}get screenToWorldRatio(){return this._screenToWorldRatio}get localOriginFactory(){return this._localOriginFactory}get pluginContext(){return this._pluginContext}initializeRenderContext(t){const e=new Bi(this._view.stage.renderView.textures,this._techniques,()=>{this._onMaterialOrContentChanged(),this.events.emit("content-changed"),this.notifyChange("updating"),this.notifyChange("isEmpty")},()=>this.events.emit("content-changed"));this._pluginContext={...t,materials:e},this._techniques.precompile(We)}uninitializeRenderContext(){}acquireTechniques(){return[]}render(){}get updating(){return this._sortedDrapeSourceRenderersDirty||ge(this._renderers,t=>t.updating||t.canCompact)}get hasOverlays(){return this._overlays!=null&&this._renderTargets!=null}getMaterialRenderer(t){for(const e of this._renderers.values()){const s=e.getMaterialRenderer(t);if(s)return s}return null}get layers(){return this._sortedDrapeSourceRenderersDirty&&this._updateSortedDrapeSourceRenderers(),tr(this._sortedRenderers.map(t=>t.drapeSource.layer).filter(t=>!!t))}registerDrapeSource(t,e){const s=this._renderers.get(t);s!=null&&s.destroy(),this._renderers.set(t,e),this._sortedDrapeSourceRenderersDirty=!0,"fullOpacity"in t&&this.addHandles(ae(()=>t.fullOpacity,()=>this.events.emit("content-changed")),t)}removeDrapeSourceRenderer(t){if(t==null)return;const e=this._renderers.get(t);e!=null&&(this._sortedDrapeSourceRenderersDirty=!0,this._renderers.delete(t),this.removeHandles(t),e.destroy())}computeValidity(){var t;return((t=this._renderTargets)==null?void 0:t.computeValidity())??0}releaseRenderTargets(t){var e;(e=this._renderTargets)==null||e.dispose(t)}get overlays(){return this._overlays??[]}ensureDrapeTargets(t){this._hasTargetWithoutRasterImage=!!this._overlays&&Se(t,e=>e.drapeTargetType===1)}ensureDrapeSources(t){this._overlays?(this._hasDrapedFeatureSource=Se(t,e=>e.drapeSourceType===1),this._hasDrapedRasterSource=Se(t,e=>e.drapeSourceType===0),this._hasDrapedFlowSource=Se(t,e=>e.drapeSourceType===2)):this._hasDrapedFeatureSource=this._hasDrapedRasterSource=this._hasDrapedFlowSource=!1}get _needsColorWithoutRasterImage(){return this._hasDrapedRasterSource&&this._hasDrapedFeatureSource&&this._hasTargetWithoutRasterImage}ensureOverlays(t,e,s=this._bindParameters.overlayStretch){this._overlays==null&&(this._renderTargets=new $i(this._stage.renderer.fboCache),this._overlays=[new It,new It]),this.ensureDrapeTargets(t),this.ensureDrapeSources(e),this._bindParameters.overlayStretch=s}disposeOverlays(){var t;this._overlays=null,(t=this._renderTargets)==null||t.dispose(1),this._renderTargets=null,this.events.emit("textures-disposed")}_useOverlayColorInsteadOfColorNoRasterImage(t){return t===1&&!this._needsColorWithoutRasterImage&&this._hasDrapedFeatureSource}getTexture(t){var s;const e=this._useOverlayColorInsteadOfColorNoRasterImage(t);return(s=this._renderTargets)==null?void 0:s.getTexture(e?0:t)}get readyToRun(){return this.updating}runTask(t){this._processDrapeSources(t,()=>!0)}_onMaterialOrContentChanged(){this.renderOccludedFlags=ge(this._renderers,t=>t.hasOccluders)?it:1}_processDrapeSources(t,e){let s=!1;for(const[r,i]of this._renderers){if(t.done)break;(r.destroyed||e(r))&&i.commitChanges()&&(s=!0,t.madeProgress())}this._sortedDrapeSourceRenderersDirty&&(this._sortedDrapeSourceRenderersDirty=!1,s=!0,this._updateSortedDrapeSourceRenderers(),t.madeProgress()),this.compact(t),s&&(this._overlays!=null&&this._renderers.size===0&&this.disposeOverlays(),this.notifyChange("updating"),this.notifyChange("isEmpty"),this._onMaterialOrContentChanged(),this.hasHighlights=ge(this._renderers,r=>r.hasHighlights),this.events.emit("content-changed"))}compact(t){let e=!1;for(const s of this._renderers.values()){if(t.done)break;e=s.compact(t)||e}return e&&this.notifyChange("updating"),e}hasHighlight(t){return ge(this._renderers,e=>e.hasHighlight(t))}processSyncDrapeSources(){this._processDrapeSources(sr,t=>t.updatePolicy===1)}get isEmpty(){return!Ke.OVERLAY_DRAW_DEBUG_TEXTURE&&Ft(this._renderers,t=>t.isEmpty)}get hasWater(){const t=ge(this._renderers,({hasWater:e})=>e);return t!==this._hasWater&&(this._hasWater=t,this.events.emit("has-water")),this._hasWater}renders(t){var i,a;if(Ke.OVERLAY_DRAW_DEBUG_TEXTURE&&t!==4&&t!==2)return!0;if(!this._overlays)return!1;const e=this._overlays[0];for(const n of this._overlays)n.setupGeometryViews(this.longitudeCyclical);if(!e.hasSomeSizedView())return!1;const s=this._setOutput(((a=(i=this._renderTargets)==null?void 0:i.targets.find(n=>n.content===t))==null?void 0:a.output)??0);++this._techniques.precompiling;const r=this._sortedRenderers.some(({renderer:n})=>n.precompile(this._renderContext));return--this._techniques.precompiling,this._setOutput(s),r}_setOutput(t){const e=this._renderContext.output;return this._renderContext.output=t,this._bindParameters.slot=t===2?20:19,e}get mode(){var t;return this.isEmpty?0:this.hasWater&&this.renders(3)?2:(t=this._renderTargets)!=null&&t.getTexture(0)?1:0}updateAnimation(t){let e=!1;return this._renderers.forEach(s=>e=s.updateAnimation(t)||e),e&&this.parent.requestRender(0),e}updateDrapeSourceOrder(){this._sortedDrapeSourceRenderersDirty=!0}precompileShaders(t){if(!this._overlays||!this._renderTargets)return!1;const e=this._bindParameters;e.alignPixelEnabled=t.alignPixelEnabled,++this._techniques.precompiling;for(const s of this._renderTargets.targets){if(s.content===1&&!this._needsColorWithoutRasterImage)continue;const{output:r}=s;this._setOutput(r),r===8&&(e.highlightMixTexture=e.highlights.length>1?this._rctx.emptyTexture:null);const i=this._renderContext.renderOccludedMask;s.content===4&&(this._renderContext.renderOccludedMask=it),this._sortedRenderers.forAll(({drapeSource:a,renderer:n})=>{s.content===1&&a.drapeSourceType===0||s.content===4&&n.hasOnlyOccluders||n.precompile(this._renderContext)}),this._renderContext.renderOccludedMask=i,e.highlightMixTexture=null}return--this._techniques.precompiling,!0}drawOverlays(t,e){if(!this._overlays||!this._renderTargets)return;for(const r of this._overlays)r.setupGeometryViews(this.longitudeCyclical);this._bindParameters.alignPixelEnabled=t.alignPixelEnabled;const s=this.allSourcesOccluders;for(const r of this._renderTargets.targets){if(!(r.content===0&&this._hasDrapedFlowSource)&&!r.handleRenderRequest(e)||r.content===1&&!this._needsColorWithoutRasterImage||r.content===4&&s)continue;const i=this._drawTarget(0,r),a=this._drawTarget(1,r);(i||a)&&r.fbo.generateMipMap()}}_drawTarget(t,e){const s=this._overlays[t],r=s.canvasGeometries;if(r.numViews===0)return!1;const i=this._view.state.contentPixelRatio;this._screenToWorldRatio=i*s.mapUnitsPerPixel/this._bindParameters.overlayStretch;const{output:a,content:n}=e;if(this.isEmpty||a===2&&!this.hasWater||!s.hasSomeSizedView())return!1;const{_rctx:o,_camera:l,_renderContext:g,_bindParameters:u}=this;if(l.pixelRatio=s.pixelRatio*i,this._setOutput(a),u.screenToWorldRatio=this._screenToWorldRatio,u.screenToPCSRatio=this._screenToWorldRatio*this.parent.worldToPCSRatio,n===4&&(g.renderOccludedMask=it),!this.renders(n))return g.renderOccludedMask=dt,!1;const{resolution:p}=s,y=t===0,_=y?0:p;if(o.setViewport(_,0,p,p),this._bindTargetFBO(e),y&&(a===8?o.gl.clearBufferuiv(o.gl.COLOR,0,[0,0,0,0]):(o.setClearColor(0,0,0,0),o.clear(16384))),Ke.OVERLAY_DRAW_DEBUG_TEXTURE&&n!==4&&n!==2){this._techniques.precompile(He,gt);const b=this._techniques.get(He,gt);for(let D=0;D<r.numViews;D++)this._setViewParameters(r.extents[D],s),this._ensureDebugPatternResources(s.resolution,ua[t]),o.bindTechnique(b,u,this._passParameters),o.screen.draw()}if(a===8){const{fboCache:b}=this._stage.renderer,D=this._resolution;this._bindTargetFBO(e),Wi(o,b,{width:D,height:D},u,()=>this._renderAllGeometry(t,e),_)}else this._renderAllGeometry(t,e);return o.bindFramebuffer(null),g.renderOccludedMask=dt,!0}get allSourcesOccluders(){return Ft(this._renderers,t=>t.hasOnlyOccluders)}_renderAllGeometry(t,e){const s=this._overlays[t],r=s.canvasGeometries;this._sortedRenderers.forAll(({drapeSource:i,renderer:a})=>{if(e.content===1&&i.drapeSourceType===0)return;const{fullOpacity:n}=i,o=n!=null&&n<1&&e.output===0&&this._bindTemporaryFBO();for(let l=0;l<r.numViews;l++)this._setViewParameters(r.extents[l],s),a.render(this._renderContext);if(o){this._bindTargetFBO(e),this._overlayParameters.texture=o.getTexture(),this._overlayParameters.opacity=n,this._overlayParameters.overlayIndex=t;const l=this._techniques.get(We);this._rctx.bindTechnique(l,this._bindParameters,this._overlayParameters),this._rctx.screen.draw(),o.release()}})}_bindTargetFBO(t){const e=this._resolution,s=2*e;t.fbo.ensureFramebuffer(s,e),t.fbo.bind(this._rctx)}_bindTemporaryFBO(){const t=this._resolution,e=2*t,s=this._stage.renderer.fboCache,r=s.acquire(e,t,"overlay tmp");return s.rctx.bindFramebuffer(r.fbo),s.rctx.clear(16384),r}get _resolution(){var t;return((t=this._overlays)==null?void 0:t[0].resolution)??0}notifyContentChanged(){this.events.emit("content-changed")}intersect(t,e,s,r){var a;this._sortedDrapeSourceRenderersDirty&&this._updateSortedDrapeSourceRenderers();let i=0;for(const{renderer:n}of this._sortedRenderers)i=((a=n.intersect)==null?void 0:a.call(n,t,e,s,r,i))??i}_updateSortedDrapeSourceRenderers(){if(this._sortedRenderers.clear(),this._renderers.size===0)return;const t=this._view.map.allLayers.map(s=>s.uid),e=t.length;this._renderers.forEach((s,r)=>{var g;const i=t.indexOf((g=r.layer)==null?void 0:g.uid),a=i>=0,n=r.renderGroup??(a?0:1),o=r.drapeSourcePriorityOffset??0,l=e*n+(a?i:0)+o;this._sortedRenderers.push(new ca(r,s,l))}),this._sortedRenderers.sort((s,r)=>s.index-r.index)}_setViewParameters(t,e){const s=this._camera;s.viewport=[0,0,e.resolution,e.resolution],rr(s.projectionMatrix,0,t[2]-t[0],0,t[3]-t[1],s.near,s.far),ir(s.viewMatrix,[-t[0],-t[1],0])}_ensureDebugPatternResources(t,e){if(Kt(this._passParameters.color,e[0],e[1],e[2]),this._passParameters.texture)return;const s=new Uint8Array(t*t*4);let r=0;for(let a=0;a<t;a++)for(let n=0;n<t;n++){const o=Math.floor(n/10),l=Math.floor(a/10);o<2||l<2||10*o>t-20||10*l>t-20?(s[r++]=255,s[r++]=255,s[r++]=255,s[r++]=255):(s[r++]=255,s[r++]=255,s[r++]=255,s[r++]=1&o&&1&l?1&n^1&a?0:255:1&o^1&l?0:128)}const i=new Yt(t);i.samplingMode=9728,this._passParameters.texture=new ft(this._rctx,i,s)}get test(){}};c([v()],L.prototype,"hasHighlights",void 0),c([v()],L.prototype,"renderOccludedFlags",void 0),c([v()],L.prototype,"_sortedDrapeSourceRenderersDirty",void 0),c([v({constructOnly:!0})],L.prototype,"parent",void 0),c([v({readOnly:!0})],L.prototype,"_techniques",null),c([v({type:Boolean,readOnly:!0})],L.prototype,"updating",null),c([v()],L.prototype,"isEmpty",null),L=c([S("esri.views.3d.terrain.OverlayRenderer")],L);class ca{constructor(e,s,r){this.drapeSource=e,this.renderer=s,this.index=r}}const ua=[[1,.5,.5],[.5,.5,1]],da=-2,it=4,gt=new _s;gt.hasAlpha=!0;let Sn=class{constructor(e,s={}){this.geometry=e,this.screenToWorldRatio=1,this._transformation=I(),this._shaderTransformation=null,this._boundingSphere=null,this.id=ar(),this.layerViewUid=s.layerViewUid,this.graphicUid=s.graphicUid,this.castShadow=s.castShadow??!1,s.objectShaderTransformation&&this.objectShaderTransformationChanged(s.objectShaderTransformation)}get transformation(){return this._transformation}set transformation(e){nr(this._transformation,e),this._boundingSphere=null}get boundingInfo(){return this.geometry.boundingInfo}objectShaderTransformationChanged(e){e==null?this._shaderTransformation=null:(this._shaderTransformation??(this._shaderTransformation=I()),nt(this._shaderTransformation,e,this.geometry.transformation)),this._boundingSphere=null}get boundingSphere(){return this.boundingInfo?(this._boundingSphere==null&&(this._boundingSphere??(this._boundingSphere=new Ur),Jt(this._boundingSphere.center,this.boundingInfo.center,this.shaderTransformation),this._boundingSphere.radius=this.boundingInfo.radius*Qr(this.shaderTransformation)),this._boundingSphere):kr}get material(){return this.geometry.material}get type(){return this.geometry.type}get shaderTransformation(){return this._shaderTransformation??this.transformation}get attributes(){return this.geometry.attributes}get positionAttribute(){return this.geometry.positionAttribute}foreachHighlightOptions(e){this.geometry.foreachHighlightOptions(e)}get hasHighlights(){return this.geometry.hasHighlights}get occludees(){return this.geometry.occludees}get visible(){return this.geometry.visible}set visible(e){this.geometry.visible=e}},ga=class extends mr{intersect(e,s,r,i,a,n){return vr(e,r,i,a,void 0,n)}intersectDraped(e,s,r,i){return xr(r[0],r[1],e,i)}};function pa(t){const e=new Y,{vertex:s,fragment:r,attributes:i,varyings:a}=e,{hasVVColor:n,hasVertexColors:o}=t;return yr(s,t),e.include(br),e.include(wr,t),e.include($r,t),e.include(Cr,t),r.include(Tr,t),e.include(Sr,t),e.include(Or,t),i.add("position","vec3"),n&&i.add("colorFeatureAttribute","float"),o||a.add("vColor","vec4"),a.add("vpos","vec3",{invariant:!0}),s.uniforms.add(new Pr("uColor",l=>l.color)),s.main.add(z`
      vpos = position;
      forwardNormalizedVertexColor();
      forwardObjectAndLayerIdColor();

      ${o?"vColor *= uColor;":n?"vColor = uColor * interpolateVVColor(colorFeatureAttribute);":"vColor = uColor;"}
      forwardViewPosDepth((view * vec4(vpos, 1.0)).xyz);
      gl_Position = transformPosition(proj, view, vpos);`),r.include(Fr),r.main.add(z`discardBySlice(vpos);
discardByTerrainDepth();
outputColorHighlightOLID(vColor, vpos, vColor.rgb);`),e}const _a=Object.freeze(Object.defineProperty({__proto__:null,build:pa},Symbol.toStringTag,{value:"Module"}));let pt=class extends k{constructor(t,e){super(t,e,ms(e).locations),this.shader=new Q(_a,()=>U(()=>import("./ImageMaterial.glsl-DfkX5TuI.js").then(s=>s.C),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82]),import.meta.url))}_createPipeline(t,e){const{oitPass:s,output:r,hasEmission:i,transparent:a,cullFace:n,draped:o,hasOccludees:l,polygonOffset:g}=t,u=s===0;return B({blending:as(r)&&a?Rr(s):null,culling:Yr(n),depthTest:o?null:Dr(s),depthWrite:Mr(t),drawBuffers:Vr(r,Ir(s,i)),colorWrite:N,stencilWrite:l?qr:null,stencilTest:l?e?zr:Lr:null,polygonOffset:u?g?fa:null:jr(t)})}initializePipeline(t){return this._occludeePipelineState=this._createPipeline(t,!0),this._createPipeline(t,!1)}getPipeline(t,e){return e?this._occludeePipelineState:super.getPipeline(t)}};pt=c([S("esri.views.3d.webgl-engine.shaders.ColorMaterialTechnique")],pt);const fa={factor:1,units:1};function ms(t){const e=X().vec3f("position");return es()&&e.vec4u8("olidColor"),t.hasVVColor?e.f32("colorFeatureAttribute"):e.vec4u8("color"),e.freeze()}let R=class extends Er{constructor(){super(...arguments),this.cullFace=0,this.hasVertexColors=!1,this.transparent=!1,this.discardInvisibleFragments=!1,this.polygonOffset=!1,this.enableOffset=!0,this.writeDepth=!0,this.hasOccludees=!1,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.hasVVColor=!1,this.draped=!1,this.textureCoordinateType=0,this.emissionSource=0,this.occlusionPass=!1,this.olidColorInstanced=!1,this.hasVVInstancing=!1,this.hasVVSize=!1,this.hasVVOpacity=!1,this.snowCover=!1}};c([F({count:3})],R.prototype,"cullFace",void 0),c([F()],R.prototype,"hasVertexColors",void 0),c([F()],R.prototype,"transparent",void 0),c([F()],R.prototype,"discardInvisibleFragments",void 0),c([F()],R.prototype,"polygonOffset",void 0),c([F()],R.prototype,"enableOffset",void 0),c([F()],R.prototype,"writeDepth",void 0),c([F()],R.prototype,"hasOccludees",void 0),c([F()],R.prototype,"terrainDepthTest",void 0),c([F()],R.prototype,"cullAboveTerrain",void 0),c([F()],R.prototype,"hasVVColor",void 0),c([F()],R.prototype,"draped",void 0);let Rn=class extends ga{constructor(e){super(e,va),this._configuration=new R,this.supportsEdges=!0,this.produces=new Map([[2,s=>this._isOpaqueMaterialPass(s)],[3,s=>this._isOpaqueNoSSAODepthPass(s)],[4,s=>et(s)&&this._transparent&&this.parameters.writeDepth],[5,s=>Dt(s)&&this._transparent&&this.parameters.writeDepth],[9,s=>et(s)&&this._transparent&&!this.parameters.writeDepth],[19,s=>Ar(s)]])}getConfiguration(e,s){return super.getConfiguration(e,s,this._configuration),this._configuration.cullFace=this.parameters.cullFace,this._configuration.hasVertexColors=this.parameters.hasVertexColors&&!this.parameters.vvColor,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this._transparent,this._configuration.discardInvisibleFragments=this._transparent&&!this._isOpaquePass(e)&&this.parameters.discardInvisibleFragments,this._configuration.polygonOffset=this.parameters.polygonOffset,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.hasOccludees=s.hasOccludees,this._configuration.oitPass=s.oitPass,this._configuration.enableOffset=s.enableOffset,this._configuration.terrainDepthTest=s.terrainDepthTest&&as(e),this._configuration.cullAboveTerrain=s.cullAboveTerrain,this._configuration.hasVVColor=!!this.parameters.vvColor,this._configuration.draped=this.parameters.draped,this._configuration}get visible(){return this.parameters.color[3]>=Hr}get _transparent(){return this.parameters.color[3]<1||this.parameters.forceTransparentMode}_isOpaquePass(e){return this._isOpaqueMaterialPass(e)||this._isOpaqueNoSSAODepthPass(e)}_isOpaqueMaterialPass(e){return e===8||et(e)&&!this._transparent}_isOpaqueNoSSAODepthPass(e){return Dt(e)&&this.parameters.writeDepth&&!this._transparent}createGLMaterial(e){return new ma(e)}createBufferWriter(){return new Wr(ms(this.parameters))}};class ma extends Gr{beginSlot(e){return this.getTechnique(pt,e)}}class va extends Br{constructor(){super(...arguments),this.color=or,this.forceTransparentMode=!1,this.writeDepth=!0,this.hasVertexColors=!1,this.polygonOffset=!1,this.hasSlicePlane=!1,this.cullFace=0,this.draped=!1,this.discardInvisibleFragments=!1}}const w={dash:[4,3],dot:[1,3],"long-dash":[8,3],"short-dash":[4,1],"short-dot":[1,1]},xa={dash:w.dash,"dash-dot":[...w.dash,...w.dot],dot:w.dot,"long-dash":w["long-dash"],"long-dash-dot":[...w["long-dash"],...w.dot],"long-dash-dot-dot":[...w["long-dash"],...w.dot,...w.dot],none:null,"short-dash":w["short-dash"],"short-dash-dot":[...w["short-dash"],...w["short-dot"]],"short-dash-dot-dot":[...w["short-dash"],...w["short-dot"],...w["short-dot"]],"short-dot":w["short-dot"],solid:null},ya=8;function ba(t,e){return t==null?t:{pattern:t.slice(),pixelRatio:e}}function Mn(t){return{pattern:[t,t],pixelRatio:2}}function Vn(t){return(t==null?void 0:t.type)==="style"?wa(t.style):null}function wa(t){return t!=null?ba(xa[t],ya):null}function In(t,e,s,r){const i=t.type==="polygon"?1:0,a=t.type==="polygon"?t.rings:t.paths,{position:n,outlines:o}=os(a,!!t.hasZ,i,t.spatialReference),l=Qt(n.length),g=Kr(n,t.spatialReference,0,l,0,n,0,n.length/3,e,s,r),u=g!=null;return{lines:u?vs(o,n,l):[],projectionSuccess:u,sampledElevation:g}}function qn(t,e){const s=t.type==="polygon"?1:0,r=t.type==="polygon"?t.rings:t.paths,{position:i,outlines:a}=os(r,!1,s),n=hr(i,t.spatialReference,0,i,e,0);for(let o=2;o<i.length;o+=3)i[o]=da;return{lines:n?vs(a,i):[],projectionSuccess:n}}function vs(t,e,s=null){const r=new Array;for(const{index:i,count:a}of t){if(a<=1)continue;const n=3*i,o=3*a;r.push({position:Rt(e,3*i,3*a),mapPositions:s!=null?Rt(s,n,o):void 0})}return r}const zn=X().vec3f("position").freeze(),Ln=X().vec3f("position").vec2f16("uv0").freeze(),jn=X().vec3f("position").vec4u8("color").freeze(),En=X().vec3f("position").vec2f("uv0").freeze(),An=X().vec3f("position").vec2f("uv0").vec4u8("olidColor").freeze();Xr(X().u16("componentIndex",{integer:!0}));const xs=[{name:"colorAndCastShadows",type:"vec4u8"},{name:"elevationOffset",type:"f32"},{name:"emissiveStrength",type:"f16"},{name:"emissiveSourceMode",type:"u8"}],$a={name:"olidColor",type:"vec4u8"};new hs(xs);new hs([...xs,$a]);export{Ci as A,fs as B,ha as C,pa as D,da as H,jn as a,zn as b,Rn as c,_n as d,An as e,Na as f,En as g,Sn as h,ga as i,Mn as j,Ln as k,Ri as l,Mi as m,Vn as n,gs as o,qn as p,us as q,yi as r,In as s,ds as t,tn as u,Pi as v,G as w,Le as x,qi as y,ls as z};
