import{pG as Xe,pI as Ge,eb as E,ee as Je,ef as Ye,pD as et,pE as tt,ea as g,hL as U,ed as it,hK as v,M as _e,cJ as nt,ks as at,dZ as Ve,ps as rt,e0 as st,aW as ot}from"./index-C_bK48d2.js";import{t as lt,l as pe}from"./arcade-DzAn-uHG.js";import{Z as ze,o as _,w as dt,m as me,B as D,p as R,g as A,a0 as ut,c as Ae,l as Ce,X as ve,z as Z,T as z,H as ae,t as V,L as ct,S as H,a1 as ft,a2 as re}from"./Dictionary-BQHLIVF1.js";import{I as ht}from"./Feature-IMCzHRW9.js";import{i as Q,D as pt,b as Ee,c as mt,C as oe,T as yt,_ as gt,N as wt}from"./featureSetUtils-Dn6DJE8w.js";import{t as Ft}from"./ImmutableArray-BPVd6ESQ.js";import{l as It}from"./portalUtils-4FqAl5PF.js";import{t as ee}from"./arcadeEnvironment-DXZ5oSsm.js";import{l as X,h as Tt,d as St,c as Nt,A as De,E as Le,y as ke,T as We,C as bt,m as de,w as ce,p as se,s as te,r as j,e as He,f as xt,v as ue,L as _t,I as At}from"./FeatureSet-C159Sq-I.js";import{c as Be,m as Ue,d as Ze,a as Re,f as qe,o as le,G as ge,N as Me}from"./shared-CCxkzcop.js";import{L as w,a as L,i as Ct,r as vt}from"./WhereClause-BTKovlsq.js";import{a as Et}from"./Empty-aIwBS85J.js";import{queryAssociations as Dt}from"./queryAssociations-BNZsSvYd.js";import Lt from"./QueryAssociationsParameters-BGudeeTW.js";import"./aiServices-nbIINXcF.js";import"./commonProperties-DHiB1uzW.js";import"./streamLayerUtils-DFlbJ4P1.js";import"./unitConversion-BJ0HkwFy.js";import"./number-B6x4HXNH.js";import"./featureConversionUtils-Di1UhLmY.js";import"./OptimizedFeatureSet-BZnZXZq6.js";import"./memoryEstimations-w0EAmzVg.js";import"./OptimizedGeometry-KE6YknPZ.js";import"./queryRelatedRecords-BHhYbV-T.js";import"./urlUtils-BlxBVR77.js";import"./operatorsWorkerConnection-DC2XMJIx.js";import"./Association-7T_5CKHS.js";class fe{constructor(i){this.field=i,this.sqlRewritable=!1}postInitialization(i,t){}}class J extends fe{constructor(i){super(i),this.sqlRewritable=!0}extractValue(i){return i.attributes[this.field.name]}rewriteSql(i){return{rewritten:this.sqlRewritable,where:i}}}class Y extends fe{constructor(i,t,n){super(le(i)),this.originalField=i,this.sqlRewritable=!0,this.field.name=t,this.field.alias=n}rewriteSql(i,t){return{rewritten:this.sqlRewritable,where:de(i,this.field.name,this.originalField.name,t.getFieldsIndex())}}extractValue(i){return i.attributes[this.originalField.name]}}const T=class T extends fe{constructor(i,t,n){super(i),this.codefield=t,this._stringToCode=n,this._codeToString={};for(const l in n)this._codeToString[n[l]]=l;this.sqlRewritable=!0}rewriteSql(i,t){const n=this.evaluateNodeToWhereClause(i.parseTree,0,this.field.name,this.codefield instanceof w?X(this.codefield,0):this.codefield,i.parameters);return n.includes(T.BADNESS)?{rewritten:!1,where:i}:{rewritten:this.sqlRewritable,where:w.create(n,{fieldsIndex:t._parent.getFieldsIndex(),timeZone:t.dateFieldsTimeZoneDefaultUTC})}}evaluateNodeToWhereClause(i,t,n=null,l=null,r){switch(i.type){case"interval":return bt(this.evaluateNodeToWhereClause(i.value,t,n,l,r),i.qualifier,i.op);case"case-expression":{let e=" CASE ";i.format==="simple"&&(e+=this.evaluateNodeToWhereClause(i.operand,t,n,T.BADNESS,r));for(const a of i.clauses)e+=" WHEN "+this.evaluateNodeToWhereClause(a.operand,t,n,T.BADNESS,r)+" THEN "+this.evaluateNodeToWhereClause(a.value,t,n,T.BADNESS,r);return i.else!==null&&(e+=" ELSE "+this.evaluateNodeToWhereClause(i.else,t,n,T.BADNESS,r)),e+=" END ",e}case"parameter":{const e=r[i.value.toLowerCase()];return typeof e=="string"?"'"+e.toString().replaceAll("'","''")+"'":Be(e)||Ue(e)?De(e,t):Ze(e)?Le(e,t):Re(e)?ke(e,t):qe(e)?We(e,t):Array.isArray(e)?e.map(a=>typeof a=="string"?"'"+a.toString().replaceAll("'","''")+"'":Be(a)||Ue(a)?De(a,t):Ze(a)?Le(a,t):Re(a)?ke(a,t):qe(a)?We(a,t):a.toString()):e.toString()}case"expression-list":{const e=[];for(const a of i.value)e.push(this.evaluateNodeToWhereClause(a,t,n,l,r));return e}case"unary-expression":return" ( NOT "+this.evaluateNodeToWhereClause(i.expr,t,n,T.BADNESS,r)+" ) ";case"binary-expression":switch(i.operator){case"AND":return" ("+this.evaluateNodeToWhereClause(i.left,t,n,l,r)+" AND "+this.evaluateNodeToWhereClause(i.right,t,n,l,r)+") ";case"OR":return" ("+this.evaluateNodeToWhereClause(i.left,t,n,l,r)+" OR "+this.evaluateNodeToWhereClause(i.right,t,n,l,r)+") ";case"IS":if(i.right.type!=="null")throw new L("UnsupportedIsRhs");return" ("+this.evaluateNodeToWhereClause(i.left,t,n,l,r)+" IS NULL )";case"ISNOT":if(i.right.type!=="null")throw new L("UnsupportedIsRhs");return" ("+this.evaluateNodeToWhereClause(i.left,t,n,l,r)+" IS NOT NULL )";case"IN":{if(i.right.type==="expression-list"){if(i.left.type==="column-reference"&&i.left.column.toUpperCase()===this.field.name.toUpperCase()){const s=[];let d=!0;for(const m of i.right.value){if(m.type!=="string"){d=!1;break}if(this._stringToCode[m.value]===void 0){d=!1;break}s.push(this._stringToCode[m.value].toString())}if(d)return" ("+this.evaluateNodeToWhereClause(i.left,t,n,l,r)+" IN ("+s.join(",")+")) "}const a=this.evaluateNodeToWhereClause(i.right,t,n,l,r);return" ("+this.evaluateNodeToWhereClause(i.left,t,n,l,r)+" IN ("+a.join(",")+")) "}const e=this.evaluateNodeToWhereClause(i.right,t,n,l,r);return Array.isArray(e)?" ("+this.evaluateNodeToWhereClause(i.left,t,n,l,r)+" IN ("+e.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(i.left,t,n,l,r)+" IN ("+e+")) "}case"NOT IN":{if(i.right.type==="expression-list"){if(i.left.type==="column-reference"&&i.left.column.toUpperCase()===this.field.name.toUpperCase()){const s=[];let d=!0;for(const m of i.right.value){if(m.type!=="string"){d=!1;break}if(this._stringToCode[m.value]===void 0){d=!1;break}s.push(this._stringToCode[m.value].toString())}if(d)return" ("+this.evaluateNodeToWhereClause(i.left,t,n,l,r)+" NOT IN ("+s.join(",")+")) "}const a=this.evaluateNodeToWhereClause(i.right,t,n,l,r);return" ("+this.evaluateNodeToWhereClause(i.left,t,n,l,r)+" NOT IN ("+a.join(",")+")) "}const e=this.evaluateNodeToWhereClause(i.right,t,n,l,r);return Array.isArray(e)?" ("+this.evaluateNodeToWhereClause(i.left,t,n,l,r)+" NOT IN ("+e.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(i.left,t,n,l,r)+" NOT IN ("+e+")) "}case"BETWEEN":{const e=this.evaluateNodeToWhereClause(i.right,t,n,T.BADNESS,r);return" ("+this.evaluateNodeToWhereClause(i.left,t,n,T.BADNESS,r)+" BETWEEN "+e[0]+" AND "+e[1]+" ) "}case"NOTBETWEEN":{const e=this.evaluateNodeToWhereClause(i.right,t,n,T.BADNESS,r);return" ("+this.evaluateNodeToWhereClause(i.left,t,n,T.BADNESS,r)+" NOT BETWEEN "+e[0]+" AND "+e[1]+" ) "}case"LIKE":return i.escape!==""?" ("+this.evaluateNodeToWhereClause(i.left,t,n,T.BADNESS,r)+" LIKE "+this.evaluateNodeToWhereClause(i.right,t,n,T.BADNESS,r)+" ESCAPE '"+i.escape+"') ":" ("+this.evaluateNodeToWhereClause(i.left,t,n,T.BADNESS,r)+" LIKE "+this.evaluateNodeToWhereClause(i.right,t,n,T.BADNESS,r)+") ";case"NOT LIKE":return i.escape!==""?" ("+this.evaluateNodeToWhereClause(i.left,t,n,T.BADNESS,r)+" NOT LIKE "+this.evaluateNodeToWhereClause(i.right,t,n,T.BADNESS,r)+" ESCAPE '"+i.escape+"') ":" ("+this.evaluateNodeToWhereClause(i.left,t,n,T.BADNESS,r)+" NOT LIKE "+this.evaluateNodeToWhereClause(i.right,t,n,T.BADNESS,r)+") ";case"<>":case"=":if(i.left.type==="column-reference"&&i.right.type==="string"){if(i.left.column.toUpperCase()===this.field.name.toUpperCase()&&this._stringToCode[i.right.value.toString()]!==void 0)return" ("+l+" "+i.operator+" "+this._stringToCode[i.right.value.toString()].toString()+") "}else if(i.right.type==="column-reference"&&i.left.type==="string"&&i.right.column.toUpperCase()===this.field.name.toUpperCase())return" ("+this._stringToCode[i.left.value.toString()].toString()+" "+i.operator+" "+l+") ";return" ("+this.evaluateNodeToWhereClause(i.left,t,n,T.BADNESS,r)+" "+i.operator+" "+this.evaluateNodeToWhereClause(i.right,t,n,T.BADNESS,r)+") ";case"<":case">":case">=":case"<=":case"*":case"-":case"+":case"/":case"||":return" ("+this.evaluateNodeToWhereClause(i.left,t,n,T.BADNESS,r)+" "+i.operator+" "+this.evaluateNodeToWhereClause(i.right,t,n,T.BADNESS,r)+") "}case"null":return"null";case"boolean":return i.value===!0?"1":"0";case"string":return"'"+i.value.toString().replaceAll("'","''")+"'";case"timestamp":return`timestamp '${i.value}'`;case"date":return`date '${i.value}'`;case"time":return`time '${i.value}'`;case"number":return i.value.toString();case"current-time":return Nt(i.mode,t);case"current-user":return"CURRENT_USER";case"column-reference":return n&&n.toLowerCase()===i.column.toLowerCase()?"("+l+")":St(i);case"data-type":return i.value;case"function":{const e=this.evaluateNodeToWhereClause(i.args,t,n,T.BADNESS,r);return Tt(i.name,e,t)}}throw new L("UnsupportedSyntax",{node:i.type})}extractValue(i){if(this.codefield instanceof w){const t=this.codefield.calculateValueCompiled(i);return this._codeToString[w.convertValueToStorageFormat(t)]}return this._codeToString[i.attributes[this.codefield]]}};T.BADNESS="_!!!_BAD_LKP_!!!!";let we=T;class G extends fe{constructor(i,t){super(i),this._sql=t}rewriteSql(i,t){return{rewritten:!0,where:de(i,this.field.name,X(this._sql,0),t.getFieldsIndex())}}extractValue(i){return w.convertValueToStorageFormat(this._sql.calculateValueCompiled(i),this.field.type)}}class B extends ce{static findField(i,t){for(const n of i)if(n.name.toLowerCase()===t.toString().toLowerCase())return n;return null}constructor(i){super(),this.declaredClass="esri.arcade.featureset.actions.Adapted",this._maxProcessing=30,this._parent=i.parentfeatureset,this._adaptedFields=i.adaptedFields,this._extraFilter=i.extraFilter}_initialiseFeatureSet(){this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types,this.fields=[];for(const i of this._adaptedFields)i.postInitialization(this,this._parent),this.fields.push(i.field)}async _queryAll(){return await this._ensureLoaded(),this._extraFilter?(await this.query({abortSignal:ee})).features:this._calculateFields(await this._parent.queryAll(ee))}async query(i){let t=i.where??null;const n=this._reformulateWithoutAdaptions(t),l=n.cannot;t=n.where;let r=!1,e=i.orderBy;if(e!=null){r=!0;const s=[];for(const d of this._adaptedFields)if(!(d instanceof J)&&e.scanForField(d.field.name)===!0){if(!(d instanceof Y)){e=null,r=!1;break}s.push({field:d.field.name,newfield:d.originalField.name})}e&&s.length>0&&(e=e.replaceFields(s))}t!=null?this._extraFilter!=null&&(t=se(this._extraFilter,t)):t=this._extraFilter,await this._ensureLoaded();const a=await this._parent.query({...i,where:t,orderBy:e});return te(i.abortSignal),l?{...a,filterApplied:!1,ordered:!!r&&a.ordered,features:this._calculateFields(a.features)}:{...a,ordered:!!r&&a.ordered,features:this._calculateFields(a.features)}}async*_calculateFields(i){for await(const t of i)yield t.map(n=>{const l={};for(const r of this._adaptedFields)l[r.field.name]=r.extractValue(n);return{attributes:l,geometry:n.geometry}})}async queryStat(i){let t=!1,n=i.field,l=this._reformulateWithoutAdaptions(n);t=l.cannot,n=l.where;let r=i.where??null;if(l=this._reformulateWithoutAdaptions(r),t=t||l.cannot,r=l.where,r!=null?this._extraFilter!==null&&(r=se(this._extraFilter,r)):r=this._extraFilter,t)return r==null&&i.spatialFilter==null?this._manualStat(i.stat,n,i.limit??ge,i.abortSignal):{calculated:!1};const e=await this._parent.queryStat({...i,field:n,where:r});return e.calculated?e:r==null&&i.spatialFilter==null?this._manualStat(i.stat,n,i.limit??ge,i.abortSignal):{calculated:!1}}async canQueryAggregate(i){for(const r of i.groupBy)for(const e of this._adaptedFields)if(r.toLowerCase()===e.field.name.toLowerCase()&&!(e instanceof J))return!1;const t=[];for(const r of i.statistics)if(r.workingexpr!==null){const e=this._reformulateWithoutAdaptions(r.workingexpr);if(e.cannot)return!1;const a=r.clone();a.workingexpr=e.where,t.push(a)}else t.push(r);let n=i.where??null;const l=this._reformulateWithoutAdaptions(n);return!l.cannot&&(n=l.where,n!==null?this._extraFilter!==null&&(n=se(this._extraFilter,n)):n=this._extraFilter,this._parent.canQueryAggregate({...i,statistics:t,where:n}))}async queryAggregate(i){const t=[];for(const r of i.statistics)if(r.workingexpr!==null){const e=this._reformulateWithoutAdaptions(r.workingexpr);if(e.cannot)throw new j("NeverReach");const a=r.clone();a.workingexpr=e.where,t.push(a)}else t.push(r);let n=i.where??null;const l=this._reformulateWithoutAdaptions(n);if(l.cannot)throw new j("NeverReach");return n=l.where,n!==null?this._extraFilter!==null&&(n=se(this._extraFilter,n)):n=this._extraFilter,this._parent.queryAggregate({...i,statistics:t,where:n})}_reformulateWithoutAdaptions(i){const t={cannot:!1,where:i};if(i!==null){for(const n of this._adaptedFields)if(He(i,n.field.name)===!0){const l=n.rewriteSql(i,this);if(l.rewritten!==!0){t.cannot=!0,t.where=null;break}t.where=l.where}}return t}}let Fe=class extends ce{constructor(i){super(),this.declaredClass="esri.arcade.featureset.actions.OrderBy",this._maxProcessing=100,this._parent=i.parentfeatureset,this._orderByClause=i.orderbyclause}async _queryAll(){return(await this.query({abortSignal:ee})).features}async query(i){await this._ensureLoaded();const t=await this._parent.query({...i,orderBy:i.orderBy==null?this._orderByClause:i.orderBy});return te(i.abortSignal),t.ordered===!1?{...t,ordered:!0,features:this._sortFeatures(t.features,i.abortSignal)}:t}async*_sortFeatures(i,t){const n=[];for await(const r of i)n.push(r),await ze(),te(t);const l=n.flat();this._orderByClause.order(l);for(const r of Xe(l,this._maxQueryRate()))yield r}async queryStat(i){const t=await this._parent.queryStat(i);return t.calculated?t:i.where==null&&i.spatialFilter==null?this._manualStat(i.stat,i.field,i.limit??ge,i.abortSignal):{calculated:!1}}async canQueryAggregate(i){return this._parent.canQueryAggregate(i)}async queryAggregate(i){return this._parent.queryAggregate(i)}getFieldsIndex(){return this._parent.getFieldsIndex()}};function Pe(o,i){return o===i?0:o===null?-1:i===null?1:o<i?-1:1}class ie{constructor(i){const t=i.split(",");this._fields=[],this._directions=[];for(let n=0;n<t.length;n++){const l=t[n].match(/\S+/g);this._fields.push(l[0]),l.length===2?l[1].toLowerCase()==="asc"?this._directions.push(1):this._directions.push(0):this._directions.push(1)}}constructClause(){let i="";for(let t=0;t<this._fields.length;t++)t!==0&&(i+=","),i+=this._fields[t],this._directions[t]===1?i+=" ASC":i+=" DESC";return i}order(i){i.sort((t,n)=>{for(let l=0;l<this._fields.length;l++){const r=this.featureValue(t,this._fields[l],l),e=this.featureValue(n,this._fields[l],l);let a=0;if(a=this._directions[l]===1?Pe(r,e):-1*Pe(r,e),a!==0)return a}return 0})}scanForField(i){for(let t=0;t<this._fields.length;t++)if(this._fields[t].toLowerCase().trim()===i.toLowerCase().trim())return!0;return!1}replaceFields(i){let t="";for(let n=0;n<this._fields.length;n++){n!==0&&(t+=",");let l=this._fields[n];for(const r of i)if(l.toLowerCase()===r.field.toLowerCase()){l=r.newfield;break}t+=l,this._directions[n]===1?t+=" ASC":t+=" DESC"}return new ie(t)}featureValue(i,t,n){const l=i.attributes[t];if(l!==void 0)return l;for(const r in i.attributes)if(t.toLowerCase()===r.toLowerCase())return this._fields[n]=r,i.attributes[r];return null}}function kt(o){if(o.parseTree.type==="function"){if(o.parseTree.args.value.length===0)return{name:o.parseTree.name,expr:null};if(o.parseTree.args.value.length>1)throw new L("MissingStatisticParameters");const i=w.create(xt(o.parseTree.args.value[0],0,o.parameters),{fieldsIndex:o.fieldsIndex,timeZone:o.timeZone,currentUser:o.currentUser});return{name:o.parseTree.name,expr:i}}return null}class ne{constructor(){this.field="",this.tofieldname="",this.typeofstat="MIN",this.workingexpr=null}clone(){const i=new ne;return i.field=this.field,i.tofieldname=this.tofieldname,i.typeofstat=this.typeofstat,i.workingexpr=this.workingexpr,i}static parseStatField(i,t,n,l){const r=new ne;r.field=i;const e=w.create(t,{fieldsIndex:n,timeZone:l}),a=kt(e);if(a===null)throw new L("UnsupportedSqlFunction",{function:""});const s=a.name.toUpperCase().trim();if(s==="MIN"){if(r.typeofstat="MIN",r.workingexpr=a.expr,e===null)throw new L("InvalidFunctionParameters",{function:"min"})}else if(s==="MAX"){if(r.typeofstat="MAX",r.workingexpr=a.expr,e===null)throw new L("InvalidFunctionParameters",{function:"max"})}else if(s==="COUNT")r.typeofstat="COUNT",r.workingexpr=a.expr;else if(s==="STDEV"){if(r.typeofstat="STDDEV",r.workingexpr=a.expr,e===null)throw new L("InvalidFunctionParameters",{function:"stdev"})}else if(s==="SUM"){if(r.typeofstat="SUM",r.workingexpr=a.expr,e===null)throw new L("InvalidFunctionParameters",{function:"sum"})}else if(s==="MEAN"){if(r.typeofstat="AVG",r.workingexpr=a.expr,e===null)throw new L("InvalidFunctionParameters",{function:s})}else if(s==="AVG"){if(r.typeofstat="AVG",r.workingexpr=a.expr,e===null)throw new L("InvalidFunctionParameters",{function:"avg"})}else{if(s!=="VAR")throw new L("UnsupportedSqlFunction",{function:s});if(r.typeofstat="VAR",r.workingexpr=a.expr,e===null)throw new L("InvalidFunctionParameters",{function:"var"})}return r}toStatisticsName(){switch(this.typeofstat.toUpperCase()){case"MIN":return"min";case"MAX":return"max";case"SUM":return"sum";case"COUNT":default:return"count";case"VAR":return"var";case"STDDEV":return"stddev";case"AVG":return"avg"}}}const Wt=new Ge(["MIN","MAX","VAR","STDDEV","COUNT","SUM","AVG"],[["VARIANCE","VAR"],["AVERAGE","AVG"],["MEAN","AVG"],["STDEV","STDDEV"]]);class je extends ce{constructor(i){super(),this.declaredClass="esri.arcade.featureset.actions.Aggregate",this._decodedStatsFields=[],this._decodedGroupByFields=[],this._canDoSimpleGroupBy=!0,this._physicalGroupByFields=[],this.objectIdField="ROW__ID",this._adaptedFields=[],this._uniqueIds=1,this._maxQuery=10,this._maxProcessing=10,this._parent=i.parentfeatureset,this._config=i}isTable(){return!0}_nextUniqueName(i){for(;i["T"+this._uniqueIds.toString()]===1;)this._uniqueIds++;const t="T"+this._uniqueIds.toString();return i[t]=1,t}_convertToEsriFieldType(i){return i}_initialiseFeatureSet(){const i=this._parent.getFieldsIndex();this.objectIdField="ROW__ID",this.globalIdField="";let t=!1,n=1;for(;t===!1;){let e=!1;for(const a of this._config.groupbyfields)if(a.name.toLowerCase()===this.objectIdField.toLowerCase()){e=!0;break}if(e===!1){for(const a of this._config.statsfields)if(a.name.toLowerCase()===this.objectIdField.toLowerCase()){e=!0;break}}e===!1?t=!0:(this.objectIdField="ROW__ID"+n.toString(),n++)}for(const e of this._config.statsfields){const a=new ne;a.field=e.name,a.tofieldname=e.name,a.workingexpr=e.expression instanceof w?e.expression:w.create(e.expression,{fieldsIndex:i,timeZone:this.dateFieldsTimeZoneDefaultUTC}),a.typeofstat=Wt.lookup(e.statistic)??"COUNT",this._decodedStatsFields.push(a)}this._decodedGroupByFields=[];for(const e of this._config.groupbyfields){const a={name:e.name,singlefield:null,tofieldname:e.name,expression:e.expression instanceof w?e.expression:w.create(e.expression,{fieldsIndex:i,timeZone:this.dateFieldsTimeZoneDefaultUTC}),sqlType:null};this._decodedGroupByFields.push(a)}const l={};this.geometryType=this._parent.geometryType,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField="";for(const e of this._parent.fields)l[e.name.toUpperCase()]=1;this.types=null,this.subtypes=null,this.subtypeField="",this.fields=[];const r=new ne;r.field=this._nextUniqueName(l),r.tofieldname=this.objectIdField,r.workingexpr=w.create(this._parent.objectIdField,{fieldsIndex:this._parent.getFieldsIndex(),timeZone:this.dateFieldsTimeZoneDefaultUTC}),r.typeofstat="MIN",this._decodedStatsFields.push(r);for(const e of this._decodedGroupByFields){const a=new E;if(e.name=this._nextUniqueName(l),a.name=e.tofieldname,a.alias=a.name,ue(e.expression)){const s=this._parent.getField(X(e.expression,0));if(!s)throw new j("AggregationFieldNotFound");e.name=s.name,e.singlefield=s.name,this._physicalGroupByFields.push(s.name),a.type=s.type,e.sqlType=s.type}else{a.type=this._convertToEsriFieldType(_t(e.expression,this._parent.fields));const s=new E;s.name=e.name,s.alias=s.name,this._physicalGroupByFields.push(e.name),this._adaptedFields.push(new G(s,e.expression)),this._canDoSimpleGroupBy=!1,e.sqlType=a.type}this.fields.push(a)}if(this._adaptedFields.length>0)for(const e of this._parent.fields)this._adaptedFields.push(new J(e));for(const e of this._decodedStatsFields){const a=new E;let s=null;e.field=this._nextUniqueName(l),a.name=e.tofieldname,a.alias=a.name;const d=e.workingexpr!==null&&ue(e.workingexpr)?X(e.workingexpr,0):"";switch(e.typeofstat){case"SUM":if(d!==""){if(s=this._parent.getField(d),!s)throw new j("AggregationFieldNotFound");a.type=s.type}else a.type="double";break;case"MIN":case"MAX":if(d!==""){if(s=this._parent.getField(d),!s)throw new j("AggregationFieldNotFound");a.type=s.type}else a.type="double";break;case"COUNT":a.type="integer";break;case"STDDEV":case"VAR":case"AVG":if(d!==""&&(s=this._parent.getField(d),!s))throw new j("AggregationFieldNotFound");a.type="double"}this.fields.push(a)}}async _queryAll(){return(await this.query({abortSignal:ee})).features}async query(i){if(i.spatialFilter!=null)return At;const t={ordered:!1,nowhereclause:!1};await this._ensureLoaded();let n=i.where;if(n!=null){for(const s of this._decodedStatsFields)if(He(n,s.tofieldname)===!0){t.nowhereclause=!0,n=null;break}}let l=i.orderBy;if(l!=null){t.ordered=!0;for(const s of this._decodedStatsFields)if(l.scanForField(s.tofieldname)===!0){l=null,t.ordered=!1;break}if(l!==null){for(const s of this._decodedGroupByFields)if(s.singlefield===null&&l.scanForField(s.tofieldname)===!0){l=null,t.ordered=!1;break}}}if(this._canDoSimpleGroupBy!==!1&&await this._parent.canQueryAggregate({groupBy:this._physicalGroupByFields,statistics:this._decodedStatsFields,where:null,spatialFilter:null,abortSignal:i.abortSignal})){const s=await this._parent.queryAggregate({groupBy:this._physicalGroupByFields,statistics:this._decodedStatsFields,where:n?this._reformulateWhereClauseWithoutGroupByFields(n):null,spatialFilter:null,orderBy:l?this._reformulateOrderClauseWithoutGroupByFields(l):null,abortSignal:i.abortSignal});return te(i.abortSignal),{...s,filterApplied:!t.nowhereclause&&s.filterApplied,ordered:t.ordered===!0&&s.ordered,features:this._fixAggregateAttributeNames(s.features)}}const r=this._adaptedFields.length>0?new B({parentfeatureset:this._parent,adaptedFields:this._adaptedFields,extraFilter:null}):this._parent;if(t.nowhereclause===!0){const s=new Fe({parentfeatureset:r,orderbyclause:new ie(this._physicalGroupByFields.join(",")+","+this._parent.objectIdField+" ASC")});return{filterApplied:!1,spatialFilterApplied:!1,ordered:!1,features:this._aggregateSortedFeatureGroups((await s.query({abortSignal:i.abortSignal})).features,this._maxQuery,i.abortSignal)}}let e=r;n!=null&&(e=new Q({parentfeatureset:e,whereclause:this._reformulateWhereClauseWithoutGroupByFields(n)}));const a=new Fe({parentfeatureset:e,orderbyclause:new ie(this._physicalGroupByFields.join(",")+","+this._parent.objectIdField+" ASC")});return{filterApplied:!1,spatialFilterApplied:!1,ordered:!1,features:this._aggregateSortedFeatureGroups((await a.query({abortSignal:i.abortSignal})).features,this._maxQuery,i.abortSignal)}}async*_fixAggregateAttributeNames(i){for await(const t of i)yield t.map(n=>{const l={geometry:n.geometry,attributes:{}},r={};for(const e in n.attributes)r[e.toLowerCase()]=n.attributes[e];for(const e of this._decodedGroupByFields)l.attributes[e.tofieldname]=r[e.name.toLowerCase()];for(const e of this._decodedStatsFields)l.attributes[e.tofieldname]=r[e.field.toLowerCase()];return l})}async*_aggregateSortedFeatureGroups(i,t,n){let l=null,r=[];for await(const e of i){await ze(),te(n);for(const a of e){const s=this._generateAggregateHash(a);l==null?l={features:[a],id:s}:s!==l.id?(r.push(this._calculateAndAppendAggregateItem(l)),l={features:[a],id:s}):l.features.push(a)}r.length>=t&&(yield r,r=[])}l!=null&&(r.push(this._calculateAndAppendAggregateItem(l)),yield r)}async queryStat(i){return{calculated:!1}}async canQueryAggregate(i){return!1}async queryAggregate(i){throw new j("NeverReach")}_reformulateWhereClauseWithoutStatsFields(i){for(const t of this._decodedStatsFields)i=de(i,t.tofieldname,X(t.workingexpr,0),this._parent.getFieldsIndex());return i}_reformulateWhereClauseWithoutGroupByFields(i){for(const t of this._decodedGroupByFields)t.tofieldname!==t.name&&(i=de(i,t.tofieldname,X(t.expression,0),this._parent.getFieldsIndex()));return i}_reformulateOrderClauseWithoutGroupByFields(i){const t=[];for(const n of this._decodedGroupByFields)n.tofieldname!==n.name&&t.push({field:n.tofieldname,newfield:n.name});return t.length>0?i.replaceFields(t):i}_calculateFieldStat(i,t,n){const l=[];for(const r of i.features)if(t.workingexpr!==null){const e=t.workingexpr.calculateValue(r);e!==null&&(e instanceof Je||e instanceof Ye?l.push(e.toNumber()):e instanceof Ct?l.push(e.toMilliseconds()):l.push(e))}else l.push(null);n.attributes[t.tofieldname]=vt(t.typeofstat,[l])}_calculateAndAppendAggregateItem(i){const t={attributes:{}};for(const n of this._decodedGroupByFields){const l=n.singlefield?i.features[0].attributes[n.singlefield]:w.convertValueToStorageFormat(n.expression.calculateValue(i.features[0]),n.sqlType);t.attributes[n.tofieldname]=l}for(const n of this._decodedStatsFields)this._calculateFieldStat(i,n,t);return t}_generateAggregateHash(i){let t="";for(const n of this._decodedGroupByFields){const l=n.singlefield?i.attributes[n.singlefield]:n.expression.calculateValue(i);t+=l==null?":":":"+l.toString()}return et(t,tt.String)}async getFeatureByObjectId(){throw new j("NotImplemented")}}async function*Bt(o,i){let t=i;for await(const n of o)if(t>=n.length?(t-=n.length,yield n):(yield n.slice(0,t),t=0),t<=0)break}class Ut extends ce{constructor(i){super(),this.declaredClass="esri.arcade.featureset.actions.Top",this._maxProcessing=100,this._parent=i.parentfeatureset,this._limit=i.topnum}async _queryAll(){return(await this.query({abortSignal:ee})).features}async query(i){await this._ensureLoaded();const t=await this._parent.queryAll(i.abortSignal);return{filterApplied:i.where==null,spatialFilterApplied:i.spatialFilter==null,ordered:!1,features:Bt(t,this._limit)}}async queryStat(i){return{calculated:!1}}async canQueryAggregate(i){return!1}async queryAggregate(i){throw new j("NeverReach")}getFieldsIndex(){return this._parent.getFieldsIndex()}}function Zt(o){if(o.length===1){if(v(o[0]))return pe("distinct",o[0],-1);if(V(o[0]))return pe("distinct",o[0].toArray(),-1)}return pe("distinct",o,-1)}function ye(o,i,t){const n=o.getVariables();if(n.length>0){const l={};for(const r of n)l[r]=i.evaluateIdentifier(t,{name:r});o.parameters=l}return o}function p(o,i,t=null){for(const n in o)if(n.toLowerCase()===i.toLowerCase())return o[n];return t}function Oe(o){if(o===null)return null;const i={type:p(o,"type",""),name:p(o,"name","")};if(i.type==="range")i.range=p(o,"range",[]);else{i.codedValues=[];for(const t of p(o,"codedValues",[]))i.codedValues.push({name:p(t,"name",""),code:p(t,"code",null)})}return i}function Ie(o){if(o===null)return null;const i={},t=p(o,"wkt");t!==null&&(i.wkt=t);const n=p(o,"wkid");return n!==null&&(i.wkid=n),i}function $e(o){if(o===null)return null;const i={hasZ:p(o,"hasz",!1),hasM:p(o,"hasm",!1)},t=p(o,"spatialreference");t!=null&&(i.spatialReference=Ie(t));const n=p(o,"x",null);if(n!==null)return i.x=n,i.y=p(o,"y",null),i.hasZ&&(i.z=p(o,"z",null)),i.hasM&&(i.m=p(o,"m",null)),i;const l=p(o,"rings",null);if(l!==null)return i.rings=l,i;const r=p(o,"paths",null);if(r!==null)return i.paths=r,i;const e=p(o,"points",null);if(e!==null)return i.points=e,i;for(const a of["xmin","xmax","ymin","ymax","zmin","zmax","mmin","mmax"]){const s=p(o,a,null);s!==null&&(i[a]=s)}return i}function Rt(o,i){for(const t of i)if(t===o)return!0;return!1}function qt(o){return!!o.layerDefinition&&!!o.featureSet&&Rt(o.layerDefinition.geometryType,["",null,"esriGeometryNull","esriGeometryPoint","esriGeometryPolyline","esriGeometryPolygon","esriGeometryMultipoint","esriGeometryEnvelope"])!==!1&&v(o.layerDefinition.fields)!==!1&&v(o.featureSet.features)!==!1}function K(o){return(o==null?void 0:o.toLowerCase())==="utc"?"UTC":(o==null?void 0:o.toLowerCase())==="unknown"?"Unknown":o}async function Mt(o,i,t,n,l,r,e){var f,y,b;const a=await o.getFeatureSetInfo();if(((a==null?void 0:a.layerId)??null)===null||!l.layerIdLookup.get(a.layerId))return null;const s=o.serviceUrl().replace(/\/FeatureServer/i,"/UtilityNetworkServer"),d=[];switch(t){case"connected":d.push("connectivity"),d.push("junction-edge-from-connectivity"),d.push("junction-edge-to-connectivity"),d.push("junction-edge-midspan-connectivity"),d.push("junction-junction-connectivity");break;case"container":case"content":d.push("containment");break;case"structure":case"attached":d.push("attachment");break;case"junctionedge":d.push("junction-edge-from-connectivity"),d.push("junction-edge-to-connectivity");break;case"midspan":d.push("junction-edge-midspan-connectivity");break;default:throw new g(r,"InvalidParameter",e)}let m=null,h=!1;if(n!==null&&n!==""&&n!==void 0){for(const F of l.terminals)F.terminalName===n&&(m=F.terminalId);m===null&&(h=!0)}const c=[];if(!h){const F=new st({globalId:i.field(o.globalIdField),networkSourceId:l.layerIdLookup.get(a.layerId).sourceId,...m?{terminalId:m}:""}),N=await Dt(s,new Lt({types:d,elements:[F]}));let x=0;for(const C of N.associations){let q=null,M="",k="";if(((f=C.fromNetworkElement)==null?void 0:f.globalId)===F.globalId?(q=C.toNetworkElement,k="to"):((y=C.toNetworkElement)==null?void 0:y.globalId)===F.globalId&&(q=C.fromNetworkElement,k="from"),!q)continue;switch(t){case"attached":if(C.associationType!=="attachment"||k!=="to")continue;break;case"structure":if(C.associationType!=="attachment"||k!=="from")continue;break;case"container":if(C.associationType!=="containment"||k!=="from")continue;break;case"content":if(C.associationType!=="containment"||k!=="to")continue;break;case"connected":break;case"junctionedge":C.associationType==="junction-edge-to-connectivity"?M="to":C.associationType==="junction-edge-from-connectivity"&&(M="from");break;case"midspan":if(C.associationType!=="junction-edge-midspan-connectivity")continue}const P=((b=l.sourceIdLookup.get(q.networkSourceId))==null?void 0:b.className)??"";c.push(new ot({geometry:null,attributes:{objectId:x++,globalId:q.globalId,percentAlong:C.percentAlong??0,isContentVisible:C.isContentVisible?0:1,className:P,side:M}}))}}const u=new Ve({source:c,geometryType:null,objectIdField:"objectId",globalIdField:"globalId",fields:[new E({name:"objectId",alias:"objectId",type:"oid"}),new E({name:"globalId",alias:"globalId",type:"global-id"}),new E({name:"percentAlong",alias:"percentAlong",type:"double"}),new E({name:"side",alias:"side",type:"string"}),new E({name:"isContentVisible",alias:"isContentVisible",type:"integer"}),new E({name:"className",alias:"className",type:"string"})]});return oe(u)}function mi(o){if(o.mode==="async"){o.functions.timezone=function(t,n){return o.standardFunctionAsync(t,n,async(l,r,e)=>{var d,m;if(_(e,1,2,t,n),dt(e[0])||me(e[0]))return"Unknown";if(D(e[0])){if(await e[0].load(),e.length===1||e[1]===null)return e[0].datesInUnknownTimezone?K("unknown"):K(e[0].dateFieldsTimeZone);if(!(e[1]instanceof R)||e[1].hasField("type")===!1)throw new g(t,"InvalidParameter",n);const h=e[1].field("type");if(U(h)===!1)throw new g(t,"InvalidParameter",n);switch(A(h).toLowerCase()){case"preferredtimezone":return K(e[0].preferredTimeZone);case"editfieldsinfo":return K(((d=e[0].editFieldsInfo)==null?void 0:d.timeZone)??null);case"timeinfo":return K(((m=e[0].timeInfo)==null?void 0:m.timeZone)??null);case"field":if(e[1].hasField("fieldname")&&U(e[1].field("fieldname")))return K(e[0].fieldTimeZone(A(e[1].field("fieldname"))))}throw new g(t,"InvalidParameter",n)}const a=ut(e[0],Ae(t));if(a===null)return null;const s=a.timeZone;return s==="system"?it.systemTimeZoneCanonicalName:s.toLowerCase()==="utc"?"UTC":s.toLowerCase()==="unknown"?"Unknown":s})},o.functions.sqltimestamp=function(t,n){return o.standardFunctionAsync(t,n,async(l,r,e)=>{_(e,1,3,t,n);const a=e[0];if(Ce(a)){if(e.length===1)return a.toSQLWithKeyword();if(e.length===2)return a.changeTimeZone(A(e[1])).toSQLWithKeyword();throw new g(t,"InvalidParameter",n)}if(me(a))return a.toSQLWithKeyword();if(D(a)){if(e.length!==3)throw new g(t,"InvalidParameter",n);await a.load();const s=A(e[1]);if(me(e[2]))return e[2].toSQLWithKeyword();if(Ce(e[2])===!1)throw new g(t,"InvalidParameter",n);const d=a.fieldTimeZone(s);return d==null?e[2].toSQLWithKeyword():e[2].changeTimeZone(d).toSQLWithKeyword()}throw new g(t,"InvalidParameter",n)})},o.signatures.push({name:"sqltimestamp",min:2,max:4}),o.functions.featuresetbyid=function(t,n){return o.standardFunctionAsync(t,n,(l,r,e)=>{if(_(e,2,4,t,n),ve(e[0])){const a=A(e[1]);let s=Z(e[2],null);const d=z(Z(e[3],!0));if(s===null&&(s=["*"]),v(s)===!1)throw new g(t,"InvalidParameter",n);return e[0].featureSetById(a,d,s)}throw new g(t,"InvalidParameter",n)})},o.signatures.push({name:"featuresetbyid",min:2,max:4});const i=new Ge(["datasource","parent","root"]);o.functions.getfeatureset=function(t,n){return o.standardFunctionAsync(t,n,async(l,r,e)=>{if(_(e,1,2,t,n),ae(e[0])){const a=e[1]==null?"datasource":i.lookup(A(e[1]));return pt(e[0].fullSchema(),a,t.lrucache,t.interceptor,t.spatialReference)}throw new g(t,"InvalidParameter",n)})},o.signatures.push({name:"getfeatureset",min:1,max:2}),o.functions.featuresetbyportalitem=function(t,n){return o.standardFunctionAsync(t,n,(l,r,e)=>{var h,c;if(_(e,2,5,t,n),e[0]===null)throw new g(t,"PortalRequired",n);if(e[0]instanceof lt){const u=A(e[1]),f=A(e[2]);let y=Z(e[3],null);const b=z(Z(e[4],!0));if(y===null&&(y=["*"]),v(y)===!1)throw new g(t,"InvalidParameter",n);let F;return F=(h=t.services)!=null&&h.portal?t.services.portal:_e.getDefault(),F=It(e[0],F),Ee(u,f,t.spatialReference,y,b,F,t.lrucache,t.interceptor)}if(U(e[0])===!1)throw new g(t,"PortalRequired",n);const a=A(e[0]),s=A(e[1]);let d=Z(e[2],null);const m=z(Z(e[3],!0));if(d===null&&(d=["*"]),v(d)===!1)throw new g(t,"InvalidParameter",n);return Ee(a,s,t.spatialReference,d,m,((c=t.services)==null?void 0:c.portal)??_e.getDefault(),t.lrucache,t.interceptor)})},o.signatures.push({name:"featuresetbyportalitem",min:2,max:5}),o.functions.featuresetbyname=function(t,n){return o.standardFunctionAsync(t,n,(l,r,e)=>{if(_(e,2,4,t,n),ve(e[0])){const a=A(e[1]);let s=Z(e[2],null);const d=z(Z(e[3],!0));if(s===null&&(s=["*"]),v(s)===!1)throw new g(t,"InvalidParameter",n);return e[0].featureSetByName(a,d,s)}throw new g(t,"InvalidParameter",n)})},o.signatures.push({name:"featuresetbyname",min:2,max:4}),o.functions.featureset=function(t,n){return o.standardFunction(t,n,(l,r,e)=>{_(e,1,1,t,n);const a={layerDefinition:{geometryType:"",objectIdField:"",globalIdField:"",typeIdField:"",hasM:!1,hasZ:!1,fields:[]},featureSet:{geometryType:"",features:[]}};if(U(e[0])){const s=JSON.parse(e[0]);s.layerDefinition!==void 0?(a.layerDefinition=s.layerDefinition,a.featureSet=s.featureSet,s.layerDefinition.spatialReference&&(a.layerDefinition.spatialReference=s.layerDefinition.spatialReference)):(a.featureSet.features=s.features,a.featureSet.geometryType=s.geometryType,a.layerDefinition.geometryType=a.featureSet.geometryType,a.layerDefinition.objectIdField=s.objectIdFieldName??"",a.layerDefinition.typeIdField=s.typeIdFieldName,a.layerDefinition.globalIdField=s.globalIdFieldName,a.layerDefinition.fields=s.fields,s.spatialReference&&(a.layerDefinition.spatialReference=s.spatialReference))}else{if(!(e[0]instanceof R))throw new g(t,"InvalidParameter",n);{const s=JSON.parse(e[0].castToText(!0)),d=p(s,"layerdefinition");if(d!==null){a.layerDefinition.geometryType=p(d,"geometrytype",""),a.featureSet.geometryType=a.layerDefinition.geometryType,a.layerDefinition.globalIdField=p(d,"globalidfield",""),a.layerDefinition.objectIdField=p(d,"objectidfield",""),a.layerDefinition.typeIdField=p(d,"typeidfield",""),a.layerDefinition.hasZ=p(d,"hasz",!1)===!0,a.layerDefinition.hasM=p(d,"hasm",!1)===!0;const m=p(d,"spatialreference");m&&(a.layerDefinition.spatialReference=Ie(m));const h=[];for(const u of p(d,"fields",[])){const f={name:p(u,"name",""),alias:p(u,"alias",""),type:p(u,"type",""),nullable:p(u,"nullable",!0),editable:p(u,"editable",!0),length:p(u,"length",null),domain:Oe(p(u,"domain"))};h.push(f)}a.layerDefinition.fields=h;const c=p(s,"featureset");if(c){const u={};for(const f of h)u[f.name.toLowerCase()]=f.name;for(const f of p(c,"features",[])){const y={},b=p(f,"attributes",{});for(const F in b)y[u[F.toLowerCase()]]=b[F];a.featureSet.features.push({attributes:y,geometry:$e(p(f,"geometry"))})}}}else{a.layerDefinition.hasZ=p(s,"hasz",!1)===!0,a.layerDefinition.hasM=p(s,"hasm",!1)===!0,a.layerDefinition.geometryType=p(s,"geometrytype",""),a.featureSet.geometryType=a.layerDefinition.geometryType,a.layerDefinition.objectIdField=p(s,"objectidfieldname",""),a.layerDefinition.typeIdField=p(s,"typeidfieldname","");const m=p(s,"spatialreference");m&&(a.layerDefinition.spatialReference=Ie(m));const h=[],c=p(s,"fields",null);if(!v(c))throw new g(t,"InvalidParameter",n);for(const y of c){const b={name:p(y,"name",""),alias:p(y,"alias",""),type:p(y,"type",""),nullable:p(y,"nullable",!0),editable:p(y,"editable",!0),length:p(y,"length",null),domain:Oe(p(y,"domain"))};h.push(b)}a.layerDefinition.fields=h;const u={};for(const y of h)u[y.name.toLowerCase()]=y.name;let f=p(s,"features",null);if(v(f))for(const y of f){const b={},F=p(y,"attributes",{});for(const N in F)b[u[N.toLowerCase()]]=F[N];a.featureSet.features.push({attributes:b,geometry:$e(p(y,"geometry",null))})}else f=null,a.featureSet.features=f}}}if(qt(a)===!1)throw new g(t,"InvalidParameter",n);return a.layerDefinition.geometryType||(a.layerDefinition.geometryType="esriGeometryNull"),mt.create(a,t.spatialReference)})},o.signatures.push({name:"featureset",min:1,max:1}),o.functions.filter=function(t,n){return o.standardFunctionAsync(t,n,async(l,r,e)=>{if(_(e,2,2,t,n),v(e[0])||V(e[0])){const a=[];let s,d=e[0];if(d instanceof Ft&&(d=d.toArray()),!ct(e[1]))throw new g(t,"InvalidParameter",n);s=e[1].createFunction(t);for(const m of d){const h=s(m);nt(h)?await h===!0&&a.push(m):h===!0&&a.push(m)}return a}if(D(e[0])){const a=await e[0].load(),s=w.create(e[1],{fieldsIndex:a.getFieldsIndex(),timeZone:a.dateFieldsTimeZoneDefaultUTC}),d=s.getVariables();if(d.length>0){const m={};for(const h of d)m[h]=o.evaluateIdentifier(t,{name:h});s.parameters=m}return new Q({parentfeatureset:e[0],whereclause:s})}throw new g(t,"InvalidParameter",n)})},o.signatures.push({name:"filter",min:2,max:2}),o.functions.orderby=function(t,n){return o.standardFunctionAsync(t,n,async(l,r,e)=>{if(_(e,2,2,t,n),D(e[0])){const a=new ie(e[1]);return new Fe({parentfeatureset:e[0],orderbyclause:a})}throw new g(t,"InvalidParameter",n)})},o.signatures.push({name:"orderby",min:2,max:2}),o.functions.top=function(t,n){return o.standardFunctionAsync(t,n,async(l,r,e)=>{if(_(e,2,2,t,n),D(e[0]))return new Ut({parentfeatureset:e[0],topnum:e[1]});if(v(e[0]))return H(e[1])>=e[0].length?e[0].slice():e[0].slice(0,H(e[1]));if(V(e[0]))return H(e[1])>=e[0].length()?e[0].slice():e[0].slice(0,H(e[1]));throw new g(t,"InvalidParameter",n)})},o.signatures.push({name:"top",min:2,max:2}),o.functions.first=function(t,n){return o.standardFunctionAsync(t,n,async(l,r,e)=>{if(_(e,1,1,t,n),D(e[0])){const a=await e[0].first(l.abortSignal);if(a!==null){const s=ht.createFromGraphicLikeObject(a.geometry,a.attributes,e[0],t.timeZone);return s._underlyingGraphic=a,s}return a}return v(e[0])?e[0].length===0?null:e[0][0]:V(e[0])?e[0].length()===0?null:e[0].get(0):null})},o.signatures.push({name:"first",min:1,max:1}),o.functions.attachments=function(t,n){return o.standardFunctionAsync(t,n,async(l,r,e)=>{_(e,1,2,t,n);const a={minsize:-1,maxsize:-1,types:null,returnMetadata:!1};if(e.length>1){if(e[1]instanceof R){if(e[1].hasField("minsize")&&(a.minsize=H(e[1].field("minsize"))),e[1].hasField("metadata")&&(a.returnMetadata=z(e[1].field("metadata"))),e[1].hasField("maxsize")&&(a.maxsize=H(e[1].field("maxsize"))),e[1].hasField("types")){const s=ft(e[1].field("types"),!1);s.length>0&&(a.types=s)}}else if(e[1]!==null)throw new g(t,"InvalidParameter",n)}if(ae(e[0])){const s=e[0]._layer;let d;if(D(s))d=s;else{if(s==null||!Me(s))return[];d=oe(s,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)}return await d.load(),d.queryAttachments(e[0].field(d.objectIdField),a.minsize,a.maxsize,a.types,a.returnMetadata)}if(e[0]===null)return[];throw new g(t,"InvalidParameter",n)})},o.signatures.push({name:"attachments",min:1,max:2}),o.functions.featuresetbyrelationshipname=function(t,n){return o.standardFunctionAsync(t,n,async(l,r,e)=>{_(e,2,4,t,n);const a=e[0],s=A(e[1]);let d=Z(e[2],null);const m=z(Z(e[3],!0));if(d===null&&(d=["*"]),v(d)===!1)throw new g(t,"InvalidParameter",n);if(e[0]===null)return null;if(!ae(e[0]))throw new g(t,"InvalidParameter",n);const h=a._layer;let c;if(D(h))c=h;else{if(h==null||!Me(h))return null;c=oe(h,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)}c=await c.load();const u=c.relationshipMetadata().filter(N=>N.name===s);if(u.length===0)return null;if(u[0].relationshipTableId!==void 0&&u[0].relationshipTableId!==null&&u[0].relationshipTableId>-1)return yt(c,u[0],a.field(c.objectIdField),c.spatialReference,d,m,t.lrucache,t.interceptor);let f=c.serviceUrl();if(!f)return null;f=f.endsWith("/")?f+u[0].relatedTableId.toString():f+"/"+u[0].relatedTableId.toString();const y=await gt(f,c.spatialReference,d,m,t.lrucache,t.interceptor);await y.load();let b=y.relationshipMetadata();if(b=b.filter(N=>N.id===u[0].id),a.hasField(u[0].keyField)===!1||a.field(u[0].keyField)===null){const N=await c.getFeatureByObjectId(a.field(c.objectIdField),[u[0].keyField]);if(N){const x=w.create(b[0].keyField+"= @id",{fieldsIndex:y.getFieldsIndex(),timeZone:y.dateFieldsTimeZoneDefaultUTC});return x.parameters={id:N.attributes[u[0].keyField]},new Q({parentfeatureset:y,whereclause:x})}return new Et({parentfeatureset:y})}const F=w.create(b[0].keyField+"= @id",{fieldsIndex:y.getFieldsIndex(),timeZone:y.dateFieldsTimeZoneDefaultUTC});return F.parameters={id:a.field(u[0].keyField)},new Q({parentfeatureset:y,whereclause:F})})},o.signatures.push({name:"featuresetbyrelationshipname",min:2,max:4}),o.functions.featuresetbyassociation=function(t,n){return o.standardFunctionAsync(t,n,async(l,r,e)=>{_(e,2,3,t,n);const a=e[0],s=at(A(Z(e[1],""))),d=U(e[2])?A(e[2]):null;if(e[0]===null)return null;if(!ae(e[0]))throw new g(t,"InvalidParameter",n);let m=a._layer;if(m instanceof Ve&&(m=oe(m,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)),m===null||D(m)===!1)return null;await m.load();const h=m.serviceUrl(),c=await wt(h,t.spatialReference,!0);if(c.unVersion>=8)return await Mt(m,a,s,d,c,t,n);const u=c.associations;let f=null,y=null,b=!1;if(d!==null&&d!==""&&d!==void 0){for(const S of c.terminals)S.terminalName===d&&(y=S.terminalId);y===null&&(b=!0)}const F=u.getFieldsIndex(),N=F.get("TOGLOBALID").name,x=F.get("FROMGLOBALID").name,C=F.get("TOTERMINALID").name,q=F.get("FROMTERMINALID").name,M=F.get("FROMNETWORKSOURCEID").name,k=F.get("TONETWORKSOURCEID").name,P=F.get("ASSOCIATIONTYPE").name,Ke=F.get("ISCONTENTVISIBLE").name,Qe=F.get("OBJECTID").name;for(const S of m.fields)if(S.type==="global-id"){f=a.field(S.name);break}let O=null,Te=new G(new E({name:"percentalong",alias:"percentalong",type:"double"}),w.create("0",{fieldsIndex:u.getFieldsIndex(),timeZone:u.dateFieldsTimeZoneDefaultUTC})),Se=new G(new E({name:"side",alias:"side",type:"string"}),w.create("''",{fieldsIndex:u.getFieldsIndex(),timeZone:u.dateFieldsTimeZoneDefaultUTC}));const W="globalid",Ne="globalId",be={};for(const S in c.lkp)be[S]=c.lkp[S].sourceId;const $=new we(new E({name:"classname",alias:"classname",type:"string"}),null,be);let I="";switch(s){case"midspan":{I=`((${N}='${f}') OR ( ${x}='${f}')) AND (${P} IN (5))`,$.codefield=w.create(`CASE WHEN (${N}='${f}') THEN ${M} ELSE ${k} END`,{fieldsIndex:u.getFieldsIndex(),timeZone:u.dateFieldsTimeZoneDefaultUTC});const S=le(B.findField(u.fields,x));S.name=W,S.alias=W,O=new G(S,w.create(`CASE WHEN (${x}='${f}') THEN ${N} ELSE ${x} END`,{fieldsIndex:u.getFieldsIndex(),timeZone:u.dateFieldsTimeZoneDefaultUTC})),Te=c.unVersion>=4?new J(B.findField(u.fields,F.get("PERCENTALONG").name)):new G(new E({name:"percentalong",alias:"percentalong",type:"double"}),w.create("0",{fieldsIndex:u.getFieldsIndex(),timeZone:u.dateFieldsTimeZoneDefaultUTC}));break}case"junctionedge":{I=`((${N}='${f}') OR ( ${x}='${f}')) AND (${P} IN (4,6))`,$.codefield=w.create(`CASE WHEN (${N}='${f}') THEN ${M} ELSE ${k} END`,{fieldsIndex:u.getFieldsIndex(),timeZone:u.dateFieldsTimeZoneDefaultUTC});const S=le(B.findField(u.fields,x));S.name=W,S.alias=W,O=new G(S,w.create(`CASE WHEN (${x}='${f}') THEN ${N} ELSE ${x} END`,{fieldsIndex:u.getFieldsIndex(),timeZone:u.dateFieldsTimeZoneDefaultUTC})),Se=new G(new E({name:"side",alias:"side",type:"string"}),w.create(`CASE WHEN (${P}=4) THEN 'from' ELSE 'to' END`,{fieldsIndex:u.getFieldsIndex(),timeZone:u.dateFieldsTimeZoneDefaultUTC}));break}case"connected":{let S=`${N}='@T'`,xe=`${x}='@T'`;y!==null&&(S+=` AND ${C}=@A`,xe+=` AND ${q}=@A`),I="(("+S+") OR ("+xe+"))",I=re(I,"@T",f??""),S=re(S,"@T",f??""),y!==null&&(S=re(S,"@A",y.toString()),I=re(I,"@A",y.toString())),$.codefield=w.create("CASE WHEN "+S+` THEN ${M} ELSE ${k} END`,{fieldsIndex:u.getFieldsIndex(),timeZone:u.dateFieldsTimeZoneDefaultUTC});const he=le(B.findField(u.fields,x));he.name=W,he.alias=W,O=new G(he,w.create("CASE WHEN "+S+` THEN ${x} ELSE ${N} END`,{fieldsIndex:u.getFieldsIndex(),timeZone:u.dateFieldsTimeZoneDefaultUTC}));break}case"container":I=`${N}='${f}' AND ${P} = 2`,y!==null&&(I+=` AND ${C} = `+y.toString()),$.codefield=M,I="( "+I+" )",O=new Y(B.findField(u.fields,x),W,W);break;case"content":I=`(${x}='${f}' AND ${P} = 2)`,y!==null&&(I+=` AND ${q} = `+y.toString()),$.codefield=k,I="( "+I+" )",O=new Y(B.findField(u.fields,N),W,W);break;case"structure":I=`(${N}='${f}' AND ${P} = 3)`,y!==null&&(I+=` AND ${C} = `+y.toString()),$.codefield=M,I="( "+I+" )",O=new Y(B.findField(u.fields,x),W,Ne);break;case"attached":I=`(${x}='${f}' AND ${P} = 3)`,y!==null&&(I+=` AND ${q} = `+y.toString()),$.codefield=k,I="( "+I+" )",O=new Y(B.findField(u.fields,N),W,Ne);break;default:throw new g(t,"InvalidParameter",n)}return b&&(I="1 <> 1"),new B({parentfeatureset:u,adaptedFields:[new J(B.findField(u.fields,Qe)),new J(B.findField(u.fields,Ke)),O,Se,$,Te],extraFilter:I?w.create(I,{fieldsIndex:u.getFieldsIndex(),timeZone:u.dateFieldsTimeZoneDefaultUTC}):null})})},o.signatures.push({name:"featuresetbyassociation",min:2,max:6}),o.functions.groupby=function(t,n){return o.standardFunctionAsync(t,n,async(l,r,e)=>{if(_(e,3,3,t,n),!D(e[0]))throw new g(t,"InvalidParameter",n);const a=await e[0].load(),s=[],d=[];let m=!1,h=[];if(U(e[1]))h.push(e[1]);else if(e[1]instanceof R)h.push(e[1]);else if(v(e[1]))h=e[1];else{if(!V(e[1]))throw new g(t,"InvalidParameter",n);h=e[1].toArray()}for(const c of h)if(U(c)){const u=w.create(A(c),{fieldsIndex:a.getFieldsIndex(),timeZone:a.dateFieldsTimeZoneDefaultUTC}),f=ue(u)===!0?A(c):"%%%%FIELDNAME";s.push({name:f,expression:u}),f==="%%%%FIELDNAME"&&(m=!0)}else{if(!(c instanceof R))throw new g(t,"InvalidParameter",n);{const u=c.hasField("name")?c.field("name"):"%%%%FIELDNAME",f=c.hasField("expression")?c.field("expression"):"";if(u==="%%%%FIELDNAME"&&(m=!0),!u)throw new g(t,"InvalidParameter",n);s.push({name:u,expression:w.create(f||u,{fieldsIndex:a.getFieldsIndex(),timeZone:a.dateFieldsTimeZoneDefaultUTC})})}}if(h=[],U(e[2]))h.push(e[2]);else if(v(e[2]))h=e[2];else if(V(e[2]))h=e[2].toArray();else{if(!(e[2]instanceof R))throw new g(t,"InvalidParameter",n);h.push(e[2])}for(const c of h){if(!(c instanceof R))throw new g(t,"InvalidParameter",n);{const u=c.hasField("name")?c.field("name"):"",f=c.hasField("statistic")?c.field("statistic"):"",y=c.hasField("expression")?c.field("expression"):"";if(!(u&&f&&U(f)&&y))throw new g(t,"InvalidParameter",n);d.push({name:u,statistic:f,expression:w.create(y,{fieldsIndex:a.getFieldsIndex(),timeZone:a.dateFieldsTimeZoneDefaultUTC})})}}if(m){const c={};for(const f of a.fields)c[f.name.toLowerCase()]=1;for(const f of s)f.name!=="%%%%FIELDNAME"&&(c[f.name.toLowerCase()]=1);for(const f of d)f.name!=="%%%%FIELDNAME"&&(c[f.name.toLowerCase()]=1);let u=0;for(const f of s)if(f.name==="%%%%FIELDNAME"){for(;c["field_"+u.toString()]===1;)u++;c["field_"+u.toString()]=1,f.name="FIELD_"+u.toString()}}for(const c of s)ye(c.expression,o,t);for(const c of d)ye(c.expression,o,t);return new je({parentfeatureset:e[0],groupbyfields:s,statsfields:d})})},o.signatures.push({name:"groupby",min:3,max:3}),o.functions.distinct=function(t,n){return o.standardFunctionAsync(t,n,async(l,r,e)=>{if(D(e[0])){_(e,2,2,t,n);const a=await e[0].load(),s=[];let d=[];if(U(e[1]))d.push(e[1]);else if(e[1]instanceof R)d.push(e[1]);else if(v(e[1]))d=e[1];else{if(!V(e[1]))throw new g(t,"InvalidParameter",n);d=e[1].toArray()}let m=!1;for(const h of d)if(U(h)){const c=w.create(A(h),{fieldsIndex:a.getFieldsIndex(),timeZone:a.dateFieldsTimeZoneDefaultUTC}),u=ue(c)===!0?A(h):"%%%%FIELDNAME";s.push({name:u,expression:c}),u==="%%%%FIELDNAME"&&(m=!0)}else{if(!(h instanceof R))throw new g(t,"InvalidParameter",n);{const c=h.hasField("name")?h.field("name"):"%%%%FIELDNAME",u=h.hasField("expression")?h.field("expression"):"";if(c==="%%%%FIELDNAME"&&(m=!0),!c)throw new g(t,"InvalidParameter",n);s.push({name:c,expression:w.create(u||c,{fieldsIndex:a.getFieldsIndex(),timeZone:a.dateFieldsTimeZoneDefaultUTC})})}}if(m){const h={};for(const u of a.fields)h[u.name.toLowerCase()]=1;for(const u of s)u.name!=="%%%%FIELDNAME"&&(h[u.name.toLowerCase()]=1);let c=0;for(const u of s)if(u.name==="%%%%FIELDNAME"){for(;h["field_"+c.toString()]===1;)c++;h["field_"+c.toString()]=1,u.name="FIELD_"+c.toString()}}for(const h of s)ye(h.expression,o,t);return new je({parentfeatureset:e[0],groupbyfields:s,statsfields:[]})}return Zt(e)})},o.functions.getfeaturesetinfo=function(t,n){return o.standardFunctionAsync(t,n,async(l,r,e)=>{if(_(e,1,1,t,n),!D(e[0]))return null;const a=await e[0].getFeatureSetInfo();return a?R.convertObjectToArcadeDictionary({layerId:a.layerId,layerName:a.layerName,itemId:a.itemId,serviceLayerUrl:a.serviceLayerUrl,webMapLayerId:a.webMapLayerId??null,webMapLayerTitle:a.webMapLayerTitle??null,className:null,objectClassId:null},Ae(t),!1,!1):null})},o.signatures.push({name:"getfeaturesetinfo",min:1,max:1}),o.functions.filterbysubtypecode=function(t,n){return o.standardFunctionAsync(t,n,async(l,r,e)=>{if(_(e,2,2,t,n),D(e[0])){const a=await e[0].load(),s=e[1];if(!rt(s))throw new g(t,"InvalidParameter",n);if(a.subtypeField){const m=w.create(`${a.subtypeField}= ${e[1]}`,{fieldsIndex:a.getFieldsIndex(),timeZone:a.dateFieldsTimeZoneDefaultUTC});return new Q({parentfeatureset:e[0],whereclause:m})}if(a.typeIdField===null||a.typeIdField==="")throw new g(t,"FeatureSetDoesNotHaveSubtypes",n);const d=w.create(`${a.typeIdField}= ${e[1]}`,{fieldsIndex:a.getFieldsIndex(),timeZone:a.dateFieldsTimeZoneDefaultUTC});return new Q({parentfeatureset:e[0],whereclause:d})}throw new g(t,"InvalidParameter",n)})},o.signatures.push({name:"filterbysubtypecode",min:2,max:2})}}export{mi as registerFunctions};
