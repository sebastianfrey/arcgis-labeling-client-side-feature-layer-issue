import{aa as j,aR as T,aS as x,aT as X,aU as h,aV as G,aF as F,a as M,aW as Y,aX as Z}from"./index-C_bK48d2.js";import{A as S}from"./MeshTransform-auT0YL_N.js";import{isFeatureIdentifierArrayWithGlobalId as U,isFeatureIdentifierArrayWithObjectId as W}from"./editingSupport-CuBBnPhC.js";async function L(t,e,s){const{geometry:n}=e,a={...e.attributes};if(s!=null&&(n==null?void 0:n.type)==="mesh"){const{transformFieldRoles:r}=s,{origin:u,spatialReference:l,vertexSpace:p}=n,o=n.transform??new S,d=p.type==="local",i=t.spatialReference,y=i.isGeographic,w=j(i,l),$=T(l,i)&&x(l,i);if(!(d&&y&&$||!d&&!y&&w))return null;const m=X(u,l,i);if(m==null)return null;if(a[r.originX]=m.x,a[r.originY]=m.y,a[r.originZ]=m.z??0,o!=null){const{translation:b,scale:I,rotation:f}=o,R=d?1:h(l)/h(i);a[r.translationX]=b[0]*R,a[r.translationY]=b[2]*R,a[r.translationZ]=-b[1]*R,a[r.scaleX]=I[0],a[r.scaleY]=I[2],a[r.scaleZ]=I[1],a[r.rotationX]=f[0],a[r.rotationY]=f[2],a[r.rotationZ]=-f[1],a[r.rotationDeg]=f[3]}return{attributes:a}}return n==null?{attributes:a}:n.type==="mesh"||n.type==="extent"?null:{geometry:n.toJSON(),attributes:a}}async function O(t,e){const s=await Promise.all((e.addAttachments??[]).map(r=>A(t,r))),n=await Promise.all((e.updateAttachments??[]).map(r=>A(t,r))),a=e.deleteAttachments??[];return s.length||n.length||a.length?{adds:s,updates:n,deletes:[...a]}:null}async function A(t,e){var d;const{feature:s,attachment:n}=e,{globalId:a,name:r,contentType:u,data:l,uploadId:p}=n,o={globalId:a};if(s&&("attributes"in s?o.parentGlobalId=(d=s.attributes)==null?void 0:d[t.globalIdField]:s.globalId&&(o.parentGlobalId=s.globalId)),p)o.uploadId=p;else if(l){const i=await G(l);i&&(o.contentType=i.mediaType,o.data=i.data),l instanceof File&&(o.name=l.name)}return r&&(o.name=r),u&&(o.contentType=u),o}function P(t,e,s){if(!e||e.length===0)return[];if(s&&U(e))return e.map(a=>a.globalId);if(W(e))return e.map(a=>a.objectId);const n=s?t.globalIdField:t.objectIdField;return n?e.map(a=>a.getAttribute(n)):[]}function z(t){var a,r,u;const e=t==null?void 0:t.assetMaps;if(e){for(const l of e.addResults)l.success||F.getLogger("esri.layers.graphics.sources.support.sourceUtils").error(`Failed to map asset to feature with globalId ${l.globalId}.`);for(const l of e.updateResults)l.success||F.getLogger("esri.layers.graphics.sources.support.sourceUtils").error(`Failed to map asset to feature with globalId ${l.globalId}.`)}const s=t==null?void 0:t.attachments,n={addFeatureResults:((a=t==null?void 0:t.addResults)==null?void 0:a.map(c))??[],updateFeatureResults:((r=t==null?void 0:t.updateResults)==null?void 0:r.map(c))??[],deleteFeatureResults:((u=t==null?void 0:t.deleteResults)==null?void 0:u.map(c))??[],addAttachmentResults:s!=null&&s.addResults?s.addResults.map(c):[],updateAttachmentResults:s!=null&&s.updateResults?s.updateResults.map(c):[],deleteAttachmentResults:s!=null&&s.deleteResults?s.deleteResults.map(c):[]};return t!=null&&t.editMoment&&(n.editMoment=t.editMoment),n}function c(t){const e=t.success===!0?null:t.error||{code:void 0,description:"Feature edit failed"};return{objectId:t.objectId,globalId:t.globalId,error:e?new M("feature-layer-source:edit-failure",e.description,{code:e.code}):null}}function g(t,e){return new Y({attributes:t.attributes,geometry:Z({...t.geometry,spatialReference:e})})}function C(t,e){var s,n,a;return{adds:((s=t==null?void 0:t.adds)==null?void 0:s.map(r=>g(r,e)))||[],updates:((n=t==null?void 0:t.updates)==null?void 0:n.map(r=>({original:g(r[0],e),current:g(r[1],e)})))||[],deletes:((a=t==null?void 0:t.deletes)==null?void 0:a.map(r=>g(r,e)))||[],spatialReference:e}}function K(t){const e=t.details.raw,s=+e.code,n=+e.extendedCode;return s===500&&(n===-2147217144||n===-2147467261)}export{C as I,c as R,P as b,O as f,K as j,L as m,z as y};
