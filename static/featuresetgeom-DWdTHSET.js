import{jU as S,jV as m,io as _,ea as c}from"./index-C_bK48d2.js";import{J as y,o as d,U as s,g as h,B as u}from"./Dictionary-BQHLIVF1.js";import{t as R}from"./arcadeEnvironment-DXZ5oSsm.js";import{w,s as g,r as F}from"./FeatureSet-C159Sq-I.js";import{G as O}from"./shared-CCxkzcop.js";import{a as i}from"./operatorsWorkerConnection-DC2XMJIx.js";import{a as p}from"./Empty-aIwBS85J.js";import"./ImmutableArray-BPVd6ESQ.js";import"./number-B6x4HXNH.js";import"./Feature-IMCzHRW9.js";import"./featureConversionUtils-Di1UhLmY.js";import"./OptimizedFeatureSet-BZnZXZq6.js";import"./memoryEstimations-w0EAmzVg.js";import"./OptimizedGeometry-KE6YknPZ.js";import"./WhereClause-BTKovlsq.js";class f extends w{constructor(e){super(),this.declaredClass="esri.arcade.featureset.actions.SpatialFilter",this._maxProcessing=40,this._parent=e.parentfeatureset,this._relation=e.relation,this._relationString=e.relationString??"",this._relationGeom=e.relationGeom}get _spatialFilter(){return{relation:this._relation!=="esriSpatialRelRelation"?this._relation:`esriSpatialRelRelation:${this._relationString}`,geometry:this._relationGeom}}async _queryAll(){return(await this.query({abortSignal:R})).features}async query(e){await this._ensureLoaded();const r=await this._parent.query({...e,spatialFilter:this._spatialFilter});return g(e.abortSignal),{...r,spatialFilterApplied:e.spatialFilter==null,features:r.spatialFilterApplied?r.features:this._applySpatialFilter(r.features,e.abortSignal)}}async*_applySpatialFilter(e,r){for await(const t of e){g(r);const l=[];for(const a of t)await this._executeSpatialRelationTest(a)&&l.push(a);l.length>0&&(yield l)}}async queryStat(e){if(e.spatialFilter!=null)return{calculated:!1};const r=await this._parent.queryStat({...e,spatialFilter:this._spatialFilter});return r.calculated?r:e.where==null&&e.spatialFilter==null?this._manualStat(e.stat,e.field,e.limit??O,e.abortSignal):{calculated:!1}}async canQueryAggregate(e){return e.spatialFilter==null&&this._parent.canQueryAggregate({...e,spatialFilter:this._spatialFilter})}async queryAggregate(e){if(e.spatialFilter!=null)throw new F("NeverReach");return this._parent.queryAggregate({...e,spatialFilter:this._spatialFilter})}async _executeSpatialRelationTest(e){if(e.geometry==null)return!1;switch(this._relation){case"esriSpatialRelEnvelopeIntersects":{const r=m(this._relationGeom),t=_(e.geometry);return r!=null&&t!=null&&i("intersects",[r.toJSON(),t])}case"esriSpatialRelIntersects":return i("intersects",[this._relationGeom.toJSON(),e.geometry]);case"esriSpatialRelContains":return i("contains",[this._relationGeom.toJSON(),e.geometry]);case"esriSpatialRelOverlaps":return i("overlaps",[this._relationGeom.toJSON(),e.geometry]);case"esriSpatialRelWithin":return i("within",[this._relationGeom.toJSON(),e.geometry]);case"esriSpatialRelTouches":return i("touches",[this._relationGeom.toJSON(),e.geometry]);case"esriSpatialRelCrosses":return i("crosses",[this._relationGeom.toJSON(),e.geometry]);case"esriSpatialRelRelation":return i("relate",[this._relationGeom.toJSON(),e.geometry,this._relationString]);default:return S(this._relation),!1}}getFieldsIndex(){return this._parent.getFieldsIndex()}}function o(n){return async(e,r,t)=>{if(d(t,2,2,e,r),(t=y(t))[0]===null&&t[1]===null)return!1;if(u(t[0])){if(s(t[1]))return new f({parentfeatureset:t[0],relation:n,relationGeom:t[1]});if(t[1]===null)return new p({parentfeatureset:t[0]});throw new c(e,"InvalidParameter",r)}if(s(t[0])){if(s(t[1])){switch(n){case"esriSpatialRelEnvelopeIntersects":{const l=m(t[0]),a=m(t[1]);return l!=null&&a!=null&&i("intersects",[l.toJSON(),a.toJSON()])}case"esriSpatialRelIntersects":return i("intersects",[t[0].toJSON(),t[1].toJSON()]);case"esriSpatialRelContains":return i("contains",[t[0].toJSON(),t[1].toJSON()]);case"esriSpatialRelOverlaps":return i("overlaps",[t[0].toJSON(),t[1].toJSON()]);case"esriSpatialRelWithin":return i("within",[t[0].toJSON(),t[1].toJSON()]);case"esriSpatialRelTouches":return i("touches",[t[0].toJSON(),t[1].toJSON()]);case"esriSpatialRelCrosses":return i("crosses",[t[0].toJSON(),t[1].toJSON()])}throw new c(e,"InvalidParameter",r)}if(u(t[1]))return new f({parentfeatureset:t[1],relation:n,relationGeom:t[0]});if(t[1]===null)return!1;throw new c(e,"InvalidParameter",r)}if(t[0]===null){if(u(t[1]))return new p({parentfeatureset:t[1]});if(s(t[1])||t[1]===null)return!1}throw new c(e,"InvalidParameter",r)}}function Q(n){n.mode==="async"&&(n.functions.intersects=function(e,r){return n.standardFunctionAsync(e,r,o("esriSpatialRelIntersects"))},n.functions.envelopeintersects=function(e,r){return n.standardFunctionAsync(e,r,o("esriSpatialRelEnvelopeIntersects"))},n.signatures.push({name:"envelopeintersects",min:2,max:2}),n.functions.contains=function(e,r){return n.standardFunctionAsync(e,r,o("esriSpatialRelContains"))},n.functions.overlaps=function(e,r){return n.standardFunctionAsync(e,r,o("esriSpatialRelOverlaps"))},n.functions.within=function(e,r){return n.standardFunctionAsync(e,r,o("esriSpatialRelWithin"))},n.functions.touches=function(e,r){return n.standardFunctionAsync(e,r,o("esriSpatialRelTouches"))},n.functions.crosses=function(e,r){return n.standardFunctionAsync(e,r,o("esriSpatialRelCrosses"))},n.functions.relate=function(e,r){return n.standardFunctionAsync(e,r,async(t,l,a)=>{if(a=y(a),d(a,3,3,e,r),s(a[0])&&s(a[1]))return i("relate",[a[0].toJSON(),a[1].toJSON(),h(a[2])]);if(s(a[0])&&a[1]===null||s(a[1])&&a[0]===null)return!1;if(u(a[0])&&a[1]===null)return new p({parentfeatureset:a[0]});if(u(a[1])&&a[0]===null)return new p({parentfeatureset:a[1]});if(u(a[0])&&s(a[1]))return new f({parentfeatureset:a[0],relation:"esriSpatialRelRelation",relationGeom:a[1],relationString:h(a[2])});if(u(a[1])&&s(a[0]))return new f({parentfeatureset:a[1],relation:"esriSpatialRelRelation",relationGeom:a[0],relationString:h(a[2])});if(a[0]===null&&a[1]===null)return!1;throw new c(e,"InvalidParameter",r)})})}export{Q as registerFunctions};
