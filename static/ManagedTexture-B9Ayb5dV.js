import{_ as H,g7 as R,fj as f,l8 as h,k4 as O,a as F,jo as U,gc as V,kt as E,lq as b,cO as T,js as c,b$ as B,aO as y,m2 as k,cG as X,cK as G,cT as N,fk as K,m3 as W,cF as j}from"./index-C_bK48d2.js";import{r as z}from"./videoUtils-DSNBJ20F.js";import{r as q}from"./image-CVbVCSUp.js";import{T as Y}from"./OutputColorHighlightOLID.glsl-sxs6Kjna.js";import{c as Z}from"./BufferView-CruTDoyp.js";function J(){return w??(w=(async()=>{const r=await H(()=>import("./basis_transcoder-B78SwDII.js"),[],import.meta.url),e=await r.default({locateFile:t=>R(`esri/libs/basisu/${t}`)});return e.initializeBasis(),e})()),w}let w,o=null,g=null;async function A(){return g==null&&(g=J(),o=await g),g}function Q(r,e){if(o==null)return r.byteLength;const t=new o.BasisFile(new Uint8Array(r)),a=C(t)?D(t.getNumLevels(0),t.getHasAlpha(),t.getImageWidth(0,0),t.getImageHeight(0,0),e):0;return t.close(),t.delete(),a}function ee(r,e){if(o==null)return r.byteLength;const t=new o.KTX2File(new Uint8Array(r)),a=I(t)?D(t.getLevels(),t.getHasAlpha(),t.getWidth(),t.getHeight(),e):0;return t.close(),t.delete(),a}function D(r,e,t,a,i){const s=O(e?h.COMPRESSED_RGBA8_ETC2_EAC:h.COMPRESSED_RGB8_ETC2),n=i&&r>1?(4**r-1)/(3*4**(r-1)):1;return Math.ceil(t*a*s*n)}function C(r){return r.getNumImages()>=1&&!r.isUASTC()}function I(r){return r.getFaces()>=1&&r.isETC1S()}async function te(r,e,t){o==null&&(o=await A());const a=new o.BasisFile(new Uint8Array(t));if(!C(a))return null;a.startTranscoding();const i=v(r,e,a.getNumLevels(0),a.getHasAlpha(),a.getImageWidth(0,0),a.getImageHeight(0,0),(s,n)=>a.getImageTranscodedSizeInBytes(0,s,n),(s,n,l)=>a.transcodeImage(l,0,s,n,0,0));return a.close(),a.delete(),i}async function ae(r,e,t){o==null&&(o=await A());const a=new o.KTX2File(new Uint8Array(t));if(!I(a))return null;a.startTranscoding();const i=v(r,e,a.getLevels(),a.getHasAlpha(),a.getWidth(),a.getHeight(),(s,n)=>a.getImageTranscodedSizeInBytes(s,0,0,n),(s,n,l)=>a.transcodeImage(l,s,0,0,n,0,-1,-1));return a.close(),a.delete(),i}function v(r,e,t,a,i,s,n,l){const{compressedTextureETC:d,compressedTextureS3TC:x}=r.capabilities,[_,S]=d?a?[1,h.COMPRESSED_RGBA8_ETC2_EAC]:[0,h.COMPRESSED_RGB8_ETC2]:x?a?[3,h.COMPRESSED_RGBA_S3TC_DXT5_EXT]:[2,h.COMPRESSED_RGB_S3TC_DXT1_EXT]:[13,6408],$=e.hasMipmap?t:Math.min(1,t),p=[];for(let u=0;u<$;u++)p.push(new Uint8Array(n(u,_))),l(u,_,p[u]);return e.internalFormat=S,e.hasMipmap=p.length>1,e.samplingMode=e.hasMipmap?9987:9729,e.width=i,e.height=s,new f(r,e,{type:"compressed",levels:p})}const m=16;function M(r,e){return e=Math.floor(e/m)*m,Math.min(Math.round(r/m)*m,e)}function ce(r,e){return e=Math.floor(e/m)*m,Math.min(Math.ceil(r/m)*m,e)}function re(r,e){const[t,a]=ie(r,e);return r.width===t&&r.height===a?r:L(r,t,a)}function ie({width:r,height:e},{maxPreferredTexturePixels:t,maxTextureSize:a}){const i=Math.max(r,e),s=r*e;if(i<=a&&s<=t)return[r,e];const n=Math.min(Math.sqrt(t/s),a/i);return[M(Math.round(r*n),a),M(Math.round(e*n),a)]}function L(r,e,t){if(r instanceof ImageData)return L(se(r),e,t);const a=document.createElement("canvas");return a.width=e,a.height=t,a.getContext("2d").drawImage(r,0,0,a.width,a.height),a}function se(r){const e=document.createElement("canvas");e.width=r.width,e.height=r.height;const t=e.getContext("2d");if(t==null)throw new F("texture:context-failed","Failed to create 2d context from HTMLCanvasElement");return t.putImageData(r,0,0),e}class _e{constructor(e,t){this._data=e,this.id=U(),this.events=new V,this._parameters={...oe,...t},this._startPreload(e)}dispose(){this.unload(),this._data=this.update=void 0}_startPreload(e){e instanceof HTMLVideoElement?(this.update=t=>this._update(e,t),this._startPreloadVideoElement(e)):e instanceof HTMLImageElement&&this._startPreloadImageElement(e)}_startPreloadVideoElement(e){if(!(E(e.src)||e.preload==="auto"&&e.crossOrigin)&&(e.preload="auto",e.crossOrigin="anonymous",e.src=e.src,e.paused&&e.autoplay)){const t=[];z(e,a=>t.push(a)).then(()=>{e.play()}).finally(()=>t.forEach(a=>a.remove()))}}_startPreloadImageElement(e){b(e.src)||E(e.src)||e.crossOrigin||(e.crossOrigin="anonymous",e.src=e.src)}_createDescriptor(e){const t=new K;return t.wrapMode=this._parameters.wrap??10497,t.flipped=!this._parameters.noUnpackFlip,t.samplingMode=this._parameters.mipmap?9987:9729,t.hasMipmap=!!this._parameters.mipmap,t.preMultiplyAlpha=!!this._parameters.preMultiplyAlpha,t.maxAnisotropy=this._parameters.maxAnisotropy??(this._parameters.mipmap?e.parameters.maxMaxAnisotropy:1),t.dataType=this._parameters.dataType??t.dataType,t.pixelFormat=this._parameters.pixelFormat??t.pixelFormat,t.internalFormat=this._parameters.internalFormat??t.internalFormat,t}get texture(){return this._texture??this._emptyTexture}get loaded(){return this._texture!=null}get usedMemory(){var e;return((e=this._texture)==null?void 0:e.usedMemory)||ne(this._data,this._parameters)}load(e){if(this._loadingPromise)return this._loadingPromise;if(this._texture)return this._texture;const t=this._data;return t==null?(this._texture=new f(e,this._createDescriptor(e),null),this._texture):(this._emptyTexture=e.emptyTexture,this._parameters.reloadable||(this._data=void 0),typeof t=="string"?this._loadFromURL(e,t):t instanceof Image?this._loadFromImageElement(e,t):t instanceof HTMLVideoElement?this._loadFromVideoElement(e,t):t instanceof ImageData||t instanceof HTMLCanvasElement?this._loadFromImage(e,t):T(t)&&this._parameters.encoding==="image/vnd-ms.dds"?this._loadFromDDSData(e,t):c(t)&&this._parameters.encoding==="image/vnd-ms.dds"?this._loadFromDDSData(e,new Uint8Array(t)):(c(t)||T(t))&&this._parameters.encoding==="image/ktx2"?this._loadFromKTX2(e,t):(c(t)||T(t))&&this._parameters.encoding==="image/x.basis"?this._loadFromBasis(e,t):c(t)?this._loadFromPixelData(e,new Uint8Array(t)):B(t)?this._loadFromPixelData(e,t):null)}_update(e,t){return this._texture==null||e.readyState<HTMLMediaElement.HAVE_CURRENT_DATA||t===e.currentTime?t:(this._texture.setData(e),this._texture.descriptor.hasMipmap&&this._texture.generateMipmap(),this._parameters.updateCallback&&this._parameters.updateCallback(),e.currentTime)}_loadFromDDSData(e,t){return this._texture=Y(e,this._createDescriptor(e),t),this._emptyTexture=null,this._texture}_loadFromKTX2(e,t){return this._loadAsync(()=>ae(e,this._createDescriptor(e),t).then(a=>(this._texture=a,a)))}_loadFromBasis(e,t){return this._loadAsync(()=>te(e,this._createDescriptor(e),t).then(a=>(this._texture=a,a)))}_loadFromPixelData(e,t){Z(this._parameters.width>0&&this._parameters.height>0);const a=this._createDescriptor(e);return a.pixelFormat!==6407&&a.pixelFormat!==6408||(a.compress=this._parameters.compressionOptions),a.width=this._parameters.width??0,a.height=this._parameters.height??0,this._texture=new f(e,a,t),this._texture}_loadFromURL(e,t){return this._loadAsync(async a=>{const i=await q(t,{signal:a});return y(a),this._loadFromImage(e,i)})}_loadFromImageElement(e,t){return t.complete?this._loadFromImage(e,t):this._loadAsync(async a=>{const i=await k(t,t.src,!1,a);return y(a),this._loadFromImage(e,i)})}_loadFromVideoElement(e,t){return t.readyState>=HTMLMediaElement.HAVE_CURRENT_DATA?this._loadFromImage(e,t):this._loadFromVideoElementAsync(e,t)}_loadFromVideoElementAsync(e,t){return this._loadAsync(a=>new Promise((i,s)=>{const n=()=>{t.removeEventListener("loadeddata",l),t.removeEventListener("error",d),j(x)},l=()=>{t.readyState>=HTMLMediaElement.HAVE_CURRENT_DATA&&(n(),i(this._loadFromImage(e,t)))},d=_=>{n(),s(_||new F("texture:load-error","Failed to load video"))};t.addEventListener("loadeddata",l),t.addEventListener("error",d);const x=X(a,()=>d(G()))}))}_loadFromImage(e,t){let a=t;a instanceof HTMLVideoElement||(a=re(a,e.parameters));const i=P(a);this._parameters.width=i.width,this._parameters.height=i.height;const s=this._createDescriptor(e);return s.width=i.width,s.height=i.height,s.compress=this._parameters.compressionOptions,this._texture=new f(e,s,a),this._emptyTexture=null,this.events.emit("loaded"),this._texture}_loadAsync(e){const t=new AbortController;this._loadingController=t;const a=e(t.signal);this._loadingPromise=a;const i=()=>{this._loadingController===t&&(this._loadingController=null),this._loadingPromise===a&&(this._loadingPromise=null),this._emptyTexture=null};return a.then(i,i),a}unload(){if(this._texture=N(this._texture),this._emptyTexture=null,this._loadingController!=null){const e=this._loadingController;this._loadingController=null,this._loadingPromise=null,e.abort()}this.events.emit("unloaded")}get parameters(){return this._parameters}}function ne(r,e){if(r==null)return 0;if(c(r)||T(r))return e.encoding==="image/ktx2"?ee(r,!!e.mipmap):e.encoding==="image/x.basis"?Q(r,!!e.mipmap):r.byteLength;const{width:t,height:a}=r instanceof Image||r instanceof ImageData||r instanceof HTMLCanvasElement||r instanceof HTMLVideoElement?P(r):e,i=e.pixelFormat??6408,s=W(i);return(e.mipmap?4/3:1)*t*a*s||0}function P(r){return r instanceof HTMLVideoElement?{width:r.videoWidth,height:r.videoHeight}:r}const oe={wrap:{s:10497,t:10497},mipmap:!0,noUnpackFlip:!1,preMultiplyAlpha:!1};export{_e as M,M as n,ce as r};
