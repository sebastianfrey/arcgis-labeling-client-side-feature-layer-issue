import{pD as X,pE as ee,aI as te,fv as R,c5 as E,pF as re,dZ as L,nP as ae,a7 as C,a8 as B,pG as ie,mE as se,eb as $,hN as le,dC as ne,hB as Z,fJ as D,a5 as ue,pH as J}from"./index-C_bK48d2.js";import{p as oe,B as ce,Y as de}from"./Dictionary-BQHLIVF1.js";import{t as k}from"./arcadeEnvironment-DXZ5oSsm.js";import{w as he,p as N,s as g,S as j,I as v,l as b,a as ye,v as V,r as I,F as q,b as p}from"./FeatureSet-C159Sq-I.js";import{G as T,J as pe,I as z,M as fe,N as O}from"./shared-CCxkzcop.js";import{L as Q}from"./WhereClause-BTKovlsq.js";import{G as _e}from"./arcade-DzAn-uHG.js";import{r as me}from"./queryRelatedRecords-BHhYbV-T.js";class K{constructor(){this.declaredRootClass="esri.arcade.featureSetCollection",this._layerById={},this._layerByName={}}add(e,r,t){this._layerById[r]=t,this._layerByName[e]=t}async featureSetByName(e,r=!0,t=["*"]){return this._layerByName[e]===void 0?null:this._layerByName[e]}async featureSetById(e,r=!0,t=["*"]){return this._layerById[e]===void 0?null:this._layerById[e]}castToText(e=!1){return"object, FeatureSetCollection"}}class W extends he{constructor(e){super(),this.declaredClass="esri.arcade.featureset.actions.AttributeFilter",this._maxProcessing=1e3,this._parent=e.parentfeatureset,e.whereclause instanceof Q?(this._whereClause=e.whereclause,this._whereClauseFunction=null):(this._whereClauseFunction=e.whereclause,this._whereClause=null)}_initialiseFeatureSet(){this.fields=this._parent.fields.slice(),this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types,this.subtypeField=this._parent.subtypeField,this.subtypes=this._parent.subtypes}async _queryAll(){return(await this.query({abortSignal:k})).features}async query(e){let r=e.where;this._whereClauseFunction!==null||(r!=null?this._whereClause!==null&&(r=N(this._whereClause,r)):r=this._whereClause),await this._ensureLoaded();const t=await this._parent.query({...e,where:r});return g(e.abortSignal),t.filterApplied&&this._whereClauseFunction==null?t:{...t,features:this._applyFilter(t.features,e.abortSignal)}}async*_applyFilter(e,r){for await(const t of e)if(g(r),this._whereClause!=null){const a=t.filter(i=>this._whereClause.testFeature(i));a.length>0&&(yield a)}else if(this._whereClauseFunction!=null){const a=[];for(const i of t)await this._whereClauseFunction(i)&&a.push(i);a.length>0&&(yield a)}else yield t}async queryStat(e){if(this._whereClauseFunction!==null)return e.where==null&&e.spatialFilter==null?this._manualStat(e.stat,e.field,e.limit??T,e.abortSignal):{calculated:!1};let r=this._whereClause;e.where!=null&&this._whereClause!==null&&(r=N(this._whereClause,e.where));const t=await this._parent.queryStat({...e,where:r});return t.calculated?t:e.where==null&&e.spatialFilter==null?this._manualStat(e.stat,e.field,e.limit??T,e.abortSignal):{calculated:!1}}async canQueryAggregate(e){if(this._whereClauseFunction!==null)return!1;let r=e.where;return r!=null?this._whereClause!==null&&(r=N(this._whereClause,r)):r=this._whereClause,this._parent.canQueryAggregate({...e,where:r})}async queryAggregate(e){let r=e.where;return r!=null?this._whereClause!==null&&(r=N(this._whereClause,r)):r=this._whereClause,this._parent.queryAggregate({...e,where:r})}getFieldsIndex(){return this._parent.getFieldsIndex()}}function Fe(n){if(n.length===0)throw new I("NeverReach");const e=[];for(let t=0;t<n.length;t++){const a=n[t],i=[`"${a.name.replaceAll('"','""')}" ${a.asc?">":"<"} @last_${t}`];for(let s=0;s<t;s++){const l=n[s];i.push(`"${l.name.replaceAll('"','""')}" = @last_${s}`)}e.push(i.join(" AND "))}const r=e.join(" OR ");return Q.create(r)}function we(n,e){n.clause==null&&(n.clause=Fe(n.keyFields));for(let r=0;r<n.keyFields.length;r++){const t=n.keyFields[r].name;n.clause.parameters[`last_${r}`]=e.attributes[t]}}class A extends j{constructor(e){super(),this.declaredClass="esri.arcade.featureset.sources.FeatureLayerDynamic",this._removeGeometry=!1,this._overrideFields=null,this._requestStandardised=!1,this._useDefinitionExpression=!0,this._recentlyUsedQueries=null,this._featureSetQueryInterceptor=null,this._featureSetInfo=null,this._maxProcessing=1e3,this._layer=e.layer,e.spatialReference&&(this.spatialReference=e.spatialReference),e.outFields!==void 0&&(this._overrideFields=e.outFields),e.includeGeometry!==void 0&&(this._removeGeometry=e.includeGeometry===!1),e.lrucache&&(this._recentlyUsedQueries=e.lrucache),e.interceptor&&(this._featureSetQueryInterceptor=e.interceptor)}_maxQueryRate(){return T}get urlQueryPath(){return this._layer.parsedUrl.path||""}convertQueryToLruCacheKey(e){const r=this.urlQueryPath+","+pe(e.toJSON());return X(r,ee.String)}async loadImpl(){return this._layer.loaded===!0?(this._initialiseFeatureSet(),this):(await this._layer.load(),this._initialiseFeatureSet(),this)}_initialiseFeatureSet(){var e,r,t,a;if(this.spatialReference??(this.spatialReference=this._layer.spatialReference),this.geometryType=this._layer.geometryType??"",this.fields=this._layer.fields.slice(),this.hasZ=((r=(e=this._layer.capabilities)==null?void 0:e.data)==null?void 0:r.supportsZ)===!0,this.hasM=((a=(t=this._layer.capabilities)==null?void 0:t.data)==null?void 0:a.supportsM)===!0,this._overrideFields!==null)if(this._overrideFields.length===1&&this._overrideFields[0]==="*")this._overrideFields=null;else{const i=new Set(this._overrideFields.map(s=>s.toLowerCase()));this.fields=this.fields.filter(({type:s,name:l})=>s==="oid"||i.has(l.toLowerCase())),this._overrideFields=this.fields.map(({name:s})=>s)}if(this._layer.source&&this._layer.source.sourceJSON){const i=this._layer.source.sourceJSON.currentVersion;this._layer.source.sourceJSON.useStandardizedQueries===!0?(this._databaseType=1,i!=null&&i>=10.61&&(this._databaseType=0)):i!=null&&(i>=10.5&&(this._databaseType=1,this._requestStandardised=!0),i>=10.61&&(this._databaseType=0))}this.objectIdField=this._layer.objectIdField;for(const i of this.fields)i.type==="global-id"&&(this.globalIdField=i.name);this.subtypeField=this._layer.subtypeField??"",this.subtypes=this._layer.subtypes,this.typeIdField=("typeIdField"in this._layer?this._layer.typeIdField:null)??"",this.types="types"in this._layer?this._layer.types:null}async _runDatabaseProbe(e){await this._ensureLoaded();const r=new te;this.datesInUnknownTimezone&&(r.timeReferenceUnknownClient=!0),r.where=e.replace("OBJECTID",this._layer.objectIdField);try{return await this._layer.queryObjectIds(r),!0}catch{return!1}}_canUsePagination(){return!(!this._layer.capabilities||!this._layer.capabilities.query||this._layer.capabilities.query.supportsPagination!==!0)}_cacheableFeatureSetSourceKey(){return this._layer.url}get gdbVersion(){return this._layer&&this._layer.capabilities&&this._layer.capabilities.data&&this._layer.capabilities.data.isVersioned?this._layer.gdbVersion||"SDE.DEFAULT":""}nativeCapabilities(){return{title:this._layer.title??"",source:this,canQueryRelated:!0,capabilities:this._layer.capabilities,databaseType:this._databaseType,requestStandardised:this._requestStandardised}}async _queryAll(){return(await this.query({abortSignal:k})).features}async query(e){return await this._ensureLoaded(),this.isTable()&&e.spatialFilter!=null?v:this._canUsePagination()?this._queryUsingPaging(e):this._queryUsingIdSetTraversal(e)}async _queryUsingPaging(e){var h,d,y;let r="",t=!1;e.orderBy!=null&&((d=(h=this._layer.capabilities)==null?void 0:h.query)==null?void 0:d.supportsOrderBy)===!0&&(r=e.orderBy.constructClause(),t=!0);const a=await this.databaseType(),i=e.where==null?e.spatialFilter==null?"1=1":"":b(e.where,a);let s=this._maxQueryRate();const l=(y=this._layer.capabilities)==null?void 0:y.query.maxRecordCount;l!=null&&l<s&&(s=l);const u=this._removeGeometry!==!0,o=this._overrideFields??this._fieldsIncludingObjectId(["*"]),c=this._createQuery();return c.where=R(c.where,i),e.spatialFilter!=null&&(c.spatialRelationship=this._makeRelationshipEnum(e.spatialFilter.relation),c.relationParameter=this._makeRelationshipParam(e.spatialFilter.relation),c.geometry=e.spatialFilter.geometry),c.orderByFields=r!==""?r.split(","):null,c.outFields=o,c.returnGeometry=u,c.outSpatialReference=this.spatialReference,{ordered:t,filterApplied:!0,spatialFilterApplied:!0,features:this._queryPaginated(c,s,e.abortSignal)}}async*_queryPaginated(e,r,t){let a;e.num=r,e.start=0;do g(t),a=await this.executeQuery(e,"execute"),yield a.features,e.start+=r;while(a.exceededTransferLimit===!0)}async _queryUsingIdSetTraversal(e){var h;let r="",t=!1;e.orderBy!=null&&this._layer.capabilities&&this._layer.capabilities.query&&this._layer.capabilities.query.supportsOrderBy===!0&&(r=e.orderBy.constructClause(),t=!0);const a=await this.databaseType(),i=e.where==null?e.spatialFilter==null?"1=1":"":b(e.where,a),s=this._createQuery();s.where=R(s.where,i),e.spatialFilter!=null&&(s.spatialRelationship=this._makeRelationshipEnum(e.spatialFilter.relation),s.relationParameter=this._makeRelationshipParam(e.spatialFilter.relation),s.geometry=e.spatialFilter.geometry),s.orderByFields=r!==""?r.split(","):null,s.outSpatialReference=this.spatialReference;const l=await this.executeQuery(s,"executeForIds");if(g(e.abortSignal),l==null||l.length<=0)return v;let u=this._maxQueryRate();const o=(h=this._layer.capabilities)==null?void 0:h.query.maxRecordCount;o!=null&&o<u&&(u=o);const c=this._createQuery();return s.outFields=this._overrideFields??this._fieldsIncludingObjectId(["*"]),s.returnGeometry=this._removeGeometry!==!0,s.outSpatialReference=this.spatialReference,{ordered:t,filterApplied:!0,spatialFilterApplied:!0,features:this._traverseIdSet(c,l,u,e.abortSignal)}}async*_traverseIdSet(e,r,t,a){for(let i=0;i<r.length;i+=t)e.objectIds=r.slice(i,i+t),g(a),yield(await this.executeQuery(e,"execute")).features}async queryStat(e){var _;await this._ensureLoaded();const r=(_=this._layer.capabilities)==null?void 0:_.query,t=!!(r!=null&&r.supportsSqlExpression),a=!!(r!=null&&r.supportsStatistics),i=!!(r!=null&&r.supportsDistinct),s=ye(e.stat);if(s==="count")return i?this._queryCount(e):{calculated:!1};const l=e.field;if(l==null)return{calculated:!1};if(a===!1||V(l)===!1&&t===!1||l.isStandardized===!1)return e.spatialFilter!=null||e.where!=null?{calculated:!1}:this._manualStat(e.stat,l,e.limit??T,e.abortSignal);if(s==="distinct")return i===!1?e.spatialFilter!=null||e.where!=null?{calculated:!1}:this._manualStat(s,l,e.limit??T,e.abortSignal):{calculated:!1};const u=await this.databaseType();if(this.isTable()&&e.spatialFilter!=null)return{calculated:!0,result:null};const o=this._createQuery();o.where=R(o.where,e.where==null?e.spatialFilter==null?"1=1":"":b(e.where,u)),e.spatialFilter!=null&&(o.spatialRelationship=this._makeRelationshipEnum(e.spatialFilter.relation),o.relationParameter=this._makeRelationshipParam(e.spatialFilter.relation),o.geometry=e.spatialFilter.geometry);const c=new E;c.statisticType=s,c.onStatisticField=b(l,u),c.outStatisticFieldName="ARCADE_STAT_RESULT",o.returnGeometry=!1;let h="ARCADE_STAT_RESULT";o.outStatistics=[c];const d=await this.executeQuery(o,"execute");if(!d.hasOwnProperty("features")||d.features.length===0)throw new I("InvalidStatResponse");let y=!1;const f=d.fields??[];for(const m of f)if(m.name.toUpperCase()==="ARCADE_STAT_RESULT"){h=m.name,m.type==="esriFieldTypeDate"&&(y=!0);break}const S=d.features[0].attributes[h];return{calculated:!0,result:y&&S!=null?new Date(S):S}}async _queryCount(e){const r=await this.databaseType();if(this.isTable()&&e.spatialFilter!=null)return{calculated:!0,result:0};const t=this._createQuery();return t.where=R(t.where,e.where==null?e.spatialFilter==null?"1=1":"":b(e.where,r)),e.spatialFilter!=null&&(t.spatialRelationship=this._makeRelationshipEnum(e.spatialFilter.relation),t.relationParameter=this._makeRelationshipParam(e.spatialFilter.relation),t.geometry=e.spatialFilter.geometry),t.returnGeometry=!1,{calculated:!0,result:await this.executeQuery(t,"executeForCount")}}async canQueryAggregate(e){var i,s;await this._ensureLoaded();let r=!1;const t=(i=this._layer.capabilities)==null?void 0:i.query,a=(t==null?void 0:t.supportsSqlExpression)===!0;if(t!=null&&t.supportsStatistics===!0&&t.supportsOrderBy===!0&&(r=!0),r)for(const l of e.statistics)(((s=l.workingexpr)==null?void 0:s.isStandardized)===!1||V(l.workingexpr)===!1&&a===!1)&&(r=!1);return r}async queryAggregate(e){var y,f,S;if(await this._ensureLoaded(),this.isTable()&&e.spatialFilter!=null)return v;const r=await this.databaseType(),t=e.groupBy,a=e.orderBy;let i=null;if(!this._layer.capabilities.query.supportsPaginationOnAggregatedQueries){const _=this.getFieldsIndex();i={keyFields:t.map((m,w)=>({name:_.normalizeFieldName(m)??m,asc:a==null||a._directions[w]===1}))}}let s="",l=!1;a!=null&&((f=(y=this._layer.capabilities)==null?void 0:y.query)==null?void 0:f.supportsOrderBy)===!0&&(i==null||re(t,0,t.length,a._fields,0,Math.min(a._fields.length,t.length),(_,m)=>_.toLowerCase()===m.toLowerCase()))&&(s=a.constructClause(),l=!0),s===""&&(s=t.join(","));const u=e.statistics.map(_=>new E({onStatisticField:_.workingexpr!==null?b(_.workingexpr,r):"",outStatisticFieldName:_.field,statisticType:_.toStatisticsName()}));let o=this._maxQueryRate();const c=(S=this._layer.capabilities)==null?void 0:S.query.maxRecordCount;c!=null&&c<o&&(o=c);const h=e.where==null?e.spatialFilter==null?"1=1":"":b(e.where,r),d=this._createQuery();return d.where=R(d.where,h),e.spatialFilter!=null&&(d.spatialRelationship=this._makeRelationshipEnum(e.spatialFilter.relation),d.relationParameter=this._makeRelationshipParam(e.spatialFilter.relation),d.geometry=e.spatialFilter.geometry),d.orderByFields=s!==""?s.split(","):null,d.outFields=["*"],d.outStatistics=u,d.groupByFieldsForStatistics=t,d.returnGeometry=!1,i==null?{filterApplied:!0,spatialFilterApplied:!0,ordered:l,features:this._queryPaginated(d,o,e.abortSignal)}:{filterApplied:!0,spatialFilterApplied:!0,ordered:l,features:this._queryKeysetPaginated(d,i,e.abortSignal)}}async*_queryKeysetPaginated(e,r,t){const a=e.where;for(;;){if(r.clause!=null){if(!this._layer.capabilities.query.supportsOrderBy)throw new I("NotImplemented");e.where=R(a,b(r.clause,await this.databaseType()))}const i=await this.executeQuery(e,"execute");if(g(t),!i.hasOwnProperty("features"))throw new I("InvalidStatResponse");if(yield i.features,i.features.length===0||i.exceededTransferLimit!==!0)break;we(r,i.features.at(-1))}}_createQuery(){const e=this._layer.createQuery();return e.returnZ=this.hasZ,e.returnM=this.hasM,this.datesInUnknownTimezone&&(e.timeReferenceUnknownClient=!0),this._requestStandardised&&(e.sqlFormat="standard"),this._useDefinitionExpression?this._layer.type==="subtype-group"&&(e.where=this._layer.definitionExpression):e.where=null,e}executeQuery(e,r){const t=r==="execute"?async i=>{const s=await this._layer.source.queryFeaturesJSON(i);return q(s.features,s.spatialReference??this.spatialReference.toJSON()),s}:r==="executeForCount"?this._layer.queryFeatureCount.bind(this._layer):this._layer.queryObjectIds.bind(this._layer);let a=null;if(this._recentlyUsedQueries){const i=this.convertQueryToLruCacheKey(e);a=this._recentlyUsedQueries.getFromCache(i),a===null&&(a=t(e),this._recentlyUsedQueries.addToCache(i,a),a=a.catch(s=>{var l;throw(l=this._recentlyUsedQueries)==null||l.removeFromCache(i),s}))}return this._featureSetQueryInterceptor&&this._featureSetQueryInterceptor.preLayerQueryCallback({layer:this._layer,query:e,method:r}),a===null&&(a=t(e)),a}_fieldsIncludingObjectId(e){if(e===null)return[this.objectIdField];const r=e.slice();if(r.includes("*"))return r;let t=!1;for(const a of r)if(a.toUpperCase()===this.objectIdField.toUpperCase()){t=!0;break}return t||r.push(this.objectIdField),r}isTable(){return this._layer.isTable||this._layer.geometryType===null||this._layer.type==="table"||this._layer.geometryType===""||this._layer.geometryType==="esriGeometryNull"}_makeRelationshipEnum(e){if(e.includes("esriSpatialRelRelation"))return"relation";switch(e){case"esriSpatialRelRelation":return"relation";case"esriSpatialRelIntersects":return"intersects";case"esriSpatialRelContains":return"contains";case"esriSpatialRelOverlaps":return"overlaps";case"esriSpatialRelWithin":return"within";case"esriSpatialRelTouches":return"touches";case"esriSpatialRelCrosses":return"crosses";case"esriSpatialRelEnvelopeIntersects":return"envelope-intersects"}return e}_makeRelationshipParam(e){return e.includes("esriSpatialRelRelation")?e.split(":")[1]:""}static create(e,r,t,a,i){const s=new L({url:e,outFields:r===null?["*"]:r});return new A({layer:s,spatialReference:t,lrucache:a,interceptor:i})}relationshipMetadata(){var e;return this._layer&&this._layer.source&&((e=this._layer.source.sourceJSON)!=null&&e.relationships)?this._layer.source.sourceJSON.relationships:[]}serviceUrl(){return z(this._layer.parsedUrl.path)}async queryAttachments(e,r,t,a,i){function s(c){const h=c.capabilities;return(h==null?void 0:h.data.supportsAttachment)&&(h==null?void 0:h.operations.supportsQueryAttachments)}const l=this._layer;if(!s(l))return[];const u=new ae({objectIds:[e],returnMetadata:i});(r&&r>0||t&&t>0)&&(u.size=[r&&r>0?r:0,t&&t>0?t:r+1]),a&&a.length>0&&(u.attachmentTypes=a),this._featureSetQueryInterceptor&&this._featureSetQueryInterceptor.preLayerQueryCallback({layer:l,query:u,method:"attachments"});const o=await l.queryAttachments(u);return o!=null&&o[e]?o[e].map(c=>{const h=`${this._layer.parsedUrl.path}/${e}/attachments/${c.id}`;let d=null;return i&&c.exifInfo&&(d=oe.convertJsonToArcade(c.exifInfo,"system",!0)),new _e(c.id,c.name,c.contentType,c.size,h,d,c.keywords??null)}):[]}async queryRelatedFeatures(e){const r=me(e);r.f="json",this._requestStandardised&&(r.sqlFormat="standard"),this._featureSetQueryInterceptor&&this._featureSetQueryInterceptor.preRequestCallback({layer:this._layer,queryPayload:r,method:"relatedrecords",url:this._layer.parsedUrl.path+"/queryRelatedRecords"});const t=await C(this._layer.parsedUrl.path+"/queryRelatedRecords",{responseType:"json",query:r});if(t.data){const a={},i=t.data;if(i!=null&&i.relatedRecordGroups){const s=i.spatialReference,l=i.exceededTransferLimit===!0;for(const u of i.relatedRecordGroups)q(u.relatedRecords,s),a[u.objectId]={features:u.relatedRecords,exceededTransferLimit:l}}return a}throw new I("InvalidRequest")}async getFeatureByObjectId(e,r){const t=this._createQuery();t.outFields=r,t.returnGeometry=!1,t.outSpatialReference=this.spatialReference,t.where=R(t.where,this.objectIdField+"="+e.toString()),this._featureSetQueryInterceptor&&this._featureSetQueryInterceptor.preLayerQueryCallback({layer:this._layer,query:t,method:"execute"});const a=await this._layer.source.queryFeaturesJSON(t);return a.features.length===1?(q(a.features,a.spatialReference??this.spatialReference.toJSON()),a.features[0]):null}async getIdentityUser(){var r;await this.load();const e=(r=B)==null?void 0:r.findCredential(this._layer.url);return e?e.userId:null}async getOwningSystemUrl(){var a,i;await this.load();const e=(a=B)==null?void 0:a.findServerInfo(this._layer.url);if(e)return e.owningSystemUrl??"";let r=this._layer.url;const t=r.toLowerCase().indexOf("/rest/services");if(r=t>-1?r.slice(0,t):r,r){r+="/rest/info";try{const s=await C(r,{query:{f:"json"}});let l="";return(i=s.data)!=null&&i.owningSystemUrl&&(l=s.data.owningSystemUrl),l}catch{return""}}return""}getDataSourceFeatureSet(){const e=new A({layer:this._layer,spatialReference:this.spatialReference??void 0,outFields:this._overrideFields??void 0,includeGeometry:!this._removeGeometry,lrucache:this._recentlyUsedQueries??void 0,interceptor:this._featureSetQueryInterceptor??void 0});return e._useDefinitionExpression=!1,e}get preferredTimeZone(){return this._layer.preferredTimeZone??null}get dateFieldsTimeZone(){return this._layer.dateFieldsTimeZone??null}get datesInUnknownTimezone(){return this._layer.datesInUnknownTimezone??!1}get editFieldsInfo(){return this._layer.editFieldsInfo??null}get timeInfo(){return this._layer.timeInfo??null}async getFeatureSetInfo(){var i,s,l;if(this._featureSetInfo)return this._featureSetInfo;let e=null,r="serviceItemId"in this._layer?this._layer.serviceItemId:null;const t=((i=this._layer.parsedUrl)==null?void 0:i.path)??null;if(t){const u=await C(t,{responseType:"json",query:{f:"json"}});e=((s=u==null?void 0:u.data)==null?void 0:s.name)??null,r=((l=u==null?void 0:u.data)==null?void 0:l.serviceItemId)??null}const a=this._layer.title&&(this._layer.parent??null)!==null;return this._featureSetInfo={layerId:this._layer.layerId,layerName:e===""?null:e,itemId:r===""?null:r,serviceLayerUrl:t===""?null:t,webMapLayerId:a?this._layer.id??null:null,webMapLayerTitle:a?this._layer.title??null:null,className:null,objectClassId:null},this._featureSetInfo}}class x extends j{constructor(e){super(),this.declaredClass="esri.arcade.featureset.sources.FeatureLayerMemory",this._removeGeometry=!1,this._overrideFields=null,this._forceIsTable=!1,this._maxProcessing=1e3,this._layer=e.layer,e.spatialReference&&(this.spatialReference=e.spatialReference),e.isTable===!0&&(this._forceIsTable=!0),e.outFields!==void 0&&(this._overrideFields=e.outFields),e.includeGeometry!==void 0&&(this._removeGeometry=e.includeGeometry===!1)}_maxQueryRate(){return T}async loadImpl(){return this._layer.loaded===!0?(this._initialiseFeatureSet(),this):(await this._layer.load(),this._initialiseFeatureSet(),this)}get gdbVersion(){return""}_initialiseFeatureSet(){var e,r,t,a;if(this.spatialReference??(this.spatialReference=this._layer.spatialReference),this.geometryType=this._layer.geometryType??"",this.fields=this._layer.fields.slice(),this._overrideFields!==null)if(this._overrideFields.length===1&&this._overrideFields[0]==="*")this._overrideFields=null;else{const i=new Set(this._overrideFields.map(s=>s.toLowerCase()));this.fields=this.fields.filter(({type:s,name:l})=>s==="oid"||this._layer.objectIdField===l||i.has(l.toLowerCase())),this._overrideFields=this.fields.map(({name:s})=>s)}this.objectIdField=this._layer.objectIdField;for(const i of this.fields)i.type==="global-id"&&(this.globalIdField=i.name);this._databaseType=0,this.hasZ=((r=(e=this._layer.capabilities)==null?void 0:e.data)==null?void 0:r.supportsZ)===!0,this.hasM=((a=(t=this._layer.capabilities)==null?void 0:t.data)==null?void 0:a.supportsM)===!0,this.subtypeField=("subtypeField"in this._layer?this._layer.subtypeField:null)??"",this.subtypes="subtypes"in this._layer?this._layer.subtypes:null,this.typeIdField=("typeIdField"in this._layer?this._layer.typeIdField:null)??"",this.types="types"in this._layer?this._layer.types:null}isTable(){return this._forceIsTable||"isTable"in this._layer&&this._layer.isTable||this._layer.type==="table"||!this._layer.geometryType}async _queryAll(){return(await this.query({abortSignal:k})).features}_queryLayerFeaturesJSON(e){return"queryFeaturesJSON"in this._layer?this._layer.queryFeaturesJSON(e):this._layer.source.queryFeaturesJSON(e)}async query(e){await this._ensureLoaded();let r="",t=!1;if(e.orderBy!=null&&(r=e.orderBy.constructClause(),t=!0),this.isTable()&&e.spatialFilter!=null)return v;const a=this._createQuery();return a.where=R(a.where,e.where==null?e.spatialFilter==null?"1=1":"":b(e.where,0)),e.spatialFilter!=null&&(a.spatialRelationship=this._makeRelationshipEnum(e.spatialFilter.relation),a.relationParameter=this._makeRelationshipParam(e.spatialFilter.relation),a.geometry=e.spatialFilter.geometry),a.outSpatialReference=this.spatialReference,a.orderByFields=r!==""?r.split(","):null,{filterApplied:!0,spatialFilterApplied:!0,ordered:t,features:(async function*(){const i=await this._queryLayerFeaturesJSON(a);g(e.abortSignal);for(const s of ie(i.features,this._maxQueryRate()))q(s,i.spatialReference??this.spatialReference.toJSON()),yield s}).apply(this)}}async queryStat(e){return{calculated:!1}}async canQueryAggregate(e){return!1}async queryAggregate(e){throw new I("NeverReach")}_createQuery(){const e=this._layer.createQuery();return e.returnZ=this.hasZ,e.returnM=this.hasM,e.outFields=this._overrideFields??["*"],e.returnGeometry=!this._removeGeometry,e}_makeRelationshipEnum(e){if(e.includes("esriSpatialRelRelation"))return"relation";switch(e){case"esriSpatialRelRelation":return"relation";case"esriSpatialRelIntersects":return"intersects";case"esriSpatialRelContains":return"contains";case"esriSpatialRelOverlaps":return"overlaps";case"esriSpatialRelWithin":return"within";case"esriSpatialRelTouches":return"touches";case"esriSpatialRelCrosses":return"crosses";case"esriSpatialRelEnvelopeIntersects":return"envelope-intersects"}return e}_makeRelationshipParam(e){return e.includes("esriSpatialRelRelation")?e.split(":")[1]:""}relationshipMetadata(){return[]}nativeCapabilities(){return{title:this._layer.title??"",canQueryRelated:!1,source:this,capabilities:this._layer.capabilities,databaseType:this._databaseType,requestStandardised:!0}}static create(e,r){let t=e.layerDefinition.objectIdField;const a=e.layerDefinition.typeIdField??"",i=[];if(e.layerDefinition.types)for(const y of e.layerDefinition.types)i.push(se.fromJSON(y));let s=e.layerDefinition.geometryType;s===void 0&&(s=e.featureSet.geometryType||"");let l=e.featureSet.features;if(!t){let y=!1;for(const f of e.layerDefinition.fields)if(f.type==="oid"||f.type==="esriFieldTypeOID"){t=f.name,y=!0;break}if(y===!1){let f="FID",S=!0,_=0;for(;S;){let w=!0;for(const H of e.layerDefinition.fields)if(H.name===f){w=!1;break}w===!0?S=!1:(_++,f="FID"+_.toString())}e.layerDefinition.fields.push({type:"esriFieldTypeOID",name:f,alias:f});const m=[];for(let w=0;w<l.length;w++)m.push({geometry:e.featureSet.features[w].geometry,attributes:{...e.featureSet.features[w].attributes,[f]:w}});l=m,t=f}}const u=[];for(const y of e.layerDefinition.fields)y instanceof $?u.push(y):u.push($.fromJSON(y));let o=s;switch(o||(o=""),o){case"esriGeometryPoint":o="point";break;case"esriGeometryPolyline":o="polyline";break;case"esriGeometryPolygon":o="polygon";break;case"esriGeometryEnvelope":o="extent";break;case"esriGeometryMultipoint":o="multipoint";break;case"":case"esriGeometryNull":o="esriGeometryNull"}if(o!=="esriGeometryNull"){const y=r.toJSON();for(const f of l)f.geometry&&!(f.geometry instanceof le)&&(f.geometry.type=o,f.geometry.spatialReference===void 0&&(f.geometry.spatialReference=y))}else for(const y of l)y.geometry&&(y.geometry=null);const c={outFields:["*"],source:l,fields:u,hasZ:e.layerDefinition.hasZ===!0||e.featureSet.hasZ===!0,hasM:e.layerDefinition.hasM===!0||e.featureSet.hasM===!0,types:i,typeIdField:a,objectIdField:t,spatialReference:r},h=o==="esriGeometryNull"||o===null;h||(c.geometryType=o);const d=new L(c);return e.layerDefinition.subtypeField&&e.layerDefinition.subtypes&&d.read({subtypes:e.layerDefinition.subtypes,subtypeField:e.layerDefinition.subtypeField}),new x({layer:d,spatialReference:r,isTable:h})}async queryAttachments(){return[]}async getFeatureByObjectId(e){const r=this._createQuery();r.where=this.objectIdField+"="+e.toString();const t=await this._queryLayerFeaturesJSON(r);return t.features.length===1?(q(t.features,t.spatialReference??this.spatialReference.toJSON()),t.features[0]):null}serviceUrl(){return""}async getOwningSystemUrl(){return""}async getIdentityUser(){return""}get preferredTimeZone(){return"preferredTimeZone"in this._layer?this._layer.preferredTimeZone:null}get dateFieldsTimeZone(){return"dateFieldsTimeZone"in this._layer?this._layer.dateFieldsTimeZone:null}get datesInUnknownTimezone(){return"datesInUnknownTimezone"in this._layer&&this._layer.datesInUnknownTimezone}get editFieldsInfo(){return"editFieldsInfo"in this._layer?this._layer.editFieldsInfo:null}get timeInfo(){return this._layer.timeInfo}async getFeatureSetInfo(){const e=this._layer.title&&this._layer.parent;return{layerId:null,layerName:null,itemId:null,serviceLayerUrl:null,webMapLayerId:e?this._layer.id??null:null,webMapLayerTitle:e?this._layer.title??null:null,className:null,objectClassId:null}}}class ge extends j{constructor(e){super(),this.declaredClass="esri.arcade.featureset.sources.FeatureLayerOGC",this._outFields=null,this._returnGeometry=!0,this._layer=e.layer,e.spatialReference&&(this.spatialReference=e.spatialReference),e.outFields!=null&&(this._outFields=e.outFields),e.includeGeometry!=null&&(this._returnGeometry=e.includeGeometry)}_maxQueryRate(){return this._layer.effectiveMaxRecordCount}async loadImpl(){return this._layer.loaded?(this._initialiseFeatureSet(),this):(await this._layer.load(),this._initialiseFeatureSet(),this)}_initialiseFeatureSet(){if(this.spatialReference??(this.spatialReference=this._layer.spatialReference),this.geometryType=this._layer.geometryType??"",this.fields=this._layer.fields.slice(),this._outFields!=null)if(this._outFields.length===1&&this._outFields[0]==="*")this._outFields=null;else{const r=new Set(this._outFields.map(t=>t.toLowerCase()));this.fields=this.fields.filter(({name:t})=>t===this._layer.objectIdField||r.has(t.toLowerCase())),this._outFields=this.fields.map(({name:t})=>t)}this.objectIdField=this._layer.objectIdField,this.hasZ=!!this._layer.hasZ,this.hasM=!1,this.typeIdField=this._layer.typeIdField??"",this.types=this._layer.types??null;const e=this._layer.source.getSource().layerDefinition.featureCount;e!=null&&e>=0&&(this._totalCount=e)}isTable(){return this._layer.isTable}async _queryAll(){await this._ensureLoaded();const e=this._layer.createQuery();return e.outSpatialReference=this.spatialReference,this._queryPaginated(e,this._layer.effectiveMaxRecordCount,k)}async query(e){await this._ensureLoaded();const r=this._layer.createQuery();if(r.outSpatialReference=this.spatialReference,e.spatialFilter!=null&&!ne(e.spatialFilter.geometry))switch(e.spatialFilter.relation){case"esriSpatialRelIntersects":case"esriSpatialRelContains":case"esriSpatialRelOverlaps":case"esriSpatialRelWithin":case"esriSpatialRelTouches":case"esriSpatialRelCrosses":r.geometry=e.spatialFilter.geometry.extent}return this._hasCachedFeatures||r.geometry==null?{filterApplied:e.where==null,spatialFilterApplied:e.spatialFilter==null,ordered:!1,features:await this.queryAll(e.abortSignal)}:{filterApplied:e.where==null,spatialFilterApplied:e.spatialFilter==null||e.spatialFilter.geometry.type==="extent"&&e.spatialFilter.relation==="esriSpatialRelIntersects",ordered:!1,features:this._queryPaginated(r,this._layer.effectiveMaxRecordCount,e.abortSignal)}}async*_queryPaginated(e,r,t){let a;e.num=r,e.start=0;do{g(t),a=await this._layer.source.queryFeaturesJSON(e);const i=a.spatialReference??this.spatialReference.toJSON();yield a.features.map(s=>{const l={};for(const o of this.fields)l[o.name]=s.attributes[o.name];let u=null;return this._returnGeometry&&!this.isTable()&&s.geometry!=null&&(s.geometry.spatialReference=i,u=s.geometry),{geometry:u,attributes:l}}),e.start+=a.features.length}while(a.exceededTransferLimit===!0)}async queryStat(e){return{calculated:!1}}async canQueryAggregate(e){return!1}async queryAggregate(e){throw new I("NeverReach")}nativeCapabilities(){return{title:this._layer.title??"",canQueryRelated:!1,source:this,capabilities:this._layer.capabilities,databaseType:this._databaseType,requestStandardised:!0}}async queryAttachments(){return[]}serviceUrl(){return""}relationshipMetadata(){return[]}get gdbVersion(){return""}getFeatureByObjectId(){throw new I("NeverReach")}async getOwningSystemUrl(){return""}async getIdentityUser(){return""}get preferredTimeZone(){return null}get dateFieldsTimeZone(){return null}get datesInUnknownTimezone(){return!1}get editFieldsInfo(){return null}get timeInfo(){return this._layer.timeInfo}async getFeatureSetInfo(){const e=this._layer.title&&this._layer.parent;return{layerId:null,layerName:null,itemId:null,serviceLayerUrl:null,webMapLayerId:e?this._layer.id??null:null,webMapLayerTitle:e?this._layer.title??null:null,className:null,objectClassId:null}}}class Ie extends j{constructor(e){super(),this.declaredClass="esri.arcade.featureset.sources.FeatureLayerRelated",this._removeGeometry=!1,this._overrideFields=null,this._maxProcessing=1e3,this._layer=e.layer,e.spatialReference&&(this.spatialReference=e.spatialReference),this._findObjectId=e.objectId,this.relationship=e.relationship,this._relatedLayer=e.relatedLayer,e.outFields!==void 0&&(this._overrideFields=e.outFields),e.includeGeometry!==void 0&&(this._removeGeometry=e.includeGeometry===!1)}_maxQueryRate(){return T}async loadImpl(){return await Promise.all([this._layer.load(),this._relatedLayer.load()]),this._initialiseFeatureSet(),this}nativeCapabilities(){return this._relatedLayer.nativeCapabilities()}_initialiseFeatureSet(){if(this.spatialReference==null&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this._relatedLayer.geometryType,this.fields=this._relatedLayer.fields.slice(),this.hasZ=this._relatedLayer.hasZ,this.hasM=this._relatedLayer.hasM,this._overrideFields!==null)if(this._overrideFields.length===1&&this._overrideFields[0]==="*")this._overrideFields=null;else{const r=new Set(this._overrideFields.map(t=>t.toLowerCase()));this.fields=this.fields.filter(({type:t,name:a})=>t==="oid"||r.has(a.toLowerCase())),this._overrideFields=this.fields.map(({name:t})=>t)}const e=this._layer.nativeCapabilities();e&&(this._databaseType=e.databaseType),this.objectIdField=this._relatedLayer.objectIdField,this.globalIdField=this._relatedLayer.globalIdField,this.hasM=this._relatedLayer.supportsM,this.hasZ=this._relatedLayer.supportsZ,this.typeIdField=this._relatedLayer.typeIdField,this.types=this._relatedLayer.types,this.subtypeField=this._relatedLayer.subtypeField,this.subtypes=this._relatedLayer.subtypes}async databaseType(){return this._databaseType=await this._relatedLayer.databaseType(),this._databaseType}isTable(){return this._relatedLayer.isTable()}async _queryAll(){return(await this.query({abortSignal:k})).features}async query(e){var s,l;if(await this._ensureLoaded(),await this.databaseType(),this.isTable()&&e.spatialFilter!=null)return v;const r=this._layer.nativeCapabilities();if(r.canQueryRelated===!1)return v;if((s=r.capabilities)!=null&&s.queryRelated.supportsPagination)return this._queryUsingPaging(r.source,e);let t="",a=!1;e.orderBy!=null&&((l=r.capabilities)==null?void 0:l.queryRelated.supportsOrderBy)===!0&&(t=e.orderBy.constructClause(),a=!0);const i=new Z;return i.objectIds=[this._findObjectId],i.outFields=this._overrideFields!==null?this._overrideFields:this._fieldsIncludingObjectId(this._relatedLayer.fields?this._relatedLayer.fields.map(u=>u.name):["*"]),i.relationshipId=this.relationship.id,i.where="1=1",i.returnGeometry=this._removeGeometry!==!0,i.outSpatialReference=this.spatialReference,i.orderByFields=t!==""?t.split(","):null,{filterApplied:e.where==null,spatialFilterApplied:e.spatialFilter==null,ordered:a,features:(async function*(){const u=await r.source.queryRelatedFeatures(i);g(e.abortSignal),yield u[this._findObjectId]?u[this._findObjectId].features:[]}).apply(this)}}async _queryUsingPaging(e,r){var o,c;let t="",a=!1;const i=this._layer.nativeCapabilities();r.orderBy!=null&&((o=i.capabilities)==null?void 0:o.queryRelated.supportsOrderBy)===!0&&(t=r.orderBy.constructClause(),a=!0),await this.databaseType();let s=this._maxQueryRate();const l=(c=i.capabilities)==null?void 0:c.query.maxRecordCount;l!=null&&l<s&&(s=l);const u=new Z;return u.relationshipId=this.relationship.id,u.objectIds=[this._findObjectId],u.outFields=this._overrideFields!==null?this._overrideFields:this._fieldsIncludingObjectId(this._relatedLayer.fields?this._relatedLayer.fields.map(h=>h.name):["*"]),u.where="1=1",u.orderByFields=t!==""?t.split(","):null,u.returnGeometry=this._removeGeometry!==!0,u.outSpatialReference=this.spatialReference,{filterApplied:r.where==null,spatialFilterApplied:r.spatialFilter==null,ordered:a,features:this._queryPaginated(e,u,s,r.abortSignal)}}async*_queryPaginated(e,r,t,a){let i;r.num=t,r.start=0;do g(a),i=(await e.queryRelatedFeatures(r))[this._findObjectId]??{exceededTransferLimit:!1,features:[]},yield i.features,r.start+=t;while(i.exceededTransferLimit===!0)}async queryStat(e){return{calculated:!1}}async canQueryAggregate(e){return!1}async queryAggregate(e){throw new I("NeverReach")}_fieldsIncludingObjectId(e){if(e===null)return[this.objectIdField];const r=e.slice();if(r.includes("*"))return r;let t=!1;for(const a of r)if(a.toUpperCase()===this.objectIdField.toUpperCase()){t=!0;break}return t||r.push(this.objectIdField),r}get gdbVersion(){return this._relatedLayer.gdbVersion}relationshipMetadata(){return this._relatedLayer.relationshipMetadata()}serviceUrl(){return this._relatedLayer.serviceUrl()}queryAttachments(e,r,t,a,i){return this._relatedLayer.queryAttachments(e,r,t,a,i)}getFeatureByObjectId(e,r){return this._relatedLayer.getFeatureByObjectId(e,r)}getOwningSystemUrl(){return this._relatedLayer.getOwningSystemUrl()}getIdentityUser(){return this._relatedLayer.getIdentityUser()}getDataSourceFeatureSet(){return this._relatedLayer}get preferredTimeZone(){return this._relatedLayer.preferredTimeZone??null}get dateFieldsTimeZone(){return this._relatedLayer.dateFieldsTimeZone??null}get datesInUnknownTimezone(){return this._relatedLayer.datesInUnknownTimezone}get editFieldsInfo(){return this._relatedLayer.editFieldsInfo??null}get timeInfo(){return this._relatedLayer.timeInfo??null}getFeatureSetInfo(){return this._relatedLayer.getFeatureSetInfo()}}function Se(){p.applicationCache===null&&(p.applicationCache=new p)}async function U(n,e,r){if(p.applicationCache){const t=p.applicationCache.getLayerInfo(n);if(t){const s=await t;return new L({url:n,outFields:e,sourceJSON:s})}const a=new L({url:n,outFields:e}),i=(async()=>(await a.load(),a.sourceJSON))();if(p.applicationCache){p.applicationCache.setLayerInfo(n,i);try{return await i,a}catch(s){throw p.applicationCache.clearLayerInfo(n),s}}return await i,a}if(r!=null){const t=r.getCachedLayerMetadata(n);if(t){const s=await t;return new L({url:n,outFields:e,sourceJSON:s})}const a=new L({url:n,outFields:e}),i=(async()=>(await a.load(),a.sourceJSON))();r.setCachedLayerMetadata(n,i);try{return await i,a}catch(s){throw r.removeCachedLayerMetadata(n,i),s}}return new L({url:n,outFields:e})}async function G(n,e,r,t,a,i=null){return F(await U(n,["*"],a),e,r,t,a,i)}function F(n,e=null,r=null,t=!0,a=null,i=null){switch(n.type){case"catalog-footprint":return F(n.parent,e,r,t,a,i);case"subtype-sublayer":{const s=F(n.parent,e,r,t,a,i);return new W({parentfeatureset:s,whereclause:Q.create(n.parent.subtypeField+"="+n.subtypeCode.toString(),{fieldsIndex:n.parent.fieldsIndex,timeZone:s.dateFieldsTimeZoneDefaultUTC})})}case"csv":case"geojson":case"knowledge-graph-sublayer":case"wfs":return new x({layer:n,spatialReference:e,outFields:r,includeGeometry:t,lrucache:a,interceptor:i});case"catalog":case"feature":case"oriented-imagery":case"subtype-group":{const s={layer:n,spatialReference:e,outFields:r,includeGeometry:t,lrucache:a,interceptor:i};return!n.url&&n.source?new x(s):new A(s)}case"ogc-feature":return new ge({layer:n,spatialReference:e,outFields:r,includeGeometry:t});default:throw new Error(`Unsupported layer type: ${n.type}`)}}async function be(n){if(p.applicationCache!==null){const r=p.applicationCache.getLayerInfo(n);if(r!==null)return r}const e=(async()=>{const r=await C(n,{responseType:"json",query:{f:"json"}});return r.data?r.data:null})();if(p.applicationCache!==null){p.applicationCache.setLayerInfo(n,e);try{return await e}catch(r){throw p.applicationCache.clearLayerInfo(n),r}}return e}async function Re(n,e){const r="QUERYDATAELEMTS:"+e.toString()+":"+n;if(p.applicationCache!==null){const a=p.applicationCache.getLayerInfo(r);if(a!==null)return a}const t=(async()=>{var i;const a=await C(n+"/queryDataElements",{method:"post",responseType:"json",query:{layers:JSON.stringify([e.toString()]),f:"json"}});if(a.data){const s=a.data;if((i=s.layerDataElements)!=null&&i[0])return s.layerDataElements[0]}throw new I("DataElementsNotFound")})();if(p.applicationCache!==null){p.applicationCache.setLayerInfo(r,t);try{return await t}catch(a){throw p.applicationCache.clearLayerInfo(r),a}}return t}async function Y(n,e){if(p.applicationCache!==null){const t=p.applicationCache.getLayerInfo(n);if(t!==null)return t}if(e!=null){const t=e.getCachedServiceMetadata(n);if(t!=null)return t}const r=(async()=>{const t=await C(n,{responseType:"json",query:{f:"json"},authMode:"no-prompt"});if(t.data){const a=t.data;return a.layers||(a.layers=[]),a.tables||(a.tables=[]),a}return{layers:[],tables:[]}})();if(p.applicationCache!==null){p.applicationCache.setLayerInfo(n,r);try{return await r}catch(t){throw p.applicationCache.clearLayerInfo(n),t}}if(e!=null){e.setCachedServiceMetadata(n,r);try{return await r}catch(t){throw e.removeCachedServiceMetadata(n,r),t}}return r}async function Le(n,e,r){var i,s,l;const t={metadata:null,networkId:-1,unVersion:3,terminals:[],layerIdLookup:new Map,sourceIdLookup:new Map,queryelem:null,layerNameLkp:{},lkp:null},a=await Y(n,null);if(t.metadata=a,((i=a.controllerDatasetLayers)==null?void 0:i.utilityNetworkLayerId)!==void 0&&a.controllerDatasetLayers.utilityNetworkLayerId!==null){if(a.layers)for(const c of a.layers)t.layerNameLkp[c.id]=c.name;if(a.tables)for(const c of a.tables)t.layerNameLkp[c.id]=c.name;const u=a.controllerDatasetLayers.utilityNetworkLayerId;t.networkId=u;const o=await Re(n,u);if(o){t.queryelem=o,(s=t.queryelem)!=null&&s.dataElement&&t.queryelem.dataElement.schemaGeneration!==void 0&&(t.unVersion=t.queryelem.dataElement.schemaGeneration),t.lkp={},t.queryelem.dataElement.domainNetworks||(t.queryelem.dataElement.domainNetworks=[]);for(const h of t.queryelem.dataElement.domainNetworks){for(const d of h.edgeSources??[]){const y={layerId:d.layerId,sourceId:d.sourceId,className:t.layerNameLkp[d.layerId]??null};t.layerIdLookup.set(y.layerId,y),t.sourceIdLookup.set(y.sourceId,y),y.className&&(t.lkp[y.className]=y)}for(const d of h.junctionSources??[]){const y={layerId:d.layerId,sourceId:d.sourceId,className:t.layerNameLkp[d.layerId]??null};t.layerIdLookup.set(y.layerId,y),t.sourceIdLookup.set(y.sourceId,y),y.className&&(t.lkp[y.className]=y)}}if(t.queryelem.dataElement.terminalConfigurations)for(const h of t.queryelem.dataElement.terminalConfigurations)for(const d of h.terminals)t.terminals.push({terminalId:d.terminalId,terminalName:d.terminalName});const c=await be(n+"/"+u);if(((l=c.systemLayers)==null?void 0:l.associationsTableId)!==void 0&&c.systemLayers.associationsTableId!==null){let h=null;if(r&&t.unVersion<8){const d=[];t.unVersion>=4&&(d.push("STATUS"),d.push("PERCENTALONG")),h=await G(n+"/"+c.systemLayers.associationsTableId,e,["OBJECTID","FROMNETWORKSOURCEID","TONETWORKSOURCEID","FROMGLOBALID","TOGLOBALID","TOTERMINALID","FROMTERMINALID","ASSOCIATIONTYPE","ISCONTENTVISIBLE","GLOBALID",...d],!1,null,null),await h.load(),t.unVersion>=4&&(h=new W({parentfeatureset:h,whereclause:Q.create("STATUS NOT IN (1, 2, 3, 4, 5, 6, 7, 9, 10, 11, 12, 13, 14, 15, 17, 18, 19, 20, 21, 22, 23, 25, 26, 27, 28, 29, 30, 31, 33, 34, 35, 36, 37, 38, 39, 41, 42, 43, 44, 45, 46, 47, 49, 50, 51, 52, 53, 54, 55, 57, 58, 59, 60, 61, 62, 63)",{fieldsIndex:h.getFieldsIndex(),timeZone:h.dateFieldsTimeZoneDefaultUTC})}),await h.load())}return{lkp:t.lkp,associations:h,unVersion:t.unVersion,terminals:t.terminals,layerIdLookup:t.layerIdLookup,sourceIdLookup:t.sourceIdLookup}}return{associations:null,unVersion:t.unVersion,lkp:null,terminals:[],layerIdLookup:new Map,sourceIdLookup:new Map}}return{associations:null,unVersion:t.unVersion,lkp:null,terminals:[],layerIdLookup:new Map,sourceIdLookup:new Map}}return{associations:null,unVersion:t.unVersion,lkp:null,terminals:[],layerIdLookup:new Map,sourceIdLookup:new Map}}async function Te(n,e,r,t=null,a=null,i=!0,s=null,l=null){let u=n.serviceUrl();if(!u)return null;u=u.endsWith("/")?u+e.relatedTableId.toString():u+"/"+e.relatedTableId.toString();const o=await G(u,t,a,i,s,l);return new Ie({layer:n,relatedLayer:o,relationship:e,objectId:r,spatialReference:t,outFields:a,includeGeometry:i,lrucache:s,interceptor:l})}class Ce extends K{constructor(e,r=null,t=null,a=null){super(),this._map=e,this._overrideSpatialReference=r,this._lrucache=t,this._interceptor=a,this._instantLayers=[]}_makeAndAddFeatureSet(e,r=!0,t=null){const a=F(e,this._overrideSpatialReference,t===null?["*"]:t,r,this._lrucache,this._interceptor);return this._instantLayers.push({featureset:a,opitem:e,includeGeometry:r,outFields:JSON.stringify(t)}),a}async featureSetByName(e,r=!0,t=null){if(J(this._map)&&!this._map.loaded)return await this._map.load(),this.featureSetByName(e,r,t);t===null&&(t=["*"]),t=(t=t.slice()).sort();const a=JSON.stringify(t);for(let s=0;s<this._instantLayers.length;s++){const l=this._instantLayers[s];if(l.opitem.title===e&&l.includeGeometry===r&&l.outFields===a)return this._instantLayers[s].featureset}const i=this._map.allLayers.find(s=>O(s)&&s.title===e);if(i!=null)return this._makeAndAddFeatureSet(i,r,t);if(this._map.allTables){const s=this._map.allTables.find(l=>O(l)&&l.title===e);if(s!=null)return this._makeAndAddFeatureSet(s,r,t)}return null}async featureSetById(e,r=!0,t=["*"]){if(J(this._map)&&!this._map.loaded)return await this._map.load(),this.featureSetById(e,r,t);t===null&&(t=["*"]),t=(t=t.slice()).sort();const a=JSON.stringify(t);for(let s=0;s<this._instantLayers.length;s++){const l=this._instantLayers[s];if(l.opitem.id===e&&l.includeGeometry===r&&l.outFields===a)return this._instantLayers[s].featureset}const i=this._map.allLayers.find(s=>O(s)&&s.id===e);if(i)return this._makeAndAddFeatureSet(i,r,t);if(this._map.allTables){const s=this._map.allTables.find(l=>O(l)&&l.id===e);if(s!=null)return this._makeAndAddFeatureSet(s,r,t)}return null}}class P extends K{constructor(e,r=null,t=null,a=null){super(),this._url=e,this._overrideSpatialReference=r,this._lrucache=t,this._interceptor=a,this.metadata=null,this._instantLayers=[]}get url(){return this._url}_makeAndAddFeatureSet(e,r=!0,t=null){const a=F(e,this._overrideSpatialReference,t===null?["*"]:t,r,this._lrucache);return this._instantLayers.push({featureset:a,opitem:e,includeGeometry:r,outFields:JSON.stringify(t)}),a}async _loadMetaData(){const e=await Y(this._url,this._lrucache);return this.metadata=e,e}load(){return this._loadMetaData()}clone(){return new P(this._url,this._overrideSpatialReference,this._lrucache,this._interceptor)}async featureSetByName(e,r=!0,t=null){t===null&&(t=["*"]),t=(t=t.slice()).sort();const a=JSON.stringify(t);for(let l=0;l<this._instantLayers.length;l++){const u=this._instantLayers[l];if(u.opitem.title===e&&u.includeGeometry===r&&u.outFields===a)return this._instantLayers[l].featureset}const i=await this._loadMetaData();let s=null;for(const l of i.layers??[])l.name===e&&(s=l);if(!s)for(const l of i.tables??[])l.name===e&&(s=l);if(s){const l=await U(this._url+"/"+s.id,["*"],this._lrucache);return this._makeAndAddFeatureSet(l,r,t)}return null}async featureSetById(e,r=!0,t=["*"]){t===null&&(t=["*"]),t=(t=t.slice()).sort();const a=JSON.stringify(t);e=e!=null?e.toString():"";for(let l=0;l<this._instantLayers.length;l++){const u=this._instantLayers[l];if(u.opitem.id===e&&u.includeGeometry===r&&u.outFields===a)return this._instantLayers[l].featureset}const i=await this._loadMetaData();let s=null;for(const l of i.layers??[])l.id!==null&&l.id!==void 0&&l.id.toString()===e&&(s=l);if(!s)for(const l of i.tables??[])l.id!==null&&l.id!==void 0&&l.id.toString()===e&&(s=l);if(s){const l=await U(this._url+"/"+s.id,["*"],this._lrucache);return this._makeAndAddFeatureSet(l,r,t)}return null}}function ve(n,e,r=null,t=null){return new Ce(n,e,r,t)}function qe(n,e,r=null,t=null){return new P(n,e,r,t)}function ke(n,e,r,t,a){if(n===null)return null;if(ce(n)){switch(e){case"datasource":return n.getDataSourceFeatureSet();case"parent":return n;case"root":return n.getRootFeatureSet()}return null}if(n instanceof D&&fe(n)){const i=n;switch(e){case"datasource":return F(i,a,"outFields"in i?i.outFields:null,!0,r,t).getDataSourceFeatureSet();case"parent":case"root":return F(i,a,"outFields"in i?i.outFields:null,!0,r,t)}return null}if(de(n)){switch(e){case"datasource":return F(n.parent,a,n.parent.outFields,!0,r,t).getDataSourceFeatureSet();case"parent":case"root":return F(n,a,n.parent.outFields,!0,r,t)}return null}return null}async function Ne(n,e,r,t,a,i,s,l=null){if(p.applicationCache){const o=p.applicationCache.getLayerInfo(n+":"+i.url);if(o)return M(await o,e,r,t,a,s,l)}if(s!=null){const o=s.getCachedPortalItem(i.url,n);if(o!=null)return await M(await o,e,r,t,a,s,l)}const u=new ue({id:n,portal:i}).load();p.applicationCache?p.applicationCache.setLayerInfo(n+":"+i.url,u):s!=null&&s.setCachedPortalItem(i.url,n,u);try{return await M(await u,e,r,t,a,s,l)}catch(o){throw p.applicationCache&&p.applicationCache.clearLayerInfo(n+":"+i.url),s!=null&&s.removeCachedPortalItem(i.url,n,u),o}}async function M(n,e,r,t,a,i,s){let l;if(n.type==="Feature Service"||n.type==="Map Service")l=await U(z(n.url??"")+"/"+e,["*"],i);else{if(e)throw new Error(`layerId=${e} provided for ${n.type} item`);if(i!=null){const u=i.getCachedPortalItemLayer(n.portal.url,n.id);if(u!=null)l=await u;else{const o=D.fromPortalItem(n);i.setCachedPortalItemLayer(n.portal.url,n.id,o);try{l=await o}catch(c){throw i.removeCachedPortalItemLayer(n.portal.url,n.id,o),c}}}else l=await D.fromPortalItem(n)}return F(l,r,t,a,i,s)}const Ge=Object.freeze(Object.defineProperty({__proto__:null,constructAssociationMetaDataFeatureSetFromUrl:Le,constructFeatureSet:F,constructFeatureSetFromPortalItem:Ne,constructFeatureSetFromRelationship:Te,constructFeatureSetFromUrl:G,convertToFeatureSet:ke,createFeatureSetCollectionFromMap:ve,createFeatureSetCollectionFromService:qe,initialiseMetaDataCache:Se},Symbol.toStringTag,{value:"Module"}));export{F as C,ke as D,Le as N,Te as T,G as _,Ne as b,x as c,Ge as f,W as i};
