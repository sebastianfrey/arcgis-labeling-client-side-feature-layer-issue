import{cT as z,kd as it,kg as gi,ki as At,dn as gt,kk as fi,lY as yi,kh as _s,aJ as c,kI as X,v9 as fe,va as ve,vb as ft,k5 as j,vc as Ce,qi as Ts,fj as ot,fh as Y,fi as te,fk as at,km as xi,aq as vs,ov as N,du as Cs,kJ as bi,aK as F,aL as nt,db as wi,eV as _i,ao as Ti,eR as as,ax as vi,eO as Ci,eP as Si,eQ as Ri,ca as ns,bZ as Pi,aM as Fi,cc as et,aF as tt,vd as Ss,oX as Ii,d3 as zi,iN as ls,kH as $i,ap as He,a as Mi,aW as ki,hg as Di,fx as us,ce as cs}from"./index-C_bK48d2.js";import{t as Rs,d as hs}from"./datasetUtils-Cmlo5xfm.js";import{v as Bi,i as Oi,d as Vi}from"./RasterVFDisplayObject-BYpmeKEO.js";import{b as Ai}from"./LayerView2D-DzSo3x-t.js";import{l as Gi}from"./pixelRangeUtils-BjN-b_zG.js";import{h as ps}from"./clipUtils-oY08WdMl.js";import{n as re,v as qi}from"./vectorFieldUtils-rpoioFtp.js";import{e as ji}from"./Container-DDZeWUS3.js";import{i as Ui,s as Li,u as Ei,o as Et}from"./rasterUtils-7WtlE8K6.js";import{b as Ps}from"./WGLContainer-Ddz6wajQ.js";import{n as Fs}from"./TileContainer-B59g0qvJ.js";import{f as Be,m as g,g as J,i as Oe,c as T,j as P,U as k,b as d,P as Ve,_ as b,d as I,af as C,N as R,ag as M,x as D,I as Ae,v as Ge,t as rt,X as lt,B as ue,k as ut,z as ce,T as ts,e as W,a3 as Hi,V as ds,Y as w,p as Q,A as Is,w as Z,n as v,$ as ie,r as ge,ah as U,q as K,D as Ht,Q as L,E as se,W as he,a4 as ke,G as zs,K as Mt,s as E,C as $e,ai as ye,a1 as Ni,a as xe,aj as Wi,a2 as Zi,a8 as Qi,ak as Yi,al as Xi,ac as Ji,am as Ki,an as er,ad as tr,ao as sr,ap as ir,aq as rr,u as or,ar,M as nr,as as lr,at as ur,au as cr,av as hr,aw as pr,Z as dr,H as mr,ax as Gt,ay as gr,y as fr,az as yr,aA as xr,a6 as br}from"./GraphShaderModule-BblaVFql.js";import{e as ms}from"./utils-DDjZAYSk.js";import{g as ct,J as Nt,E as De}from"./utils-EG3Lc9jF.js";import{H as yt}from"./constants-BBnGEY1d.js";import{m as Bt}from"./FramebufferObject-C4D9djRW.js";import{m as wr}from"./bitmapUtils-gwbw2c-H.js";import{c as _r}from"./PixelBlock-CE63rTmP.js";import{g as gs,a as fs,i as Tr,u as vr}from"./RawBlockCache-CHGqbnWp.js";import{$ as Cr,m as Sr,v as Rr,u as ys,I as Pr}from"./rasterProjectionHelper-DaGB8Ymv.js";import{r as qt}from"./highlightOptionsUtils-DXd9_sA-.js";import{a as Fr,i as Ue,V as Ir}from"./rasterFieldUtils-Dunpj7JV.js";import{i as zr}from"./timeSupport-CyzlmYj-.js";import{n as $r}from"./popupUtils-xKNFEs4a.js";import{I as Mr}from"./LayerView-BIRCz2lH.js";import{i as kr}from"./RefreshableLayerView-C4x13X1v.js";import"./VertexArrayObject-DXnl-4Rl.js";import"./memoryEstimations-w0EAmzVg.js";import"./VertexAttributeLocations-BSIMTgtd.js";import"./VertexBuffer-CJAj1yU0.js";import"./BufferObject--KeRTd-9.js";import"./VertexElementDescriptor-2_ON7b9t.js";import"./dataUtils-BsH8cfJg.js";import"./Utils-DV4XWvXG.js";import"./BoundingBox-hPKJQmqA.js";import"./layerViewUtils-B_qaHejE.js";import"./EffectView-P_O1XbEJ.js";import"./ProgramTemplate-ESmcnuBB.js";import"./vec3f32-WCVSSNPR.js";import"./config-MDUrh2eL.js";import"./earcut-Lltz9D9k.js";import"./featureConversionUtils-Di1UhLmY.js";import"./OptimizedFeatureSet-BZnZXZq6.js";import"./OptimizedGeometry-KE6YknPZ.js";import"./ShaderBuilder-DMt-f1fI.js";const Dr={bandCount:3,minOutput:0,maxOutput:1,minCutOff:[0,0,0],maxCutOff:[255,255,255],factor:[1/255,1/255,1/255],useGamma:!1,gamma:[1,1,1],gammaCorrection:[1,1,1],colormap:null,colormapOffset:null,stretchType:"none",type:"stretch"};let Br=class extends ji{constructor(e=null,t=null,s=null){super(),this._textureInvalidated=!0,this._colormapTextureInvalidated=!0,this._rasterTexture=null,this._maskTexture=null,this._rasterTextureBandIds=null,this._transformGridTexture=null,this._colormapTexture=null,this._colormap=null,this._supportsBilinearTexture=!0,this._processedTexture=null,this._highlightTexture=null,this.functionTextures=[],this.projected=!1,this.stencilRef=0,this.coordScale=[1,1],this._processed=!1,this._highlighted=!1,this._symbolizerParameters=null,this.height=null,this.isRendereredSource=!1,this.pixelRatio=1,this.resolution=0,this.rotation=0,this._source=null,this._mask=null,this.rawPixelData=null,this._suspended=!1,this._bandIds=null,this._interpolation=null,this._transformGrid=null,this.width=null,this.x=0,this.y=0,this.source=e,this.transformGrid=t,this.interpolation=s}destroy(){super.destroy(),this._disposeTextures()}get processedTexture(){return this._processedTexture}set processedTexture(e){this._processedTexture!==e&&(this._disposeTextures(!0),this._processedTexture=e)}get highlightTexture(){return this._highlightTexture}set highlightTexture(e){var t;this._highlightTexture!==e&&((t=this._highlightTexture)==null||t.dispose(),this._highlightTexture=e),e==null&&(this._highlighted=!1)}get rasterTexture(){return this._rasterTexture}set rasterTexture(e){var t;this._rasterTexture!==e&&((t=this._rasterTexture)==null||t.dispose(),this._rasterTexture=e),e==null&&(this.projected=!1)}get processed(){return this._processed}set processed(e){this._processed=e,e||(this.processedTexture=z(this.processedTexture),this.invalidateTexture())}get highlighted(){return this._highlighted}get symbolizerParameters(){return this._symbolizerParameters||Dr}set symbolizerParameters(e){this._symbolizerParameters!==e&&(this._symbolizerParameters=e,this._colormapTextureInvalidated=!0)}get source(){return this._source}set source(e){this._source!==e&&(this._source=e,this._rasterTexture&&(this._rasterTexture=z(this._rasterTexture),this._rasterTextureBandIds=null),this.projected=!1,this.invalidateTexture())}get mask(){return this._mask}set mask(e){this._mask!==e&&(this._mask=e,this._maskTexture=z(this._maskTexture))}get suspended(){return this._suspended}set suspended(e){this._suspended&&!e&&this.stage&&(this.ready(),this.requestRender()),this._suspended=e}get bandIds(){return this._bandIds}set bandIds(e){this._bandIds=e,this._isBandIdsChanged(e)&&(this.projected=!1,this.invalidateTexture())}get interpolation(){return this._interpolation||"nearest"}set interpolation(e){this._interpolation=e,this._rasterTexture&&this._rasterTexture.setSamplingMode(this._getTextureSamplingMethod(e||"nearest")==="bilinear"?9729:9728)}get transformGrid(){return this._transformGrid}set transformGrid(e){this._transformGrid!==e&&(this._transformGrid=e,this._transformGridTexture=z(this._transformGridTexture))}invalidateTexture(){this._textureInvalidated||(this._textureInvalidated=!0,this.requestRender())}getRasterTextureSize(e=!1){var s,o;const t=e||this.projected;return[t?this.width:((s=this.source)==null?void 0:s.width)||this.width,t?this.height:((o=this.source)==null?void 0:o.height)||this.height]}getRasterCellSize(){var o;const e=(o=this.rawPixelData)==null?void 0:o.srcPixelSize,{projected:t,resolution:s}=this;return e&&!t?[e.x,e.y]:[s,s]}_createTransforms(){return{displayViewScreenMat3:it()}}setTransform(e){const t=gi(this.transforms.displayViewScreenMat3),[s,o]=e.toScreenNoRotation([0,0],[this.x,this.y]),i=this.resolution/this.pixelRatio/e.resolution,a=i*this.width,n=i*this.height,l=Math.PI*this.rotation/180;At(t,t,gt(s,o)),At(t,t,gt(a/2,n/2)),fi(t,t,-l),At(t,t,gt(-a/2,-n/2)),yi(t,t,gt(a,n)),_s(this.transforms.displayViewScreenMat3,e.displayViewMat3,t)}getTextures({forProcessing:e=!1,useProcessedTexture:t=!1}={}){const s=t?this._processedTexture??this._rasterTexture:this._rasterTexture,o=[],i=[];return s?(this._transformGridTexture&&!this.projected&&(i.push(this._transformGridTexture),o.push("u_transformGrid")),i.push(s),o.push("u_image"),!this._colormapTexture||!t&&e||(i.push(this._colormapTexture),o.push("u_colormap")),this._maskTexture&&(i.push(this._maskTexture),o.push("u_mask")),{names:o,textures:i}):{names:o,textures:i}}onAttach(){this.invalidateTexture()}onDetach(){this.invalidateTexture()}updateTexture({context:e}){if(!this.stage)return void this._disposeTextures();const t=this._isValidSource(this.source);t&&this._colormapTextureInvalidated&&(this._colormapTextureInvalidated=!1,this._updateColormapTexture(e)),this._textureInvalidated&&(this._textureInvalidated=!1,this._createOrDestroyRasterTexture(e),this._rasterTexture&&(t?(this.transformGrid&&!this._transformGridTexture&&(this._transformGridTexture=Ui(e,this.transformGrid)),this._mask&&!this._maskTexture&&(this._maskTexture=Li(e,this._mask,[this.width,this.height]))):this._rasterTexture.setData(null)),this.suspended||(this.ready(),this.requestRender()))}updateProcessedTexture(e=!0){e&&(this._highlighted=this.highlightTexture!=null);const{functionTextures:t}=this;t.length!==0&&(this.processedTexture=t.shift(),t.forEach(s=>s==null?void 0:s.dispose()),t.length=0,this.processed=!!this.processedTexture)}_createOrDestroyRasterTexture(e){var a;const t=(a=this.source)==null?void 0:a.extractBands(this.bandIds);if(!this._isValidSource(t))return void(this._rasterTexture&&(this._rasterTexture=z(this._rasterTexture),this._rasterTextureBandIds=null));const s=!this._isBandIdsChanged(this.bandIds);if(this._rasterTexture){if(s)return;this._rasterTexture=z(this._rasterTexture),this._rasterTextureBandIds=null}this._supportsBilinearTexture=!!e.capabilities.textureFloatLinear;const o=this._getTextureSamplingMethod(this.interpolation),i=this.isRendereredSource;this._rasterTexture=Ei(e,t,o,i),this.projected=!1,this._processed=!1,this._rasterTextureBandIds=this.bandIds?[...this.bandIds]:null}_isBandIdsChanged(e){const t=this._rasterTextureBandIds;return!(t==null&&e==null||t&&e&&t.join("")===e.join(""))}_isValidSource(e){var t;return e!=null&&((t=e.pixels)==null?void 0:t.length)>0}_getTextureSamplingMethod(e){const{type:t}=this.symbolizerParameters,s=t==="lut"&&!this.symbolizerParameters.isClassBreaks||t==="hillshade"||t==="stretch"&&this.symbolizerParameters.bandCount===1;return!this._supportsBilinearTexture||s||e!=="bilinear"&&e!=="cubic"?"nearest":"bilinear"}_updateColormapTexture(e){const t=this._colormap,s=this.symbolizerParameters.colormap;return s?t?s.length!==t.length||s.some((o,i)=>o!==t[i])?(this._colormapTexture&&(this._colormapTexture=z(this._colormapTexture)),this._colormapTexture=Et(e,s),void(this._colormap=s)):void 0:(this._colormapTexture=Et(e,s),void(this._colormap=s)):(this._colormapTexture&&(this._colormapTexture=z(this._colormapTexture)),void(this._colormap=null))}_disposeTextures(e=!1){e?this.projected&&(this._transformGridTexture=z(this._transformGridTexture)):(this._rasterTexture=z(this._rasterTexture),this._colormapTexture=z(this._colormapTexture),this._transformGridTexture=z(this._transformGridTexture),this._maskTexture=z(this._maskTexture),this._rasterTextureBandIds=null,this._colormap=null,this._colormapTextureInvalidated=!0),this._processedTexture=z(this._processedTexture),this._highlightTexture=z(this._highlightTexture)}},Or=class extends Ps{constructor(e,t,s,o,i,a,n=null){super(e,t,s,o,i,a),this.bitmap=null,this.bitmap=new Br(n,null,null),this.bitmap.coordScale=[i,a],this.bitmap.once("isReady",()=>this.ready())}destroy(){super.destroy(),this.bitmap.destroy(),this.bitmap=null,this.stage=null}set stencilRef(e){this.bitmap.stencilRef=e}get stencilRef(){return this.bitmap.stencilRef}setTransform(e){super.setTransform(e),this.bitmap.transforms.displayViewScreenMat3=this.transforms.displayViewScreenMat3}_createTransforms(){return{displayViewScreenMat3:it(),tileMat3:it()}}onAttach(){this.bitmap.stage=this.stage}onDetach(){this.bitmap.stage=null}},$s=class extends Oe{};c([Be(0,T)],$s.prototype,"position",void 0);let Vr=class extends Ae{},Ne=class extends P{};c([g(k)],Ne.prototype,"inputTexture",void 0),c([g(k)],Ne.prototype,"sumTexture",void 0),c([g(k)],Ne.prototype,"numOfNoDataTexture",void 0),c([g(d)],Ne.prototype,"numTexels",void 0);let wt=class extends Ve{constructor(){super(...arguments),this.type="TextureStatisticsDiffShader"}vertex(e){const t=e.position;return{uv:t,glPosition:new b(ct(t),0,1)}}fragment(e){const{inputTexture:t,numOfNoDataTexture:s,sumTexture:o}=this.config,i=new Ge,a=I(t,e.uv),n=C(o,new M(0,0),new R(0)),l=C(s,new M(0,0),new R(0)).r,u=this.config.numTexels.subtract(l),h=n.divide(u),p=D(a.a,new d(0)),m=new d(1).subtract(p).multiply(a.subtract(h));return i.fragColor=m.multiply(m),i}};c([g(Ne)],wt.prototype,"config",void 0),c([X(0,J($s))],wt.prototype,"vertex",null),c([X(0,J(Vr))],wt.prototype,"fragment",null);let Ms=class extends Oe{};c([Be(0,T)],Ms.prototype,"position",void 0);let Ar=class extends Ae{},de=class extends P{};c([g(k)],de.prototype,"minTexture",void 0),c([g(k)],de.prototype,"maxTexture",void 0),c([g(k)],de.prototype,"sumTexture",void 0),c([g(k)],de.prototype,"numOfNoDataTexture",void 0),c([g(R)],de.prototype,"width",void 0),c([g(R)],de.prototype,"height",void 0),c([g(R)],de.prototype,"isFirstPass",void 0);let _t=class extends Ve{constructor(){super(...arguments),this.type="TextureStatisticsMinMaxSumShader"}vertex(e){const t=e.position;return{uv:t,glPosition:new b(ct(t),0,1)}}fragment(e){const t=new Ge,{minTexture:s,maxTexture:o,sumTexture:i,numOfNoDataTexture:a}=this.config,n=e.glFragCoord.xy,l=new M(n.multiply(2)),u=new R(0),h=C(s,l,u),p=C(s,l.add(new M(-1,0)),u),m=C(s,l.add(new M(0,-1)),u),f=C(s,l.add(new M(-1,-1)),u),x=Le(Le(h,Le(p,new b(yt))),Le(m,Le(f,new b(yt)))),y=C(o,l,u),_=C(o,l.add(new M(-1,0)),u),$=C(o,l.add(new M(0,-1)),u),S=C(o,l.add(new M(-1,-1)),u),V=Ee(Ee(y,Ee(_,new b(-yt))),Ee($,Ee(S,new b(-yt)))),ee=C(i,l,u),pe=C(i,l.add(new M(-1,0)),u),je=C(i,l.add(new M(0,-1)),u),Ot=C(i,l.add(new M(-1,-1)),u),dt=Nt(xt(ee),xt(pe),xt(je),xt(Ot)),Vt=C(a,l,u),Te=C(a,l.add(new M(-1,0)),u),oe=C(a,l.add(new M(0,-1)),u),di=C(a,l.add(new M(-1,-1)),u),mt=new d(this.config.isFirstPass),mi=Nt(bt(Vt,mt),bt(Te,mt),bt(oe,mt),bt(di,mt));return t.fragData0=x,t.fragData1=V,t.fragData2=dt,t.fragData3=mi,t}};function Le(r,e){const t=D(r.a,new d(0));return rt(r,e).multiply(new d(1).subtract(t)).add(e.multiply(t))}function Ee(r,e){const t=D(r.a,new d(0));return lt(r,e).multiply(new d(1).subtract(t)).add(e.multiply(t))}function xt(r){const e=D(r.a,new d(0)),t=new d(1).subtract(e);return r.multiply(t)}function bt(r,e){const t=D(r.a,new d(0)),s=new d(1).subtract(e);return e.multiply(t).multiply(new b(1)).add(s.multiply(r))}c([g(de)],_t.prototype,"config",void 0),c([X(0,J(Ms))],_t.prototype,"vertex",null),c([X(0,J(Ar))],_t.prototype,"fragment",null);let ks=class extends Oe{};c([Be(0,T)],ks.prototype,"position",void 0);let Gr=class extends Ae{},be=class extends P{};c([g(k)],be.prototype,"minTexture",void 0),c([g(k)],be.prototype,"maxTexture",void 0),c([g(k)],be.prototype,"sumTexture",void 0),c([g(k)],be.prototype,"numOfNoDataTexture",void 0),c([g(k)],be.prototype,"diffSqTexture",void 0),c([g(d)],be.prototype,"numTexels",void 0);let Tt=class extends Ve{constructor(){super(...arguments),this.type="TextureStatisticsStdDevShader"}vertex(e){const t=e.position;return{uv:t,glPosition:new b(ct(t),0,1)}}fragment(e){const t=new Ge,{minTexture:s,maxTexture:o,numOfNoDataTexture:i,sumTexture:a,diffSqTexture:n}=this.config,l=e.glFragCoord.xy,u=new M(l),h=new R(0),p=C(s,u,h),m=C(o,u,h),f=C(a,u,h),x=C(i,u,h).r,y=C(n,u,h),_=this.config.numTexels.subtract(x),$=f.divide(_),S=y.divide(_),V=ue(S);return t.fragData0=p,t.fragData1=m,t.fragData2=$,t.fragData3=V,t}};c([g(be)],Tt.prototype,"config",void 0),c([X(0,J(ks))],Tt.prototype,"vertex",null),c([X(0,J(Gr))],Tt.prototype,"fragment",null);let Ds=class extends Oe{};c([Be(0,T)],Ds.prototype,"position",void 0);let qr=class extends Ae{},vt=class extends P{};c([g(k)],vt.prototype,"sumTexture",void 0),c([g(R)],vt.prototype,"width",void 0),c([g(R)],vt.prototype,"height",void 0);class Ct extends Ve{constructor(){super(...arguments),this.type="TextureStatisticsSumOfSquaredDiffShader"}vertex(e){const t=e.position;return{uv:t,glPosition:new b(ct(t),0,1)}}fragment(e){const t=new Ge,{sumTexture:s}=this.config,o=e.glFragCoord.xy,i=new M(o.multiply(2)),a=new R(0),n=C(s,i,a),l=C(s,i.add(new M(-1,0)),a),u=C(s,i.add(new M(0,-1)),a),h=C(s,i.add(new M(-1,-1)),a),p=Nt(n,l,u,h);return t.fragData0=p,t.fragData1=new b(0),t.fragData2=new b(0),t.fragData3=new b(0),t}}c([g(vt)],Ct.prototype,"config",void 0),c([X(0,J(Ds))],Ct.prototype,"vertex",null),c([X(0,J(qr))],Ct.prototype,"fragment",null);const jt=1048576;class jr extends ut{constructor(){super(...arguments),this.type=32,this._width=0,this._height=0,this._framebuffers=null,this._minTexture=null,this._maxTexture=null,this._sumTexture=null,this._numOfNoDataTexture=null,this._resultsFramebuffer=null,this._startFramebuffer=null,this._diffFramebuffer=null,this._scaleFbo=null,this.shaders={textureStatisticsMinMaxSum:new _t,textureStatisticsSum:new Ct,textureStatisticsDiff:new wt,textureStatisticsStdDev:new Tt}}dispose(){this.shaders.textureStatisticsMinMaxSum=null,this._framebuffers&&(this._framebuffers.forEach(e=>z(e)),this._framebuffers=null),z(this._resultsFramebuffer),z(this._startFramebuffer),z(this._diffFramebuffer),z(this._scaleFbo),z(this._minTexture),z(this._maxTexture),z(this._sumTexture),z(this._numOfNoDataTexture)}get minValuesTexture(){return this._minTexture||null}get maxValuesTexture(){return this._maxTexture||null}get meanValuesTexture(){var e;return((e=this._resultsFramebuffer)==null?void 0:e.getColorTexture(fe))||null}get stdDevValuesTexture(){var e;return((e=this._resultsFramebuffer)==null?void 0:e.getColorTexture(ve))||null}get statsFbo(){return this._resultsFramebuffer}render(e,t){const{context:s,painter:o}=e;let i=t.fbo.width,a=t.fbo.height,n=t.fbo;const l=s.gl,u=s.getBoundFramebufferObject();if(i*a>jt||!ft(i)||!ft(a)){const f=i/a;if(i*a>jt){const x=Math.max(Math.floor(Math.sqrt(jt/f)),1);i=Math.max(Math.floor(f*x),1),a=x}if(ft(i)||(i=xs(i)),ft(a)||(a=xs(a)),this._scaleFbo)this._scaleFbo.resize(i,a);else{const{dataType:x,internalFormat:y}=t.fbo.getColorTexture(j).descriptor,_=y??Y.RGBA8;this._scaleFbo=We(s,i,a,x,_)}s.bindFramebuffer(this._scaleFbo),s.setViewport(0,0,i,a),o.blitTexture(s,n.getColorTexture(j),9728),n=this._scaleFbo}this._updateResources(e,n),o.setPipelineState({...ms,color:{write:[!0,!0,!0,!0],blendMode:"none"}});const h=this._applyReductionPass(e);l.readBuffer(l.COLOR_ATTACHMENT3),h.copyToTexture(0,0,1,1,0,0,this._numOfNoDataTexture),l.readBuffer(l.COLOR_ATTACHMENT2),h.copyToTexture(0,0,1,1,0,0,this._sumTexture),l.readBuffer(l.COLOR_ATTACHMENT1),h.copyToTexture(0,0,1,1,0,0,this._maxTexture),l.readBuffer(l.COLOR_ATTACHMENT0),h.copyToTexture(0,0,1,1,0,0,this._minTexture);const p=t.fbo.getColorTexture(j);if(!p)throw new Error("Start buffer color texture is not available, cannot compute diff.");this._computeDiff(e,p,this._sumTexture,this._numOfNoDataTexture,i,a);const m=this._applySecondReductionPass(e,i,a).getColorTexture(j);this._computeSdtDev(e,this._minTexture,this._maxTexture,this._sumTexture,this._numOfNoDataTexture,m,i,a),s.bindFramebuffer(u),s.setViewport(0,0,t.fbo.width,t.fbo.height),s.setDrawBuffers([j]),o.setPipelineState(ms)}_applyReductionPass(e){const{context:t,painter:s}=e,o=this.shaders.textureStatisticsMinMaxSum,i=this._framebuffers;if(i===null)throw new Error("Framebuffers are not initialized, cannot apply reduction pass.");t.setDrawBuffers([j,Ce,fe]);const a=this._startFramebuffer;let n=a.getColorTexture(j),l=a.getColorTexture(Ce),u=a.getColorTexture(fe),h=a.getColorTexture(ve);const p=i;let m=0;for(const f of p){t.setViewport(0,0,f.width,f.height),t.bindFramebuffer(f),t.setClearColor(0,0,0,0),t.clear(16384);const x={shader:o,uniforms:{config:{minTexture:{texture:n,unit:1},maxTexture:{texture:l,unit:2},sumTexture:{texture:u,unit:3},numOfNoDataTexture:{texture:h,unit:4},width:f.width,height:f.height,isFirstPass:m===0?1:0}},defines:null,optionalAttributes:null,useComputeBuffer:!1};s.submitDrawMesh(t,x,s.quadMesh),n=f.getColorTexture(j),l=f.getColorTexture(Ce),u=f.getColorTexture(fe),h=f.getColorTexture(ve),m++}return i.at(-1)}_applySecondReductionPass(e,t,s){const{context:o,painter:i}=e,a=this.shaders.textureStatisticsSum,n=this._framebuffers;if(n===null||this._diffFramebuffer==null)throw new Error("Framebuffers are not initialized, cannot apply reduction pass.");o.setDrawBuffers([j]);let l=this._diffFramebuffer.getColorTexture(j);const u=n;for(const h of u){o.setViewport(0,0,h.width,h.height),o.bindFramebuffer(h),o.setClearColor(0,0,0,0),o.clear(16384);const p={shader:a,uniforms:{config:{sumTexture:{texture:l,unit:2},width:h.width,height:h.height}},defines:null,optionalAttributes:null,useComputeBuffer:!1};i.submitDrawMesh(o,p,i.quadMesh),l=h.getColorTexture(j)}return n.at(-1)}_updateResources(e,t){const{context:s}=e,o=t.width,i=t.height;if(this._startFramebuffer===null){if(!Ts().supportsColorBufferFloat)throw new Error("WebGL does not support color buffer float, cannot compute texture statistics.");const n=t.getColorTexture(j);if(!n)throw new Error("Input FBO does not have a color attachment 0, cannot compute texture statistics.");const l=n.descriptor,{dataType:u,internalFormat:h}=l,p=We(s,o,i,u,h??Y.RGBA8,4),m=p.getColorTexture(j),f=p.getColorTexture(Ce),x=p.getColorTexture(fe),y=p.getColorTexture(ve);t.copyToTexture(0,0,o,i,0,0,m),t.copyToTexture(0,0,o,i,0,0,f),t.copyToTexture(0,0,o,i,0,0,x),t.copyToTexture(0,0,o,i,0,0,y),this._startFramebuffer=p,this._diffFramebuffer=We(s,o,i,te.FLOAT,Y.RGBA32F),this._resultsFramebuffer=We(s,1,1,te.FLOAT,Y.RGBA32F,4),this._minTexture=Me(s,1,1,te.FLOAT,Y.RGBA32F),this._maxTexture=Me(s,1,1,te.FLOAT,Y.RGBA32F),this._sumTexture=Me(s,1,1,te.FLOAT,Y.RGBA32F),this._numOfNoDataTexture=Me(s,1,1,te.FLOAT,Y.R32F)}else{const n=this._startFramebuffer;n.resize(o,i);const l=n.getColorTexture(j),u=n.getColorTexture(Ce),h=n.getColorTexture(fe),p=n.getColorTexture(ve);t.copyToTexture(0,0,o,i,0,0,l),t.copyToTexture(0,0,o,i,0,0,u),t.copyToTexture(0,0,o,i,0,0,h),t.copyToTexture(0,0,o,i,0,0,p),this._diffFramebuffer.resize(o,i)}if(this._width===o&&this._height===i&&this._framebuffers!==null)return;const a=(this._framebuffers||[]).reverse();this._framebuffers=null,this._width=o,this._height=i,this._framebuffers=this._updateFramebuffers(s,o,i,a,4)}_updateFramebuffers(e,t,s,o,i=1){const a=[];let n=t,l=s;for(;n>1||l>1;){const u=Math.max(1,Math.floor(n/2)),h=Math.max(1,Math.floor(l/2)),p=Ur(e,u,h,o,i);a.push(p),n=u,l=h}return a.at(-1),o.forEach(u=>z(u)),o.length=0,a}_computeDiff(e,t,s,o,i,a){const{context:n,painter:l}=e;n.bindFramebuffer(this._diffFramebuffer),n.setDrawBuffers([j]),n.setViewport(0,0,i,a),n.setClearColor(0,0,0,0),n.clear(16384);const u={shader:this.shaders.textureStatisticsDiff,uniforms:{config:{inputTexture:{texture:t,unit:1},sumTexture:{texture:s,unit:2},numOfNoDataTexture:{texture:o,unit:3},numTexels:i*a}},defines:null,optionalAttributes:null,useComputeBuffer:!1};l.submitDrawMesh(n,u,l.quadMesh)}_computeSdtDev(e,t,s,o,i,a,n,l){const{context:u,painter:h}=e;u.bindFramebuffer(this._resultsFramebuffer),u.setDrawBuffers([j,Ce,fe,ve]),u.setViewport(0,0,1,1),u.setClearColor(0,0,0,0),u.clear(16384);const p={shader:this.shaders.textureStatisticsStdDev,uniforms:{config:{minTexture:{texture:t,unit:1},maxTexture:{texture:s,unit:2},sumTexture:{texture:o,unit:3},numOfNoDataTexture:{texture:i,unit:4},diffSqTexture:{texture:a,unit:5},numTexels:n*l}},defines:null,optionalAttributes:null,useComputeBuffer:!1};h.submitDrawMesh(u,p,h.quadMesh)}}function Ur(r,e,t,s,o=1){let i=s.pop();return i!==void 0?i.resize(e,t):i=We(r,e,t,te.FLOAT,Y.RGBA32F,o),i}function We(r,e,t,s,o,i=1){if(i<1||i>4)throw new Error("Number of color attachments must be between 1 and 4.");const a=new Bt(r,Me(r,e,t,s,o));for(let n=1;n<i;n++){const l=Me(r,e,t,s,o);a.attachColorTexture(l,j+n)}return a}function Me(r,e,t,s,o){const i=new at(e,t);return i.samplingMode=9728,i.wrapMode=33071,i.pixelFormat=6408,i.dataType=s,i.internalFormat=o,new ot(r,i)}function xs(r){const e=xi(r),t=e/2;return Math.abs(e-r)<Math.abs(t-r)?e:t}function Bs(r,e){const t=new at(r,e);return t.internalFormat=Y.RGBA32F,t.samplingMode=9728,t.dataType=te.FLOAT,t.isImmutable=!0,t.wrapMode=33071,t}function Lr(r,e,t){const s=Bs(e,t);return new ot(r,s)}function Os(r,e,t){const s=Bs(e,t);return new Bt(r,s)}function st(r,e){const{symbolizerParameters:t}=r,{type:s}=t,o=s==="lut"?"nearest":r.interpolation,i=o==="bilinear"&&s!=="lut"&&(s!=="stretch"||t.bandCount===1),a=o==="cubic";return{bilinear:i||o==="bilinear"&&e!=null&&!e.capabilities.textureFloatLinear,bicubic:a,nearestOnEdge:i}}function Er(r,e,t,s){const o=ce(e.multiply(t)),i=new M(new R(o.x),new R(o.y)),a=new M(i.x.add(1),i.y),n=new M(i.x,i.y.add(1)),l=new M(i.x.add(1),i.y.add(1)),u=C(r,i,new R(0)),h=C(r,a,new R(0)),p=C(r,n,new R(0)),m=C(r,l,new R(0)),f=ts(e.multiply(t)),x=W(u,h,f.x),y=W(p,m,f.x),_=W(x,y,f.y);if(!s)return _;const $=new b(u.a,h.a,p.a,m.a),S=$.xy.multiply($.zw),V=ce(S.x.multiply(S.y).add(.5)),ee=_.multiply(V),pe=De(V).multiply(I(r,e));return ee.add(pe)}let Ze=class extends P{};function Hr(r,e){const t=I(e.transformTexture,r);return new T(t.r,t.g)}function Nr(r,e){const{transformTexture:t,targetImageSize:s,transformSpacing:o}=e,i=ce(r.multiply(s)),a=new T(4,1),n=ce(i.divide(o)).multiply(a),l=ts(i.add(new T(.5,.5)).divide(o)),u=new M(ds(n.x),ds(n.y)),h=new w(l,1);return Q(Is(l.x,l.y),Wr(t,u,h),Zr(t,u,h))}function Wr(r,e,t){const s=C(r,e,new R(0)),o=new M(e.x.add(1),e.y),i=C(r,o,new R(0));return new T(Z(s.rgb,t),Z(i.rgb,t))}function Zr(r,e,t){const s=new M(e.x.add(2),e.y),o=C(r,s,new R(0)),i=new M(e.x.add(3),e.y),a=C(r,i,new R(0));return new T(Z(o.rgb,t),Z(a.rgb,t))}function Qr(r){const e=D(new T(-1e-5,-1e-5),r).multiply(D(r,new T(1.00001,1.00001))),t=De(e.x.multiply(e.y));return new Hi(t)}function Vs(r,e,t=!1){return e?t?Hr(r,e):Nr(r,e):r}function As(r,e,t){const{bicubic:s=!1,bilinear:o=!1,nearestOnEdge:i=!1}=t??{};return s||o?s?wr(e.texture,r,e.srcImageSize):Er(e.texture,r,e.srcImageSize,i):I(e.texture,r)}c([g(k)],Ze.prototype,"transformTexture",void 0),c([g(T)],Ze.prototype,"targetImageSize",void 0),c([g(T)],Ze.prototype,"transformSpacing",void 0),c([g(T)],Ze.prototype,"transformGridSize",void 0);let Gs=class extends Oe{};c([Be(0,T)],Gs.prototype,"position",void 0);let Yr=class extends Ae{};class Se extends P{}c([g(k)],Se.prototype,"texture",void 0),c([g(ge)],Se.prototype,"dvsMat3",void 0),c([g(T)],Se.prototype,"coordScale",void 0),c([g(T)],Se.prototype,"srcImageSize",void 0),c([g(d)],Se.prototype,"opacity",void 0);let qs=class extends P{};c([g(k)],qs.prototype,"maskTexture",void 0);let js=class extends P{};c([g(k)],js.prototype,"highlightTexture",void 0);let q=class extends Ve{constructor(){super(...arguments),this.applyProjection=!0,this.lookupProjection=!1,this.bilinear=!1,this.bicubic=!1,this.nearestOnEdge=!1,this.applyPixelMask=!1,this.applyPixelHighlights=!1}vertex(e){const t=e.position,{dvsMat3:s,coordScale:o}=this.config,i=s.multiply(new w(t.multiply(o),1));return{uv:t,glPosition:new b(i,1)}}fragment(e){const t=new Ge,s=Vs(e.uv,this.applyProjection?this.projectionConfig:void 0,this.lookupProjection);let o=this._colorize(s,e.uv);this.applyPixelHighlights&&(o=this._highlightPixels(e.uv,o));const i=Q(Qr(s),new b(0),o);let a=i.a.multiply(this.config.opacity);if(this.applyPixelMask){const n=this._getPixelMask(e.uv);a=a.multiply(n)}return t.fragColor=new b(i.rgb,1).multiply(a),t}_getPixel(e){const{config:t,bicubic:s,bilinear:o,nearestOnEdge:i}=this;return As(e,t,{bicubic:s,bilinear:o,nearestOnEdge:i})}_getPixelMask(e){const{maskTexture:t}=this.pixelMaskConfig,s=I(t,e);return U(s.a)}_highlightPixels(e,t){const{highlightTexture:s}=this.highlightConfig,o=I(s,e),i=U(o.a);return W(t,o,i)}};c([v],q.prototype,"applyProjection",void 0),c([v],q.prototype,"lookupProjection",void 0),c([v],q.prototype,"bilinear",void 0),c([v],q.prototype,"bicubic",void 0),c([v],q.prototype,"nearestOnEdge",void 0),c([v],q.prototype,"applyPixelMask",void 0),c([v],q.prototype,"applyPixelHighlights",void 0),c([g(Se)],q.prototype,"config",void 0),c([ie(Ze)],q.prototype,"projectionConfig",void 0),c([ie(qs)],q.prototype,"pixelMaskConfig",void 0),c([ie(js)],q.prototype,"highlightConfig",void 0),c([X(0,J(Gs))],q.prototype,"vertex",null),c([X(0,J(Yr))],q.prototype,"fragment",null);let me=class extends P{};function ht(r,e,t,s=!0){const{colormapTexture:o,colormapOffset:i,colormapMaxIndex:a}=t,n=r.r.multiply(e).subtract(i),l=K(n,new d(0),a),u=new T(l.add(.5).divide(a.add(1)),0),h=I(o,u),p=new b(h.rgb,h.a.multiply(r.a));if(s)return p;const m=D(new d(0),n).multiply(D(n,t.colormapMaxIndex));return p.multiply(m)}c([g(k)],me.prototype,"colormapTexture",void 0),c([g(d)],me.prototype,"colormapOffset",void 0),c([g(d)],me.prototype,"colormapMaxIndex",void 0);let Us=class extends q{constructor(){super(...arguments),this.type="RasterColorizerLUTShader"}_colorize(e){const t=this._getPixel(e);return ht(t,new d(1),this.colormapConfig,!1)}};c([g(me)],Us.prototype,"colormapConfig",void 0);function Ls(r){const e=new b(0,-.3333333333333333,.6666666666666666,-1),t=Q(Ht(r.y,r.z),new b(r.zy,e.wz),new b(r.yz,e.xy)),s=Q(Ht(r.x,t.x),new b(t.xyw,r.x),new b(r.x,t.yzx)),o=s.x.subtract(rt(s.w,s.y)),i=new d(1e-10),a=s.w.subtract(s.y),n=o.multiply(6).add(i),l=L(a.divide(n).add(s.z)),u=s.x.add(i),h=rt(o.divide(u),new d(1));return new w(l,h,s.x)}function Es(r){const e=new b(1,.6666666666666666,.3333333333333333,3),t=L(ts(r.xxx.add(e.xyz)).multiply(6).subtract(e.www)),s=K(t.subtract(e.xxx),new w(0,0,0),new w(1));return r.z.multiply(W(e.xxx,s,r.y))}let ne=class extends P{};function H(r){const e=L(r),t=D(e,new T(1,1)).multiply(e),s=new d(2).subtract(e),o=D(new d(1),e).multiply(s);return t.add(o)}function pt(r,e,t){const s=new d(1).divide(t),o=I(r,H(s.multiply(new T(-1,-1)).add(e))),i=I(r,H(s.multiply(new T(0,-1)).add(e))),a=I(r,H(s.multiply(new T(1,-1)).add(e))),n=I(r,H(s.multiply(new T(-1,0)).add(e))),l=I(r,H(e)),u=I(r,H(s.multiply(new T(1,0)).add(e))),h=I(r,H(s.multiply(new T(-1,1)).add(e))),p=I(r,H(s.multiply(new T(0,1)).add(e))),m=I(r,H(s.multiply(new T(1,1)).add(e))),f=new b(o.a,i.a,a.a,n.a),x=new b(u.a,h.a,p.a,m.a),y=f.multiply(x),_=y.xy.multiply(y.zw),$=_.x.multiply(_.y).multiply(l.a),S=new se(new d(0),10);return S[0]=o.r,S[1]=i.r,S[2]=a.r,S[3]=n.r,S[4]=l.r,S[5]=u.r,S[6]=h.r,S[7]=p.r,S[8]=m.r,S[9]=$,S}function ss(r,e){const t=new b(r[5],r[3],r[7],r[1]).multiply(2),s=new w(r[2],t[0],r[8]),o=new w(r[0],t[1],r[6]),i=Z(s.subtract(o),new w(1)),a=new w(r[6],t[2],r[8]),n=new w(r[0],t[3],r[2]),l=Z(a.subtract(n),new w(1));return new T(i,l).multiply(e)}function Hs(r,e,t){const{factor:s}=e,o=ss(r,s),i=ue(Z(o,o).add(1)),a=r[9],{sinZsinAs:n,sinZcosAs:l,cosZs:u,weights:h}=e;if(!t){const x=Ut({sinZsinA:n[0],sinZcosA:l[0],cosZ:u[0],weights:new d(1),dzxy:o,dzd:i});return new b(x,x,x,a)}const p=Ut({sinZsinA:new w(n[0],n[1],n[2]),sinZcosA:new w(l[0],l[1],l[2]),cosZ:new w(u[0],u[1],u[2]),weights:new w(h[0],h[1],h[2]),dzxy:o,dzd:i}),m=Ut({sinZsinA:new w(n[3],n[4],n[5]),sinZcosA:new w(l[3],l[5],l[5]),cosZ:new w(u[3],u[4],u[5]),weights:new w(h[3],h[4],h[5]),dzxy:o,dzd:i}),f=Z(p.add(m),new w(1));return new b(f,f,f,a)}function Ut(r){const e=r.sinZsinA.multiply(r.dzxy.y),t=r.sinZcosA.multiply(r.dzxy.x),s=e.subtract(t),o=r.cosZ.add(s).divide(r.dzd);return o.multiply(D(new d(0),o)).multiply(r.weights)}function Ns(r,e){const{pixelSizeFactor:t}=r,s=[r.factor[0]/e[0],r.factor[1]/e[1]];if(t>0){const{zFactor:o,pixelSizePower:i,gcsFactor:a}=r,n=e[0]*a,l=e[1]*a;s[0]=(o+n**i*t)/(8*n),s[1]=(o+l**i*t)/(8*l)}return s}c([g(se.ofType(d,6))],ne.prototype,"sinZcosAs",void 0),c([g(se.ofType(d,6))],ne.prototype,"sinZsinAs",void 0),c([g(se.ofType(d,6))],ne.prototype,"cosZs",void 0),c([g(se.ofType(d,6))],ne.prototype,"weights",void 0),c([g(d)],ne.prototype,"minValue",void 0),c([g(d)],ne.prototype,"maxValue",void 0),c([g(T)],ne.prototype,"factor",void 0);let Qe=class extends q{constructor(){super(...arguments),this.type="RasterColorizerShadedReliefShader",this.applyColormap=!1,this.isMultidirectional=!1}_colorize(e){const{texture:t}=this.config,s=pt(t,e,this.config.srcImageSize),o=Hs(s,this.hillshadeConfig,this.isMultidirectional);if(!this.applyColormap)return new b(o.x,o.x,o.x,o.a);const{minValue:i,maxValue:a}=this.hillshadeConfig,n=this._getPixel(e),l=a.subtract(i),u=n.r.subtract(i),h=K(u.divide(l),new d(0),new d(1)),p=ht(new b(h,h,h,1),new d(255),this.colormapConfig),m=Ls(p.xyz),f=Es(new w(m.xy,o.x));return new b(f,p.a.multiply(o.a))}};c([v],Qe.prototype,"applyColormap",void 0),c([v],Qe.prototype,"isMultidirectional",void 0),c([g(ne)],Qe.prototype,"hillshadeConfig",void 0),c([ie(me)],Qe.prototype,"colormapConfig",void 0);function B(r){const e=U(r),t=r.add(L(e).subtract(1));return e.multiply(e).divide(t)}function qe(r){return new b(ce(r.rgb.add(.5)),r.a)}function kt(r,e){return D(e.x,r).multiply(D(r,e.y))}function Xr(r,e){let t=new w(0,0,0);const s=new w(r);for(let o=0;o<re/3;o++){const i=6*o,a=new w(e[i],e[i+2],e[i+4]),n=new w(e[i+1],e[i+3],e[i+5]);t=t.add(D(a,s).multiply(D(s,n)))}return U(Z(t,new w(1,1,1)))}function Jr(r,e,t){const s=new w(r);let o=new w(0,0,0),i=new d(0);for(let a=0;a<t/3;a++){const n=9*a,l=new w(e[n],e[n+3],e[n+6]),u=new w(e[n+1],e[n+4],e[n+7]),h=D(l,s).multiply(D(s,u)),p=new w(e[n+2],e[n+5],e[n+8]);i=W(i,p.x,h.x),i=W(i,p.y,h.y),i=W(i,p.z,h.z),o=o.add(h)}return{mapValue:i,includeMask:U(Z(o,new w(1,1,1)))}}let le=class extends P{};c([g(d)],le.prototype,"minOutput",void 0),c([g(d)],le.prototype,"maxOutput",void 0),c([g(w)],le.prototype,"minCutOff",void 0),c([g(w)],le.prototype,"maxCutOff",void 0),c([g(w)],le.prototype,"factor",void 0),c([g(w)],le.prototype,"gamma",void 0),c([g(w)],le.prototype,"gammaCorrection",void 0);class Re extends P{}function Ws(r,e){const{minCutOff:t,maxCutOff:s,factor:o,minOutput:i}=e;return K(r,t,s).subtract(t).multiply(o).add(i)}function Zs(r,e){const{minCutOff:t,maxCutOff:s,minOutput:o,maxOutput:i,gamma:a,gammaCorrection:n}=e,l=K(r,t,s).subtract(t),u=s.subtract(t),h=l.divide(u),p=D(new d(1),a),m=U(a.subtract(1)),f=i.subtract(o),x=new w(1),y=he(x.divide(f),h.multiply(n)),_=De(p.multiply(m).multiply(y)),$=he(h,x.divide(a)),S=_.multiply(f).multiply($).add(o);return K(S,o,i)}function Qs(r,e,t,s=255){const o=t?Zs(r.rgb,e).divide(s):Ws(r.rgb,e);return new b(o,r.a)}function Kr(r,e,t,s,o){const i=new M(0,0),a=new R(0);let n=C(t.minTexture,i,a).rgb,l=C(t.maxTexture,i,a).rgb;if(o){const x=C(t.meanTexture,i,a).rgb,y=C(t.stddevTexture,i,a).rgb.multiply(t.numberOfStandardDeviations);n=lt(n,x.subtract(y)),l=rt(l,x.add(y))}const u=l.subtract(n),h=new w(B(u.x),B(u.y),B(u.z)),p=e.maxOutput.subtract(e.minOutput).multiply(h),m={...e,minCutOff:n,maxCutOff:l,factor:p},f=s?Zs(r.rgb,m).divide(255):Ws(r.rgb,m);return new b(f,r.a)}c([g(k)],Re.prototype,"minTexture",void 0),c([g(k)],Re.prototype,"maxTexture",void 0),c([g(k)],Re.prototype,"meanTexture",void 0),c([g(k)],Re.prototype,"stddevTexture",void 0),c([g(d)],Re.prototype,"numberOfStandardDeviations",void 0);let ae=class extends q{constructor(){super(...arguments),this.type="RasterColorizerStretchShader",this.isMultiband=!0,this.applyColormap=!1,this.useGamma=!1,this.noOp=!1,this.draStretchType=0}_colorize(e){const t=this._getPixel(e);if(this.noOp)return t;const{draStretchType:s,stretchConfig:o,useGamma:i,statisticsConfig:a}=this;let n=s===0?Qs(t,o,i):Kr(t,o,a,i,s===2);if(this.isMultiband)return n;if(n=new b(n.rrr,n.a),this.applyColormap){const l=this.useGamma?255:1;n=ht(n,new d(l),this.colormapConfig)}return n}};c([v],ae.prototype,"isMultiband",void 0),c([v],ae.prototype,"applyColormap",void 0),c([v],ae.prototype,"useGamma",void 0),c([v],ae.prototype,"noOp",void 0),c([v],ae.prototype,"draStretchType",void 0),c([g(le)],ae.prototype,"stretchConfig",void 0),c([ie(me)],ae.prototype,"colormapConfig",void 0),c([ie(Re)],ae.prototype,"statisticsConfig",void 0);const eo=160,to=new Set(["f32","f64","u16","s16","u32","s32"]);let so=class extends ut{constructor(){super(...arguments),this.name="BrushRasterColorizer",this.type=0,this.shaders={lut:new Us,stretch:new ae,shadedRelief:new Qe},this._mosaicFbo=null,this._statisticsTechnique=null,this._draTimer=0}shutdown(e){super.shutdown(e),this._mosaicFbo=z(this._mosaicFbo),this._statisticsTechnique=z(this._statisticsTechnique)}render(e,t){const s=t.bitmaps.some(Lt);s||(this._mosaicFbo=z(this._mosaicFbo),this._statisticsTechnique=z(this._statisticsTechnique));const o=s?this._computeStatisticsTextures(e,t):void 0;for(const i of t.bitmaps){if(!i.source||i.suspended)continue;e.timeline.begin(this.name);const{painter:a}=e;a.setPipelineState({depth:!1,stencil:{test:{mask:255,compare:514,op:{fail:7680,zFail:7680,zPass:7680}},write:!1},color:{write:[!0,!0,!0,!0],blendMode:"composite"}}),i.updateTexture(e),i.updateProcessedTexture();const{type:n}=i.symbolizerParameters,l=n==="stretch"?this._getStretchOptions(i,o):n==="lut"?this._getLutOptions(i):this._getShadedReliefOptions(i);i.interpolation!=="bilinear"||e.context.capabilities.textureFloatLinear||(l.defines.bilinear=!0),a.submitDrawMesh(e.context,l,a.quadMesh,i),e.timeline.end(this.name)}}_computeStatisticsTextures(e,t){this._statisticsTechnique??(this._statisticsTechnique=new jr);const s=this._statisticsTechnique;let o=vs("esri-2d-dra-delay");if(o==null){const i=t.bitmaps.find(Lt),{stretchType:a,bandCount:n}=i.symbolizerParameters,{pixelType:l}=i.source;a==="minMax"&&n>=3&&to.has(l)&&(o=eo)}if(o){const i=performance.now();(i-this._draTimer>=o||e.stationary||!s.minValuesTexture)&&(this._mosaic(e,t),s.render(e,{fbo:this._mosaicFbo}),this._draTimer=i)}else this._mosaic(e,t),s.render(e,{fbo:this._mosaicFbo});return{minTexture:s.minValuesTexture,maxTexture:s.maxValuesTexture,meanTexture:s.meanValuesTexture,stddevTexture:s.stdDevValuesTexture}}_mosaic(e,t){const{context:s,painter:o}=e,i=s.getBoundFramebufferObject();if(this._mosaicFbo)this._mosaicFbo.resize(i.width,i.height);else{const n=io(s,i.width,i.height);this._mosaicFbo=new Bt(s,n)}s.bindFramebuffer(this._mosaicFbo);const a="RasterColorizerMosaic";for(const n of t.bitmaps){if(!Lt(n))continue;e.timeline.begin(a),o.setPipelineState({depth:!1,stencil:{test:{mask:255,compare:514,op:{fail:7680,zFail:7680,zPass:7680}},write:!1},color:{write:[!0,!0,!0,!0],blendMode:"composite"}});const l=n.interpolation;n.interpolation="nearest",n.updateTexture(e),n.updateProcessedTexture();const u=this._getStretchOptions(n);u.defines.noOp=!0,o.submitDrawMesh(e.context,u,o.quadMesh,n),n.interpolation=l,e.timeline.end(a)}s.bindFramebuffer(i)}_getLutOptions(e){const{config:t,projectionConfig:s,colormapConfig:o,pixelMaskConfig:i,highlightConfig:a,projectionDefines:n}=this._getCommonConfig(e),l=st(e);return{shader:this.shaders.lut,uniforms:{projectionConfig:s,config:t,colormapConfig:o,pixelMaskConfig:i,highlightConfig:a},defines:{...n,...l,applyPixelMask:!!i,applyPixelHighlights:!!a},optionalAttributes:null,useComputeBuffer:!1}}_getStretchOptions(e,t){const s=e.symbolizerParameters,{config:o,projectionConfig:i,colormapConfig:a,pixelMaskConfig:n,highlightConfig:l,projectionDefines:u,textureUnit:h}=this._getCommonConfig(e),p=st(e),m=t?{minTexture:{texture:t.minTexture,unit:h},maxTexture:{texture:t.maxTexture,unit:h+1},meanTexture:{texture:t.meanTexture,unit:h+2},stddevTexture:{texture:t.stddevTexture,unit:h+3},numberOfStandardDeviations:s.numberOfStandardDeviations||2}:void 0,f=t?s.stretchType==="standardDeviation"?2:1:0;return{shader:this.shaders.stretch,uniforms:{projectionConfig:i,config:o,stretchConfig:s,colormapConfig:a,pixelMaskConfig:n,highlightConfig:l,statisticsConfig:m},defines:{...u,...p,isMultiband:s.bandCount>1,applyColormap:!!a,useGamma:s.useGamma,noOp:e.isRendereredSource&&!e.processed,applyPixelMask:!!n,applyPixelHighlights:!!l,draStretchType:f},optionalAttributes:null,useComputeBuffer:!1}}_getShadedReliefOptions(e){const t=e.symbolizerParameters,{config:s,projectionConfig:o,colormapConfig:i,pixelMaskConfig:a,highlightConfig:n,projectionDefines:l}=this._getCommonConfig(e),u=st(e);return{shader:this.shaders.shadedRelief,uniforms:{projectionConfig:o,config:s,hillshadeConfig:t,colormapConfig:i,pixelMaskConfig:a,highlightConfig:n},defines:{...l,...u,isMultidirectional:t.hillshadeType>0,applyColormap:!!i,applyPixelMask:!!a,applyPixelHighlights:!!n},optionalAttributes:null,useComputeBuffer:!1}}_getCommonConfig(e){const{coordScale:t,computedOpacity:s,transforms:o}=e,{names:i,textures:a}=e.getTextures({useProcessedTexture:e.processed}),n=a[i.indexOf("u_image")],l=e.getRasterTextureSize();let u=0;const h={texture:{texture:n,unit:u++},dvsMat3:o.displayViewScreenMat3,coordScale:t,srcImageSize:l,opacity:s},p=a[i.indexOf("u_transformGrid")],{transformGrid:m}=e,f=!(!p||!m),x=f?{transformTexture:{texture:p,unit:u++},targetImageSize:[e.width,e.height],transformSpacing:m.spacing,transformGridSize:m.size}:void 0,y=a[i.indexOf("u_colormap")],{colormap:_,colormapOffset:$}=e.symbolizerParameters,S=y&&_?{colormapTexture:{texture:y,unit:u++},colormapOffset:$??0,colormapMaxIndex:_.length/4-1}:void 0,V=a[i.indexOf("u_mask")],ee=V?{maskTexture:{texture:V,unit:u++}}:void 0,{highlightTexture:pe}=e;return{config:h,projectionConfig:x,colormapConfig:S,pixelMaskConfig:ee,highlightConfig:pe?{highlightTexture:{texture:pe,unit:u++}}:void 0,projectionDefines:{applyProjection:f,lookupProjection:f&&m.spacing[0]===1},textureUnit:u}}};function io(r,e,t){const s=new at(e,t);return s.internalFormat=Y.RGBA32F,s.samplingMode=9728,s.dataType=te.FLOAT,s.wrapMode=33071,new ot(r,s)}function Lt(r){return!r.suspended&&r.source!=null&&!r.isRendereredSource&&r.symbolizerParameters.type==="stretch"&&!!r.symbolizerParameters.dynamicRangeAdjustment}let is=class extends q{constructor(){super(...arguments),this.hasExistingHighlights=!1}_computeHighlightedColor(e,t,s){const o=W(new b(0),t,e);if(this.hasExistingHighlights){const{highlightTexture:i}=this.highlightConfig,a=I(i,s);return W(a,o,e)}return o}};c([v],is.prototype,"hasExistingHighlights",void 0);let St=class extends P{};c([g(se.ofType(d,2*re))],St.prototype,"ranges",void 0),c([g(ge)],St.prototype,"bandSwap",void 0),c([g(b)],St.prototype,"color",void 0);let Ys=class extends is{constructor(){super(...arguments),this.type="RasterRangeHighlightShader"}_colorize(e,t){const s=this._getPixel(e),{ranges:o,color:i,bandSwap:a}=this.rangeHighlightConfig,n=a.multiply(s.rgb).x,l=Xr(n,o).multiply(U(s.a));return this._computeHighlightedColor(l,i,t)}};c([g(St)],Ys.prototype,"rangeHighlightConfig",void 0);let Ye=class extends P{};c([g(T)],Ye.prototype,"xRange",void 0),c([g(T)],Ye.prototype,"yRange",void 0),c([g(ge)],Ye.prototype,"bandSwap",void 0),c([g(b)],Ye.prototype,"color",void 0);let Xs=class extends P{};c([g(k)],Xs.prototype,"maskTexture",void 0);let Rt=class extends is{constructor(){super(...arguments),this.type="RasterXYBandHighlightShader",this.useMask=!1}_colorize(e,t){const s=this._getPixel(e),{xRange:o,yRange:i,color:a,bandSwap:n}=this.xyRangeHighlightConfig,{x:l,y:u}=n.multiply(s.rgb);let h=kt(l,o).multiply(kt(u,i)).multiply(U(s.a));if(this.useMask){const{maskTexture:p}=this.xyMaskHighlightConfig,m=K(l.subtract(o.x).divide(o.y.subtract(o.x)),new d(0),new d(1)),f=K(i.y.subtract(u).divide(i.y.subtract(i.x)),new d(0),new d(1)),x=I(p,new T(m,f)).r;h=h.multiply(x)}return this._computeHighlightedColor(h,a,t)}};c([v],Rt.prototype,"useMask",void 0),c([g(Ye)],Rt.prototype,"xyRangeHighlightConfig",void 0),c([ie(Xs)],Rt.prototype,"xyMaskHighlightConfig",void 0);let ro=class extends ut{constructor(){super(...arguments),this.name="BrushRasterHighlight",this.type=2,this.shaders={range:new Ys,xyBand:new Rt}}shutdown(e){var t;super.shutdown(e),(t=this._fbo)==null||t.dispose(),this._fbo=void 0}_getBandIds(e,t){const{type:s}=e,o=s==="xy-band"?e.bandIds:[e.bandId];return t!=null&&t.length?o.map(i=>t.indexOf(i)):s==="xy-band"?[0,1]:[0]}_getSingleBandShaderOptions(e,t,s,o){const{config:i,projectionConfig:a,highlightConfig:n,projectionDefines:l}=this._getCommonConfig(t),u=st(t,o),h={bandSwap:s,ranges:e.ranges,color:e.color};return{shader:this.shaders.range,uniforms:{projectionConfig:a,config:i,rangeHighlightConfig:h,highlightConfig:n},defines:{...l,...u,applyPixelMask:!1,applyPixelHighlights:!1,hasExistingHighlights:!!n},optionalAttributes:null,useComputeBuffer:!1}}_getXYBandShaderOptions(e,t,s,o,i){const{config:a,projectionConfig:n,highlightConfig:l,projectionDefines:u}=this._getCommonConfig(t),h=st(t,o),p={bandSwap:s,xRange:e.xRange,yRange:e.yRange,color:e.color},m=i?{maskTexture:{texture:i,unit:4}}:void 0;return{shader:this.shaders.xyBand,uniforms:{projectionConfig:n,config:a,xyRangeHighlightConfig:p,xyMaskHighlightConfig:m,highlightConfig:l},defines:{...u,...h,applyPixelMask:!1,applyPixelHighlights:!1,hasExistingHighlights:!!l,useMask:!!m},optionalAttributes:null,useComputeBuffer:!1}}render(e,t){const{pixelHighlightOptions:s}=e;if(!s)return;const{context:o}=e;if(!this._fbo){const u=bs(e.context,N,N);this._fbo=new Bt(o,u)}const{type:i}=s,a=i==="xy-band"?oo(e.context,s):void 0,n=o.getBoundFramebufferObject(),l=o.getViewport();for(const u of t.bitmaps){if(!u.source||u.highlighted||u.suspended||u.isRendereredSource)continue;const h=this._getBandIds(s,u.bandIds);if(h.some(y=>y<0||y>2))continue;e.timeline.begin(this.name);const{painter:p}=e;p.setPipelineState({depth:!1,stencil:{test:!1,write:!1},color:{write:[!0,!0,!0,!0],blendMode:"custom",blendParameters:{srcRGB:1,dstRGB:0,srcAlpha:1,dstAlpha:0}}}),u.updateTexture(e),u.updateProcessedTexture(!1);const m=new Float32Array(9);m[3*h[0]]=1,m[3*h[1]+1]=i==="xy-band"?1:0;const f=i==="single-band"?this._getSingleBandShaderOptions(s,u,m,o):this._getXYBandShaderOptions(s,u,m,o,a);o.bindFramebuffer(this._fbo),o.setViewport(0,0,N,N),p.submitDrawMesh(e.context,f,p.quadMesh);const x=bs(e.context,N,N);this._fbo.copyToTexture(0,0,N,N,0,0,x),u.highlightTexture=x,e.timeline.end(this.name)}a==null||a.dispose(),o.bindFramebuffer(n),o.setViewport(l.x,l.y,l.width,l.height)}_getCommonConfig(e){const{names:t,textures:s}=e.getTextures({forProcessing:!0,useProcessedTexture:e.processed}),o=s[t.indexOf("u_image")],i=e.getRasterTextureSize(),a={texture:{texture:o,unit:0},dvsMat3:new Float32Array([2,0,0,0,2,0,-1,-1,0]),coordScale:[1,1],srcImageSize:i,opacity:1},n=s[t.indexOf("u_transformGrid")],{transformGrid:l}=e,u=!(!n||!l),h=u?{transformTexture:{texture:n,unit:1},targetImageSize:[e.width,e.height],transformSpacing:l.spacing,transformGridSize:l.size}:void 0,{highlightTexture:p}=e;return{config:a,projectionConfig:h,highlightConfig:p?{highlightTexture:{texture:p,unit:2}}:void 0,projectionDefines:{applyProjection:u,lookupProjection:u&&l.spacing[0]===1}}}};function bs(r,e,t){const s=new at(e,t);return s.internalFormat=Y.RGBA8,s.samplingMode=9728,s.dataType=te.UNSIGNED_BYTE,s.isImmutable=!0,s.wrapMode=33071,new ot(r,s)}function oo(r,e){const{mask:t,maskSize:s}=e;if(!(t!=null&&t.length)||!(s!=null&&s.length))return;const o=new at(s[0],s[1]);return o.internalFormat=Y.R8,o.samplingMode=9728,o.dataType=te.UNSIGNED_BYTE,o.isImmutable=!0,o.wrapMode=33071,new ot(r,o,t)}let A=class extends ut{shutdown(e){var t;super.shutdown(e),(t=this._fbo)==null||t.dispose(),this._fbo=void 0}render(e,t){var u;const{rasterFunction:s}=e;if(!s)return;const{context:o}=e,i="indexedColormap"in s.parameters?Et(o,s.parameters.indexedColormap):void 0,a=s.name==="Reproject",n=o.getBoundFramebufferObject(),l=o.getViewport();for(const h of t.bitmaps){const p=a?!(h.rasterTexture&&h.projected):!h.processed;if(!h.source||!p||h.suspended)continue;e.timeline.begin(this.name);const{painter:m}=e;m.setPipelineState({depth:!1,stencil:{test:!1,write:!1},color:{write:[!0,!0,!0,!0],blendMode:"custom",blendParameters:{srcRGB:1,dstRGB:0,srcAlpha:1,dstAlpha:0}}}),a||(h.processedTexture=z(h.processedTexture)),h.updateTexture(e);const[f,x]=h.getRasterTextureSize(a),y=f===N&&x===N,_=y?t.processorFbo:Os(o,f,x);o.bindFramebuffer(_),o.setViewport(0,0,_.width,_.height),this._process(e,h,i);const $=Lr(e.context,f,x);if(_.copyToTexture(0,0,f,x,0,0,$),a)h.rasterTexture=$;else{const S=e.hasBranches?s.id:0;(u=h.functionTextures[S])==null||u.dispose(),h.functionTextures[S]=$}y||_.dispose(),e.timeline.end(this.name)}i==null||i.dispose(),o.bindFramebuffer(n),o.setViewport(l.x,l.y,l.width,l.height)}_getCommonConfig(e,t){var h;const{rasterFunction:s,hasBranches:o}=e,{raster:i,rasters:a}=s.parameters,n=o?(i==null?void 0:i.id)??((h=a==null?void 0:a.find(p=>p.name!=="Constant"))==null?void 0:h.id)??-1:0,l=t.functionTextures[n]??t.rasterTexture,u=s.name==="Reproject";return{texture:{texture:l,unit:0},srcImageSize:t.getRasterTextureSize(u)}}_getMultipleInputConfig(e,t){return t!=null&&t.length?t.length===2?{twoRasterConfig:this._getTwoInputConfig(t,e)}:t.length===3?{threeRasterConfig:this._getThreeInputConfig(t,e)}:{}:{}}_getConstantCount(e){return(e==null?void 0:e.filter(t=>t.name==="Constant").length)??0}_getTextures(e,t){return e.filter(s=>s.name!=="Constant").map(s=>s.id!=null&&s.name!=="Identity"?t.functionTextures[s.id]:t.rasterTexture)}_getTwoInputConfig(e,t){const s=this._getTextures(e,t),o=s[1]?{texture:s[1],unit:1}:void 0,i=e.findIndex(n=>n.name==="Constant"),a=i===0?new Float32Array([0,1,0,1,0,0,0,0,0]):new Float32Array([1,0,0,0,1,0,0,0,0]);return{image1:o,image1Const:i>-1?e[i].parameters.value:0,imageSwap:a}}_getThreeInputConfig(e,t){const s=this._getTextures(e,t);let o=0,i=0,a=new Float32Array([1,0,0,0,1,0,0,0,1]);const n=s[1]?{texture:s[1],unit:1}:void 0,l=s[2]?{texture:s[2],unit:2}:void 0,u=[];if(e.forEach((h,p)=>h.name==="Constant"&&u.push(p)),u.length===1)o=e[u[0]].parameters.value,a=u[0]===0?new Float32Array([0,1,0,0,0,1,1,0,0]):u[0]===1?new Float32Array([1,0,0,0,0,1,0,1,0]):new Float32Array([1,0,0,0,1,0,0,0,1]);else if(u.length===2){o=e[u[0]].parameters.value,i=e[u[1]].parameters.value;const h=e.findIndex(p=>p.name!=="Constant");a=h===0?new Float32Array([1,0,0,0,1,0,0,0,1]):h===1?new Float32Array([0,1,0,1,0,0,0,0,1]):new Float32Array([0,0,1,1,0,0,0,1,0])}return{image1:n,image2:l,image1Const:o,image2Const:i,imageSwap:a}}},Js=class extends Oe{};c([Be(0,T)],Js.prototype,"position",void 0);class ao extends Ae{}let Wt=class extends P{};c([g(k)],Wt.prototype,"texture",void 0),c([g(T)],Wt.prototype,"srcImageSize",void 0);let O=class extends Ve{vertex(e){return{uv:e.position,glPosition:new b(ct(e.position),0,1)}}fragment(e){const t=new Ge,s=Vs(e.uv),o=this._process(s);return t.fragColor=new b(o.rgb,1).multiply(o.a),t}_getPixel(e){return As(e,this.config)}};c([g(Wt)],O.prototype,"config",void 0),c([X(0,J(Js))],O.prototype,"vertex",null),c([X(0,J(ao))],O.prototype,"fragment",null);let Ks=class extends P{};c([g(T)],Ks.prototype,"cellSize",void 0);let ei=class extends O{constructor(){super(...arguments),this.type="AspectShader"}_process(e){const{texture:t}=this.config,s=pt(t,e,this.config.srcImageSize),o=new T(1).divide(this.aspectConfig.cellSize.multiply(8)),{x:i,y:a}=ss(s,o),n=ke(a),l=s[9].multiply(U(L(i).add(L(n)))),u=L(U(i)),h=new d(3.14159265359),p=new d(0),m=D(p,n).multiply(.5).multiply(h).add(D(n,p).multiply(1.5).multiply(h)),f=zs(new d(2.5).multiply(h).add(Mt(n,ke(i))),new d(2).multiply(h)),x=W(m,f,u).multiply(180).divide(h);return new b(x,x,x,l)}};c([g(Ks)],ei.prototype,"aspectConfig",void 0);let no=class extends A{constructor(){super(...arguments),this.name="RasterAspectProcessor",this.type=3,this.shaders={aspect:new ei}}_process(e,t){const s={cellSize:t.getRasterCellSize()},o=this._getCommonConfig(e,t),i={shader:this.shaders.aspect,uniforms:{config:o,aspectConfig:s},defines:{},optionalAttributes:null,useComputeBuffer:!1},{painter:a,context:n}=e;a.submitDrawMesh(n,i,a.quadMesh)}};class ti extends P{}c([g(ge)],ti.prototype,"bandIndexMat3",void 0);let si=class extends P{};c([g(w)],si.prototype,"adjustments",void 0);let Xe=class extends O{constructor(){super(...arguments),this.type="BandArithmeticShader",this.isOutputRounded=!1}_process(e){const t=this._getPixel(e),s=this.bandArithmeticConfig.bandIndexMat3.multiply(t.rgb),o=this._processIndex(s),i=new b(o,o,o,t.a);return this.isOutputRounded?qe(i):i}_processIndex(e){var i;const{r:t,g:s}=e,o=(i=this.adjustmentConfig)==null?void 0:i.adjustments;switch(this.indexType){case"ndxi":{const a=t.subtract(s),n=t.add(s);return a.multiply(B(n))}case"sr":return t.multiply(B(s));case"ci":return t.multiply(B(s)).subtract(1);case"savi":{const{x:a}=o,n=t.subtract(s),l=t.add(s).add(a);return n.multiply(B(l)).multiply(a.add(1))}case"tsavi":{const{x:a,y:n,z:l}=o,u=l.multiply(a.multiply(a).add(1)).subtract(n.multiply(a)),h=a.multiply(t.subtract(a.multiply(s)).subtract(n)),p=n.multiply(t).add(s).add(u);return h.multiply(B(p))}case"msavi":{const a=t.multiply(2).add(1),n=a.multiply(a).subtract(t.subtract(s).multiply(8));return a.subtract(ue(n)).multiply(.5)}case"gemi":{const a=t.multiply(t).subtract(s.multiply(s)).multiply(2).add(t.multiply(1.5)).add(s.multiply(.5)),n=t.add(s).add(.5),l=a.multiply(B(n)),u=l.multiply(De(l.multiply(.25))),h=s.subtract(.125).multiply(B(De(s)));return u.subtract(h)}case"pvi":{const{x:a,y:n}=o,l=ue(a.multiply(a).add(1));return t.subtract(s.multiply(a)).subtract(n).multiply(B(l))}case"vari":{const a=e.g.subtract(e.r),n=e.g.add(e.r).subtract(e.b);return a.multiply(B(n))}case"rtvicore":return t.subtract(s).multiply(100).subtract(t.subtract(e.b).multiply(10));case"bai":{const a=he(new d(.1).subtract(s),new d(2)),n=he(new d(.06).subtract(t),new d(2));return B(a.add(n))}case"evi":{const a=e.b,n=t.add(s.multiply(6)).subtract(a.multiply(7.5)).add(1);return t.subtract(s).multiply(2.5).multiply(B(n))}case"wndwi":{const{r:a,g:n,b:l}=e,u=o.x,h=u.multiply(n),p=u.multiply(l),m=a.add(h).add(l).subtract(p);return a.subtract(h).subtract(l).add(p).multiply(B(m))}case"mtvi":{const a=e.b,n=he(t.multiply(2).add(1),new d(2)),l=t.multiply(6).subtract(ue(s).multiply(5)),u=ue(n.subtract(l).subtract(.5)),h=t.subtract(a).multiply(1.2),p=s.subtract(a).multiply(2.5);return h.subtract(p).multiply(1.5).multiply(B(u))}default:return t}}};c([v],Xe.prototype,"indexType",void 0),c([v],Xe.prototype,"isOutputRounded",void 0),c([g(ti)],Xe.prototype,"bandArithmeticConfig",void 0),c([ie(si)],Xe.prototype,"adjustmentConfig",void 0);let lo=class extends A{constructor(){super(...arguments),this.name="RasterBandArithmeticProcessor",this.type=4,this.shaders={bandArithmetic:new Xe}}_process(e,t){const s=e.rasterFunction.parameters,o={indexType:s.indexType,isOutputRounded:s.isOutputRounded},i={bandIndexMat3:s.bandIndexMat3},a=s.adjustments?{adjustments:[...s.adjustments]}:void 0,n=this._getCommonConfig(e,t),l={shader:this.shaders.bandArithmetic,uniforms:{config:n,bandArithmeticConfig:i,adjustmentConfig:a},defines:o,optionalAttributes:null,useComputeBuffer:!1},{painter:u,context:h}=e;u.submitDrawMesh(h,l,u.quadMesh)}},ii=class extends O{constructor(){super(...arguments),this.type="ColormapToRGBShader"}_process(e){const t=this._getPixel(e),s=ht(t,new d(1),this.colormapConfig,!1);return new b(s.xyz.multiply(255),s.a)}};c([g(me)],ii.prototype,"colormapConfig",void 0);let uo=class extends A{constructor(){super(...arguments),this.name="RasterColormapToRGBProcessor",this.type=5,this.shaders={colormapToRGB:new ii}}_process(e,t,s){const o=e.rasterFunction.parameters,i={colormapTexture:{texture:s,unit:1},colormapOffset:o.offset,colormapMaxIndex:o.indexedColormap.length/4-1},a=this._getCommonConfig(e,t),n={shader:this.shaders.colormapToRGB,uniforms:{config:a,colormapConfig:i},defines:{},optionalAttributes:null,useComputeBuffer:!1},{painter:l,context:u}=e;l.submitDrawMesh(u,n,l.quadMesh)}},Pt=class extends P{};c([g(k)],Pt.prototype,"image1",void 0),c([g(d)],Pt.prototype,"image1Const",void 0),c([g(ge)],Pt.prototype,"imageSwap",void 0);let Pe=class extends P{};c([g(k)],Pe.prototype,"image1",void 0),c([g(k)],Pe.prototype,"image2",void 0),c([g(d)],Pe.prototype,"image1Const",void 0),c([g(d)],Pe.prototype,"image2Const",void 0),c([g(ge)],Pe.prototype,"imageSwap",void 0);const rs=r=>{const e=r;class t extends e{constructor(){super(...arguments),this.constantCount=0,this.imageCount=1}_getRasterValues(o){const{imageCount:i}=this;if(i===1){const a=I(this.config.texture,o);return{a:a.r,b:a.g,c:a.b,alpha:a.a}}if(i===2){const a=this._getTwoValues(o);return{a:a.a,b:a.b,c:a.b,alpha:a.alpha}}return this._getThreeValues(o)}_getTwoValues(o){const i=I(this.config.texture,o);if(this.constantCount===1){const{imageSwap:l,image1Const:u}=this.twoRasterConfig,h=l.multiply(new w(i.r,u,0));return{a:h.x,b:h.y,alpha:i.a}}const{image1:a}=this.twoRasterConfig,n=I(a,o);return{a:i.r,b:n.r,alpha:i.a.multiply(n.a)}}_getThreeValues(o){const i=I(this.config.texture,o),{imageSwap:a,image1:n,image2:l,image1Const:u,image2Const:h}=this.threeRasterConfig;if(this.constantCount===2){const f=a.multiply(new w(i.r,u,h));return{a:f.x,b:f.y,c:f.z,alpha:i.a}}if(this.constantCount===1){const f=I(n,o),x=a.multiply(new w(i.r,f.r,u));return{a:x.x,b:x.y,c:x.z,alpha:i.a.multiply(f.a)}}const p=I(n,o),m=I(l,o);return{a:i.r,b:p.r,c:m.r,alpha:i.a.multiply(p.a).multiply(m.a)}}}return c([v],t.prototype,"constantCount",void 0),c([v],t.prototype,"imageCount",void 0),c([ie(Pt)],t.prototype,"twoRasterConfig",void 0),c([ie(Pe)],t.prototype,"threeRasterConfig",void 0),t};let co=class extends rs(O){constructor(){super(...arguments),this.type="CompositeBandShader"}_process(e){const{a:t,b:s,c:o,alpha:i}=this._getRasterValues(e);return new b(t,s,o,i)}},ho=class extends A{constructor(){super(...arguments),this.name="RasterCompositeBandProcessor",this.type=6,this.shaders={compositeBand:new co}}_process(e,t){const{rasters:s}=e.rasterFunction.parameters,o={constantCount:this._getConstantCount(s),imageCount:(s==null?void 0:s.length)??1},i=this._getMultipleInputConfig(t,s),a=this._getCommonConfig(e,t),n={shader:this.shaders.compositeBand,uniforms:{config:a,...i},defines:o,optionalAttributes:null,useComputeBuffer:!1},{painter:l,context:u}=e;l.submitDrawMesh(u,n,l.quadMesh)}};class os extends P{}c([g(T)],os.prototype,"domainRange",void 0);class Ft extends rs(O){constructor(){super(...arguments),this.type="LocalShader",this.isOutputRounded=!1}_process(e){if(this.operationName==="conditional")return this._conditional(e);const{a:t,b:s,alpha:o}=this._getRasterValues(e),{value:i,alpha:a}=this._compute(t,s,o);return this._processResult(i,a)}_processResult(e,t){const s=kt(e,this.domainRangeConfig.domainRange),o=new b(e,e,e,t).multiply(s);return this.isOutputRounded?qe(o):o}_compute(e,t,s){const{operationName:o}=this;let i;switch(o){case"plus":i=e.add(t);break;case"minus":i=e.subtract(t);break;case"times":i=e.multiply(t);break;case"divide":case"floatdivide":i=e.multiply(B(t)),s=s.multiply(E(L(U(t))));break;case"floordivide":i=ce(e.multiply(B(t))),s=s.multiply(E(L(U(t))));break;case"square":i=e.multiply(e);break;case"sqrt":i=ue(e);break;case"power":i=he(e,t);break;case"ln":i=Q(xe(e,new d(0)),gr(e),new d(0)),s=s.multiply(this._isAboveZero(e));break;case"log10":i=Q(xe(e,new d(0)),Gt(e).multiply(B(Gt(new d(10)))),new d(0)),s=s.multiply(this._isAboveZero(e));break;case"log2":i=Q(xe(e,new d(0)),Gt(e),new d(0)),s=s.multiply(this._isAboveZero(e));break;case"exp":i=mr(e);break;case"exp10":i=he(new d(10),e);break;case"exp2":i=he(new d(2),e);break;case"rounddown":i=ce(e);break;case"roundup":i=dr(e);break;case"int":i=U(e).multiply(ce(L(e)));break;case"mod":i=zs(e,t);break;case"negate":i=ke(e);break;case"abs":i=L(e);break;case"acos":{const a=this._isAbsBiggerThanOne(e);i=Q(a,new d(0),pr(e)),s=Q(a,new d(0),s);break}case"acosh":i=hr(e);break;case"asin":{const a=this._isAbsBiggerThanOne(e);i=Q(a,new d(0),cr(e)),s=Q(a,new d(0),s);break}case"asinh":i=ur(e);break;case"atan":i=Mt(e);break;case"atanh":{const a=this._isAbsBiggerThanOne(e);i=Q(a,new d(0),lr(e)),s=Q(a,new d(0),s);break}case"atan2":i=Mt(e,t);break;case"cos":i=nr(e);break;case"cosh":i=ar(e);break;case"sin":i=or(e);break;case"sinh":i=rr(e);break;case"tan":i=ir(e);break;case"tanh":i=sr(e);break;case"bitwiseand":i=new d(tr(new R(e),new R(t)));break;case"bitwiseor":i=new d(er(new R(e),new R(t)));break;case"bitwiseleftshift":i=new d(Ki(new R(e),new R(t)));break;case"bitwiserightshift":i=new d(Ji(new R(e),new R(t)));break;case"bitwisenot":i=new d(Xi(new R(e)));break;case"bitwisexor":i=new d(Yi(new R(e),new R(t)));break;case"booleanand":i=E(Qi(ye(e,new d(0)),ye(t,new d(0))));break;case"booleanor":i=E(Zi(ye(e,new d(0)),ye(t,new d(0))));break;case"booleannot":i=E($e(e,new d(0)));break;case"booleanxor":i=E(Wi(ye(e,new d(0)),ye(t,new d(0))));break;case"greaterthan":i=E(xe(e,t));break;case"greaterthanequal":i=E(Ni(e,t));break;case"lessthan":i=E(Ht(e,t));break;case"lessthanequal":i=E(Is(e,t));break;case"equalto":i=E($e(e,t));break;case"notequal":i=E(ye(e,t));break;case"isnull":i=E($e(s,new d(0))),s=new d(1);break;case"setnull":{const a=E($e(e,new d(0)));i=a.multiply(t),s=s.multiply(a);break}default:i=e}return{value:i,alpha:s}}_conditional(e){const{a:t,b:s,c:o,alpha:i}=this._getRasterValues(e),a=new d(L(U(t))),n=W(o,s,a);return this._processResult(n,i)}_isAboveZero(e){return E(xe(e,new d(0)))}_isAbsBiggerThanOne(e){return xe(L(e),new d(1))}}c([v],Ft.prototype,"operationName",void 0),c([v],Ft.prototype,"isOutputRounded",void 0),c([g(os)],Ft.prototype,"domainRangeConfig",void 0);let It=class extends rs(O){constructor(){super(...arguments),this.type="ComputeChangeShader",this.isOutputRounded=!1}_process(e){const{a:t,b:s,alpha:o}=this._getRasterValues(e);let i=t.subtract(s);this.method==="relative-difference"&&(i=i.multiply(B(lt(L(t),L(s)))));const a=kt(i,this.domainRangeConfig.domainRange),n=new b(i,i,i,o).multiply(a);return this.isOutputRounded?qe(n):n}};c([v],It.prototype,"method",void 0),c([v],It.prototype,"isOutputRounded",void 0),c([g(os)],It.prototype,"domainRangeConfig",void 0);let po=class extends A{constructor(){super(...arguments),this.name="RasterComputeChangeProcessor",this.type=7,this.shaders={computeChange:new It}}_process(e,t){const s=e.rasterFunction.parameters,{rasters:o}=s,i={constantCount:this._getConstantCount(o),imageCount:o.length,method:s.method,isOutputRounded:s.isOutputRounded},a={domainRange:s.domainRange},{twoRasterConfig:n}=this._getMultipleInputConfig(t,o),l=this._getCommonConfig(e,t),u={shader:this.shaders.computeChange,uniforms:{config:l,domainRangeConfig:a,twoRasterConfig:n},defines:i,optionalAttributes:null,useComputeBuffer:!1},{painter:h,context:p}=e;h.submitDrawMesh(p,u,h.quadMesh)}},Zt=class extends P{};c([g(d)],Zt.prototype,"contrastOffset",void 0),c([g(d)],Zt.prototype,"brightnessOffset",void 0);let ri=class extends O{constructor(){super(...arguments),this.type="ContrastBrightnessShader"}_process(e){const{rgb:t,a:s}=this._getPixel(e),{contrastOffset:o,brightnessOffset:i}=this.contrastBrightnessConfig,a=new d(255),n=new d(128),l=t.multiply(200),u=a.multiply(100),h=a.multiply(2).multiply(i),p=l.subtract(u).add(h),m=fr([$e(o,new d(-100)),new w(n)],[$e(o,new d(100)),U(p).add(1).divide(2).multiply(a)],[xe(o,new d(0)),p.divide(new d(100).subtract(o).multiply(2)).add(n)],[!0,p.multiply(o.add(100)).divide(2e4).add(n)]);return qe(new b(m,s))}};c([g(Zt)],ri.prototype,"contrastBrightnessConfig",void 0);let mo=class extends A{constructor(){super(...arguments),this.name="RasterContrastBrightnessProcessor",this.type=8,this.shaders={contrastBrightness:new ri}}_process(e,t){const s=this._getCommonConfig(e,t),o=e.rasterFunction.parameters,i={shader:this.shaders.contrastBrightness,uniforms:{config:s,contrastBrightnessConfig:o},defines:{},optionalAttributes:null,useComputeBuffer:!1},{painter:a,context:n}=e;a.submitDrawMesh(n,i,a.quadMesh)}};class Qt extends P{}c([g(yr.ofType(d,5,5,!0))],Qt.prototype,"kernel",void 0),c([g(T)],Qt.prototype,"clampRange",void 0);let zt=class extends O{constructor(){super(...arguments),this.type="ConvolutionShader",this.rows=3,this.cols=3}_process(e){const{rows:t,cols:s}=this,o=new T(Math.floor(t/2),Math.floor(s/2)),{texture:i,srcImageSize:a}=this.config,n=new d(1).divide(a),{kernel:l}=this.convolutionConfig,u=xr(l,{initialValue:new b(0,0,0,1),xRange:[0,t],yRange:[0,s],callback:(p,m,f,x)=>{const y=new T(new d(f),new d(x)).subtract(o).multiply(n),_=I(i,H(e.add(y))),$=_.rgb.multiply(m).add(p.rgb),S=_.a.multiply(p.a);return new b($,S)}}),{clampRange:h}=this.convolutionConfig;return new b(K(u.rgb,h.x,h.y),1).multiply(u.a)}};c([v],zt.prototype,"rows",void 0),c([v],zt.prototype,"cols",void 0),c([g(Qt)],zt.prototype,"convolutionConfig",void 0);let go=class extends A{constructor(){super(...arguments),this.name="RasterConvolutionProcessor",this.type=9,this.shaders={convolution:new zt}}_process(e,t){const s=e.rasterFunction.parameters,o={rows:s.kernelRows,cols:s.kernelCols},i={kernel:[...s.kernel],clampRange:s.clampRange},a=this._getCommonConfig(e,t),n={shader:this.shaders.convolution,uniforms:{config:a,convolutionConfig:i},defines:o,optionalAttributes:null,useComputeBuffer:!1},{painter:l,context:u}=e;l.submitDrawMesh(u,n,l.quadMesh)}},oi=class extends P{};c([g(d)],oi.prototype,"zlFactor",void 0);let Yt=class extends O{constructor(){super(...arguments),this.type="CurvatureShader"}_process(e){const{texture:t}=this.config,s=pt(t,e,this.config.srcImageSize),o=s[3].add(s[5]).multiply(.5).subtract(s[4]),i=s[1].add(s[7]).multiply(.5).subtract(s[4]),{zlFactor:a}=this.curvatureConfig,{curvatureType:n}=this;let l;if(n==="standard")l=ke(a).multiply(o.add(i));else{const u=s[2].subtract(s[0]).add(s[6]).subtract(s[8]).divide(4),h=s[5].subtract(s[3]).divide(2),p=s[1].subtract(s[7]).divide(2),m=h.multiply(h),f=p.multiply(p),x=h.multiply(p),y=a.divide(m.add(f));l=n==="profile"?Z(new w(o,i,u),new w(m,f,x)).multiply(y):Z(new w(o,i,ke(u)),new w(f,m,x)).multiply(ke(y))}return new b(l,l,l,s[9])}};c([v],Yt.prototype,"curvatureType",void 0),c([g(oi)],Yt.prototype,"curvatureConfig",void 0);let fo=class extends A{constructor(){super(...arguments),this.name="RasterCurvatureProcessor",this.type=10,this.shaders={curvature:new Yt}}_process(e,t){const s=e.rasterFunction.parameters,o={curvatureType:s.curvatureType},i=t.getRasterCellSize(),a={zlFactor:200*s.zFactor/i[0]/i[1]},n=this._getCommonConfig(e,t),l={shader:this.shaders.curvature,uniforms:{config:n,curvatureConfig:a},defines:o,optionalAttributes:null,useComputeBuffer:!1},{painter:u,context:h}=e;u.submitDrawMesh(h,l,u.quadMesh)}},ai=class extends P{};c([g(ge)],ai.prototype,"bandIndexMat3",void 0);let ni=class extends O{constructor(){super(...arguments),this.type="ExtractBandShader"}_process(e){const t=this._getPixel(e),s=this.extractBandConfig.bandIndexMat3.multiply(t.rgb);return new b(s,t.a)}};c([g(ai)],ni.prototype,"extractBandConfig",void 0);let yo=class extends A{constructor(){super(...arguments),this.name="RasterExtractBandProcessor",this.type=11,this.shaders={extractBand:new ni}}_process(e,t){const s={bandIndexMat3:e.rasterFunction.parameters.bandIndexMat3},o=this._getCommonConfig(e,t),i={shader:this.shaders.extractBand,uniforms:{config:o,extractBandConfig:s},defines:{},optionalAttributes:null,useComputeBuffer:!1},{painter:a,context:n}=e;a.submitDrawMesh(n,i,a.quadMesh)}},li=class extends P{};c([g(T)],li.prototype,"clampRange",void 0);class Fe extends O{constructor(){super(...arguments),this.type="FocalStatisticsShader",this.rows=3,this.cols=3,this.fill=!1}_process(e){const t=this._process1(e),s=D(new d(1),t.a);if(!this.fill)return this._clamp(t.rgb,s);const o=this._getPixel(e),i=W(t.rgb,o.rgb,o.a);return this._clamp(i,s)}_clamp(e,t){const{clampRange:s}=this.focalStatisticsConfig;return new b(K(e,s.x,s.y),1).multiply(t)}_process1(e){const{texture:t,srcImageSize:s}=this.config,{rows:o,cols:i}=this,a=new T(Math.floor(o/2),Math.floor(i/2)),n=new d(1).divide(s),l=this._getPixel(e),{statisticsType:u}=this,h=u==="min"||u==="max"?new b(l.rgb,0):new b(0,0,0,0);switch(u){case"min":return this._stat(o,i,h,(p,m,f)=>{const x=new T(new d(m),new d(f)).subtract(a).multiply(n),y=I(t,H(e.add(x))),_=rt(p.rgb,y.rgb);return new b(_,p.a.add(y.a))});case"max":return this._stat(o,i,h,(p,m,f)=>{const x=new T(new d(m),new d(f)).subtract(a).multiply(n),y=I(t,H(e.add(x))),_=lt(p.rgb,y.rgb);return new b(_,p.a.add(y.a))});case"mean":{const p=this._stat(o,i,h,(f,x,y)=>{const _=new T(new d(x),new d(y)).subtract(a).multiply(n),$=I(t,H(e.add(_))),S=f.rgb.add($.rgb.multiply($.a));return new b(S,f.a.add($.a))}),m=p.rgb.multiply(B(p.a));return new b(m,p.a)}case"stddev":{const p=this._stat(o,i,h,(y,_,$)=>{const S=new T(new d(_),new d($)).subtract(a).multiply(n),V=I(t,H(e.add(S))),ee=y.rgb.add(V.rgb.multiply(V.a));return new b(ee,y.a.add(V.a))}),m=this._stat(o,i,h,(y,_,$)=>{const S=new T(new d(_),new d($)).subtract(a).multiply(n),V=I(t,H(e.add(S))),ee=y.rgb.add(V.a.multiply(V.rgb).multiply(V.rgb));return new b(ee,y.a.add(V.a))}),f=B(m.a),x=ue(m.subtract(p.multiply(p).multiply(f)).multiply(f));return new b(x.rgb,p.a)}default:return l}}_stat(e=3,t=3,s,o){const i=new R(0).setMutable().setDebugName("StatColIterator"),a=new R(0).setMutable().setDebugName("StatRowIterator"),n=s.setMutable().setDebugName("StatAccumulator"),l=o(n,i,a).setDebugName("StatPredicate");return br({iterX:i,iterY:a,accumulator:n},b,l,({out:h,iterX:p,iterY:m,accumulator:f,subgraph:x})=>`
  for (${m} = 0; ${m} < ${e}; ${m}++) {
    for (${p} = 0; ${p} < ${t}; ${p}++) {
  
    ${x.body}
  
    ${f} = ${x.varName};
    }
  }
  ${h} = ${f};
  `).setDebugName("statBody")}}c([v],Fe.prototype,"rows",void 0),c([v],Fe.prototype,"cols",void 0),c([v],Fe.prototype,"statisticsType",void 0),c([v],Fe.prototype,"fill",void 0),c([g(li)],Fe.prototype,"focalStatisticsConfig",void 0);class xo extends A{constructor(){super(...arguments),this.name="RasterFocalStatisticsProcessor",this.type=21,this.shaders={focalStatistics:new Fe}}_process(e,t){const s=e.rasterFunction.parameters,o={rows:s.kernelRows,cols:s.kernelCols,statisticsType:s.statisticsType,fill:s.fillNoDataOnly},i={clampRange:s.clampRange},a=this._getCommonConfig(e,t),n={shader:this.shaders.focalStatistics,uniforms:{config:a,focalStatisticsConfig:i},defines:o,optionalAttributes:null,useComputeBuffer:!1},{painter:l,context:u}=e;l.submitDrawMesh(u,n,l.quadMesh)}}class ui extends P{}c([g(w)],ui.prototype,"weights",void 0);let ci=class extends O{constructor(){super(...arguments),this.type="GrayscaleShader"}_process(e){const t=this._getPixel(e),{weights:s}=this.grayscaleConfig,o=Z(s,t.rgb);return new b(o,o,o,t.a)}};c([g(ui)],ci.prototype,"grayscaleConfig",void 0);let bo=class extends A{constructor(){super(...arguments),this.name="RasterGrayscaleProcessor",this.type=12,this.shaders={grayscale:new ci}}_process(e,t){const s={weights:e.rasterFunction.parameters.weights},o=this._getCommonConfig(e,t),i={shader:this.shaders.grayscale,uniforms:{config:o,grayscaleConfig:s},defines:{},optionalAttributes:null,useComputeBuffer:!1},{painter:a,context:n}=e;a.submitDrawMesh(n,i,a.quadMesh)}},Dt=class extends O{constructor(){super(...arguments),this.type="HillshadeShader",this.isMultidirectional=!1}_process(e){const{texture:t}=this.config,s=pt(t,e,this.config.srcImageSize),o=Hs(s,this.hillshadeConfig,this.isMultidirectional);return new b(o.rgb.multiply(255),o.a)}};c([v],Dt.prototype,"isMultidirectional",void 0),c([g(ne)],Dt.prototype,"hillshadeConfig",void 0);let wo=class extends A{constructor(){super(...arguments),this.name="RasterHillshadeProcessor",this.type=13,this.shaders={hillshade:new Dt}}_process(e,t){const s=e.rasterFunction.parameters,o={isMultidirectional:s.hillshadeType>0},i=t.getRasterCellSize(),a=Ns(s,i),n={...s,factor:a,minValue:0,maxValue:8e3},l=this._getCommonConfig(e,t),u={shader:this.shaders.hillshade,uniforms:{config:l,hillshadeConfig:n},defines:o,optionalAttributes:null,useComputeBuffer:!1},{painter:h,context:p}=e;h.submitDrawMesh(p,u,h.quadMesh)}},_o=class extends A{constructor(){super(...arguments),this.name="RasterLocalProcessor",this.type=14,this.shaders={local:new Ft}}_process(e,t){var m;const s=e.rasterFunction.parameters,o={constantCount:this._getConstantCount(s.rasters),imageCount:s.imageCount,operationName:s.operationName,isOutputRounded:s.isOutputRounded},i={domainRange:s.domainRange},a=s.operationName==="conditional"?s.rasters:(m=s.rasters)==null?void 0:m.slice(0,2),n=this._getMultipleInputConfig(t,a),l=this._getCommonConfig(e,t),u={shader:this.shaders.local,uniforms:{config:l,domainRangeConfig:i,...n},defines:o,optionalAttributes:null,useComputeBuffer:!1},{painter:h,context:p}=e;h.submitDrawMesh(p,u,h.quadMesh)}};class Xt extends P{}c([g(se.ofType(d,6))],Xt.prototype,"includedRanges",void 0),c([g(se.ofType(d,re))],Xt.prototype,"noDataValues",void 0);let Jt=class extends O{constructor(){super(...arguments),this.type="MaskShader",this.isMultiband=!0}_process(e){const t=this._getPixel(e),s=this._computeNoDataFactor(t.r),o=this._computeRangeFactor(t.rgb);let i;if(this.isMultiband){const a=this._computeNoDataFactor(t.g),n=this._computeNoDataFactor(t.b),l=new w(s,a,n).multiply(o);i=l.x.multiply(l.y).multiply(l.z)}else i=s.multiply(o.x);return t.multiply(i)}_computeNoDataFactor(e){const{noDataValues:t}=this.maskConfig;let s=new w(1);for(let o=0;o<re/3;o++){const i=3*o,a=new w(t[i+0],t[i+1],t[i+2]),n=L(U(a.subtract(e)));s=s.multiply(n)}return s.x.multiply(s.y).multiply(s.z)}_computeRangeFactor(e){const{includedRanges:t}=this.maskConfig,s=new w(t[0],t[2],t[4]),o=new w(t[1],t[3],t[5]);return D(s,e).multiply(D(e,o))}};c([v],Jt.prototype,"isMultiband",void 0),c([g(Xt)],Jt.prototype,"maskConfig",void 0);let To=class extends A{constructor(){super(...arguments),this.name="RasterMaskProcessor",this.type=15,this.shaders={mask:new Jt}}_process(e,t){const s=e.rasterFunction.parameters,o={isMultiband:s.bandCount>1},i={includedRanges:[...s.includedRanges],noDataValues:[...s.noDataValues]},a=this._getCommonConfig(e,t),n={shader:this.shaders.mask,uniforms:{config:a,maskConfig:i},defines:o,optionalAttributes:null,useComputeBuffer:!1},{painter:l,context:u}=e;l.submitDrawMesh(u,n,l.quadMesh)}};class hi extends P{}c([g(ge)],hi.prototype,"bandIndexMat3",void 0);class Kt extends O{constructor(){super(...arguments),this.type="NDVIShader",this.scaled=!0}_process(e){const t=this._getPixel(e),{r:s,g:o}=this.ndviConfig.bandIndexMat3.multiply(t.rgb),i=s.subtract(o),a=s.add(o),n=i.multiply(B(a));if(!this.scaled)return new b(n,n,n,t.a);const l=ce(n.multiply(100).add(100.5));return new b(l,l,l,t.a)}}c([v],Kt.prototype,"scaled",void 0),c([g(hi)],Kt.prototype,"ndviConfig",void 0);let vo=class extends A{constructor(){super(...arguments),this.name="RasterNDVIProcessor",this.type=16,this.shaders={ndvi:new Kt}}_process(e,t){const s=e.rasterFunction.parameters,o={scaled:s.scaled},i={bandIndexMat3:s.bandIndexMat3},a=this._getCommonConfig(e,t),n={shader:this.shaders.ndvi,uniforms:{config:a,ndviConfig:i},defines:o,optionalAttributes:null,useComputeBuffer:!1},{painter:l,context:u}=e;l.submitDrawMesh(u,n,l.quadMesh)}};class Ie extends P{}c([g(se.ofType(d,3*re))],Ie.prototype,"rangeMaps",void 0),c([g(se.ofType(d,2*re))],Ie.prototype,"noDataRanges",void 0),c([g(d)],Ie.prototype,"unmatchMask",void 0),c([g(d)],Ie.prototype,"replacementValue",void 0),c([g(T)],Ie.prototype,"clampRange",void 0);class es extends O{constructor(){super(...arguments),this.type="RemapShader"}_process(e){const t=this._getPixel(e),{rangeMaps:s,unmatchMask:o,clampRange:i,replacementValue:a}=this.remapConfig,{mapValue:n,includeMask:l}=Jr(t.r,s,re),u=this.replaceUnmatched?a:o.multiply(t.r),h=W(u,n,l),p=K(h,i.x,i.y),m=this._computeNoDataFactor(t.rrr).multiply(lt(o,l));return new b(p,p,p,t.a).multiply(m)}_computeNoDataFactor(e){const{noDataRanges:t}=this.remapConfig;let s=new w(0,0,0);for(let o=0;o<re/3;o++){const i=6*o,a=new w(t[i],t[i+2],t[i+4]),n=new w(t[i+1],t[i+3],t[i+5]);s=s.add(D(a,e).multiply(D(e,n)))}return De(U(Z(s,new w(1,1,1))))}}c([g(Ie)],es.prototype,"remapConfig",void 0),c([v],es.prototype,"replaceUnmatched",void 0);class Co extends A{constructor(){super(...arguments),this.name="RasterRemapProcessor",this.type=17,this.shaders={remap:new es}}_process(e,t){const s=e.rasterFunction.parameters,o={replaceUnmatched:s.allowUnmatched&&s.replacementValue!=null},i={rangeMaps:[...s.rangeMaps],noDataRanges:[...s.noDataRanges],unmatchMask:s.allowUnmatched?1:0,replacementValue:s.replacementValue??0,clampRange:s.clampRange},a=this._getCommonConfig(e,t),n={shader:this.shaders.remap,uniforms:{config:a,remapConfig:i},defines:o,optionalAttributes:null,useComputeBuffer:!1},{painter:l,context:u}=e;l.submitDrawMesh(u,n,l.quadMesh)}}let So=class extends q{constructor(){super(...arguments),this.type="ReprojectShader"}_colorize(e){return this._getPixel(e)}},Ro=class extends A{constructor(){super(...arguments),this.name="RasterReprojectProcessor",this.type=18,this.shaders={reproject:new So}}_process(e,t){const s=e.rasterFunction.parameters,o=this._getInterpolationDefines(t.interpolation,!!s.requireNNEdge),{config:i,projectionConfig:a,projectionDefines:n}=this._getReprojectConfig(t),l={shader:this.shaders.reproject,uniforms:{config:i,projectionConfig:a},defines:{...n,...o,applyPixelMask:!1,applyPixelHighlights:!1},optionalAttributes:null,useComputeBuffer:!1},{interpolation:u}=t;t.interpolation="nearest";const{painter:h,context:p}=e;h.submitDrawMesh(p,l,h.quadMesh),t.interpolation=u,t.projected=!0}_getReprojectConfig(e){const{source:t}=e,{names:s,textures:o}=e.getTextures({forProcessing:!0}),i={texture:{texture:o[s.indexOf("u_image")],unit:0},dvsMat3:new Float32Array([2,0,0,0,2,0,-1,-1,0]),coordScale:[1,1],srcImageSize:[t.width,t.height],opacity:1},a=o[s.indexOf("u_transformGrid")],{transformGrid:n}=e,l=!(!a||!n);return{config:i,projectionConfig:l?{transformTexture:{texture:a,unit:1},targetImageSize:[e.width,e.height],transformSpacing:n.spacing,transformGridSize:n.size}:void 0,projectionDefines:{applyProjection:l,lookupProjection:l&&n.spacing[0]===1}}}_getInterpolationDefines(e,t){const s=e==="bilinear"&&t;return{bilinear:s,bicubic:e==="cubic",nearestOnEdge:s}}};class pi extends Dt{constructor(){super(...arguments),this.type="ShadedReliefShader"}_process(e){const t=super._process(e),{minValue:s,maxValue:o}=this.hillshadeConfig,i=this._getPixel(e),a=o.subtract(s),n=i.r.subtract(s),l=K(n.divide(a),new d(0),new d(1)),u=ht(new b(l,l,l,1),new d(255),this.colormapConfig),h=Ls(u.xyz),p=Es(new w(h.xy,t.x.divide(255))).multiply(255);return new b(p,u.a.multiply(t.a))}}c([g(me)],pi.prototype,"colormapConfig",void 0);let Po=class extends A{constructor(){super(...arguments),this.name="RasterShadedReliefProcessor",this.type=19,this.shaders={shadedRelief:new pi}}_process(e,t,s){const o=e.rasterFunction.parameters,i={isMultidirectional:o.hillshadeType>0},a=t.getRasterCellSize(),n=Ns(o,a),l={...o,factor:n},u={colormapTexture:{texture:s,unit:1},colormapOffset:o.offset,colormapMaxIndex:o.indexedColormap.length/4-1},h=this._getCommonConfig(e,t),p={shader:this.shaders.shadedRelief,uniforms:{config:h,hillshadeConfig:l,colormapConfig:u},defines:i,optionalAttributes:null,useComputeBuffer:!1},{painter:m,context:f}=e;m.submitDrawMesh(f,p,m.quadMesh)}},Je=class extends P{};c([g(d)],Je.prototype,"pixelSizePower",void 0),c([g(d)],Je.prototype,"pixelSizeFactor",void 0),c([g(d)],Je.prototype,"zFactor",void 0),c([g(T)],Je.prototype,"cellSize",void 0);let $t=class extends O{constructor(){super(...arguments),this.type="SlopeShader",this.isOutputRounded=!1,this.percentRise=!1}_process(e){const{cellSize:t,pixelSizePower:s,pixelSizeFactor:o,zFactor:i}=this.slopeConfig,a=he(t,new T(s)).multiply(o).add(i).divide(t.multiply(8)),{texture:n}=this.config,l=pt(n,e,this.config.srcImageSize),{x:u,y:h}=ss(l,a),p=ue(u.multiply(u).add(h.multiply(h))),m=this.percentRise?p.multiply(100):Mt(p).multiply(57.2957795),f=new b(m,m,m,l[9]);return this.isOutputRounded?qe(f):f}};c([v],$t.prototype,"isOutputRounded",void 0),c([v],$t.prototype,"percentRise",void 0),c([g(Je)],$t.prototype,"slopeConfig",void 0);let Fo=class extends A{constructor(){super(...arguments),this.name="RasterSlopeProcessor",this.type=20,this.shaders={slope:new $t}}_process(e,t){const s=e.rasterFunction.parameters,o={isOutputRounded:s.isOutputRounded,percentRise:s.slopeType==="percent-rise"},i={cellSize:t.getRasterCellSize(),pixelSizePower:s.slopeType==="adjusted"?s.pixelSizePower:0,pixelSizeFactor:s.slopeType==="adjusted"?s.pixelSizeFactor:0,zFactor:s.zFactor},a=this._getCommonConfig(e,t),n={shader:this.shaders.slope,uniforms:{config:a,slopeConfig:i},defines:o,optionalAttributes:null,useComputeBuffer:!1},{painter:l,context:u}=e;l.submitDrawMesh(u,n,l.quadMesh)}};class Ke extends O{constructor(){super(...arguments),this.type="StretchShader",this.isMultiband=!0,this.isOutputRounded=!1,this.useGamma=!1}_process(e){const t=this._getPixel(e);let s=Qs(t,this.stretchConfig,this.useGamma,1);return this.isMultiband||(s=new b(s.rrr,s.a)),this.isOutputRounded?qe(s):s}}c([v],Ke.prototype,"isMultiband",void 0),c([v],Ke.prototype,"isOutputRounded",void 0),c([v],Ke.prototype,"useGamma",void 0),c([g(le)],Ke.prototype,"stretchConfig",void 0);class Io extends A{constructor(){super(...arguments),this.name="RasterStretchProcessor",this.type=22,this.shaders={stretch:new Ke}}_process(e,t){const s=e.rasterFunction.parameters,o={isMultiband:s.bandCount>1,isOutputRounded:s.isOutputRounded,useGamma:s.useGamma},i=this._getCommonConfig(e,t),a={shader:this.shaders.stretch,uniforms:{config:i,stretchConfig:s},defines:o,optionalAttributes:null,useComputeBuffer:!1},{painter:n,context:l}=e;n.submitDrawMesh(l,a,n.quadMesh)}}const zo=new Map([["Aspect",no],["BandArithmetic",lo],["ColormapToRGB",uo],["CompositeBand",ho],["ComputeChange",po],["ContrastBrightness",mo],["Convolution",go],["Curvature",fo],["ExtractBand",yo],["Grayscale",bo],["Hillshade",wo],["Local",_o],["Mask",To],["NDVI",vo],["Remap",Co],["Reproject",Ro],["ShadedRelief",Po],["Slope",Fo],["Statistics",xo],["Stretch",Io]]);class $o extends ut{constructor(){super(...arguments),this.type=1,this.shaders={},this._techniques=new Map}shutdown(e){var t;super.shutdown(e),(t=this._fbo)==null||t.dispose(),this._fbo=void 0;for(const s of this._techniques.values())s.shutdown();this._techniques.clear()}render(e,t){this._fbo??(this._fbo=Os(e.context,N,N));let{name:s}=e.rasterFunction;if(s==="Arithmetic"&&(s="Local"),!this._techniques.has(s)){const o=zo.get(s);if(!o)return;this._techniques.set(s,new o)}this._techniques.get(s).render(e,{...t,processorFbo:this._fbo})}}class Mo extends Fs{constructor(){super(...arguments),this.isCustomTilingScheme=!1}get pixelHighlights(){return this._pixelHighlights}set pixelHighlights(e){this._pixelHighlights=e,this.children.forEach(({bitmap:t})=>t.highlightTexture=null),this.requestRender()}createTile(e){const t=this._getTileBounds(e),[s,o]=this.tileInfoView.tileInfo.size,i=this.tileInfoView.getTileResolution(e.level);return new Or(e,i,t[0],t[3],s,o)}onAttach(){super.onAttach(),this._colorizerTechnique=new so,this._processorTechnique=new $o,this._highlightTechnique=new ro}onDetach(){var e,t,s;super.onDetach(),(e=this._colorizerTechnique)==null||e.shutdown(),this._colorizerTechnique=void 0,(t=this._processorTechnique)==null||t.shutdown(),this._processorTechnique=void 0,(s=this._highlightTechnique)==null||s.shutdown(),this._highlightTechnique=void 0}doRender(e){var o,i;if(!this.visible||e.drawPhase!==1||!this._colorizerTechnique)return;const{rasterFunctionChain:t}=this;if((o=t==null?void 0:t.functions)!=null&&o.length){if(!this._processorTechnique)return;const{functions:a,hasBranches:n}=t;for(const l of a){if(l.name==="Constant"||l.name==="Identity")continue;e.rasterFunction=l,e.hasBranches=n,super.doRender(e);const u=this.children.map(h=>h.bitmap);this._processorTechnique.render(e,{bitmaps:u})}}if((i=this._pixelHighlights)!=null&&i.length&&this._highlightTechnique)for(const a of this._pixelHighlights){e.pixelHighlightOptions=a,super.doRender(e);const n=this.children.map(l=>l.bitmap);this._highlightTechnique.render(e,{bitmaps:n})}e.rasterFunction=null,e.pixelHighlightOptions=void 0,super.doRender(e);const s=this.children.map(a=>a.bitmap);this._colorizerTechnique.render(e,{bitmaps:s})}_getTileBounds(e){const t=this.tileInfoView.getTileBounds(Cs(),e);if(this.isCustomTilingScheme&&e.world){const{tileInfo:s}=this.tileInfoView,o=bi(s.spatialReference);if(o){const i=s.lodAt(e.level);if(!i)return t;const{resolution:a}=i,n=a*s.size[0];t[0]=o*e.world+s.origin.x+e.col*n,t[2]=t[0]+n}}return t}}const ko=[0,0];let G=class extends wi{constructor(){super(...arguments),this._updatingHandles=new _i,this._emptyTilePixelBlock=null,this._tileStrategy=null,this._tileInfoView=null,this._fetchQueue=null,this._blockCacheRegistryUrl=null,this._blockCacheRegistryId=null,this._srcResolutions=[],this.previousLOD=null,this._needBlockCacheUpdate=!1,this._globalSymbolizerParams=null,this._symbolizerParams=null,this._abortController=null,this._isCustomTilingScheme=!1,this._maxIndexedColormapSize=0,this._rasterFunctionState="na",this._globalUpdateRequested=!1,this.attached=!1,this.timeExtent=null,this.redrawOrRefetch=Ti(async(r={})=>{const e=this._rasterFunctionState,t=r.reprocess||e==="gpu"&&!this.canUseWebGLForProcessing||e==="cpu"&&this.canUseWebGLForProcessing;if(t&&(await this._updatingHandles.addPromise(this.layer.updateRasterFunction()),this.updateRasterFunctionParameters()),!this.previousLOD||this.layerView.suspended)return;const s=this._rasterFunctionState,{type:o}=this;return r.refetch||o!=="raster"&&t||s==="cpu"||e==="cpu"?this._updatingHandles.addPromise(this.doRefresh()):this._updatingHandles.addPromise(this._redrawImage(r.signal))})}destroy(){this._updatingHandles.destroy()}get canUseWebGLForProcessing(){return!1}get canUseLocalSymbolizerParams(){return(this.canUseWebGLForProcessing||this.type==="rasterVF")&&!this.layerView.hasTilingEffects}get isCPUBasedDRA(){const{renderer:r}=this.layer;return(r==null?void 0:r.type)==="raster-stretch"&&r.dynamicRangeAdjustment&&(!this.canUseWebGLForProcessing||!(r.stretchType==="min-max"||r.stretchType==="standard-deviation"))}get useWebGLForProcessing(){return this._get("useWebGLForProcessing")??!0}set useWebGLForProcessing(r){this._set("useWebGLForProcessing",r)}get useProgressiveUpdate(){return this._get("useProgressiveUpdate")??!0}set useProgressiveUpdate(r){if(this._tileStrategy&&this.useProgressiveUpdate!==r){this._tileStrategy.destroy(),this.container.removeAllChildren();const e=this._getCacheSize(r);this._tileStrategy=new as({cachePolicy:"purge",acquireTile:t=>this.acquireTile(t),releaseTile:t=>this.releaseTile(t),cacheSize:e,tileInfoView:this._tileInfoView}),this._set("useProgressiveUpdate",r),this.layerView.requestUpdate()}}update(r){var i;this._fetchQueue.pause(),this._fetchQueue.state=r.state,this._tileStrategy.update(r),this._fetchQueue.resume();const{extent:e,resolution:t,scale:s}=r.state,o=this._tileInfoView.getClosestInfoForScale(s);if(this.layer.raster){if(!this.useProgressiveUpdate||this._needBlockCacheUpdate){const a=this._srcResolutions[o.level],n="toJSON"in e?e:vi.fromJSON(e);gs(this._blockCacheRegistryUrl,this._blockCacheRegistryId,n,t,a,this.layer.raster.ioConfig.sampling)}this._needBlockCacheUpdate=!1,((i=this.previousLOD)==null?void 0:i.level)!==o.level&&(this.previousLOD=o,this._symbolizerParams!=null&&this.canUseLocalSymbolizerParams&&this._updateSymbolizerParams(),this._tileStrategy.updateCacheSize(0))}}moveEnd(){!this.isCPUBasedDRA&&this.useProgressiveUpdate||(this._abortController&&this._abortController.abort(),this._abortController=new AbortController,this._fetchQueue.length===0&&this._redrawImage(this._abortController.signal).then(()=>{this._globalUpdateRequested=!1,this.layerView.requestUpdate()}));const r=this._getCacheSize(this.useProgressiveUpdate);this._tileStrategy.updateCacheSize(r),this.layerView.requestUpdate()}get updating(){var r;return this._globalUpdateRequested||((r=this._updatingHandles)==null?void 0:r.updating)}attach(){const r=Ts();this._maxIndexedColormapSize=4*(r.maxTextureSize||4096),this._initializeTileInfo(),this._tileInfoView=new Ci(this.layerView.tileInfo,this.layerView.fullExtent);const e=this._computeFetchConcurrency();this._fetchQueue=new Si({tileInfoView:this._tileInfoView,concurrency:e,process:(s,o)=>this._fetchTile(s,o),priority:Ri.MAPVIEW_FETCH_QUEUE,scheduler:this.scheduler});const t=this._getCacheSize(this.useProgressiveUpdate);this._tileStrategy=new as({cachePolicy:"purge",acquireTile:s=>this.acquireTile(s),releaseTile:s=>this.releaseTile(s),cacheSize:t,tileInfoView:this._tileInfoView}),this._updateBlockCacheRegistry()}detach(){this._tileStrategy.destroy(),this._fetchQueue.clear(),this.container.removeAllChildren(),this._fetchQueue=this._tileStrategy=this._tileInfoView=null,fs(this._blockCacheRegistryUrl,this._blockCacheRegistryId),this._blockCacheRegistryUrl=this._blockCacheRegistryId=null}acquireTile(r){const e=this.container.createTile(r);return this._updatingHandles.addPromise(this._enqueueTileFetch(e)),this.layerView.requestUpdate(),this._needBlockCacheUpdate=!0,this._globalUpdateRequested=this.isCPUBasedDRA||!this.useProgressiveUpdate,e}releaseTile(r){this._fetchQueue.abort(r.key.id),this.container.removeChild(r),r.once("detach",()=>{r.destroy(),this.layerView.requestUpdate()}),this.layerView.requestUpdate()}createEmptyTilePixelBlock(r=null){const e=r==null||r.join(",")===this._tileInfoView.tileInfo.size.join(",");if(e&&this._emptyTilePixelBlock!=null)return this._emptyTilePixelBlock;r=r||this._tileInfoView.tileInfo.size;const[t,s]=r,o=new _r({width:t,height:s,pixels:[new Uint8Array(t*s)],mask:new Uint8Array(t*s),pixelType:"u8"});return e&&(this._emptyTilePixelBlock=o),o}_getBandIds(){if(this.container&&(!("rasterFunctionChain"in this.container)||!this.container.rasterFunctionChain))return this.layer.bandIds;const{bandIds:r,raster:e}=this.layer,t="rasterFunction"in e?e.rasterFunction.rawInputBandIds:null;return r!=null&&r.length&&(t!=null&&t.length)&&e.rasterInfo.bandCount!==1?r.map(s=>t[Math.min(s,t.length-1)]):"rasterFunction"in e?t:r}updateRasterFunctionParameters(){}_fetchTile(r,e){const t=this._getFetchOptions(r.level,e.signal);return this.fetchTile(r,t)}_getFetchOptions(r,e){var u;const{canUseWebGLForProcessing:t}=this,{layerView:s}=this,{tileInfo:o}=s,i=!o.isWrappable&&Cr(s.view.spatialReference)!=null,a=t&&this.layer.raster.hasUniqueSourceStorageInfo,{layer:n}=this.layerView,l=(u=n.serviceRasterInfo)!=null&&u.storageInfo.isBsqTile?n.getRawDisplayBandIds():void 0;return{allowPartialFill:!0,datumTransformation:s.datumTransformation,interpolation:t?"nearest":this.layer.interpolation,registryId:this._blockCacheRegistryId,requestRawData:a,skipRasterFunction:this.type==="raster"&&this.container.rasterFunctionChain!=null,signal:e,srcResolution:this._srcResolutions[r],timeExtent:s.timeExtent,tileInfo:o,bandIds:l,disableWrapAround:i}}_getCacheSize(r){return r?40:0}_initializeTileInfo(){const{layerView:r}=this,e=r.view.spatialReference;if(this._canUseLayerLODs()){const{origin:u,lods:h}=this.layer.tileInfo,p=h.map(({scale:f})=>f),m=ns.create({spatialReference:e,size:N,scales:p,origin:u});return r.set("tileInfo",m),void(this._srcResolutions=h.map(({resolution:f})=>({x:f,y:f})))}const{scales:t,srcResolutions:s,isCustomTilingScheme:o}=Sr(this.layer.serviceRasterInfo,e,{tileSize:N,alignGlobalDatasetWithAGOL:!0,limitToSrcResolution:!1}),i=ns.create({spatialReference:e,size:N,scales:t}),a=i.origin.x===0;Pi(r.fullExtent);const{xmin:n,ymax:l}=r.fullExtent;(a||o&&i.origin.x>n)&&(i.origin=new Fi({x:n,y:l,spatialReference:e})),this._isCustomTilingScheme=o,r.set("tileInfo",i),this._srcResolutions=s??[]}_canUseLayerLODs(){var o;const{layer:r,layerView:e}=this;if(r.raster.tileType!=="Map")return!1;const{lods:t}=r.tileInfo,s=(o=e.view.constraints)==null?void 0:o.effectiveLODs;return(s==null?void 0:s.length)===t.length&&s.every(({scale:i},a)=>Math.abs(i-t[a].scale)<.001)}_computeFetchConcurrency(){const{blockBoundary:r}=this.layer.serviceRasterInfo.storageInfo,e=r[r.length-1];return(e.maxCol-e.minCol+1)*(e.maxRow-e.minRow+1)>64?2:10}async _enqueueTileFetch(r,e){var t;if(!this._fetchQueue.has(r.key.id)){try{let s=r.once("detach",()=>s=void 0);const o=await this._fetchQueue.push(r.key),i=this._getBandIds();let a=!this.useProgressiveUpdate||this.isCPUBasedDRA&&!this._globalSymbolizerParams;if(this._globalUpdateRequested&&!this.layerView.moving&&this._fetchQueue.length===0){a=!1;try{await this._redrawImage((t=this._abortController)==null?void 0:t.signal)}catch(u){et(u)&&tt.getLogger(this).error(u)}this._globalUpdateRequested=!1}if(!s)return;this.canUseLocalSymbolizerParams&&this._symbolizerParams==null&&this._updateSymbolizerParams();const n=this._tileInfoView.getTileCoords(ko,r.key),l=this._tileInfoView.getTileResolution(r.key);await this.updateTileSource(r,{source:o,symbolizerParams:this._symbolizerParams,globalSymbolizerParams:this._globalSymbolizerParams,suspended:a,bandIds:i,coords:n,resolution:l}),s&&(r.once("attach",()=>this.layerView.requestUpdate()),this.container.addChild(r),s.remove())}catch(s){et(s)||tt.getLogger(this).error(s)}this.layerView.requestUpdate()}}async _redrawImage(r){if(!this.attached||this.container.children.length===0||(await this.layer.updateRenderer(),this.isCPUBasedDRA?await this._updateGlobalSymbolizerParams(r):(this.canUseLocalSymbolizerParams&&this._updateSymbolizerParams(),this._globalSymbolizerParams=null),!this.attached||(r==null?void 0:r.aborted)))return;const e=this.container.children.map(async t=>this.updateTileSymbolizerParameters(t,{local:this._symbolizerParams,global:this._globalSymbolizerParams},r));await Promise.allSettled(e),this.attached&&!(r!=null&&r.aborted)&&this.container.requestRender()}async _updateGlobalSymbolizerParams(r){var n;const e=this._getFetchOptions(this.previousLOD.level,r),t=await this.layer.fetchPixels(this.layerView.view.extent,this.layerView.view.width,this.layerView.view.height,{...e,interpolation:"nearest",requestRawData:!1,skipRasterFunction:!1});if(!(t!=null&&t.pixelBlock))return;const{resolution:s}=this.previousLOD,{isBsqTile:o}=this.layer.raster.rasterInfo.storageInfo,i=o?null:this._getBandIds(),a=this.layer.symbolizer.generateWebGLParameters({pixelBlock:t.pixelBlock.extractBands(i),isGCS:this.layerView.view.spatialReference.isGeographic,resolution:{x:s,y:s},bandIds:i});!this.canUseWebGLForProcessing&&a&&a.type==="stretch"&&((n=this.layer.renderer)==null?void 0:n.type)==="raster-stretch"&&(a.factor=a.factor.map(l=>255*l),a.minOutput=Math.round(255*a.minOutput),a.maxOutput=Math.round(255*a.maxOutput)),this._globalSymbolizerParams=a}_updateSymbolizerParams(){const{resolution:r}=this.previousLOD,e=this._getBandIds();this._symbolizerParams=this.layer.symbolizer.generateWebGLParameters({pixelBlock:null,isGCS:this.layerView.view.spatialReference.isGeographic,resolution:{x:r,y:r},bandIds:e})}_updateBlockCacheRegistry(r=!1){const{layer:e,layerView:t}=this,{raster:s}=e,{multidimensionalDefinition:o}=e.normalizeRasterFetchOptions({multidimensionalDefinition:e.multidimensionalDefinition,timeExtent:t.timeExtent}),i=s.rasterInfo.multidimensionalInfo?s.getSliceIndex(o):null,a=s.rasterInfo.storageInfo.isBsqTile?e.getRawDisplayBandIds():null,n=Tr(s.rasterId,i,a);if(n!==this._blockCacheRegistryUrl){if(this._blockCacheRegistryUrl!=null&&fs(this._blockCacheRegistryUrl,this._blockCacheRegistryId),this._blockCacheRegistryId=vr(n,s.rasterInfo),r){const{view:l}=t,u=this._tileInfoView.getClosestInfoForScale(l.scale),h=this._srcResolutions[u.level];gs(n,this._blockCacheRegistryId,l.extent,l.resolution,h,s.ioConfig.sampling)}this._blockCacheRegistryUrl=n}}async doRefresh(){if(!this.attached||!this.previousLOD||this.layerView.suspended)return;await this.layer.updateRenderer(),this.canUseLocalSymbolizerParams&&this._updateSymbolizerParams(),this._updateBlockCacheRegistry(!0),this._fetchQueue.reset();const r=[];this._globalUpdateRequested=this.isCPUBasedDRA||!this.useProgressiveUpdate,this._tileStrategy.refresh(e=>r.push(this._enqueueTileFetch(e))),await this._updatingHandles.addPromise(Promise.allSettled(r))}};c([F()],G.prototype,"_globalUpdateRequested",void 0),c([F()],G.prototype,"attached",void 0),c([F()],G.prototype,"canUseWebGLForProcessing",null),c([F()],G.prototype,"canUseLocalSymbolizerParams",null),c([F()],G.prototype,"isCPUBasedDRA",null),c([F()],G.prototype,"container",void 0),c([F()],G.prototype,"layer",void 0),c([F()],G.prototype,"layerView",void 0),c([F()],G.prototype,"scheduler",void 0),c([F()],G.prototype,"type",void 0),c([F()],G.prototype,"useWebGLForProcessing",null),c([F()],G.prototype,"useProgressiveUpdate",null),c([F()],G.prototype,"timeExtent",void 0),c([F()],G.prototype,"updating",null),G=c([nt("esri.views.2d.layers.imagery.BaseImageryTileSubView2D")],G);const ws=[1024,1024];let we=class extends G{constructor(){super(...arguments),this.type="raster"}get canUseWebGLForProcessing(){var a;const{loaded:e,symbolizer:t}=this.layer;if(!e||!t)return!1;const s=(a=t.lookup.colormapLut)==null?void 0:a.indexedColormap,o=s&&s.length>this._maxIndexedColormapSize,i=Gi(this.layer.serviceRasterInfo);return!(vs("ios")&&i>4)&&this.useWebGLForProcessing&&t.canRenderInWebGL&&!o&&!(this.layer.interpolation==="majority"&&Ss(this.layer))}attach(){super.attach(),this.container=new Mo(this._tileInfoView),this.container.isCustomTilingScheme=this._isCustomTilingScheme,this.updateRasterFunctionParameters()}detach(){super.detach(),this.container.removeAllChildren(),this.container=null}fetchTile(e,t){return this.layer.fetchTile(e.level,e.row,e.col,t)}updateRasterFunctionParameters(){var f;const{raster:e,type:t}=this.layer,{container:s}=this;if(e.datasetFormat!=="Function"||t==="wcs")return s.rasterFunctionChain=null,s.children.forEach(x=>{const{bitmap:y}=x;y&&(y.suspended=!0,y.processed=!1,y.projected&&(y.invalidateTexture(),y.rasterTexture=null))}),void(this._rasterFunctionState="na");const o=this._rasterFunctionState,{rasterFunction:i,primaryRasters:a}=e,n=i.supportsGPU&&(!a||a.rasters.length<=1),l=n?i.flatWebGLFunctionChain:null,{renderer:u}=this.layer,h=!n||!(l!=null&&l.functions.length)||(u==null?void 0:u.type)==="raster-stretch"&&u.dynamicRangeAdjustment||!this.canUseWebGLForProcessing;s.rasterFunctionChain=h?null:this._addProjection(l);const p=i==null?"na":s.rasterFunctionChain?"gpu":"cpu",m=o===p||o==="na"&&p==="cpu"&&((f=l==null?void 0:l.functions)==null?void 0:f.length)===0;s.children.forEach(x=>{const{bitmap:y}=x;y&&(y.suspended=!m,y.processed=!1,y.processedTexture=null)}),this._rasterFunctionState=p}async updateTileSource(e,t){const s=this._getBandIds(),o=this._getLayerInterpolation(),{canUseWebGLForProcessing:i}=this,{source:a,globalSymbolizerParams:n,suspended:l,coords:u,resolution:h}=t,p=this.isCPUBasedDRA?n:t.symbolizerParams,{bitmap:m}=e;if([m.x,m.y]=u,m.resolution=h,(a==null?void 0:a.pixelBlock)!=null){const y={extent:a.extent,pixelBlock:a.pixelBlock,srcPixelSize:a.srcTilePixelSize};if(m.rawPixelData=y,i)m.source=a.pixelBlock,m.isRendereredSource=!1;else{const _=await this.layer.applyRenderer(y,(n==null?void 0:n.type)==="stretch"?n:void 0);m.source=_,m.isRendereredSource=!0}m.symbolizerParameters=i?p:null,m.transformGrid=i?a.transformGrid:null}else{const y=this.createEmptyTilePixelBlock();m.source=y,m.symbolizerParameters=i?p:null,m.transformGrid=null}const{isBsqTile:f}=this.layer.raster.rasterInfo.storageInfo;m.bandIds=i&&!f?s:null,m.width=this._tileInfoView.tileInfo.size[0],m.height=this._tileInfoView.tileInfo.size[1],m.interpolation=o,m.suspended=l;const{raster:x}=this.layer;if(Rs(x)){const y=x.getClippingGeometry(this.layerView.view.spatialReference);if(y){const _=x.getTileExtentFromTileInfo(e.key.level,e.key.row,e.key.col,this._tileInfoView.tileInfo);_&&(m.mask=ps({srcExtent:_,geometry:y,size:[m.width,m.height]}))}}m.invalidateTexture()}async updateTileSymbolizerParameters(e,t,s){const{local:o,global:i}=t,a=this._getBandIds(),n=this._getLayerInterpolation(),{canUseWebGLForProcessing:l}=this,{bitmap:u}=e,{rawPixelData:h}=u;l||h==null?(u.isRendereredSource&&h!=null&&(u.source=h.pixelBlock),u.isRendereredSource=!1):(u.source=await this.layer.applyRenderer(h,(i==null?void 0:i.type)==="stretch"?i:void 0,{signal:s}),u.isRendereredSource=!0),u.symbolizerParameters=l?this.layerView.hasTilingEffects?i:o:null;const{isBsqTile:p}=this.layer.raster.rasterInfo.storageInfo;u.bandIds=l&&!p?a:null,u.interpolation=n,u.suspended=!1}updateHighlightOptions(e){var o;if(!e.length)return void(this.container.pixelHighlights=void 0);const t=[],{highlights:s}=this.layerView.view;e.sort((i,a)=>s.findIndex(({name:n})=>n===qt(a.options))-s.findIndex(({name:n})=>n===qt(i.options)));for(const{target:i,options:a}of e){const{pixelRanges:n}=i,l=qt(a),u=((o=s.find(p=>p.name===l))==null?void 0:o.color)??Ii,h=zi.toUnitRGBA(u);if(Array.isArray(n)){const p=Array.from({length:2*re},()=>0);for(let f=0;f<n.length;f++)p[2*f]=n[f][0],p[2*f+1]=n[f][1];for(let f=n.length;f<re;f++)p[2*f]=ls,p[2*f+1]=-ls;const m=i.bandId??0;t.push({ranges:p,bandId:m,color:h,type:"single-band"})}else{const p=n.type==="extent"?n:n.extent;if(!p)continue;const m=[p.xmin,p.xmax],f=[p.ymin,p.ymax],{xBandId:x,yBandId:y}=i,_={xRange:m,yRange:f,bandIds:[x,y],color:h,type:"xy-band"};n.type==="polygon"&&(_.maskSize=ws,_.mask=ps({srcExtent:p,geometry:n,size:ws})),t.push(_)}}this.container.pixelHighlights=t}_getLayerInterpolation(){const{interpolation:e,renderer:t}=this.layer;if(!t)return e;const s=t.type;return s==="raster-colormap"||s==="unique-value"?"nearest":t.type==="raster-stretch"&&t.colorRamp!=null?e==="bilinear"||e==="cubic"?"bilinear":"nearest":e}_addProjection(e){var t;return(t=e==null?void 0:e.functions)!=null&&t.length&&!e.hasFocalFunction&&e.functions.unshift({name:"Reproject",parameters:{targetImageSize:this._tileInfoView.tileInfo.size,requireNNEdge:e.isSourceSingleBand},pixelType:"f32",id:0,isNoopProcess:!1}),e}};c([F()],we.prototype,"canUseWebGLForProcessing",null),c([F()],we.prototype,"container",void 0),c([F()],we.prototype,"layer",void 0),c([F()],we.prototype,"type",void 0),we=c([nt("esri.views.2d.layers.imagery.ImageryTileView2D")],we);class Do extends Ps{constructor(e,t,s,o,i,a,n=null){super(e,t,s,o,i,a),this.tileData=new Bi(n),this.tileData.coordScale=[i,a],this.tileData.once("isReady",()=>this.ready())}destroy(){super.destroy(),this.tileData.destroy(),this.tileData=null,this.stage=null}set stencilRef(e){this.tileData.stencilRef=e}get stencilRef(){return this.tileData.stencilRef}_createTransforms(){return{displayViewScreenMat3:it(),tileMat3:it()}}setTransform(e){super.setTransform(e);const t=this.resolution/(e.resolution*e.pixelRatio),s=this.transforms.tileMat3,[o,i]=this.tileData.offset,a=[this.x+o*this.resolution,this.y-i*this.resolution],[n,l]=e.toScreenNoRotation([0,0],a),{symbolTileSize:u}=this.tileData.symbolizerParameters,h=Math.round((this.width-this.tileData.offset[0])/u)*u,p=Math.round((this.height-this.tileData.offset[1])/u)*u,m=h/this.rangeX*t,f=p/this.rangeY*t;$i(s,m,0,0,0,f,0,n,l,1),_s(this.transforms.displayViewScreenMat3,e.displayViewMat3,s),this.tileData.transforms.displayViewScreenMat3=this.transforms.displayViewScreenMat3}onAttach(){this.tileData.stage=this.stage}onDetach(){this.tileData.stage=null}}class Bo extends Fs{constructor(){super(...arguments),this.isCustomTilingScheme=!1,this.symbolTypes=["triangle"]}createTile(e){const t=this.tileInfoView.getTileBounds(Cs(),e),[s,o]=this.tileInfoView.tileInfo.size,i=this.tileInfoView.getTileResolution(e.level);return new Do(e,i,t[0],t[3],s,o)}prepareRenderPasses(e){const t=e.registerRenderPass({name:"imagery (vf tile)",brushes:[Oi],target:()=>this.children.map(s=>s.tileData),drawPhase:1});return[...super.prepareRenderPasses(e),t]}doRender(e){this.visible&&e.drawPhase===1&&this.symbolTypes.forEach(t=>{e.renderPass=t,super.doRender(e)})}}let ze=class extends G{constructor(){super(...arguments),this._handle=null,this.type="rasterVF"}async fetchTile(r,e){var s;e={...e,interpolation:"nearest",requestProjectedLocalDirections:!0};const t=await this.layer.fetchTile(r.level,r.row,r.col,e);return((s=this.layer.serviceRasterInfo)==null?void 0:s.dataType)==="vector-magdir"&&(t!=null&&t.pixelBlock)&&(t.pixelBlock=await this.layer.convertVectorFieldData(t.pixelBlock,"vector-magdir",e)),t}updateTileSource(r,e){const t=e.symbolizerParams,{tileData:s}=r;s.key=r.key,s.width=this._tileInfoView.tileInfo.size[0],s.height=this._tileInfoView.tileInfo.size[1];const{symbolTileSize:o}=t,{source:i}=e;if(s.offset=this._getTileSymbolOffset(s.key,o),(i==null?void 0:i.pixelBlock)!=null){const a={extent:i.extent,pixelBlock:i.pixelBlock};s.rawPixelData=a,s.symbolizerParameters=t,s.source=this._sampleVectorFieldData(i.pixelBlock,t,s.offset)}else{const a=[Math.round((this._tileInfoView.tileInfo.size[0]-s.offset[0])/o),Math.round((this._tileInfoView.tileInfo.size[1]-s.offset[1])/o)],n=this.createEmptyTilePixelBlock(a);s.source=n,s.symbolizerParameters=t}return s.invalidateVAO(),Promise.resolve()}updateTileSymbolizerParameters(r,e){var n;const t=e.local,{symbolTileSize:s}=t,{tileData:o}=r;o.offset=this._getTileSymbolOffset(o.key,s);const i=o.symbolizerParameters.symbolTileSize;o.symbolizerParameters=t;const a=(n=o.rawPixelData)==null?void 0:n.pixelBlock;return a!=null&&i!==s&&(o.source=this._sampleVectorFieldData(a,o.symbolizerParameters,o.offset)),Promise.resolve()}attach(){super.attach(),this.container=new Bo(this._tileInfoView),this.container.isCustomTilingScheme=this._isCustomTilingScheme,this._updateSymbolType(this.layer.renderer),this._handle=He(()=>this.layer.renderer,r=>this._updateSymbolType(r))}detach(){var r;super.detach(),this.container.removeAllChildren(),(r=this._handle)==null||r.remove(),this._handle=null,this.container=null}_getTileSymbolOffset(r,e){const t=r.col*this._tileInfoView.tileInfo.size[0]%e,s=r.row*this._tileInfoView.tileInfo.size[1]%e;return[t>e/2?e-t:-t,s>e/2?e-s:-s]}_sampleVectorFieldData(r,e,t){const{symbolTileSize:s}=e;return qi(r,"vector-uv",s,t)}_updateSymbolType(r){(r==null?void 0:r.type)==="vector-field"&&(this.container.symbolTypes=r.style==="wind-barb"?["scalar","triangle"]:r.style==="simple-scalar"?["scalar"]:["triangle"])}};c([F()],ze.prototype,"container",void 0),c([F()],ze.prototype,"layer",void 0),c([F()],ze.prototype,"type",void 0),ze=c([nt("esri.views.2d.layers.imagery.VectorFieldTileView2D")],ze);const Oo=r=>{const e=r;let t=class extends e{constructor(...s){super(...s),this.layer=null,this.tileInfo=null}get fullExtent(){try{return this.layer.loaded?this._getFullExtent():null}catch{return null}}get timeExtent(){var s;return zr(this.layer,(s=this.view)==null?void 0:s.timeExtent,this._get("timeExtent"))}get hasTilingEffects(){const{renderer:s}=this.layer;return!!((s==null?void 0:s.type)==="raster-stretch"&&s.dynamicRangeAdjustment&&!(s.stretchType==="min-max"||s.stretchType==="standard-deviation"))}get datumTransformation(){try{return this.layer.loaded?Rr(this.layer.fullExtent,this.view.spatialReference,!0):null}catch{return null}}supportsSpatialReference(s){try{return!this.layer.loaded||!!ys(this.layer.serviceRasterInfo,s)}catch{return!1}}async fetchPopupFeaturesAtLocation(s,o){var f,x;const{layer:i}=this;if(!s)throw new Mi("imageryTileLayerView:fetchPopupFeatures","Nothing to fetch without area",{layer:i});const{popupEnabled:a}=i,n=$r(i,o);if(!a||n==null)return[];const l=[],{value:u,magdirValue:h,processedValue:p}=await i.identify(s,{timeExtent:this.timeExtent,signal:o==null?void 0:o.signal});let m="";if(u!=null&&u.length){m=i.type==="imagery-tile"&&i.hasStandardTime()&&u[0]!=null?u.map(je=>i.getStandardTimeValue(je)).join(", "):u.join(", ");const y={ObjectId:0};y[Ue.servicePixelValue]=i.type==="imagery-tile"&&Rs(i.raster)?p==null?void 0:p.join(", "):m,y[Ue.rawServicePixelValue]=m;const _=((f=i.raster)==null?void 0:f.rasterInfo)??i.serviceRasterInfo,$=_==null?void 0:_.attributeTable;if($!=null){const{fields:je,features:Ot}=$,dt=je.find(({name:oe})=>oe.toLowerCase()==="value"),Vt=y[Ue.servicePixelValue],Te=dt?Ot.find(oe=>String(oe.attributes[dt.name])===Vt):null;if(Te)for(const oe in Te.attributes)Te.attributes.hasOwnProperty(oe)&&(y[Fr+oe]=Te.attributes[oe])}const S=_==null?void 0:_.dataType;S!=="vector-magdir"&&S!=="vector-uv"||(y[Ue.magnitude]=h==null?void 0:h[0],y[Ue.direction]=h==null?void 0:h[1]);const{multidimensionalDefinition:V}=this.layer.normalizeRasterFetchOptions({timeExtent:this.timeExtent});Ir(i.rasterFields,y,V);const{graphicOrigin:ee}=i,pe=new ki({geometry:(x=this.fullExtent)==null?void 0:x.clone(),attributes:y,layer:i,origin:ee,sourceLayer:i});l.push(pe)}return l}async getSourceScale(){return await this.layer.load(),Pr(this.layer.serviceRasterInfo,this.view.spatialReference)}_getFullExtent(){return ys(this.layer.serviceRasterInfo,this.view.spatialReference)}};return c([F()],t.prototype,"fullExtent",null),c([F()],t.prototype,"layer",void 0),c([F({readOnly:!0})],t.prototype,"timeExtent",null),c([F()],t.prototype,"tileInfo",void 0),c([F({readOnly:!0})],t.prototype,"hasTilingEffects",null),c([F()],t.prototype,"datumTransformation",null),t=c([nt("esri.views.layers.ImageryTileLayerViewMixin")],t),t};let _e=class extends Oo(kr(Ai(Mr))){constructor(){super(...arguments),this._useWebGLForProcessing=!0,this._useProgressiveUpdate=!0,this._pixelHighlights=[],this.subview=null}get useWebGLForProcessing(){return this._useWebGLForProcessing}set useWebGLForProcessing(r){this._useWebGLForProcessing=r,this.subview&&"useWebGLForProcessing"in this.subview&&(this.subview.useWebGLForProcessing=r)}get useProgressiveUpdate(){return this._useWebGLForProcessing}set useProgressiveUpdate(r){this._useProgressiveUpdate=r,this.subview&&"useProgressiveUpdate"in this.subview&&(this.subview.useProgressiveUpdate=r)}get displayParameters(){const{layer:r}=this,e=this._get("displayParameters");return r.renderer&&r.visible?{bandIds:r.bandIds,renderer:r.renderer,interpolation:r.interpolation,multidimensionalDefinition:r.multidimensionalDefinition,rasterFunction:r.type==="imagery-tile"?r.rasterFunction:null}:e}update(r){var e;(e=this.subview)==null||e.update(r),this.notifyChange("updating")}isUpdating(){return!this.subview||this.subview.updating}attach(){this.layer.increaseRasterJobHandlerUsage(),this._updateSubview(),this.addAttachHandles([He(()=>this.displayParameters,(r,e)=>{var u,h,p,m;const t=r.interpolation!==(e==null?void 0:e.interpolation)&&(r.interpolation==="majority"||(e==null?void 0:e.interpolation)==="majority")&&Ss(this.layer),s=!!((h=(u=this.layer.serviceRasterInfo)==null?void 0:u.storageInfo)!=null&&h.isBsqTile)&&((p=r.bandIds)==null?void 0:p.join())!==((m=e==null?void 0:e.bandIds)==null?void 0:m.join()),o=r.renderer!==(e==null?void 0:e.renderer)&&this._getSubviewType(e==null?void 0:e.renderer)!==this._getSubviewType(r.renderer);o&&this._updateSubview();const i=r.multidimensionalDefinition!==(e==null?void 0:e.multidimensionalDefinition),a=r.rasterFunction!==(e==null?void 0:e.rasterFunction),n=a&&!this._useWebGLForProcessing,l=i||t||o||n||s;this.subview.redrawOrRefetch({refetch:l,reprocess:a}).catch(f=>{et(f)||tt.getLogger(this).error(f)}),this.notifyChange("updating")}),He(()=>this.layer.multidimensionalSubset??null,(r,e)=>{const{multidimensionalDefinition:t}=this.layer;t!=null&&hs(t,r)!==hs(t,e)&&(this.subview.redrawOrRefetch({refetch:!0}).catch(s=>{et(s)||tt.getLogger(this).error(s)}),this.notifyChange("updating"))},Di),He(()=>this.timeExtent,()=>{this.subview.timeExtent=this.timeExtent,this.subview.redrawOrRefetch({refetch:!0}).catch(r=>{et(r)||tt.getLogger(this).error(r)})},us),He(()=>this.view.highlights.items.map(({name:r,color:e})=>({name:r,color:e})),()=>this._updateHighlightOptions(this.subview),us)])}detach(){var r;this.layer.decreaseRasterJobHandlerUsage(),this._detachSubview(this.subview),(r=this.subview)==null||r.destroy(),this.subview=null}viewChange(){this.requestUpdate()}moveEnd(){this.subview.moveEnd()}highlight(r,e){if(!r.pixelRanges||Array.isArray(r.pixelRanges)&&r.pixelRanges.length===0)return cs();const t={target:{...r},options:{...e}};return this._pixelHighlights.push(t),this._updateHighlightOptions(this.subview),cs(()=>{const s=this._pixelHighlights.indexOf(t);s!==-1&&(this._pixelHighlights.splice(s,1),this._updateHighlightOptions(this.subview))})}doRefresh(){return this.subview?this.subview.doRefresh():Promise.resolve()}_updateSubview(){var o;const{renderer:r}=this.layer;if(!r)return;const e=this._getSubviewType(r);if(this.subview){if(this.subview.type===e)return void this._attachSubview(this.subview);this._detachSubview(this.subview),(o=this.subview)==null||o.destroy(),this.subview=null}const{layer:t}=this;let s;if(s=e==="rasterVF"?new ze({layer:t,layerView:this,scheduler:this.scheduler}):e==="flow"?new Vi({layer:t,layerView:this,scheduler:this.scheduler}):new we({layer:t,layerView:this,scheduler:this.scheduler}),"useWebGLForProcessing"in s&&(s.useWebGLForProcessing=this._useWebGLForProcessing),"useProgressiveUpdate"in s&&(s.useProgressiveUpdate=this._useProgressiveUpdate),"previousLOD"in s){const{subview:i}=this;s.previousLOD=i&&"previousLOD"in i?i.previousLOD:null}this._attachSubview(s),this._updateHighlightOptions(s),this.subview=s,this.requestUpdate()}_attachSubview(r){r&&!r.attached&&(r.attach(),r.attached=!0,this.container.addChildAt(r.container,0))}_detachSubview(r){r!=null&&r.attached&&(this.container.removeChild(r.container),r.detach(),r.attached=!1)}_getSubviewType(r){const e=r==null?void 0:r.type;return e==="vector-field"?"rasterVF":e==="flow"?"flow":"raster"}_updateHighlightOptions(r){(r==null?void 0:r.type)==="raster"&&r.updateHighlightOptions(this._pixelHighlights)}};c([F()],_e.prototype,"subview",void 0),c([F()],_e.prototype,"useWebGLForProcessing",null),c([F()],_e.prototype,"useProgressiveUpdate",null),c([F({readOnly:!0})],_e.prototype,"displayParameters",null),_e=c([nt("esri.views.2d.layers.ImageryTileLayerView2D")],_e);const il=_e;export{il as default};
