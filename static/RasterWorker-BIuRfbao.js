import{aJ as k,c2 as O,aL as B,ax as h,aM as N,ev as P}from"./index-C_bK48d2.js";import{c as a}from"./PixelBlock-CE63rTmP.js";import{k as w,R as J,O as b,y as v}from"./RasterSymbolizer-D_kc921t.js";import{u as g}from"./pixelRangeUtils-BjN-b_zG.js";import{k as z,f as T,z as $,s as M,d as D,E,D as F,S as L,O as j,j as I,u as R}from"./vectorFieldUtils-rpoioFtp.js";import{T as A}from"./rasterFunctionHelper-BFv537F1.js";import{j as U,r as G}from"./rasterProjectionHelper-DaGB8Ymv.js";import{t as X,a as _,y as q}from"./PolynomialTransform-DX_aYQrr.js";import{c as H}from"./dataUtils-BsH8cfJg.js";import"./_commonjsHelpers-DCkdB7M8.js";import"./colorUtils-CLNuAJnC.js";import"./clipUtils-oY08WdMl.js";function K(i,t,e){const r=i.length,o=a.createEmptyBand(e,r);for(let s=0;s<r;s++)if(t[s]){const n=i[s];n<=0?t[s]=0:o[s]=Math.log(n)}return o}function V(i,t,e,r){const o=i.length,s=a.createEmptyBand(e,o),[n,l]=g(e),c=(r==null?void 0:r.lambda)??0,p=(r==null?void 0:r.shift)??0,y=c===0;for(let f=0;f<o;f++)if(t[f]){const m=i[f];if(m<=0)t[f]=0;else if(y)s[f]=Math.log(m+p);else{const d=((m+p)**c-1)/c;s[f]=Math.max(n,Math.min(d,l))}}return s}function W(i,t,e){const r=i.length,o=a.createEmptyBand(e,r);for(let s=0;s<r;s++)if(t[s]){const n=i[s];n<0?t[s]=0:o[s]=Math.sqrt(n)}return o}function C(i,t,e){const r=i.length,o=a.createEmptyBand(e,r),[s,n]=g(e);for(let l=0;l<r;l++)if(!t||t[l]){const c=1/i[l];o[l]=o[l]=Math.max(s,Math.min(c,n))}return o}function Q(i,t,e){const{width:r,height:o,pixels:s}=i;let n=[];n=i.bandMasks?i.bandMasks.map(m=>new Uint8Array(m)):s.map(()=>i.mask?new Uint8Array(i.mask):new Uint8Array(r*o).fill(255));const l="f32",c=s.map((m,d)=>{switch(t){case"log":return K(m,n[d],l);case"sqrt":return W(m,n[d],l);case"inverse":return C(m,n[d],l);case"box-cox":return V(m,n[d],l,e);default:return m}}),p=t==="inverse",y=p?i.mask:n.length===1?n[0]:z(n),f=p?i.bandMasks:n.length===1?void 0:n;return new a({width:r,height:o,pixelType:l,bandMasks:f,mask:y,pixels:c})}var S;let x=S=class extends X{constructor(){super(...arguments),this.type="identity"}clone(){return new S}};k([O({IdentityXform:"identity"})],x.prototype,"type",void 0),x=S=k([B("esri.layers.support.rasterTransforms.IdentityTransform")],x);const Y={GCSShiftXform:_,IdentityXform:x,PolynomialXform:q};function Z(i){if(!(i==null?void 0:i.type))return null;const e=Y[i==null?void 0:i.type];if(e){const r=new e;return r.read(i),r}return null}function u(i){if(!i)return{result:null,transferList:[]};const{pixelBlock:t,transferList:e}=i.getTransferableObject();return{result:t,transferList:e}}class ut{convertVectorFieldData(t){const e=a.fromJSON(t.pixelBlock),r=u(T(e,t.type));return Promise.resolve(r)}convertPixelBlockToFeatures(t){const e=$({pixelBlock:a.fromJSON(t.pixelBlock),extent:h.fromJSON(t.extent),fieldNames:t.fieldNames,skipFactor:t.skipFactor,skipSpatialReference:!0,pixelIdOffset:t.pixelIdOffset,imageRowSize:t.imageRowSize});return Promise.resolve(e)}transformPixels(t){const e=a.fromJSON(t.pixelBlock),r=Q(e,t.transformType,t.transformParameters);return Promise.resolve(u(r))}computeStatisticsHistograms(t){const e=a.fromJSON(t.pixelBlock),r=w(e,{histogramSize:t.histogramSize,includeSkewnessKurtosis:t.includeSkewnessKurtosis});return Promise.resolve(r)}compositeBands(t){const e=t.pixelBlocks.map(o=>o&&a.fromJSON(o)),r=u(M(e));return Promise.resolve(r)}async decode(t){return u(await J(t.data,t.options))}symbolize(t){const e=t.pixelBlock?a.fromJSON(t.pixelBlock):null,r=t.extent?h.fromJSON(t.extent):null,o=u(this.symbolizer.symbolize({...t,pixelBlock:e,extent:r}));return Promise.resolve(o)}highlightPixels(t){const e=a.fromJSON(t.pixelBlock),r=a.fromJSON(t.renderedPixelBlock);return D({pixelBlock:e,renderedPixelBlock:r,highlightOptions:t.highlightOptions}),Promise.resolve(r.toJSON())}async updateSymbolizer(t){var e;this.symbolizer=b.fromJSON(t.symbolizerJSON),t.histograms&&((e=this.symbolizer)==null?void 0:e.rendererJSON.type)==="rasterStretch"&&(this.symbolizer.rendererJSON.histograms=t.histograms)}async updateRasterFunction(t){this.rasterFunction=A(t.rasterFunctionJSON)}async process(t){var e;return u(this.rasterFunction.process({extent:h.fromJSON(t.extent),primaryPixelBlocks:t.primaryPixelBlocks.map(r=>r!=null?a.fromJSON(r):null),primaryPixelSizes:(e=t.primaryPixelSizes)==null?void 0:e.map(r=>r!=null?N.fromJSON(r):null),primaryRasterIds:t.primaryRasterIds}))}stretch(t){const e=u(this.symbolizer.simpleStretch(a.fromJSON(t.srcPixelBlock),t.stretchParams));return Promise.resolve(e)}estimateStatisticsHistograms(t){const e=v(a.fromJSON(t.srcPixelBlock));return Promise.resolve(e)}split(t){const e=E(a.fromJSON(t.srcPixelBlock),t.tileSize,t.maximumPyramidLevel??0,t.useBilinear===!1),r=[];let o;return e&&(o=new Map,e.forEach((s,n)=>{if(s){const{pixelBlock:l,transferList:c}=s.getTransferableObject();o.set(n,l),c.forEach(p=>{r.includes(p)||r.push(p)})}})),Promise.resolve({result:o,transferList:r})}clipTile(t){const e=a.fromJSON(t.pixelBlock),r=u(F({...t,pixelBlock:e}));return Promise.resolve(r)}async mosaicAndTransform(t){const e=t.srcPixelBlocks.map(c=>c?new a(c):null),r=L(e,t.srcMosaicSize,{blockWidths:t.blockWidths,alignmentInfo:t.alignmentInfo,clipOffset:t.clipOffset,clipSize:t.clipSize});let o,s=r;t.coefs&&(s=j(r,t.destDimension,t.coefs,t.sampleSpacing,t.interpolation)),t.projectDirections&&t.gcsGrid&&(o=I(t.destDimension,t.gcsGrid),s=R(s,t.isUV?"vector-uv":"vector-magdir",o));const{result:n,transferList:l}=u(s);return{result:{pixelBlock:n,localNorthDirections:o},transferList:l}}async createFlowMesh(t,e){const r={data:new Float32Array(t.flowData.buffer),mask:new Uint8Array(t.flowData.maskBuffer),width:t.flowData.width,height:t.flowData.height},{vertexData:o,indexData:s}=await H(t.meshType,t.simulationSettings,r,e.signal);return{result:{vertexBuffer:o.buffer,indexBuffer:s.buffer},transferList:[o.buffer,s.buffer]}}async getProjectionOffsetGrid(t){var n;const e=h.fromJSON(t.projectedExtent),r=h.fromJSON(t.srcBufferExtent);let o=null;(n=t.datumTransformationSteps)!=null&&n.length&&(o=new P({steps:t.datumTransformationSteps})),await U();const s=t.rasterTransform?Z(t.rasterTransform):null;return G({...t,projectedExtent:e,srcBufferExtent:r,datumTransformation:o,rasterTransform:s})}}export{ut as default};
