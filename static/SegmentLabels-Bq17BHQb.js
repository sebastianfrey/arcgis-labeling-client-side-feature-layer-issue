import{dF as I,dG as j,mT as X,dH as E,dJ as F,mU as A,dI as J,dK as Y,dO as q,dP as K,aJ as n,aK as a,aL as P,db as D,d3 as L,ap as U,f3 as R,mV as N,ce as W,dE as Q,jM as tt,jZ as et,dk as ot,kF as M,mW as st,mX as it,mY as $,mZ as rt,eZ as nt,m_ as at,iW as lt,jI as ht,bI as dt,i0 as O,id as B}from"./index-C_bK48d2.js";import{D as ct,I as xt}from"./colorUtils-CLNuAJnC.js";import{k as pt}from"./quantityFormatUtils-BygWVGS0.js";import{i as C}from"./sphere-Dx28BAGo.js";import{b as gt,k as ut}from"./elevationInfoUtils-C7MilKvD.js";import{e as ft}from"./getDefaultUnitForView-DghHjrRa.js";function yt(t,e,o){if(I(e))return[t[0]+o*(e[0]-t[0]),t[1]+o*(e[1]-t[1])];if(j(e))return X(t,e,o);if(E(e)){const s=F(t,e);return A(s,o)}if(J(e)){const s=Y(t,e);return A(s,o)}const r=q(t,e);return K(r,o)}let bt=t=>({vnodeSelector:"",properties:void 0,children:void 0,text:t.toString(),domNode:null}),G=(t,e,o)=>{for(let r=0,s=e.length;r<s;r++){let i=e[r];Array.isArray(i)?G(t,i,o):i!=null&&i!==!1&&(typeof i=="string"&&(i=bt(i)),o.push(i))}};function mt(t,e,o){if(Array.isArray(e))o=e,e=void 0;else if(e&&(typeof e=="string"||e.hasOwnProperty("vnodeSelector"))||o&&(typeof o=="string"||o.hasOwnProperty("vnodeSelector")))throw new Error("h called with invalid arguments");let r,s;return o&&o.length===1&&typeof o[0]=="string"?r=o[0]:o&&(s=[],G(t,o,s),s.length===0&&(s=void 0)),{vnodeSelector:t,properties:e,children:s,text:r===""?void 0:r,domNode:null}}const z={bottom:"esri-text-overlay-item-anchor-bottom","bottom-right":"esri-text-overlay-item-anchor-bottom-right","bottom-left":"esri-text-overlay-item-anchor-bottom-left",top:"esri-text-overlay-item-anchor-top","top-right":"esri-text-overlay-item-anchor-top-right","top-left":"esri-text-overlay-item-anchor-top-left",center:"esri-text-overlay-item-anchor-center",right:"esri-text-overlay-item-anchor-right",left:"esri-text-overlay-item-anchor-left"};let c=class extends D{get position(){return[this.x,this.y]}set position(t){this._set("x",t[0]),this._set("y",t[1])}get _textShadowColor(){const{textColor:t,backgroundColor:e}=this,o=e.clone();return o.a*=t.a,o}get _textShadow(){const t=this._textShadowColor.toCss(!0);return`0 0 ${this._textShadowSize}px ${t}`}get padding(){return .5*this.fontSize}get borderRadius(){return this.padding}set borderRadius(t){this._overrideIfSome("borderRadius",t)}constructor(t){super(t),this.x=0,this.y=0,this.text="-",this.fontSize=14,this.anchor="center",this.visible=!0,this.isDecoration=!0,this.backgroundColor=new L([0,0,0,.6]),this.textColor=new L([255,255,255]),this._textShadowSize=1}render(){return mt("div",{classes:this._cssClasses(),styles:{left:Math.floor(this.x)+"px",top:Math.floor(this.y)+"px",visibility:this.visible?"visible":"hidden",fontSize:this.fontSize+"px",lineHeight:this.fontSize+"px",backgroundColor:this.backgroundColor.toCss(!0),color:this.textColor.toCss(!0),padding:this.padding+"px",borderRadius:this.borderRadius+"px",textShadow:this._textShadow}},[this.text])}renderCanvas(t){if(!this.visible)return;const e=t.font.replace(/^(.*?)px/,"");t.font=`${this.fontSize}px ${e}`;const{padding:o,borderRadius:r}=this,s=t.measureText(this.text).width,i=this.text!==""?this.fontSize:0,d=_t[this.anchor];t.textAlign="center",t.textBaseline="middle";const h=s+2*o,l=i+2*o,p=this.x+d.x*h,g=this.y+d.y*l;this._roundedRect(t,p,g,h,l,r),t.fillStyle=this.backgroundColor.toCss(!0),t.fill();const b=this.x+(d.x+.5)*h,u=this.y+(d.y+.5)*l;this._renderTextShadow(t,this.text,b,u),t.fillStyle=this.textColor.toCss(!0),t.fillText(this.text,b,u)}_renderTextShadow(t,e,o,r){t.lineJoin="miter",t.fillStyle=`rgba(${this._textShadowColor.r}, ${this._textShadowColor.g}, ${this._textShadowColor.b}, ${1/T.length})`;const s=this._textShadowSize;for(const[i,d]of T)t.fillText(e,o+s*i,r+s*d)}_roundedRect(t,e,o,r,s,i){i=Math.min(i,s/2,r/2),t.beginPath(),t.moveTo(e,o+i),t.arcTo(e,o,e+i,o,i),t.lineTo(e+r-i,o),t.arcTo(e+r,o,e+r,o+i,i),t.lineTo(e+r,o+s-i),t.arcTo(e+r,o+s,e+r-i,o+s,i),t.lineTo(e+i,o+s),t.arcTo(e,o+s,e,o+s-i,i),t.closePath()}_cssClasses(){const t={"esri-text-overlay-item":!0};let e;for(e in z)t[z[e]]=this.anchor===e;return t}};n([a()],c.prototype,"x",void 0),n([a()],c.prototype,"y",void 0),n([a()],c.prototype,"position",null),n([a()],c.prototype,"text",void 0),n([a()],c.prototype,"fontSize",void 0),n([a()],c.prototype,"anchor",void 0),n([a()],c.prototype,"visible",void 0),n([a()],c.prototype,"isDecoration",void 0),n([a()],c.prototype,"backgroundColor",void 0),n([a()],c.prototype,"textColor",void 0),n([a()],c.prototype,"_textShadowSize",void 0),n([a()],c.prototype,"_textShadowColor",null),n([a()],c.prototype,"_textShadow",null),n([a()],c.prototype,"padding",null),n([a()],c.prototype,"borderRadius",null),c=n([P("esri.views.overlay.TextOverlayItem")],c);const _t={bottom:{x:-.5,y:-1,textAlign:"center",textBaseline:"bottom"},"bottom-left":{x:0,y:-1,textAlign:"left",textBaseline:"bottom"},"bottom-right":{x:-1,y:-1,textAlign:"right",textBaseline:"bottom"},center:{x:-.5,y:-.5,textAlign:"center",textBaseline:"middle"},left:{x:0,y:-.5,textAlign:"left",textBaseline:"middle"},right:{x:-1,y:-.5,textAlign:"right",textBaseline:"middle"},top:{x:-.5,y:0,textAlign:"center",textBaseline:"top"},"top-left":{x:0,y:0,textAlign:"left",textBaseline:"top"},"top-right":{x:-1,y:0,textAlign:"right",textBaseline:"top"}},T=[];for(let e=0;e<360;e+=360/16)T.push([Math.cos(Math.PI*e/180),Math.sin(Math.PI*e/180)]);const vt=3025,St={default:15,far:25};let y=class extends D{constructor(t){super(t),this.context=null,this.stagedVertex=null,this.visible=!0,this.edgeDistance="default",this._messageUnitsTask=null,this._labelInfos=[],this._nextLabelIndex=0}initialize(){this.addHandles([U(()=>[this.context!=null&&this.getCameraOrExtent(this.context),this.visible,this._edgeDistancePixels,this.stagedVertex,this._messagesUnits],()=>this._update()),R(()=>{var t;return(t=this.context)==null?void 0:t.editGeometryOperations},["vertex-add","vertex-remove"],()=>this._update()),R(()=>{var t;return(t=this.context)==null?void 0:t.editGeometryOperations},"vertex-update",t=>this._update(t.vertices)),U(()=>this._colors,t=>this._updateStyle(t)),N(()=>this._refreshMessages()),W(()=>{var t;return(t=this._messageUnitsTask)==null?void 0:t.abort()})]),this._refreshMessages()}destroy(){for(this._nextLabelIndex=0;this._labelInfos.length;)this._destroyLabel(this._labelInfos.pop())}get updating(){return this._messagesUnits==null}get test(){}get _messagesUnits(){var t;return(t=this._messageUnitsTask)==null?void 0:t.value}get _edgeDistancePixels(){return St[this.edgeDistance]}get _colors(){var e;const t=((e=this.context)==null?void 0:e.view.effectiveTheme.textColor)??L.fromArray([255,255,255]);return{textColor:t,backgroundColor:ct(xt(t,160),.6)}}_update(t){if(this.destroyed)return;this._nextLabelIndex=0;const{context:e,stagedVertex:o}=this;if(!e)return this._destroyUnusedLabels();const r=e.editGeometryOperations.data,{parts:s,geometry:i,coordinateHelper:d}=r;if(!i)return this._destroyUnusedLabels();const h=s.length;for(let l=0;l<h;++l){const p=this.getRing(i,r,o,d,l),g=p.map(x=>C(x)?x:d.arrayToXYZ(Q(x)));if(p.length<2||!Ct(p,e.view,e.elevationInfo,d.spatialReference))continue;const b=h===1&&!tt(g);let u=It,m=Lt;this.toScreenPointArray(e,g[0],u);for(let x=1;x<p.length;++x){const _=g[x-1],S=g[x],k=p[x];this.toScreenPointArray(e,S,m);const H=x===g.length-1,V=!(!(t!=null&&t.length)||t.some(({index:w,part:Z})=>Z.index===l&&(w===x-1||w===x||H&&w===0)));this._addLabel(e,_,u,S,C(k)?null:k,m,b,V),[u,m]=[m,u]}}this._destroyUnusedLabels()}_updateStyle({textColor:t,backgroundColor:e}){const o=this._nextLabelIndex,r=this._labelInfos;for(let s=0;s<o;++s){const{label:i}=r[s];i.textColor=t,i.backgroundColor=e}}_addLabel(t,e,o,r,s,i,d,h=!1){const{label:l,wasReused:p}=this._getOrCreateLabel(t);if(!this.visible||et(o,i)<vt)return void(l.visible=!1);const{spatialReference:g,coordinateHelper:b}=t.editGeometryOperations.data;if(!h||!p){const x=!s||I(s)?t.automaticLengthMeasurementUtils.autoDistance2D(e,r,g):t.automaticLengthMeasurementUtils.autoLength2D(new ot({spatialReference:g,curvePaths:[[[e[0],e[1]],s]]})),_=this._messagesUnits,S=ft(t.view);l.text=_!=null&&x!=null?pt(_,x,S):""}l.visible=!0;const u=i[0]-o[0],m=i[1]-o[1];if(d?M(f,-m,u):M(f,m,-u),st(f,f),it(f,f,this._edgeDistancePixels),s&&!I(s)){const x=b.arrayToXYZ(yt(e,s,.5)),_=this.toScreenPointArray(t,x);$(v,_,f)}else rt(v,o,i,.5),$(v,v,f);l.position=[v[0],v[1]],Math.abs(f[0])>Math.abs(f[1])?l.anchor=f[0]>0?"left":"right":l.anchor=-f[1]<0?"top":"bottom"}_getOrCreateLabel(t){var d;const e=this._labelInfos.length>this._nextLabelIndex,{textColor:o,backgroundColor:r}=this._colors;if(e){const h=this._labelInfos[this._nextLabelIndex++],{label:l}=h;return l.textColor=o,l.backgroundColor=r,h.wasReused=!0,h}const s=new c({anchor:"center",fontSize:8,textColor:o,backgroundColor:r});(d=t.view.overlay)==null||d.items.add(s);const i={label:s,wasReused:!1};return this._labelInfos.push(i),this._nextLabelIndex=this._labelInfos.length,i}_destroyUnusedLabels(){for(;this._labelInfos.length>this._nextLabelIndex;)this._destroyLabel(this._labelInfos.pop())}_destroyLabel({label:t}){var e,o;(o=(e=this.context)==null?void 0:e.view.overlay)==null||o.items.remove(t),t.destroy()}_refreshMessages(){var t;(t=this._messageUnitsTask)==null||t.abort(),this._messageUnitsTask=nt(()=>at("esri/core/t9n/Units"))}};function Ct(t,e,o,r){if(e.type==="2d")return!0;const s=lt(r)??1,i=ht(r),d=h=>gt(e,h,r,o,ut)??0;for(let h=1;h<t.length;++h){const l=t[h-1],p=t[h];if(!C(l)||!C(p))return!1;const g=(p[0]-l[0])*s,b=(p[1]-l[1])*s,u=(d(p)-d(l))*i;if(Math.abs(u)/Math.sqrt(g*g+b*b)>wt)return!1}return!0}n([a()],y.prototype,"context",void 0),n([a()],y.prototype,"stagedVertex",void 0),n([a()],y.prototype,"visible",void 0),n([a()],y.prototype,"edgeDistance",void 0),n([a()],y.prototype,"updating",null),n([a()],y.prototype,"_messageUnitsTask",void 0),n([a()],y.prototype,"_messagesUnits",null),n([a()],y.prototype,"_edgeDistancePixels",null),n([a()],y.prototype,"_colors",null),y=n([P("esri.views.interactive.SegmentLabels")],y);const wt=dt(5),f=O(),v=O(),It=B(),Lt=B();export{y as V};
