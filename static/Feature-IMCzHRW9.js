import{aX as T,ea as l,aM as A,iD as S,hN as N,c_ as B,ed as p,hL as K,gP as X,hM as q,hP as H,ee as Q,ef as W}from"./index-C_bK48d2.js";import{K as z,t as h,p as L,B as Y,A as ee,i as te,V as k,l as Z,w as O,m as P,G as ie,D as se}from"./Dictionary-BQHLIVF1.js";import{J as re}from"./featureConversionUtils-Di1UhLmY.js";function ne(e,i,s=null){const t=C(e,!0);if(t.hasm!==void 0&&(t.hasM=t.hasm,delete t.hasm),t.hasz!==void 0&&(t.hasZ=t.hasz,delete t.hasz),t.spatialreference!==void 0&&(t.spatialReference=t.spatialreference,delete t.spatialreference),t.spatialReference||(t.spatialReference=i),t.curverings!==void 0){const r=F(t.curverings,t.hasZ,t.hasM,G);if(r==null)return null;t.curveRings=r.arrays,delete t.curverings,delete t.rings,t.hasZ=r.hasZ,t.hasM=r.hasM}else if(t.rings!==void 0){const r=F(t.rings,t.hasZ,t.hasM,c);if(r==null)return null;t.rings=r.arrays,t.hasZ=r.hasZ,t.hasM=r.hasM}if(t.curvepaths!==void 0){const r=F(t.curvepaths,t.hasZ,t.hasM,G);if(r==null)return null;t.curvePaths=r.arrays,delete t.curvepaths,delete t.paths,t.hasZ=r.hasZ,t.hasM=r.hasM}else if(t.paths!==void 0){const r=F(t.paths,t.hasZ,t.hasM,c);if(r==null)return null;t.paths=r.arrays,t.hasZ=r.hasZ,t.hasM=r.hasM}if(t.points!==void 0){const r=pe(t.points,t.hasZ,t.hasM);if(r==null)return null;t.points=r.array,t.hasZ=r.hasZ,t.hasM=r.hasM}const n=T(t);if(s!=null&&(n==null?void 0:n.type)!==s)throw new l(null,"InvalidParameter",null);return n}function C(e,i=!1){const s={};for(const t of e.keys()){const n=i?t.toLowerCase():t,r=e.attributes[t];s[n]=z(r)?C(r):r}return s}const v=Symbol("NoValue");function g(e){return Array.isArray(e)&&e.length>0?e[0]:h(e)&&e.length()>0?e.get(0):v}function ae(e){const i=g(g(e));return i===v||Array.isArray(i)||h(i)||i instanceof A?e:[e]}const w=0;function R(e){return S(e,w)??w}function J(e){return typeof e=="number"&&!Number.isNaN(e)}const x=null;function U(e){return S(e,x)??x}function $(e){return typeof e=="number"&&!Number.isNaN(e)||e===null}function D(e){return!(e.length<2)&&typeof e[0]=="number"&&!Number.isNaN(e[0])&&typeof e[1]=="number"&&!Number.isNaN(e[1])}function b(e){return D(e)?e.length>2?e.slice(0,2):e:null}function le(e){return D(e)?J(e[2])?e.length>3?e.slice(0,3):e:[e[0],e[1],R(e[2])]:null}function oe(e){return D(e)?e.length>=3&&!$(e[2])?[e[0],e[1],U(e[2])]:e.length>3?e.slice(0,3):e:null}function ue(e){return D(e)?J(e[2])&&$(e[3])?e.length>4?e.slice(0,4):e:[e[0],e[1],R(e[2]),U(e[3])]:null}function _(e){return[e.x,e.y]}function ce(e){return[e.x,e.y,e.z??w]}function he(e){return[e.x,e.y,e.m??x]}function fe(e){return[e.x,e.y,e.z??w,e.m??x]}function de(e,i,s){if(h(e)&&(e=e.toArray()),!Array.isArray(e)||e.length!==2)throw new l(null,"InvalidParameter",null);const t=c(e[0],i,s);if(t==null)return null;const n=c(e[1],_,b);return n==null?null:{c:[t,n]}}function ye(e,i,s){if(h(e)&&(e=e.toArray()),!Array.isArray(e)||e.length!==4&&e.length!==7)throw new l(null,"InvalidParameter",null);const t=c(e[0],i,s);if(t==null)return null;const n=c(e[1],_,b);if(n==null)return null;const r=e[2];if(r!==0&&r!==1)throw new l(null,"InvalidParameter",null);const a=e[3];if(a!==0&&a!==1)throw new l(null,"InvalidParameter",null);if(e.length===4)return{a:[t,n,r,a]};const o=e[4];if(typeof o!="number")throw new l(null,"InvalidParameter",null);if(Number.isNaN(o))return null;const y=e[5];if(typeof y!="number")throw new l(null,"InvalidParameter",null);if(Number.isNaN(y))return null;const f=e[6];if(typeof f!="number")throw new l(null,"InvalidParameter",null);return Number.isNaN(f)?null:{a:[t,n,r,a,o,y,f]}}function me(e,i,s){if(h(e)&&(e=e.toArray()),!Array.isArray(e)||e.length!==3)throw new l(null,"InvalidParameter",null);const t=c(e[0],i,s);if(t==null)return null;const n=c(e[1],_,b);if(n==null)return null;const r=c(e[2],_,b);return r==null?null:{b:[t,n,r]}}function j(e,i){return e?i?ue:le:i?oe:b}function V(e,i){return e?i?fe:ce:i?he:_}function c(e,i,s){return Array.isArray(e)?s(e):e instanceof A?i(e):h(e)?s(e.toArray()):null}function G(e,i,s){return Array.isArray(e)?s(e):z(e)?e.hasField("c")?de(e.field("c"),i,s):e.hasField("a")?ye(e.field("a"),i,s):e.hasField("b")?me(e.field("b"),i,s):null:e instanceof A?i(e):h(e)?s(e.toArray()):null}function M(e,i,s,t){const n=[];if(Array.isArray(e))for(const r of e){const a=i(r,s,t);a!=null&&n.push(a)}else if(h(e))for(let r=0;r<e.length();r++){const a=i(e.get(r),s,t);a!=null&&n.push(a)}return n}function m(e,i,s){return Array.isArray(e)?e.length>=i:h(e)?e.length()>=i:e instanceof A&&e[s]}function E(e,i,s){return e===void 0&&i===void 0?{hasZ:m(s,3,"hasZ"),hasM:m(s,4,"hasM")}:e===void 0?i===!0?{hasZ:m(s,4,"hasZ"),hasM:!0}:{hasZ:m(s,3,"hasZ"),hasM:!1}:i===void 0?e===!0?{hasZ:!0,hasM:m(s,4,"hasM")}:{hasZ:!1,hasM:m(s,3,"hasM")}:{hasZ:e===!0,hasM:i===!0}}function pe(e,i,s){const t=g(e);if(t===v)return null;const{hasZ:n,hasM:r}=E(i,s,t);return{array:M(e,c,V(n,r),j(n,r)),hasZ:n,hasM:r}}function F(e,i,s,t){const n=g(g(e=ae(e)));if(n===v)return null;const{hasZ:r,hasM:a}=E(i,s,n),o=V(r,a),y=j(r,a),f=[];if(Array.isArray(e))for(let d=0;d<e.length;d++)f.push(M(e[d],t,o,y));else if(h(e))for(let d=0;d<e.length();d++)f.push(M(e.get(d),t,o,y));return{arrays:f,hasZ:r,hasM:a}}function ge(e){switch(e.type){case"small-integer":case"esriFieldTypeSmallInteger":case"integer":case"esriFieldTypeInteger":case"single":case"esriFieldTypeSingle":case"double":case"esriFieldTypeDouble":case"big-integer":case"esriFieldTypeBigInteger":case"long":case"esriFieldTypeLong":case"oid":case"esriFieldTypeOID":return{name:e.name,type:"number"};case"global-id":case"esriFieldTypeGlobalID":case"guid":case"esriFieldTypeGUID":case"string":case"esriFieldTypeString":return{name:e.name,type:"text"};case"date":case"esriFieldTypeDate":case"timestamp-offset":case"esriFieldTypeTimestampOffset":return{name:e.name,type:"date"};case"date-only":case"esriFieldTypeDateOnly":return{name:e.name,type:"dateOnly"};case"time-only":case"esriFieldTypeTimeOnly":return{name:e.name,type:"time"};default:return null}}function I(e,i,s){if(e==null)return null;switch(i){case"time-only":return O(e)?e:W.fromReader(e.toString());case"date-only":return P(e)?e:Q.fromReader(e.toString());case"timestamp-offset":return Z(e)?e:p.fromReaderAsTimeStampOffset(e.toString());case"date":return Z(e)?e:H(e)?p.dateJSAndZoneToArcadeDate(e,s):p.epochToArcadeDate(e,s);case"geometry":return null;default:return e}}class u{constructor(){this.arcadeDeclaredClass="esri.arcade.Feature",this._optimizedGeomDefinition=null,this._geometry=null,this.attributes=null,this._layer=null,this._fieldTypesFixed=!0,this.fieldsIndex=null,this.contextTimeZone=null,this.immutable=!0,this._fieldsToFixDataTypes=null,this.immutable=!0}static createFromGraphic(i,s){const t=new u;return t.contextTimeZone=s??null,t._geometry=i.geometry!=null?i.geometry:null,i.attributes===void 0||i.attributes===null?t.attributes={}:t.attributes=i.attributes,i._sourceLayer?(t._layer=i._sourceLayer,t._fieldTypesFixed=!1):i._layer?(t._layer=i._layer,t._fieldTypesFixed=!1):i.layer&&"fields"in i.layer?(t._layer=i.layer,t._fieldTypesFixed=!1):i.sourceLayer&&"fields"in i.sourceLayer&&(t._layer=i.sourceLayer,t._fieldTypesFixed=!1),t._layer&&!t._fieldTypesFixed&&(t.fieldsIndex=this.hydrateFieldsIndex(t._layer)),t}static createFromArcadeFeature(i){if(i instanceof u){const t=new u;return t._fieldTypesFixed=i._fieldTypesFixed,t.attributes=i.attributes,t._geometry=i._geometry,t._optimizedGeomDefinition=i._optimizedGeomDefinition,i._layer&&(t._layer=i._layer),t.fieldsIndex=i.fieldsIndex,t.contextTimeZone=i.contextTimeZone,t}const s={};for(const t of i.keys())s[t]=i.field(t);return u.createFromGraphicLikeObject(i.geometry(),s,i.fullSchema(),i.contextTimeZone)}static createFromOptimisedFeature(i,s,t){const n=new u;return n._geometry=i.geometry?{geometry:i.geometry}:null,n._optimizedGeomDefinition=t,n.attributes=i.attributes||{},n._layer=s,n._fieldTypesFixed=!1,n}static createFromArcadeDictionary(i,s){const t=new u;return t.attributes=i.field("attributes"),t.attributes!==null&&t.attributes instanceof L?(t.attributes=t.attributes.attributes,t.attributes===null&&(t.attributes={})):t.attributes={},t._geometry=i.field("geometry"),t._geometry!==null&&(t._geometry instanceof L?t._geometry=ne(t._geometry,s):t._geometry instanceof N||(t._geometry=null)),t}static createFromGraphicLikeObject(i,s,t=null,n){const r=new u;return r.contextTimeZone=n??null,s===null&&(s={}),r.attributes=s,r._geometry=i??null,r._layer=t,r._layer&&(r._fieldTypesFixed=!1,r.fieldsIndex=this.hydrateFieldsIndex(r._layer)),r}static hydrateFieldsIndex(i){return i===null?null:Y(i)?i.getFieldsIndex():i.fieldsIndex?i.fieldsIndex:B.fromLayerJSON({datesInUnknownTimezone:i.datesInUnknownTimezone,fields:i.fields,timeInfo:i.timeInfo,editFieldsInfo:i.editFieldsInfo,dateFieldsTimeReference:i.dateFieldsTimeReference??{timeZone:"UTC",respectsDaylightSaving:!1}})}repurposeFromGraphicLikeObject(i,s,t=null){s===null&&(s={}),this.attributes=s,this._geometry=i??null,this._layer=t,this._layer?this._fieldTypesFixed=!1:this._fieldTypesFixed=!0}castToText(i=!1){this._fieldTypesFixed===!1&&this._fixFieldTypes();const s=ee(this.attributes,{useNumbersForDates:i});return'{"geometry":'+(this.geometry()===null?"null":te(this.geometry()))+',"attributes":'+s+"}"}_fixFieldTypes(){var t;if(this._fieldsToFixDataTypes&&((t=this._fieldsToFixDataTypes)==null?void 0:t.length)>0)return this._fixAllFields(this._fieldsToFixDataTypes),void(this._fieldTypesFixed=!0);const i=[],s=this._layer.fields;for(let n=0;n<((s==null?void 0:s.length)??0);n++){const r=s[n],{name:a,type:o}=r;switch(o){case"date":case"esriFieldTypeDate":i.push({field:a,dataType:"date"});break;case"date-only":case"esriFieldTypeDateOnly":i.push({field:a,dataType:"date-only"});break;case"time-only":case"esriFieldTypeTimeOnly":i.push({field:a,dataType:"time-only"});break;case"timestamp-offset":case"esriFieldTypeTimestampOffset":i.push({field:a,dataType:"timestamp-offset"});break;case"geometry":case"esriFieldTypeGeometry":i.push({field:a,dataType:"geometry"})}}this._fieldsToFixDataTypes=i,i.length>0&&this._fixAllFields(i),this._fieldTypesFixed=!0}isUnknownDateTimeField(i){var s;return((s=this.fieldsIndex)==null?void 0:s.getTimeZone(i))==="unknown"}_fixAllFields(i){this.attributes={...this.attributes};const s=this.contextTimeZone??"system";for(let t=0;t<i.length;t++){const n=i[t].field,r=i[t].dataType;let a=this.attributes[n];if(a===void 0){for(const o in this.attributes)if(o.toLowerCase()===n.toLowerCase()){a=this.attributes[o],this.attributes[o]=I(a,r,this.isUnknownDateTimeField(o)?"unknown":s);break}}else a!==null&&(this.attributes[n]=I(a,r,this.isUnknownDateTimeField(n)?"unknown":s))}}geometry(){return this._geometry===null||this._geometry instanceof N||(this._optimizedGeomDefinition?(this._geometry=T(re(this._geometry,this._optimizedGeomDefinition.geometryType,this._optimizedGeomDefinition.hasZ,this._optimizedGeomDefinition.hasM)),this._geometry.spatialReference=this._optimizedGeomDefinition.spatialReference):this._geometry=T(this._geometry)),this._geometry}field(i){this._fieldTypesFixed||this._fixFieldTypes();const s=this.attributes[i];if(s!==void 0)return s;const t=i.toLowerCase();for(const n in this.attributes)if(n.toLowerCase()===t)return this.attributes[n];if(this._hasFieldDefinition(t))return null;throw new l(null,"FieldNotFound",null,{key:i})}_hasFieldDefinition(i){if(this._layer===null)return!1;for(let s=0;s<this._layer.fields.length;s++)if(this._layer.fields[s].name.toLowerCase()===i)return!0;return!1}setField(i,s){if(this.immutable)throw new l(null,"Immutable",null);if(s instanceof Date&&(s=this.isUnknownDateTimeField(i)?p.unknownDateJSToArcadeDate(s):p.dateJSToArcadeDate(s)),k(s)===!1)throw new l(null,"TypeNotAllowedInFeature",null);const t=i.toLowerCase();if(this.attributes[i]===void 0){for(const n in this.attributes)if(n.toLowerCase()===t)return void(this.attributes[n]=s);this.attributes[i]=s}else this.attributes[i]=s}hasField(i){const s=i.toLowerCase();if(this.attributes[i]!==void 0)return!0;for(const t in this.attributes)if(t.toLowerCase()===s)return!0;return!!this._hasFieldDefinition(s)}keys(){let i=[];const s={};for(const t in this.attributes)i.push(t),s[t.toLowerCase()]=1;if(this._layer!==null)for(let t=0;t<this._layer.fields.length;t++){const n=this._layer.fields[t];s[n.name.toLowerCase()]!==1&&i.push(n.name)}return i=i.sort(),i}isEmpty(){for(const i in this.attributes)return!1;return!(this._layer!=null&&this._layer.fields.length>0)&&this.geometry()==null}static parseAttributesFromDictionary(i){const s={};for(const t in i.attributes){const n=i.attributes[t];if(!k(n))throw new l(null,"InvalidParameter",null);s[t]=n}return s}static fromJson(i,s){let t=null;i.geometry!==null&&i.geometry!==void 0&&(t=T(i.geometry));const n={};if(i.attributes!==null&&i.attributes!==void 0)for(const r in i.attributes){const a=i.attributes[r];if(a===null)n[r]=a;else{if(!(K(a)||X(a)||q(a)||Z(a)||O(a)||P(a)))throw new l(null,"InvalidParameter",null);n[r]=a}}return u.createFromGraphicLikeObject(t,n,null,s??null)}fullSchema(){return this._layer}gdbVersion(){var s;if(this._layer===null)return"";const i=this._layer.gdbVersion;return i===void 0?"":i===""&&((s=this._layer.capabilities)!=null&&s.isVersioned)?"SDE.DEFAULT":i}castAsJson(i){var t;const s={attributes:{},geometry:(i==null?void 0:i.keepGeometryType)===!0?this.geometry():((t=this.geometry())==null?void 0:t.toJSON())??null};for(const n in this.attributes){const r=this.attributes[n];r!==void 0&&(s.attributes[n]=ie(r,i))}return s}async castAsJsonAsync(i=null,s){return this.castAsJson(s)}}se(u);const Te=Object.freeze(Object.defineProperty({__proto__:null,Feature:u,convertAttributeToArcadeValue:I,getArcadeVariableForField:ge},Symbol.toStringTag,{value:"Module"}));export{ge as D,Te as F,u as I,ne as a,I as w};
