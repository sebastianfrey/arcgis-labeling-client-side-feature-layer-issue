import{da as b,a as J,d3 as A,dC as D,hT as P}from"./index-C_bK48d2.js";import{E as T}from"./colorUtils-CLNuAJnC.js";import{c as K}from"./fontUtils-WtN6_M4S.js";import{U as Q,k as V}from"./quantizationUtils-DpuTGthe.js";import{y as Z}from"./densifyCurvedGeometry-7KKcR85x.js";import{u as H,y as I,g as X,f as Y}from"./utils-B2fTWpox.js";import{t as _,h as U}from"./previewUtils-B8Y4tA-6.js";import{l as tt}from"./symbolUtils-C-02jwAZ.js";import"./cimSymbolUtils-kUrI6vhQ.js";const W="picture-fill",nt="picture-marker",ot="simple-fill",at="simple-line",it="simple-marker",lt="text",et="Aa",st=22,L=120,rt=80,q=50,R=225,ht=document.createElement("canvas");function N(n,t,s){const{extent:a}=n;if(!a)return"";const p=a.width||1,h=a.height||1;if(n.type==="polygon"){const r=n.clone();D(r)&&(r.rings=Z(r,{minSegmentsPerCurve:128}).rings),Q({originPosition:"upperLeft",scale:[p/t,h/s],translate:[a.xmin,a.ymax]},r,r);let l="";for(let e=0;e<r.rings.length;e++){const m=r.rings[e];for(let c=0;c<m.length;c++){const f=m[c][0],i=m[c][1],o=c===0?"M":"l",x=c===m.length-1?" Z":"";l+=`${l!==""?" ":""}${o}${f.toString()} ${i.toString()}${x}`}}return l}if(n.type==="polyline"){const r=n.clone();D(r)&&(r.paths=Z(r,{minSegmentsPerCurve:128}).paths),V({originPosition:"upperLeft",scale:[p/t,h/s],translate:[a.xmin,a.ymax]},r,r);let l="";for(let e=0;e<r.paths.length;e++){const m=r.paths[e];for(let c=0;c<m.length;c++){const f=m[c][0],i=m[c][1];l+=`${l!==""?" ":""}${c===0?"M":"l"}${f.toString()} ${i.toString()}`}}return l}return""}function G(n,t){const s=ht.getContext("2d"),a=[];t&&(t.weight&&a.push(t.weight),t.size&&a.push(t.size+"px"),t.family&&a.push(t.family)),s.font=a.join(" ");const{width:p,actualBoundingBoxLeft:h,actualBoundingBoxRight:r,actualBoundingBoxAscent:l,actualBoundingBoxDescent:e}=s.measureText(n);return{width:Math.ceil(Math.max(p,h+r)),height:Math.ceil(l+e),x:Math.floor(h),y:Math.floor((l-e)/2)}}function S(n){const t=n==null?void 0:n.size;return{width:t!=null&&typeof t=="object"&&"width"in t?b(t.width):null,height:t!=null&&typeof t=="object"&&"height"in t?b(t.height):null}}async function ct(n,t){const s=t.fill,a=n.color;if((s==null?void 0:s.type)==="pattern"&&a&&n.type!==W){const p=await Y(s.src,a.toCss(!0));s.src=p,t.fill=s}}async function mt(n,t,s,a){var r,l,e;if(!("font"in n)||!n.font||t.shape.type!=="text")return;try{await K(n.font)}catch{}const{width:p,height:h}=S(a);if(!/[\uE600-\uE6FF]/.test(t.shape.text)){const{width:m,height:c,x:f,y:i}=G(t.shape.text,{weight:(r=t.font)==null?void 0:r.weight,size:(l=t.font)==null?void 0:l.size,family:(e=t.font)==null?void 0:e.family});s[0]=p??m,s[1]=h??c,t.shape.x=f,t.shape.y=i;let o="angle"in n?n.angle:null;if((a==null?void 0:a.rotation)!=null&&(o=(o??0)+a.rotation),o){const x=o*(Math.PI/180),z=Math.abs(Math.sin(x)),C=Math.abs(Math.cos(x));s[1]=s[0]*z+s[1]*C}}}function ut(n,t,s,a,p){var h;if(n.haloColor!=null&&n.haloSize!=null){p.masking??(p.masking=s.map(()=>[]));const r=b(n.haloSize);a[0]+=r,a[1]+=r,s.unshift([{...t,fill:null,stroke:{color:n.haloColor,width:2*r,join:"round",cap:"round"}}]),p.masking.unshift([{shape:{type:"rect",x:0,y:0,width:a[0]+2*P,height:a[1]+2*P},fill:[255,255,255],stroke:null},{...t,fill:[0,0,0,0],stroke:null}])}n.backgroundColor==null&&n.borderLineColor==null||(a[0]+=2*P,a[1]+=2*P,s.unshift([{shape:{type:"rect",x:0,y:0,width:a[0],height:a[1]},fill:n.backgroundColor,stroke:{color:n.borderLineColor,width:b(n.borderLineSize)}}]),(h=p.masking)==null||h.unshift([]))}function O(n,t){return n>t?"dark":"light"}function pt(n,t){var z,C,E,$,j;const s=typeof(t==null?void 0:t.size)=="number"?t==null?void 0:t.size:null,a=s!=null?b(s):null,p=(t==null?void 0:t.maxSize)!=null?b(t.maxSize):null;let h="angle"in n?n.angle:null;(t==null?void 0:t.rotation)!=null&&(h=(h??0)+t.rotation);const r=H(n);let l=I(n);dt(n,245)!=="dark"||t!=null&&t.ignoreWhiteSymbols||(l={width:.75,...l,color:"#bdc3c7"});let e=null;const m={shape:null,fill:r,stroke:l,offset:[0,0]};l!=null&&l.width&&(l.width=Math.min(l.width,rt));const c=(l==null?void 0:l.width)||0;let f=(t==null?void 0:t.size)!=null&&((t==null?void 0:t.scale)==null||(t==null?void 0:t.scale)),i=0,o=0,x=!1;switch(n.type){case it:{const g=n.style,{width:d,height:u}=S(t);let v=d===u&&d!=null?d:a??Math.min(b(n.size),p||L);if((t==null?void 0:t.useMarkerSymbolSize)===!0&&d!==null&&u!==null){const y=Math.min(b(n.size),p||L);v=y>d&&y>u?Math.min(d,u):y}switch(i=v,o=v,g){case"circle":m.shape={type:"circle",cx:0,cy:0,r:.5*v},f||(i+=c,o+=c);break;case"cross":m.shape={type:"path",path:[{command:"M",values:[0,.5*o]},{command:"L",values:[i,.5*o]},{command:"M",values:[.5*i,0]},{command:"L",values:[.5*i,o]}]};break;case"diamond":m.shape={type:"path",path:[{command:"M",values:[0,.5*o]},{command:"L",values:[.5*i,0]},{command:"L",values:[i,.5*o]},{command:"L",values:[.5*i,o]},{command:"Z",values:[]}]},f||(i+=c,o+=c);break;case"square":m.shape={type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[i,0]},{command:"L",values:[i,o]},{command:"L",values:[0,o]},{command:"Z",values:[]}]},f||(i+=c,o+=c),h&&(x=!0);break;case"triangle":m.shape={type:"path",path:[{command:"M",values:[.5*i,0]},{command:"L",values:[i,o]},{command:"L",values:[0,o]},{command:"Z",values:[]}]},f||(i+=c,o+=c),h&&(x=!0);break;case"x":m.shape={type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[i,o]},{command:"M",values:[i,0]},{command:"L",values:[0,o]}]},h&&(x=!0);break;case"path":m.shape={type:"path",path:n.path||""},f||(i+=c,o+=c),h&&(x=!0),f=!0}break}case at:{const{width:g,height:d}=S(t),u=X(l).reduce((M,k)=>M+k,0),v=u&&Math.ceil(q/u),y=d??a??c,w=g??(u*v||q);if(f=!0,((z=t==null?void 0:t.geometry)==null?void 0:z.type)==="polyline"&&((C=t==null?void 0:t.geometry)==null?void 0:C.extent)){i=w,o=d??i;const M=1e3,k=.15*M;e=[i,o],o=e[0]>e[1]?M*e[1]/e[0]:M,i=e[0]>e[1]?M:M*e[0]/e[1],l!=null&&l.width&&(l.width=l.width*M/(e[1]>e[0]?e[1]:e[0]),l.width>k&&(l.width=k)),m.shape={type:"path",path:N(t.geometry,i,o)}}else i=(t==null?void 0:t.maxSize)!=null?Math.min(w,t.maxSize):w,o=y,l&&(l.width=y),m.shape={type:"path",path:[{command:"M",values:[y/2,o/2]},{command:"L",values:[i-y/2,o/2]}]};break}case W:case ot:{const g=typeof(t==null?void 0:t.symbolConfig)=="object"&&!!((E=t==null?void 0:t.symbolConfig)!=null&&E.isSquareFill),{width:d,height:u}=S(t);i=!g&&d!==u||d==null?a??st:d,o=!g&&d!==u||u==null?i:u,f||(i+=c,o+=c),f=!0,($=t==null?void 0:t.geometry)!=null&&$.extent&&((j=t==null?void 0:t.geometry)==null?void 0:j.type)==="polygon"?(e=[i,o],o=e[0]>e[1]?1e3*e[1]/e[0]:1e3,i=e[0]>e[1]?1e3:1e3*e[0]/e[1],m.shape={type:"path",path:N(t.geometry,i,o)}):m.shape=g?{type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[i,0]},{command:"L",values:[i,o]},{command:"L",values:[0,o]},{command:"L",values:[0,0]},{command:"Z",values:[]}]}:_.fill[0];break}case nt:{const g=Math.min(b(n.width),p||L),d=Math.min(b(n.height),p||L),{width:u,height:v}=S(t),y=u===v&&u!=null?u:a??Math.max(g,d),w=n.width/n.height;i=w<=1?Math.ceil(y*w):y,o=w<=1?y:Math.ceil(y/w),m.shape={type:"image",x:-Math.round(i/2),y:-Math.round(o/2),width:i,height:o,src:n.url||""},h&&(x=!0);break}case lt:{const g=n,d=(t==null?void 0:t.overrideText)||g.text||et,u=g.font,{width:v,height:y}=S(t),w=y??a??Math.min(b(u.size),p||L),{width:M,height:k}=G(d,{weight:u.weight,size:w,family:u.family}),B=/[\uE600-\uE6FF]/.test(d);i=v??(B?w:M),o=B?w:k;let F=.5*(B?w:k);B&&(F+=5),m.shape={type:"text",text:d,x:g.xoffset||0,y:g.yoffset||F,align:"middle",alignBaseline:g.verticalAlignment,decoration:u&&u.decoration,rotated:g.rotated,kerning:g.kerning},m.font=u&&{size:w,style:u.style,decoration:u.decoration,weight:u.weight,family:u.family};break}}return{shapeDescriptor:m,size:[i,o],outputSize:e,renderOptions:{node:t==null?void 0:t.node,scale:f,opacity:t==null?void 0:t.opacity,rotations:[h],useRotationSize:x,cssEffectFilter:t==null?void 0:t.cssEffectFilter,ariaLabel:t==null?void 0:t.ariaLabel,clipBloomEffect:t==null?void 0:t.clipBloomEffect}}}async function St(n,t){var e,m,c,f,i;const{shapeDescriptor:s,size:a,renderOptions:p,outputSize:h}=pt(n,t);if(!s.shape)throw new J("symbolPreview: renderPreviewHTML2D","symbol not supported.");await ct(n,s),await mt(n,s,a,t);const r=[[s]];if(typeof(t==null?void 0:t.symbolConfig)=="object"&&((e=t==null?void 0:t.symbolConfig)!=null&&e.applyColorModulation)){const o=.6*a[0];r.unshift([{...s,offset:[-o,0],fill:U(s.fill,-.3)}]),r.push([{...s,offset:[o,0],fill:U(s.fill,.3)}]),a[0]+=2*o,p.scale=!1}n.type==="text"&&ut(n,s,r,a,p);const l=tt(r,a,p);if(h&&l){const o=l.nodeName.toLowerCase()==="img"?l:l.firstChild;o.nodeName.toLowerCase()==="svg"&&o.setAttribute("viewBox",`0 0 ${a[0].toString()} ${a[1].toString()}`),o.setAttribute("width",h[0].toString()),o.setAttribute("height",h[1].toString()),h.length>2&&(o.style.setProperty("padding-left",((m=h[2])==null?void 0:m.toString())+"px"),o.style.setProperty("padding-right",((c=h[2])==null?void 0:c.toString())+"px"),o.style.setProperty("padding-top",((f=h[3])==null?void 0:f.toString())+"px"),o.style.setProperty("padding-bottom",((i=h[3])==null?void 0:i.toString())+"px"),o.style.setProperty("box-sizing","border-box"))}return l}function dt(n,t=R){const s=H(n),a=I(n),p=!s||"type"in s?null:new A(s),h=a!=null&&a.color?new A(a==null?void 0:a.color):null,r=p?O(T(p),t):null,l=h?O(T(h),t):null;return l?r?r===l?r:t>=R?"light":"dark":l:r}export{dt as getContrastingBackgroundTheme,pt as getRenderSymbolParameters,St as previewSymbol2D};
