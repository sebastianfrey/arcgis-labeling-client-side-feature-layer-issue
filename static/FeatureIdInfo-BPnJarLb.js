import{aq as u,aI as y,fv as m,iK as h,ae as p,ay as f}from"./index-C_bK48d2.js";const l=4;function q(s){switch(s.type){case"object-id":case"unique-id-simple":return`${s.fieldName} ASC`;case"unique-id-composite":return`${s.fieldNames.join(",")} ASC`}}function g(s,e,r){const a=q(r.featureIdInfo);return{returnCentroid:r.serviceGeometryType==="esriGeometryPolygon"&&!s.queryMetadata.supportsCentroidOnDegeneratedQuantizedGeometry&&!s.queryMetadata.supportsDegeneratedQuantizedGeometry,returnGeometry:!0,timeReferenceUnknownClient:r.timeReferenceUnknownClient??void 0,outSpatialReference:p.fromJSON(s.outSpatialReference),orderByFields:s.type==="memory"?[]:[a],where:e.definitionExpression??"1=1",outFields:e.availableFields,multipatchOption:r.serviceGeometryType==="esriGeometryMultiPatch"?"xyFootprint":null,gdbVersion:e.gdbVersion,historicMoment:e.historicMoment?new Date(e.historicMoment):null,timeExtent:e.timeExtent?f.fromJSON(e.timeExtent):null}}class d{static create(e,r,a){const t=r.queryScaleRanges,n=r.displayFilterInfo;return new d(g(e,r,a),n,t,a.subtypeField,r.customParameters,a.geometryType,e.queryMetadata)}constructor(e,r,a,t,n,o,i){this._queryParams=e,this._displayFilter=r,this._queryScaleRanges=a,this._subtypeField=t,this._customParameters=n,this._geometryType=o,this._queryMetadata=i}get pageSize(){if(this._queryMetadata==null)throw new Error("InternalError: Service does not support paged queries");const e=this._queryMetadata.supportsMaxRecordCountFactor?l:null,r=(this._queryMetadata.maxRecordCount??8e3)*(e??1);return Math.min(8e3,r)}get objectIdsQueryPageSize(){var e;return((e=this._queryMetadata)==null?void 0:e.maxRecordCount)??2e3}updateHistoricMoment(e){this._queryParams.historicMoment=e}updateFields(e){this._queryParams.outFields=e}createPatchFieldsQuery(e,r,a){if(!r.getSize())return null;const t=e.clone();if(this._queryParams.outFields[0]==="*"){if((t.outFields??[])[0]==="*")return null;t.outFields=this._queryParams.outFields}else{const o=new Set(this._queryParams.outFields),i=[];for(const c of o)r.hasField(c)||i.push(c);if(i.length===0)return null;t.outFields=i}t.returnGeometry=!1,t.returnCentroid=!1,t.quantizationParameters=null,t.cacheHint=!0;const n={inner:t,customParameters:this._customParameters};if(u("esri-tiles-debug")&&a!=null){const o=a.chunkId.toString().replaceAll("/",".");n.customParameters=n.customParameters?{...n.customParameters,chunkId:o}:{chunkId:o}}return n}createQuery(e={}){if(!this._queryParams)throw new Error("InternalError: queryInfo should be defined");return{inner:new y({...this._queryParams,...e}),customParameters:this._customParameters}}createTileQuery(e,r){var n;if(this._queryMetadata==null)throw new Error("InternalError: Service does not support tile queries");const a=this.createQuery(r),t=a.inner;if((n=this._queryScaleRanges)!=null&&n.length){const o=this._queryScaleRanges.filter(i=>(!i.minScale||i.minScale>=e.maxScale)&&(!i.maxScale||i.maxScale<=e.minScale)).map(i=>i.subtypeCode);if(o.length){const i=`${this._subtypeField} IN (${o})`;t.where=m(t.where,i)}}if(this._displayFilter&&(t.where=m(t.where,h(this._displayFilter,e.minScale,e.maxScale))),t.quantizationParameters=r.quantizationParameters??e.getQuantizationParameters(),t.resultType="tile",t.geometry=e.extent,this._queryMetadata.supportsQuantization?this._geometryType==="esriGeometryPolyline"&&(t.maxAllowableOffset=e.resolution*u("feature-polyline-generalization-factor")):this._geometryType!=="esriGeometryPolyline"&&this._geometryType!=="esriGeometryPolygon"||(t.maxAllowableOffset=e.resolution,this._geometryType==="esriGeometryPolyline"&&(t.maxAllowableOffset*=u("feature-polyline-generalization-factor"))),t.defaultSpatialReferenceEnabled=this._queryMetadata.supportsDefaultSpatialReference,t.compactGeometryEnabled=this._queryMetadata.supportsCompactGeometry,this._queryMetadata.supportsMaxRecordCountFactor&&(t.maxRecordCountFactor=l),u("esri-tiles-debug")){const o=e.id.replaceAll("/",".");a.customParameters=a.customParameters?{...a.customParameters,tileId:o}:{tileId:o}}return a}createPagedTileQuery(e,r){const a=this.pageSize;return this.createTileQuery(e,{start:a*r,num:a,returnExceededLimitFeatures:!0})}createPagedQuery(e,r){const a=this.pageSize;return this.createQuery({start:a*e,num:a,returnExceededLimitFeatures:!0,maxRecordCountFactor:l,quantizationParameters:r,cacheHint:!0})}createObjectIdsQuery(e){return this.createQuery({objectIds:e,outFields:["*"]})}}function*_(s){switch(s.type){case"object-id":case"unique-id-simple":return void(yield s.fieldName);case"unique-id-composite":return void(yield*s.fieldNames)}}export{_ as e,d as u};
