import{e as he}from"./deduplicate-Z43o2PF3.js";import{Q as E,t as T}from"./InterleavedLayout-DFvKIHDS.js";import{i as we}from"./TextureBackedBufferLayout-Bu_3CpJU.js";import{t as ie}from"./VertexAttributeLocations-BSIMTgtd.js";import{b3 as N,fB as G,gq as ve,gp as P,bH as Z,bB as K,gs as ye,gr as xe,bC as ae,fN as ee,bE as ce,bI as le,go as $e,fb as Ne}from"./index-C_bK48d2.js";import{e as Q}from"./Normals-4KUYifO5.js";const Ae=E().vec3f("position").u16("componentIndex",{integer:!0}).freeze(),Ie=E().vec2u8("sideness").freeze(),fe=T(Ie),ue=E().vec3f("position0").vec3f("position1").vec2i16("normalCompressed").u16("componentIndex",{integer:!0}).u8("variantOffset",{glNormalized:!0}).u8("variantStroke").u8("variantExtension",{glNormalized:!0}).freeze(),pe=E().vec3f("position0").vec3f("position1").vec2i16("normalCompressed").vec2i16("normal2Compressed").u16("componentIndex",{integer:!0}).u8("variantOffset",{glNormalized:!0}).u8("variantStroke").u8("variantExtension",{glNormalized:!0}).freeze(),be=T(ue,1),Se=T(pe,1);ie([fe,be]);ie([fe,Se]);new we([{name:"color",type:"vec4unorm8"},{name:"lineWidth",type:"u8"},{name:"extensionLength",type:"u8"},{name:"materialType",type:"u8"},{name:"opacity",type:"unorm8"},{name:"elevationOffset",type:"f32"}]);class Ve{constructor(){this.position0=N(),this.position1=N(),this.faceNormal0=N(),this.faceNormal1=N(),this.componentIndex=0,this.cosAngle=0}}const H=-1;function Be(e,n,o){const r=e.vertices.position,a=e.vertices.componentIndex,f=h.position0,d=h.position1,g=h.faceNormal0,y=h.faceNormal1,{edges:i,normals:u}=Fe(e),w=i.length/4,x=n.allocate(w);let C=0;const W=w,A=o==null?void 0:o.allocate(W);let L=0,t=0,s=0;k.length=0;for(let p=0;p<w;++p){const b=4*p;r.getVec(i.data[b],f),r.getVec(i.data[b+1],d);const _=k.pushNew();_.index=4*p,_.length=ve(f,d)}k.sort((p,b)=>b.length-p.length);const l=new Array,c=new Array;k.forAll(({length:p,index:b})=>{const _=i.data[b],me=i.data[b+1],J=i.data[b+2],X=i.data[b+3],Y=X===H;if(r.getVec(_,f),r.getVec(me,d),Y){const $=3*J;P(g,u.data[$],u.data[$+1],u.data[$+2]),Z(y,g),h.componentIndex=a.get(_),h.cosAngle=K(g,y)}else{let $=3*J;if(P(g,u.data[$],u.data[$+1],u.data[$+2]),$=3*X,P(y,u.data[$],u.data[$+1],u.data[$+2]),h.componentIndex=a.get(_),h.cosAngle=K(g,y),ze(h,Ee))return;h.cosAngle<-.9999&&Z(y,g)}t+=p,s++,Y||Ce(h,Le)?(n.write(x,C++,h),l.push(p)):_e(h,de)&&(A&&o&&o.write(A,L++,h),c.push(p))});const v=new Float32Array(l.reverse()),I=new Float32Array(c.reverse()),S=A&&o?{instancesData:A.slice(0,L),lodInfo:{lengths:I}}:void 0;return{regular:{instancesData:x.slice(0,C),lodInfo:{lengths:v}},silhouette:S,averageEdgeLength:t/s}}function Ce(e,n){return e.cosAngle<n}function ze(e,n){return e.cosAngle>n}function _e(e,n){const o=ye(e.cosAngle);return xe(te,e.position1,e.position0),o*(K(ae(Ue,e.faceNormal0,e.faceNormal1),te)>0?-1:1)>n}function Fe(e){const n=e.faces.length/3,o=e.faces,r=e.neighbors,a=e.vertices.position;m.length=j.length=0;for(let f=0;f<n;f++){const d=3*f,g=r[d],y=r[d+1],i=r[d+2],u=o[d],w=o[d+1],x=o[d+2];a.getVec(u,z),a.getVec(w,D),a.getVec(x,O),ee(D,D,z),ee(O,O,z),ae(z,D,O),ce(z,z),j.pushArray(z),(g===H||u<w)&&(m.push(u),m.push(w),m.push(f),m.push(g)),(y===H||w<x)&&(m.push(w),m.push(x),m.push(f),m.push(y)),(i===H||x<u)&&(m.push(x),m.push(u),m.push(f),m.push(i))}return{edges:m,normals:j}}class Me{constructor(){this.index=0,this.length=0}}const k=new G({allocator:e=>e||new Me,deallocator:null}),m=new G({deallocator:null}),j=new G({deallocator:null}),h=new Ve,Ue=N(),te=N(),z=N(),D=N(),O=N(),de=le(4),Ee=Math.cos(de),We=le(35),Le=Math.cos(We);function ne(e,n,o){const r=n/3,a=new Uint32Array(o+1),f=new Uint32Array(o+1),d=(t,s)=>{t<s?a[t+1]++:f[s+1]++};for(let t=0;t<r;t++){const s=e[3*t],l=e[3*t+1],c=e[3*t+2];d(s,l),d(l,c),d(c,s)}let g=0,y=0;for(let t=0;t<o;t++){const s=a[t+1],l=f[t+1];a[t+1]=g,f[t+1]=y,g+=s,y+=l}const i=new Uint32Array(6*r),u=a[o],w=(t,s,l)=>{if(t<s){const c=a[t+1]++;i[2*c]=s,i[2*c+1]=l}else{const c=f[s+1]++;i[2*u+2*c]=t,i[2*u+2*c+1]=l}};for(let t=0;t<r;t++){const s=e[3*t],l=e[3*t+1],c=e[3*t+2];w(s,l,t),w(l,c,t),w(c,s,t)}const x=(t,s)=>{const l=2*t,c=s-t;for(let v=1;v<c;v++){const I=i[l+2*v],S=i[l+2*v+1];let p=v-1;for(;p>=0&&i[l+2*p]>I;p--)i[l+2*p+2]=i[l+2*p],i[l+2*p+3]=i[l+2*p+1];i[l+2*p+2]=I,i[l+2*p+3]=S}};for(let t=0;t<o;t++)x(a[t],a[t+1]),x(u+f[t],u+f[t+1]);const C=new Int32Array(3*r),W=(t,s)=>t===e[3*s]?0:t===e[3*s+1]?1:t===e[3*s+2]?2:-1,A=(t,s)=>{const l=W(t,s);C[3*s+l]=-1},L=(t,s,l,c)=>{const v=W(t,s);C[3*s+v]=c;const I=W(l,c);C[3*c+I]=s};for(let t=0;t<o;t++){let s=a[t];const l=a[t+1];let c=f[t];const v=f[t+1];for(;s<l&&c<v;){const I=i[2*s],S=i[2*u+2*c];I===S?(L(t,i[2*s+1],S,i[2*u+2*c+1]),s++,c++):I<S?(A(t,i[2*s+1]),s++):(A(S,i[2*u+2*c+1]),c++)}for(;s<l;)A(t,i[2*s+1]),s++;for(;c<v;)A(i[2*u+2*c],i[2*u+2*c+1]),c++}return C}const R=.7;let ge=class{updateSettings(n){this.settings=n,this._edgeHashFunction=n.reducedPrecision?De:ke}write(n,o,r){q.seed=this._edgeHashFunction(r);const a=q.getIntRange(0,255),f=q.getIntRange(0,this.settings.variants-1),d=q.getFloat(),g=255*(.5*Oe(-(1-Math.min(d/R,1))+Math.max(0,d-R)/(1-R),1.2)+.5);n.position0.setVec(o,r.position0),n.position1.setVec(o,r.position1),n.componentIndex.set(o,r.componentIndex),n.variantOffset.set(o,a),n.variantStroke.set(o,f),n.variantExtension.set(o,g)}};const V=new Float32Array(6),B=new Uint32Array(V.buffer),U=new Uint32Array(1);function ke(e){return V[0]=e.position0[0],V[1]=e.position0[1],V[2]=e.position0[2],V[3]=e.position1[0],V[4]=e.position1[1],V[5]=e.position1[2],U[0]=31*(31*(31*(31*(31*(166811+B[0])+B[1])+B[2])+B[3])+B[4])+B[5],U[0]}function De(e){const n=V;n[0]=F(e.position0[0]),n[1]=F(e.position0[1]),n[2]=F(e.position0[2]),n[3]=F(e.position1[0]),n[4]=F(e.position1[1]),n[5]=F(e.position1[2]),U[0]=5381;for(let o=0;o<B.length;o++)U[0]=31*U[0]+B[o];return U[0]}const oe=1e4;function F(e){return Math.round(e*oe)/oe}function Oe(e,n){return Math.abs(e)**n*Math.sign(e)}class qe{constructor(){this._commonWriter=new ge}updateSettings(n){this._commonWriter.updateSettings(n)}allocate(n){return ue.createBuffer(n)}write(n,o,r){this._commonWriter.write(n,o,r),$e(M,r.faceNormal0,r.faceNormal1),ce(M,M);const{typedBuffer:a,typedBufferStride:f}=n.normalCompressed;Q(a,o,M[0],M[1],M[2],f)}}class He{constructor(){this._commonWriter=new ge}updateSettings(n){this._commonWriter.updateSettings(n)}allocate(n){return pe.createBuffer(n)}write(n,o,r){this._commonWriter.write(n,o,r);{const{typedBuffer:a,typedBufferStride:f}=n.normalCompressed;Q(a,o,r.faceNormal0[0],r.faceNormal0[1],r.faceNormal0[2],f)}{const{typedBuffer:a,typedBufferStride:f}=n.normal2Compressed;Q(a,o,r.faceNormal1[0],r.faceNormal1[1],r.faceNormal1[2],f)}}}const M=N(),q=new Ne;function Ye(e){const n=Pe(e.data,e.skipDeduplicate,e.indices,e.indicesLength);return se.updateSettings(e.writerSettings),re.updateSettings(e.writerSettings),Be(n,se,re)}function Pe(e,n,o,r){if(n){const d=ne(o,r,e.count);return new je(o,r,d,e)}const a=he(e.buffer,e.stride/4,{originalIndices:o}),f=ne(a.indices,r,a.uniqueCount);return{faces:a.indices,facesLength:a.indices.length,neighbors:f,vertices:Ae.createView(a.buffer)}}class je{constructor(n,o,r,a){this.faces=n,this.facesLength=o,this.neighbors=r,this.vertices=a}}const se=new qe,re=new He,Ze=E().vec3f("position0").vec3f("position1"),et=E().vec3f("position0").vec3f("position1").u16("componentIndex",{integer:!0});export{et as a,Ye as c,Be as d,Pe as f,Ze as g,Ae as n};
