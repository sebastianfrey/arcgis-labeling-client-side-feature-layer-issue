import{i6 as M,l3 as _,l4 as S,l5 as k,aJ as z,aL as E}from"./index-C_bK48d2.js";import{f as v,d as b}from"./dataUtils-BsH8cfJg.js";function T(n,r,t){const{extent:o,valid:u}=n,[e,i,s,a]=o;return!(t<i||t>a)&&(u!=null&&e>s?r>=s||r<=e:r>=e&&r<=s)}function j(n,r,t,o){const{extent:u,modelSize:e,valid:i}=n,[s,a,c]=u,f=L(s,c,i);let l=r/e[0]*f+s;return i!=null&&o&&(l=new M(i[0],i[1]).normalize(l)),[l,(e[1]-t)/e[1]*_(u)+a]}function L(n,r,t){if(t!=null&&n>r){const[o,u]=t;return u-n+(r-o)}return r-n}function A(n){return n?4:3}function F(n,r,t){const[o,u]=t.modelSize;let e=null;const i=new Map;r.forEach(a=>{i.set(a.lij,v(n,a))});const s=(a,c,f)=>k(a.extent,c,f);return(a,c)=>{const f=Math.round(a),l=Math.round(c);if(!n.wrapAround&&(f<0||f>=o||l<0||l>=u))return[0,0];const[d,p]=j(t,a,c,!0);if(!T(t,d,p))return[0,0];if(e==null||!s(e,d,p)){e=null;for(const[I,x]of r)if(s(x,d,p)){e=x;break}}if((e==null?void 0:e.data)==null)return[0,0];const w=i.get(e.lij);if(w==null)return[0,0];const{width:y,height:g,extent:h}=e;return w((d-h[0])/S(h)*y,g-(p-h[1])/_(h)*g)}}let m=class{constructor(){this._tileData=new Map}async generateStreamlines(n){const{flowData:r,flowExtentInfo:t,needsMagnitude:o,simulationSettings:u,startPositions:e}=n,i=D(v(u,r),u,t.modelSize,o,e);return{result:{streamlines:i},transferList:i==null?void 0:i.map(s=>s.vertices.buffer)}}async generateTiledStreamlines(n){const{flowDataTiles:r,flowExtentInfo:t,needsMagnitude:o,reset:u,simulationSettings:e,startPositions:i}=n;this._updateTileData(r,u);const s=D(F(e,this._tileData,t),e,t.modelSize,o,i);return{result:{streamlines:s},transferList:(s==null?void 0:s.map(a=>a.vertices.buffer))??[]}}_updateTileData(n,r){if(r)for(const t of this._tileData.keys())n.has(t)||this._tileData.delete(t);n.forEach((t,o)=>{t.type==="delete"?this._tileData.delete(o):t.type!=="on-worker"&&t.type!=="invalid"&&this._tileData.set(o,t.data)})}};m=z([E("esri.views.3d.support.flow.FlowWorker")],m);const J=m;function D(n,r,t,o,u){if(n==null)return;const e=b(r,n,t[0],t[1],{positions:u}),i=[],s=A(o);for(const{vertices:a,stage:c}of e){const f=new Float32Array(a.length*s);for(let l=0;l<a.length;l++)f[l*s]=a[l].x,f[l*s+1]=a[l].y,f[l*s+2]=a[l].t,o&&(f[l*s+3]=a[l].speed);i.push({vertices:f,stage:c,hasMagnitude:o})}return i}export{J as default};
