import{hp as S,gL as x,hE as g,a7 as E,I as j,bi as I,aA as b}from"./index-C_bK48d2.js";import{t as R}from"./urlUtils-BlxBVR77.js";import{t as q}from"./pbfQueryUtils-CX8BKSeH.js";function F(n,e){if(e&&n.type==="extent")return`${n.xmin},${n.ymin},${n.xmax},${n.ymax}`;if(e&&n.type==="point")return`${n.x},${n.y}`;const i=n.toJSON();return delete i.spatialReference,JSON.stringify(i)}function w(n,e,i){var d,y;const{geometry:u}=n,o=n.compactGeometryEnabled??!1,t=n.toJSON();delete t.compactGeometryEnabled,delete t.defaultSpatialReferenceEnabled;const r=t;let a,s,c;if(u&&(s=u.spatialReference,c=S(s),r.geometryType=x(u),r.geometry=F(u,o),r.inSR=c),t.groupByFieldsForStatistics&&(r.groupByFieldsForStatistics=t.groupByFieldsForStatistics.join(",")),t.objectIds)switch((d=i==null?void 0:i.uniqueIdFields)==null?void 0:d.length){case void 0:r.objectIds=t.objectIds.join(",");break;case 1:r.uniqueIds=JSON.stringify(t.objectIds),delete r.objectIds;break;default:r.uniqueIds=JSON.stringify(t.objectIds.map(m=>JSON.parse(m))),delete r.objectIds}if(t.orderByFields&&(r.orderByFields=t.orderByFields.join(",")),!t.outFields||!t.returnDistinctValues&&(e!=null&&e.returnCountOnly||e!=null&&e.returnExtentOnly||e!=null&&e.returnIdsOnly)?delete r.outFields:t.outFields.includes("*")?r.outFields="*":r.outFields=t.outFields.join(","),t.outSR?(r.outSR=S(t.outSR),a=n.outSpatialReference):u&&(t.returnGeometry||t.returnCentroid)&&(r.outSR=r.inSR,a=s),t.returnGeometry&&delete t.returnGeometry,t.outStatistics&&(r.outStatistics=JSON.stringify(t.outStatistics)),t.fullText&&(r.fullText=JSON.stringify(t.fullText)),t.pixelSize&&(r.pixelSize=JSON.stringify(t.pixelSize)),t.quantizationParameters&&(n.defaultSpatialReferenceEnabled&&s!=null&&((y=n.quantizationParameters)==null?void 0:y.extent)!=null&&s.equals(n.quantizationParameters.extent.spatialReference)&&delete t.quantizationParameters.extent.spatialReference,r.quantizationParameters=JSON.stringify(t.quantizationParameters)),t.parameterValues&&(r.parameterValues=JSON.stringify(t.parameterValues)),t.rangeValues&&(r.rangeValues=JSON.stringify(t.rangeValues)),t.dynamicDataSource&&(r.layer=JSON.stringify({source:t.dynamicDataSource}),delete t.dynamicDataSource),t.timeExtent){const m=t.timeExtent,{start:f,end:p}=m;f==null&&p==null||(r.time=f===p?f:`${f??"null"},${p??"null"}`),delete t.timeExtent}return n.defaultSpatialReferenceEnabled&&s!=null&&a!=null&&s.equals(a)&&(r.defaultSR=r.inSR,delete r.inSR,delete r.outSR),r}const O="Layer does not support extent calculation.";function $(n,e,i){return w(n,e,i)}async function v(n,e,i,u,o){var r;const t=(r=e.timeExtent)!=null&&r.isEmpty?{features:[]}:await l(n,e,"json",u,void 0,o);return g(e,i,t),t}async function C(n,e,i,u,o){var r;if((r=e.timeExtent)!=null&&r.isEmpty)return i.createFeatureResult();const t=await h(n,e,u,o);return q(t,i)}function h(n,e,i,u){return l(n,e,"pbf",i,void 0,u)}function D(n,e,i,u){var o;return(o=e.timeExtent)!=null&&o.isEmpty?Promise.resolve({objectIds:[]}):l(n,e,"json",i,{returnIdsOnly:!0},u)}async function T(n,e,i,u){var o;return(o=e.timeExtent)!=null&&o.isEmpty?0:(await l(n,e,"json",i,{returnIdsOnly:!0,returnCountOnly:!0},u)).count}async function k(n,e,i){var t;if((t=e.timeExtent)!=null&&t.isEmpty)return{count:0,extent:null};const u=await l(n,e,"json",i,{returnExtentOnly:!0,returnCountOnly:!0});if(u.hasOwnProperty("extent"))return u;const o=typeof n=="string"?n:n.path;if(/\/imageserver\/?$/i.test(o)&&u.hasOwnProperty("count")){const r=await l(n,e,"json",i,{returnExtentOnly:!0});return{count:u.count,extent:r.extent}}if(u.features)throw new Error(O);if(u.hasOwnProperty("count"))throw new Error(O);return u}function J(n,e){if(!n.returnIdsOnly||!e.uniqueIdFields)return n;const i={...n,returnUniqueIdsOnly:!0};return delete i.returnIdsOnly,i}async function l(n,e,i,u={},o={},t={}){const r=await N(n,e,i,u,o,t),a=i==="json"?"json":"array-buffer";return E(r.url,{responseType:a,...r.options}).then(({data:s})=>s)}async function N(n,e,i,u,o={},t={}){const r=typeof n=="string"?j(n):n,a=e.geometry?[e.geometry]:[],s=await I(a,null,{signal:u.signal}),c=s==null?void 0:s[0];if(c!=null){const y=e.clone();y.geometry=c.clone(),e=y}const d=R({...r.query,f:i,...J(o,t),...$(e,o,t)});return u={...u,query:{...d,...u.query}},new P(b(r.path,z(e,o)?"query3d":"query"),u)}class P{constructor(e,i){this.url=e,this.options=i}}function z(n,e){return n.formatOf3DObjects!=null&&!(e.returnCountOnly||e.returnExtentOnly||e.returnIdsOnly)}export{k as O,h as f,C as l,D as m,T as p,w as r,v as y};
